<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>AsyncTask实现多任务多线程断点续传下载 | 残剑博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="这篇博客是AsyncTask下载系列的最后一篇文章，前面写了关于断点续传的和多线程下载的博客，这篇是在前两篇的基础上面实现的，有兴趣的可以去看下。
　　一、AsyncTask实现断点续传
　　二、AsyncTask实现多线程断点续传
　　这里模拟应用市场app下载实现了一个Demo，因为只有一个界面，所以没有将下载放到Service中，而是直接在Activity中创建。在正式的项目中，下载都是放到">
<meta property="og:type" content="article">
<meta property="og:title" content="AsyncTask实现多任务多线程断点续传下载">
<meta property="og:url" content="http://www.liuling123.com/2015/10/asynctask-multi-task-thread.html">
<meta property="og:site_name" content="残剑博客">
<meta property="og:description" content="这篇博客是AsyncTask下载系列的最后一篇文章，前面写了关于断点续传的和多线程下载的博客，这篇是在前两篇的基础上面实现的，有兴趣的可以去看下。
　　一、AsyncTask实现断点续传
　　二、AsyncTask实现多线程断点续传
　　这里模拟应用市场app下载实现了一个Demo，因为只有一个界面，所以没有将下载放到Service中，而是直接在Activity中创建。在正式的项目中，下载都是放到">
<meta property="og:image" content="http://www.liuling123.com/wp-content/uploads/2015/11/420264-20151016210637601-2103512377.gif">
<meta property="og:updated_time" content="2016-01-03T07:04:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AsyncTask实现多任务多线程断点续传下载">
<meta name="twitter:description" content="这篇博客是AsyncTask下载系列的最后一篇文章，前面写了关于断点续传的和多线程下载的博客，这篇是在前两篇的基础上面实现的，有兴趣的可以去看下。
　　一、AsyncTask实现断点续传
　　二、AsyncTask实现多线程断点续传
　　这里模拟应用市场app下载实现了一个Demo，因为只有一个界面，所以没有将下载放到Service中，而是直接在Activity中创建。在正式的项目中，下载都是放到">
    

    

    

    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/vendor/open-sans/styles.css" type="text/css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css" type="text/css">

    <link rel="stylesheet" href="/css/style.css" type="text/css">

    <script src="/vendor/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
    
    
        <link rel="stylesheet" href="/vendor/fancybox/jquery.fancybox.css" type="text/css">
    
    
    
    

</head>
<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">残剑博客</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/protrait.jpg" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js" type="text/javascript"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/protrait.jpg" />
            <h2 id="name">Lauren</h2>
            <h3 id="title">Android Developer &amp; Designer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Shenzhen, China</span>
            <a id="follow" target="_blank" href="https://github.com/liuling07">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                146
                <span>文章</span>
            </div>
            <div class="article-info-block">
                36
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/liuling07" target="_blank" title="github" >
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="http://weibo.com/LaurenLiuling/" target="_blank" title="weibo" >
                            <i class="fa fa-weibo"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://plus.google.com/u/0/107098505138563589748/" target="_blank" title="google-plus" >
                            <i class="fa fa-google-plus"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="http://stackoverflow.com/users/5629327/lauren-liuling" target="_blank" title="stack-overflow" >
                            <i class="fa fa-stack-overflow"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://twitter.com/lauren_liuLing/" target="_blank" title="twitter" >
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://www.facebook.com/lauren.liuling/" target="_blank" title="facebook" >
                            <i class="fa fa-facebook"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/atom.xml" target="_blank" title="rss" >
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main"><article id="post-asynctask-multi-task-thread" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            AsyncTask实现多任务多线程断点续传下载
        </h1>
    

                <div class="article-meta">
                    
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2015/10/asynctask-multi-task-thread.html">
            <time datetime="2015-10-16T05:29:00.000Z" itemprop="datePublished">2015-10-16</time>
        </a>
    </div>


                    
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                    
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/AsyncTask/">AsyncTask</a>, <a class="tag-link" href="/tags/android/">android</a>, <a class="tag-link" href="/tags/多线程/">多线程</a>, <a class="tag-link" href="/tags/断点续传/">断点续传</a>
    </div>

                </div>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>　　<span style="font-size: 15px;">这篇博客是AsyncTask下载系列的最后一篇文章，前面写了关于断点续传的和多线程下载的博客，这篇是在前两篇的基础上面实现的，有兴趣的可以去看下。</span></p>
<p><span style="font-size: 15px;">　　一、<a href="http://www.cnblogs.com/liuling/p/2015-10-10-01.html" title="http://www.cnblogs.com/liuling/p/2015-10-10-01.html" target="_blank" rel="external">AsyncTask实现断点续传</a></span></p>
<p><span style="font-size: 15px;">　　二、<a href="http://www.cnblogs.com/liuling/p/2015-10-13-01.html" title="http://www.cnblogs.com/liuling/p/2015-10-13-01.html" target="_blank" rel="external">AsyncTask实现多线程断点续传</a></span></p>
<p><span style="font-size: 15px;">　　这里模拟应用市场app下载实现了一个Demo，因为只有一个界面，所以没有将下载放到Service中，而是直接在Activity中创建。在正式的项目中，下载都是放到Service中，然后通过BroadCast通知界面更新进度。<span style="line-height: 1.5;"><br></span></span><br><a id="more"></a><br><span style="font-size: 15px;">　　上代码之前，先看下demo的运行效果图吧。</span></p>
<p><img src="http://www.liuling123.com/wp-content/uploads/2015/11/420264-20151016210637601-2103512377.gif" alt=""></p>
<p>&nbsp;</p>
<p>　　<span style="font-size: 15px;">下面我们看代码，这里每一个文件的下载定义一个Downloador来管理下载该文件的所有线程（暂停、下载等）。Downloador创建3个DownloadTask（这里定义每个文件分配3个线程下载）来下载该文件特定的起止位置。这里要通过文件的大小来计算每个线程所下载的起止位置，详细可以参考《<a href="http://www.cnblogs.com/liuling/p/2015-10-13-01.html" title="http://www.cnblogs.com/liuling/p/2015-10-13-01.html" target="_blank" rel="external">AsyncTask实现多线程断点续传</a>》。</span></p>
<p><span style="font-size: 15px;">　　1、Downloador类</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.downloador;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Intent;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.AsyncTask;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Handler;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Message;<br></span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.text.TextUtils;<br></span><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.Log;<br></span><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.Toast;<br></span><span style="color: #008080;"> 12</span><br><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.beans.AppContent;<br></span><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.beans.DownloadInfo;<br></span><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.db.DownloadFileDAO;<br></span><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.db.DownloadInfoDAO;<br></span><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.utils.DownloadUtils;<br></span><span style="color: #008080;"> 18</span><br><span style="color: #008080;"> 19</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.HttpResponse;<br></span><span style="color: #008080;"> 20</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.client.HttpClient;<br></span><span style="color: #008080;"> 21</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.client.methods.HttpGet;<br></span><span style="color: #008080;"> 22</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.impl.client.DefaultHttpClient;<br></span><span style="color: #008080;"> 23</span><br><span style="color: #008080;"> 24</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;"> 25</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;"> 26</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Executor;<br></span><span style="color: #008080;"> 27</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Executors;<br></span><span style="color: #008080;"> 28</span><br><span style="color: #008080;"> 29</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 30</span> <span style="color: #008000;"> <em> @Class: Downloador<br></em></span><span style="color: #008080;"> 31</span> <span style="color: #008000;">  @Description: 任务下载器<br></span><span style="color: #008080;"> 32</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;">: lling(www.cnblogs.com/liuling)<br></span><span style="color: #008080;"> 33</span> <span style="color: #008000;">  @Date: 2015/10/13<br></span><span style="color: #008080;"> 34</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 35</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Downloador {<br></span><span style="color: #008080;"> 36</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “Downloador”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 37</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> THREAD_POOL_SIZE = 9;  <span style="color: #008000;">//</span><span style="color: #008000;">线程池大小为9</span><br><span style="color: #008080;"> 38</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> THREAD_NUM = 3;  <span style="color: #008000;">//</span><span style="color: #008000;">每个文件3个线程下载</span><br><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> GET_LENGTH_SUCCESS = 1<span style="color: #000000;">;<br></span><span style="color: #008080;"> 40</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> Executor THREAD_POOL_EXECUTOR =<span style="color: #000000;"> Executors.newFixedThreadPool(THREAD_POOL_SIZE);<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span>     <span style="color: #0000ff;">private</span> List<downloadtask><span style="color: #000000;"> tasks;<br></span><span style="color: #008080;"> 43</span>     <span style="color: #0000ff;">private</span> InnerHandler handler = <span style="color: #0000ff;">new</span><span style="color: #000000;"> InnerHandler();<br></span><span style="color: #008080;"> 44</span><br><span style="color: #008080;"> 45</span>     <span style="color: #0000ff;">private</span> AppContent appContent; <span style="color: #008000;">//</span><span style="color: #008000;">待下载的应用</span><br><span style="color: #008080;"> 46</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span> downloadLength; <span style="color: #008000;">//</span><span style="color: #008000;">下载过程中记录已下载大小</span><br><span style="color: #008080;"> 47</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> fileLength;<br></span><span style="color: #008080;"> 48</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br></span><span style="color: #008080;"> 49</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String downloadPath;<br></span><span style="color: #008080;"> 50</span><br><span style="color: #008080;"> 51</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Downloador(Context context, AppContent appContent) {<br></span><span style="color: #008080;"> 52</span>         <span style="color: #0000ff;">this</span>.context =<span style="color: #000000;"> context;<br></span><span style="color: #008080;"> 53</span>         <span style="color: #0000ff;">this</span>.appContent =<span style="color: #000000;"> appContent;<br></span><span style="color: #008080;"> 54</span>         <span style="color: #0000ff;">this</span>.downloadPath =<span style="color: #000000;"> DownloadUtils.getDownloadPath();<br></span><span style="color: #008080;"> 55</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 56</span><br><span style="color: #008080;"> 57</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 58</span> <span style="color: #008000;">     <em> 开始下载<br></em></span><span style="color: #008080;"> 59</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 60</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> download() {<br></span><span style="color: #008080;"> 61</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(TextUtils.isEmpty(downloadPath)) {<br></span><span style="color: #008080;"> 62</span>             Toast.makeText(context, “未找到SD卡”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;"> 63</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 64</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 65</span>         <span style="color: #0000ff;">if</span>(appContent == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 66</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> IllegalArgumentException(“download content can not be null”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 68</span>         <span style="color: #0000ff;">new</span><span style="color: #000000;"> Thread() {<br></span><span style="color: #008080;"> 69</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 70</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;"> 71</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">获取文件大小</span><br><span style="color: #008080;"> 72</span>                 HttpClient client = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DefaultHttpClient();<br></span><span style="color: #008080;"> 73</span>                 HttpGet request = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HttpGet(appContent.getUrl());<br></span><span style="color: #008080;"> 74</span>                 HttpResponse response = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 75</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 76</span>                     response =<span style="color: #000000;"> client.execute(request);<br></span><span style="color: #008080;"> 77</span>                     fileLength =<span style="color: #000000;"> response.getEntity().getContentLength();<br></span><span style="color: #008080;"> 78</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 79</span> <span style="color: #000000;">                    Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;"> 80</span>                 } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 81</span>                     <span style="color: #0000ff;">if</span> (request != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 82</span> <span style="color: #000000;">                        request.abort();<br></span><span style="color: #008080;"> 83</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;"> 84</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 85</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">计算出该文件已经下载的总长度</span><br><span style="color: #008080;"> 86</span>                 List<downloadinfo> lists =<span style="color: #000000;"> DownloadInfoDAO.getInstance(context.getApplicationContext())<br></span><span style="color: #008080;"> 87</span> <span style="color: #000000;">                        .getDownloadInfosByUrl(appContent.getUrl());<br></span><span style="color: #008080;"> 88</span>                 <span style="color: #0000ff;">for</span><span style="color: #000000;"> (DownloadInfo info : lists) {<br></span><span style="color: #008080;"> 89</span>                     downloadLength +=<span style="color: #000000;"> info.getDownloadLength();<br></span><span style="color: #008080;"> 90</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 91</span><br><span style="color: #008080;"> 92</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">插入文件下载记录到数据库</span><br><span style="color: #008080;"> 93</span> <span style="color: #000000;">                DownloadFileDAO.getInstance(context.getApplicationContext()).insertDownloadFile(appContent);<br></span><span style="color: #008080;"> 94</span> <span style="color: #000000;">                Message.obtain(handler, GET_LENGTH_SUCCESS).sendToTarget();<br></span><span style="color: #008080;"> 95</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 96</span> <span style="color: #000000;">        }.start();<br></span><span style="color: #008080;"> 97</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 98</span><br><span style="color: #008080;"> 99</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">100</span> <span style="color: #008000;">     <em> 开始创建AsyncTask下载<br></em></span><span style="color: #008080;">101</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">102</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> beginDownload() {<br></span><span style="color: #008080;">103</span>         Log.e(TAG, “beginDownload” +<span style="color: #000000;"> appContent.getUrl());<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">        appContent.setStatus(AppContent.Status.WAITING);<br></span><span style="color: #008080;">105</span>         <span style="color: #0000ff;">long</span> blockLength = fileLength /<span style="color: #000000;"> THREAD_NUM;<br></span><span style="color: #008080;">106</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; THREAD_NUM; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;">107</span>             <span style="color: #0000ff;">long</span> beginPosition = i <em> blockLength;<span style="color: #008000;">//</span><span style="color: #008000;">每条线程下载的开始位置</span><br><span style="color: #008080;">108</span>             <span style="color: #0000ff;">long</span> endPosition = (i + 1) </em> blockLength;<span style="color: #008000;">//</span><span style="color: #008000;">每条线程下载的结束位置</span><br><span style="color: #008080;">109</span>             <span style="color: #0000ff;">if</span> (i == (THREAD_NUM - 1<span style="color: #000000;">)) {<br></span><span style="color: #008080;">110</span>                 endPosition = fileLength;<span style="color: #008000;">//</span><span style="color: #008000;">如果整个文件的大小不为线程个数的整数倍，则最后一个线程的结束位置即为文件的总长度</span><br><span style="color: #008080;">111</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">112</span>             DownloadTask task = <span style="color: #0000ff;">new</span> DownloadTask(i, beginPosition, endPosition, <span style="color: #0000ff;">this</span><span style="color: #000000;">, context);<br></span><span style="color: #008080;">113</span> <span style="color: #000000;">            task.executeOnExecutor(THREAD_POOL_EXECUTOR, appContent.getUrl());<br></span><span style="color: #008080;">114</span>             <span style="color: #0000ff;">if</span>(tasks == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">115</span>                 tasks = <span style="color: #0000ff;">new</span> ArrayList<downloadtask><span style="color: #000000;">();<br></span><span style="color: #008080;">116</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">117</span> <span style="color: #000000;">            tasks.add(task);<br></span><span style="color: #008080;">118</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">119</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">120</span><br><span style="color: #008080;">121</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">122</span> <span style="color: #008000;">     <em> 暂停下载<br></em></span><span style="color: #008080;">123</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">124</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> pause() {<br></span><span style="color: #008080;">125</span>         <span style="color: #0000ff;">for</span><span style="color: #000000;"> (DownloadTask task : tasks) {<br></span><span style="color: #008080;">126</span>             <span style="color: #0000ff;">if</span> (task != <span style="color: #0000ff;">null</span> &amp;&amp; (task.getStatus() == AsyncTask.Status.RUNNING || !<span style="color: #000000;">task.isCancelled())) {<br></span><span style="color: #008080;">127</span>                 task.cancel(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">128</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">129</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">130</span> <span style="color: #000000;">        tasks.clear();<br></span><span style="color: #008080;">131</span> <span style="color: #000000;">        appContent.setStatus(AppContent.Status.PAUSED);<br></span><span style="color: #008080;">132</span> <span style="color: #000000;">        DownloadFileDAO.getInstance(context.getApplicationContext()).updateDownloadFile(appContent);<br></span><span style="color: #008080;">133</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">134</span><br><span style="color: #008080;">135</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">136</span> <span style="color: #008000;">     <em> 将已下载大小归零<br></em></span><span style="color: #008080;">137</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">138</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> resetDownloadLength() {<br></span><span style="color: #008080;">139</span>         <span style="color: #0000ff;">this</span>.downloadLength = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">140</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">141</span><br><span style="color: #008080;">142</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">143</span> <span style="color: #008000;">     <em> 添加已下载大小<br></em></span><span style="color: #008080;">144</span> <span style="color: #008000;">      多线程访问需加锁<br></span><span style="color: #008080;">145</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> size<br></span><span style="color: #008080;">146</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">147</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">void</span> updateDownloadLength(<span style="color: #0000ff;">long</span><span style="color: #000000;"> size){<br></span><span style="color: #008080;">148</span>         <span style="color: #0000ff;">this</span>.downloadLength +=<span style="color: #000000;"> size;<br></span><span style="color: #008080;">149</span>         <span style="color: #008000;">//</span><span style="color: #008000;">通知更新界面</span><br><span style="color: #008080;">150</span>         <span style="color: #0000ff;">int</span> percent = (<span style="color: #0000ff;">int</span>)((<span style="color: #0000ff;">float</span>)downloadLength * 100 / (<span style="color: #0000ff;">float</span><span style="color: #000000;">)fileLength);<br></span><span style="color: #008080;">151</span> <span style="color: #000000;">        appContent.setDownloadPercent(percent);<br></span><span style="color: #008080;">152</span>         <span style="color: #0000ff;">if</span>(percent == 100 || downloadLength ==<span style="color: #000000;"> fileLength) {<br></span><span style="color: #008080;">153</span>             appContent.setDownloadPercent(100); <span style="color: #008000;">//</span><span style="color: #008000;">上面计算有时候会有点误差，算到percent=99</span><br><span style="color: #008080;">154</span> <span style="color: #000000;">            appContent.setStatus(AppContent.Status.FINISHED);<br></span><span style="color: #008080;">155</span> <span style="color: #000000;">            DownloadFileDAO.getInstance(context.getApplicationContext()).updateDownloadFile(appContent);<br></span><span style="color: #008080;">156</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">157</span>         Intent intent = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Intent(Constants.DOWNLOAD_MSG);<br></span><span style="color: #008080;">158</span>         <span style="color: #0000ff;">if</span>(appContent.getStatus() ==<span style="color: #000000;"> AppContent.Status.WAITING) {<br></span><span style="color: #008080;">159</span> <span style="color: #000000;">            appContent.setStatus(AppContent.Status.DOWNLOADING);<br></span><span style="color: #008080;">160</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">161</span>         Bundle bundle = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Bundle();<br></span><span style="color: #008080;">162</span>         bundle.putParcelable(“appContent”<span style="color: #000000;">, appContent);<br></span><span style="color: #008080;">163</span> <span style="color: #000000;">        intent.putExtras(bundle);<br></span><span style="color: #008080;">164</span> <span style="color: #000000;">        context.sendBroadcast(intent);<br></span><span style="color: #008080;">165</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">166</span><br><span style="color: #008080;">167</span>     <span style="color: #0000ff;">protected</span><span style="color: #000000;"> String getDownloadPath() {<br></span><span style="color: #008080;">168</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> downloadPath;<br></span><span style="color: #008080;">169</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">170</span><br><span style="color: #008080;">171</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">class</span> InnerHandler <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Handler {<br></span><span style="color: #008080;">172</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">173</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> handleMessage(Message msg) {<br></span><span style="color: #008080;">174</span>             <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (msg.what) {<br></span><span style="color: #008080;">175</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> GET_LENGTH_SUCCESS :<br></span><span style="color: #008080;">176</span> <span style="color: #000000;">                    beginDownload();<br></span><span style="color: #008080;">177</span>                     <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">178</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">179</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">.handleMessage(msg);<br></span><span style="color: #008080;">180</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">181</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">182</span> }</downloadtask></downloadinfo></downloadtask></pre><br></div>

<p><span style="font-size: 15px;">　　2、DownloadTask类</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.downloador;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.AsyncTask;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.Log;<br></span><span style="color: #008080;">  6</span><br><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.beans.DownloadInfo;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.db.DownloadInfoDAO;<br></span><span style="color: #008080;">  9</span><br><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.Header;<br></span><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.HttpResponse;<br></span><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.client.HttpClient;<br></span><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.client.methods.HttpGet;<br></span><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.impl.client.DefaultHttpClient;<br></span><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.message.BasicHeader;<br></span><span style="color: #008080;"> 16</span><br><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.File;<br></span><span style="color: #008080;"> 18</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.IOException;<br></span><span style="color: #008080;"> 19</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.InputStream;<br></span><span style="color: #008080;"> 20</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.OutputStream;<br></span><span style="color: #008080;"> 21</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.RandomAccessFile;<br></span><span style="color: #008080;"> 22</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.MalformedURLException;<br></span><span style="color: #008080;"> 23</span><br><span style="color: #008080;"> 24</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 25</span> <span style="color: #008000;">  @Class: DownloadTask<br></span><span style="color: #008080;"> 26</span> <span style="color: #008000;"> <em> @Description: 文件下载AsyncTask<br></em></span><span style="color: #008080;"> 27</span> <span style="color: #008000;">  </span><span style="color: #808080;">@author</span><span style="color: #008000;">: lling(www.cnblogs.com/liuling)<br></span><span style="color: #008080;"> 28</span> <span style="color: #008000;"> <em> @Date: 2015/10/13<br></em></span><span style="color: #008080;"> 29</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 30</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> DownloadTask <span style="color: #0000ff;">extends</span> AsyncTask<string, integer="" ,="" long=""><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 31</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “DownloadTask”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 32</span><br><span style="color: #008080;"> 33</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> taskId;<br></span><span style="color: #008080;"> 34</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> beginPosition;<br></span><span style="color: #008080;"> 35</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> endPosition;<br></span><span style="color: #008080;"> 36</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> downloadLength;<br></span><span style="color: #008080;"> 37</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String url;<br></span><span style="color: #008080;"> 38</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Downloador downloador;<br></span><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> DownloadInfoDAO downloadInfoDAO;<br></span><span style="color: #008080;"> 40</span><br><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span>     <span style="color: #0000ff;">public</span> DownloadTask(<span style="color: #0000ff;">int</span> taskId, <span style="color: #0000ff;">long</span> beginPosition, <span style="color: #0000ff;">long</span><span style="color: #000000;"> endPosition, Downloador downloador,<br></span><span style="color: #008080;"> 43</span> <span style="color: #000000;">                        Context context) {<br></span><span style="color: #008080;"> 44</span>         <span style="color: #0000ff;">this</span>.taskId =<span style="color: #000000;"> taskId;<br></span><span style="color: #008080;"> 45</span>         <span style="color: #0000ff;">this</span>.beginPosition =<span style="color: #000000;"> beginPosition;<br></span><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">this</span>.endPosition =<span style="color: #000000;"> endPosition;<br></span><span style="color: #008080;"> 47</span>         <span style="color: #0000ff;">this</span>.downloador =<span style="color: #000000;"> downloador;<br></span><span style="color: #008080;"> 48</span>         downloadInfoDAO =<span style="color: #000000;"> DownloadInfoDAO.getInstance(context.getApplicationContext());<br></span><span style="color: #008080;"> 49</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 50</span><br><span style="color: #008080;"> 51</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 52</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPreExecute() {<br></span><span style="color: #008080;"> 53</span>         Log.e(TAG, “onPreExecute”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 54</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 55</span><br><span style="color: #008080;"> 56</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 57</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPostExecute(Long aLong) {<br></span><span style="color: #008080;"> 58</span>         Log.e(TAG, url + “taskId:” + taskId + “executed”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 59</span> <span style="color: #008000;">//</span><span style="color: #008000;">        downloador.updateDownloadInfo(null);</span><br><span style="color: #008080;"> 60</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 61</span><br><span style="color: #008080;"> 62</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 63</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onProgressUpdate(Integer… values) {<br></span><span style="color: #008080;"> 64</span>         <span style="color: #008000;">//</span><span style="color: #008000;">通知downloador增加已下载大小<br></span><span style="color: #008080;"> 65</span> <span style="color: #008000;">//</span><span style="color: #008000;">        downloador.updateDownloadLength(values[0]);</span><br><span style="color: #008080;"> 66</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 67</span><br><span style="color: #008080;"> 68</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 69</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCancelled() {<br></span><span style="color: #008080;"> 70</span>         Log.e(TAG, “onCancelled”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 71</span> <span style="color: #008000;">//</span><span style="color: #008000;">        downloador.updateDownloadInfo(null);</span><br><span style="color: #008080;"> 72</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 73</span><br><span style="color: #008080;"> 74</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 75</span>     <span style="color: #0000ff;">protected</span><span style="color: #000000;"> Long doInBackground(String… params) {<br></span><span style="color: #008080;"> 76</span>         <span style="color: #008000;">//</span><span style="color: #008000;">这里加判断的作用是：如果还处于等待就暂停了，运行到这里已经cancel了，就直接退出</span><br><span style="color: #008080;"> 77</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(isCancelled()) {<br></span><span style="color: #008080;"> 78</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 79</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 80</span>         url = params[0<span style="color: #000000;">];<br></span><span style="color: #008080;"> 81</span>         <span style="color: #0000ff;">if</span>(url == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 82</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 83</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 84</span>         HttpClient client = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DefaultHttpClient();<br></span><span style="color: #008080;"> 85</span>         HttpGet request = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HttpGet(url);<br></span><span style="color: #008080;"> 86</span> <span style="color: #000000;">        HttpResponse response;<br></span><span style="color: #008080;"> 87</span> <span style="color: #000000;">        InputStream is;<br></span><span style="color: #008080;"> 88</span>         RandomAccessFile fos = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 89</span>         OutputStream output = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 90</span><br><span style="color: #008080;"> 91</span>         DownloadInfo downloadInfo = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 92</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 93</span>             <span style="color: #008000;">//</span><span style="color: #008000;">本地文件</span><br><span style="color: #008080;"> 94</span>             File file = <span style="color: #0000ff;">new</span> File(downloador.getDownloadPath() + File.separator + url.substring(url.lastIndexOf(“/“) + 1<span style="color: #000000;">));<br></span><span style="color: #008080;"> 95</span><br><span style="color: #008080;"> 96</span>             <span style="color: #008000;">//</span><span style="color: #008000;">获取之前下载保存的信息</span><br><span style="color: #008080;"> 97</span>             downloadInfo =<span style="color: #000000;"> downloadInfoDAO.getDownloadInfoByTaskIdAndUrl(taskId, url);<br></span><span style="color: #008080;"> 98</span>             <span style="color: #008000;">//</span><span style="color: #008000;">从之前结束的位置继续下载<br></span><span style="color: #008080;"> 99</span>             <span style="color: #008000;">//</span><span style="color: #008000;">这里加了判断file.exists()，判断是否被用户删除了，如果文件没有下载完，但是已经被用户删除了，则重新下载</span><br><span style="color: #008080;">100</span>             <span style="color: #0000ff;">if</span>(file.exists() &amp;&amp; downloadInfo != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">101</span>                 <span style="color: #0000ff;">if</span>(downloadInfo.isDownloadSuccess() == 1<span style="color: #000000;">) {<br></span><span style="color: #008080;">102</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">下载完成直接结束</span><br><span style="color: #008080;">103</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">105</span>                 beginPosition = beginPosition +<span style="color: #000000;"> downloadInfo.getDownloadLength();<br></span><span style="color: #008080;">106</span>                 downloadLength =<span style="color: #000000;"> downloadInfo.getDownloadLength();<br></span><span style="color: #008080;">107</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">108</span>             <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">file.exists()) {<br></span><span style="color: #008080;">109</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">如果此task已经下载完，但是文件被用户删除，则需要重新设置已下载长度，重新下载</span><br><span style="color: #008080;">110</span> <span style="color: #000000;">                downloador.resetDownloadLength();<br></span><span style="color: #008080;">111</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">112</span><br><span style="color: #008080;">113</span>             <span style="color: #008000;">//</span><span style="color: #008000;">设置下载的数据位置beginPosition字节到endPosition字节</span><br><span style="color: #008080;">114</span>             Header header_size = <span style="color: #0000ff;">new</span> BasicHeader(“Range”, “bytes=” + beginPosition + “-“ +<span style="color: #000000;"> endPosition);<br></span><span style="color: #008080;">115</span> <span style="color: #000000;">            request.addHeader(header_size);<br></span><span style="color: #008080;">116</span>             <span style="color: #008000;">//</span><span style="color: #008000;">执行请求获取下载输入流</span><br><span style="color: #008080;">117</span>             response =<span style="color: #000000;"> client.execute(request);<br></span><span style="color: #008080;">118</span>             is =<span style="color: #000000;"> response.getEntity().getContent();<br></span><span style="color: #008080;">119</span><br><span style="color: #008080;">120</span>             <span style="color: #008000;">//</span><span style="color: #008000;">创建文件输出流</span><br><span style="color: #008080;">121</span>             fos = <span style="color: #0000ff;">new</span> RandomAccessFile(file, “rw”<span style="color: #000000;">);<br></span><span style="color: #008080;">122</span>             <span style="color: #008000;">//</span><span style="color: #008000;">从文件的size以后的位置开始写入</span><br><span style="color: #008080;">123</span> <span style="color: #000000;">            fos.seek(beginPosition);<br></span><span style="color: #008080;">124</span><br><span style="color: #008080;">125</span>             <span style="color: #0000ff;">byte</span> buffer [] = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">byte</span>[1024<span style="color: #000000;">];<br></span><span style="color: #008080;">126</span>             <span style="color: #0000ff;">int</span> inputSize = -1<span style="color: #000000;">;<br></span><span style="color: #008080;">127</span>             <span style="color: #0000ff;">while</span>((inputSize = is.read(buffer)) != -1<span style="color: #000000;">) {<br></span><span style="color: #008080;">128</span>                 fos.write(buffer, 0<span style="color: #000000;">, inputSize);<br></span><span style="color: #008080;">129</span>                 downloadLength +=<span style="color: #000000;"> inputSize;<br></span><span style="color: #008080;">130</span> <span style="color: #000000;">                downloador.updateDownloadLength(inputSize);<br></span><span style="color: #008080;">131</span><br><span style="color: #008080;">132</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">如果暂停了，需要将下载信息存入数据库</span><br><span style="color: #008080;">133</span>                 <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isCancelled()) {<br></span><span style="color: #008080;">134</span>                     <span style="color: #0000ff;">if</span>(downloadInfo == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">135</span>                         downloadInfo = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadInfo();<br></span><span style="color: #008080;">136</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">137</span> <span style="color: #000000;">                    downloadInfo.setUrl(url);<br></span><span style="color: #008080;">138</span> <span style="color: #000000;">                    downloadInfo.setDownloadLength(downloadLength);<br></span><span style="color: #008080;">139</span> <span style="color: #000000;">                    downloadInfo.setTaskId(taskId);<br></span><span style="color: #008080;">140</span>                     downloadInfo.setDownloadSuccess(0<span style="color: #000000;">);<br></span><span style="color: #008080;">141</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">保存下载信息到数据库</span><br><span style="color: #008080;">142</span> <span style="color: #000000;">                    downloadInfoDAO.insertDownloadInfo(downloadInfo);<br></span><span style="color: #008080;">143</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">144</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">145</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">146</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (MalformedURLException e) {<br></span><span style="color: #008080;">147</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">148</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;">149</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">150</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;">{<br></span><span style="color: #008080;">151</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;">{<br></span><span style="color: #008080;">152</span>                 <span style="color: #0000ff;">if</span> (request != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">153</span> <span style="color: #000000;">                    request.abort();<br></span><span style="color: #008080;">154</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">155</span>                 <span style="color: #0000ff;">if</span>(output != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">156</span> <span style="color: #000000;">                    output.close();<br></span><span style="color: #008080;">157</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">158</span>                 <span style="color: #0000ff;">if</span>(fos != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">159</span> <span style="color: #000000;">                    fos.close();<br></span><span style="color: #008080;">160</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">161</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;">(Exception e) {<br></span><span style="color: #008080;">162</span> <span style="color: #000000;">                e.printStackTrace();<br></span><span style="color: #008080;">163</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">164</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">165</span>         <span style="color: #008000;">//</span><span style="color: #008000;">执行到这里，说明该task已经下载完了</span><br><span style="color: #008080;">166</span>         <span style="color: #0000ff;">if</span>(downloadInfo == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">167</span>             downloadInfo = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadInfo();<br></span><span style="color: #008080;">168</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">169</span> <span style="color: #000000;">        downloadInfo.setUrl(url);<br></span><span style="color: #008080;">170</span> <span style="color: #000000;">        downloadInfo.setDownloadLength(downloadLength);<br></span><span style="color: #008080;">171</span> <span style="color: #000000;">        downloadInfo.setTaskId(taskId);<br></span><span style="color: #008080;">172</span>         downloadInfo.setDownloadSuccess(1<span style="color: #000000;">);<br></span><span style="color: #008080;">173</span>         <span style="color: #008000;">//</span><span style="color: #008000;">保存下载信息到数据库</span><br><span style="color: #008080;">174</span> <span style="color: #000000;">        downloadInfoDAO.insertDownloadInfo(downloadInfo);<br></span><span style="color: #008080;">175</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">176</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">177</span> }</string,></pre><br></div>

<p>　　<span style="font-size: 15px;">Downloador和DownloadTask只这个例子的核心代码，下面是关于数据库的，因为要实现断点续传必须要在暂停的时候将每个线程下载的位置记录下来，方便下次继续下载时读取。这里有两个表，一个是存放每个文件的下载状态的，一个是存放每个文件对应的每个线程的下载状态的。</span></p>
<p><span style="font-size: 15px;">　　3、DBHelper</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.db;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.database.sqlite.SQLiteDatabase;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.database.sqlite.SQLiteOpenHelper;<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 8</span> <span style="color: #008000;">  @Class: DBHelper<br></span><span style="color: #008080;"> 9</span> <span style="color: #008000;"> <em> @Description: 数据库帮助类<br></em></span><span style="color: #008080;">10</span> <span style="color: #008000;">  </span><span style="color: #808080;">@author</span><span style="color: #008000;">: lling(www.cnblogs.com/liuling)<br></span><span style="color: #008080;">11</span> <span style="color: #008000;"> <em> @Date: 2015/10/14<br></em></span><span style="color: #008080;">12</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> DBHelper <span style="color: #0000ff;">extends</span><span style="color: #000000;"> SQLiteOpenHelper {<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> DBHelper(Context context) {<br></span><span style="color: #008080;">16</span>         <span style="color: #0000ff;">super</span>(context, “download.db”, <span style="color: #0000ff;">null</span>, 1<span style="color: #000000;">);<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(SQLiteDatabase db) {<br></span><span style="color: #008080;">21</span>         db.execSQL(“create table download_info(_id INTEGER PRIMARY KEY AUTOINCREMENT, task_id INTEGER, “<br><span style="color: #008080;">22</span>                 + “download_length INTEGER, url VARCHAR(255), is_success INTEGER)”<span style="color: #000000;">);<br></span><span style="color: #008080;">23</span>         db.execSQL(“create table download_file(_id INTEGER PRIMARY KEY AUTOINCREMENT, app_name VARCHAR(255), “<br><span style="color: #008080;">24</span>                 + “url VARCHAR(255), download_percent INTEGER, status INTEGER)”<span style="color: #000000;">);<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">28</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onUpgrade(SQLiteDatabase db, <span style="color: #0000ff;">int</span> oldVersion, <span style="color: #0000ff;">int</span><span style="color: #000000;"> newVersion) {<br></span><span style="color: #008080;">29</span><br><span style="color: #008080;">30</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">31</span> }</pre><br></div>

<p>　<span style="font-size: 15px;">　4、DownloadFileDAO，文件下载状态的数据库操作类</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.db;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.database.Cursor;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.database.sqlite.SQLiteDatabase;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.text.TextUtils;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.Log;<br></span><span style="color: #008080;">  8</span><br><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.beans.AppContent;<br></span><span style="color: #008080;"> 10</span><br><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;"> 13</span><br><span style="color: #008080;"> 14</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 15</span> <span style="color: #008000;"> <em> @Class: DownloadFileDAO<br></em></span><span style="color: #008080;"> 16</span> <span style="color: #008000;">  @Description: 每个文件下载状态记录的数据库操作类<br></span><span style="color: #008080;"> 17</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;">: lling(www.cnblogs.com/liuling)<br></span><span style="color: #008080;"> 18</span> <span style="color: #008000;">  @Date: 2015/10/13<br></span><span style="color: #008080;"> 19</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 20</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> DownloadFileDAO {<br></span><span style="color: #008080;"> 21</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “DownloadFileDAO”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> DownloadFileDAO dao=<span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 23</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br></span><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> DownloadFileDAO(Context context) {<br></span><span style="color: #008080;"> 25</span>         <span style="color: #0000ff;">this</span>.context=<span style="color: #000000;">context;<br></span><span style="color: #008080;"> 26</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 27</span><br><span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> DownloadFileDAO getInstance(Context context){<br></span><span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">if</span>(dao==<span style="color: #0000ff;">null</span><span style="color: #000000;">){<br></span><span style="color: #008080;"> 30</span>             dao=<span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadFileDAO(context);<br></span><span style="color: #008080;"> 31</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 32</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> dao;<br></span><span style="color: #008080;"> 33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 34</span><br><span style="color: #008080;"> 35</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 36</span> <span style="color: #008000;">     <em> 获取数据库连接<br></em></span><span style="color: #008080;"> 37</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 38</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> SQLiteDatabase getConnection() {<br></span><span style="color: #008080;"> 40</span>         SQLiteDatabase sqliteDatabase = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 41</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 42</span>             sqliteDatabase= <span style="color: #0000ff;">new</span><span style="color: #000000;"> DBHelper(context).getReadableDatabase();<br></span><span style="color: #008080;"> 43</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 44</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;"> 45</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> sqliteDatabase;<br></span><span style="color: #008080;"> 47</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 50</span> <span style="color: #008000;">      插入数据<br></span><span style="color: #008080;"> 51</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> appContent<br></span><span style="color: #008080;"> 52</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 53</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> insertDownloadFile(AppContent appContent) {<br></span><span style="color: #008080;"> 54</span>         <span style="color: #0000ff;">if</span>(appContent == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 55</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 56</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 57</span>         <span style="color: #008000;">//</span><span style="color: #008000;">如果本地已经存在，直接修改</span><br><span style="color: #008080;"> 58</span>         <span style="color: #0000ff;">if</span>(getAppContentByUrl(appContent.getUrl()) != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 59</span> <span style="color: #000000;">            updateDownloadFile(appContent);<br></span><span style="color: #008080;"> 60</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 62</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;"> 63</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 64</span>             String sql = “insert into download_file(app_name, url, download_percent, status) values (?,?,?,?)”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 65</span>             Object[] bindArgs =<span style="color: #000000;"> { appContent.getName(), appContent.getUrl(), appContent.getDownloadPercent()<br></span><span style="color: #008080;"> 66</span> <span style="color: #000000;">                    , appContent.getStatus().getValue()};<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">            database.execSQL(sql, bindArgs);<br></span><span style="color: #008080;"> 68</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 69</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;"> 70</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 71</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;"> 72</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;"> 73</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 74</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 75</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 76</span><br><span style="color: #008080;"> 77</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 78</span> <span style="color: #008000;">     <em> 根据url获取下载文件信息<br></em></span><span style="color: #008080;"> 79</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> url<br></span><span style="color: #008080;"> 80</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 81</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 82</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> AppContent getAppContentByUrl(String url) {<br></span><span style="color: #008080;"> 83</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(TextUtils.isEmpty(url)) {<br></span><span style="color: #008080;"> 84</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 85</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 86</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;"> 87</span>         AppContent appContent = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 88</span>         Cursor cursor = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 89</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 90</span>             String sql = “select * from download_file where url=?”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 91</span>             cursor = database.rawQuery(sql, <span style="color: #0000ff;">new</span><span style="color: #000000;"> String[] { url });<br></span><span style="color: #008080;"> 92</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (cursor.moveToNext()) {<br></span><span style="color: #008080;"> 93</span>                 appContent = <span style="color: #0000ff;">new</span> AppContent(cursor.getString(1), cursor.getString(2<span style="color: #000000;">));<br></span><span style="color: #008080;"> 94</span>                 appContent.setDownloadPercent(cursor.getInt(3<span style="color: #000000;">));<br></span><span style="color: #008080;"> 95</span>                 appContent.setStatus(AppContent.Status.getByValue(cursor.getInt(4<span style="color: #000000;">)));<br></span><span style="color: #008080;"> 96</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 97</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 98</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;"> 99</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">100</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;">101</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;">102</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">103</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> cursor) {<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">                cursor.close();<br></span><span style="color: #008080;">105</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">106</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">107</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> appContent;<br></span><span style="color: #008080;">108</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">109</span><br><span style="color: #008080;">110</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">111</span> <span style="color: #008000;">     <em> 更新下载信息<br></em></span><span style="color: #008080;">112</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> appContent<br></span><span style="color: #008080;">113</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">114</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> updateDownloadFile(AppContent appContent) {<br></span><span style="color: #008080;">115</span>         <span style="color: #0000ff;">if</span>(appContent == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">116</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">117</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">118</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;">119</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">120</span>             Log.e(TAG, “update download_file,app name:” + appContent.getName() + “,url:” +<span style="color: #000000;"> appContent.getUrl()<br></span><span style="color: #008080;">121</span>                     + “,percent” + appContent.getDownloadPercent() + “,status:” +<span style="color: #000000;"> appContent.getStatus().getValue());<br></span><span style="color: #008080;">122</span>             String sql = “update download_file set app_name=?, url=?, download_percent=?, status=? where url=?”<span style="color: #000000;">;<br></span><span style="color: #008080;">123</span>             Object[] bindArgs =<span style="color: #000000;"> {appContent.getName(), appContent.getUrl(), appContent.getDownloadPercent()<br></span><span style="color: #008080;">124</span> <span style="color: #000000;">                    , appContent.getStatus().getValue(), appContent.getUrl()};<br></span><span style="color: #008080;">125</span> <span style="color: #000000;">            database.execSQL(sql, bindArgs);<br></span><span style="color: #008080;">126</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">127</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">128</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">129</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;">130</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;">131</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">132</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">133</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">134</span><br><span style="color: #008080;">135</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">136</span> <span style="color: #008000;">      获取所有下载文件记录<br></span><span style="color: #008080;">137</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">138</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">139</span>     <span style="color: #0000ff;">public</span> List<appcontent><span style="color: #000000;"> getAll() {<br></span><span style="color: #008080;">140</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;">141</span>         List<appcontent> list = <span style="color: #0000ff;">new</span> ArrayList<appcontent><span style="color: #000000;">();<br></span><span style="color: #008080;">142</span>         Cursor cursor = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">143</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">144</span>             String sql = “select <em> from download_file”<span style="color: #000000;">;<br></span><span style="color: #008080;">145</span>             cursor = database.rawQuery(sql, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">146</span>             <span style="color: #0000ff;">while</span><span style="color: #000000;"> (cursor.moveToNext()) {<br></span><span style="color: #008080;">147</span>                 AppContent appContent = <span style="color: #0000ff;">new</span> AppContent(cursor.getString(1), cursor.getString(2<span style="color: #000000;">));<br></span><span style="color: #008080;">148</span>                 appContent.setDownloadPercent(cursor.getInt(3<span style="color: #000000;">));<br></span><span style="color: #008080;">149</span>                 appContent.setStatus(AppContent.Status.getByValue(cursor.getInt(4<span style="color: #000000;">)));<br></span><span style="color: #008080;">150</span> <span style="color: #000000;">                list.add(appContent);<br></span><span style="color: #008080;">151</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">152</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">153</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">154</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">155</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;">156</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;">157</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">158</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> cursor) {<br></span><span style="color: #008080;">159</span> <span style="color: #000000;">                cursor.close();<br></span><span style="color: #008080;">160</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">161</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">162</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> list;<br></span><span style="color: #008080;">163</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">164</span><br><span style="color: #008080;">165</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">166</span> <span style="color: #008000;">     </span></em> 根据url删除记录<br><span style="color: #008080;">167</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> url<br></span><span style="color: #008080;">168</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">169</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> delByUrl(String url) {<br></span><span style="color: #008080;">170</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(TextUtils.isEmpty(url)) {<br></span><span style="color: #008080;">171</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">172</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">173</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;">174</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">175</span>             String sql = “delete from download_file where url=?”<span style="color: #000000;">;<br></span><span style="color: #008080;">176</span>             Object[] bindArgs =<span style="color: #000000;"> { url };<br></span><span style="color: #008080;">177</span> <span style="color: #000000;">            database.execSQL(sql, bindArgs);<br></span><span style="color: #008080;">178</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">179</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">180</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">181</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;">182</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;">183</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">184</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">185</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">186</span><br><span style="color: #008080;">187</span> }</appcontent></appcontent></appcontent></pre><br></div>

<p>　　<span style="font-size: 15px;">5、DownloadInfoDAO，每个线程对应下载状态的数据库操作类</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.db;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.database.Cursor;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.database.sqlite.SQLiteDatabase;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.text.TextUtils;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.Log;<br></span><span style="color: #008080;">  8</span><br><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.beans.DownloadInfo;<br></span><span style="color: #008080;"> 10</span><br><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;"> 13</span><br><span style="color: #008080;"> 14</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 15</span> <span style="color: #008000;"> <em> @Class: DownloadInfoDAO<br></em></span><span style="color: #008080;"> 16</span> <span style="color: #008000;">  @Description: 每个单独线程下载信息记录的数据库操作类<br></span><span style="color: #008080;"> 17</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;">: lling(www.cnblogs.com/liuling)<br></span><span style="color: #008080;"> 18</span> <span style="color: #008000;">  @Date: 2015/10/13<br></span><span style="color: #008080;"> 19</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 20</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> DownloadInfoDAO {<br></span><span style="color: #008080;"> 21</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “DownloadInfoDAO”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> DownloadInfoDAO dao=<span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 23</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br></span><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;">  DownloadInfoDAO(Context context) {<br></span><span style="color: #008080;"> 25</span>         <span style="color: #0000ff;">this</span>.context=<span style="color: #000000;">context;<br></span><span style="color: #008080;"> 26</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 27</span><br><span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> DownloadInfoDAO getInstance(Context context){<br></span><span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">if</span>(dao==<span style="color: #0000ff;">null</span><span style="color: #000000;">){<br></span><span style="color: #008080;"> 30</span>             dao=<span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadInfoDAO(context);<br></span><span style="color: #008080;"> 31</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 32</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> dao;<br></span><span style="color: #008080;"> 33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 34</span><br><span style="color: #008080;"> 35</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 36</span> <span style="color: #008000;">     <em> 获取数据库连接<br></em></span><span style="color: #008080;"> 37</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 38</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> SQLiteDatabase getConnection() {<br></span><span style="color: #008080;"> 40</span>         SQLiteDatabase sqliteDatabase = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 41</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 42</span>             sqliteDatabase= <span style="color: #0000ff;">new</span><span style="color: #000000;"> DBHelper(context).getReadableDatabase();<br></span><span style="color: #008080;"> 43</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 44</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;"> 45</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> sqliteDatabase;<br></span><span style="color: #008080;"> 47</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 50</span> <span style="color: #008000;">      插入数据<br></span><span style="color: #008080;"> 51</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> downloadInfo<br></span><span style="color: #008080;"> 52</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 53</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> insertDownloadInfo(DownloadInfo downloadInfo) {<br></span><span style="color: #008080;"> 54</span>         <span style="color: #0000ff;">if</span>(downloadInfo == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 55</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 56</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 57</span>         <span style="color: #008000;">//</span><span style="color: #008000;">如果本地已经存在，直接修改</span><br><span style="color: #008080;"> 58</span>         <span style="color: #0000ff;">if</span>(getDownloadInfoByTaskIdAndUrl(downloadInfo.getTaskId(), downloadInfo.getUrl()) != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 59</span> <span style="color: #000000;">            updateDownloadInfo(downloadInfo);<br></span><span style="color: #008080;"> 60</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 62</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;"> 63</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 64</span>             String sql = “insert into download_info(task_id, download_length, url, is_success) values (?,?,?,?)”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 65</span>             Object[] bindArgs =<span style="color: #000000;"> { downloadInfo.getTaskId(), downloadInfo.getDownloadLength(),<br></span><span style="color: #008080;"> 66</span> <span style="color: #000000;">                    downloadInfo.getUrl(), downloadInfo.isDownloadSuccess()};<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">            database.execSQL(sql, bindArgs);<br></span><span style="color: #008080;"> 68</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 69</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;"> 70</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 71</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;"> 72</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;"> 73</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 74</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 75</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 76</span><br><span style="color: #008080;"> 77</span>     <span style="color: #0000ff;">public</span> List<downloadinfo><span style="color: #000000;"> getDownloadInfosByUrl(String url) {<br></span><span style="color: #008080;"> 78</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(TextUtils.isEmpty(url)) {<br></span><span style="color: #008080;"> 79</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 80</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 81</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;"> 82</span>         List<downloadinfo> list = <span style="color: #0000ff;">new</span> ArrayList<downloadinfo><span style="color: #000000;">();<br></span><span style="color: #008080;"> 83</span>         Cursor cursor = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 84</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 85</span>             String sql = “select <em> from download_info where url=?”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 86</span>             cursor = database.rawQuery(sql, <span style="color: #0000ff;">new</span><span style="color: #000000;"> String[] { url });<br></span><span style="color: #008080;"> 87</span>             <span style="color: #0000ff;">while</span><span style="color: #000000;"> (cursor.moveToNext()) {<br></span><span style="color: #008080;"> 88</span>                 DownloadInfo info = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadInfo();<br></span><span style="color: #008080;"> 89</span>                 info.setTaskId(cursor.getInt(1<span style="color: #000000;">));<br></span><span style="color: #008080;"> 90</span>                 info.setDownloadLength(cursor.getLong(2<span style="color: #000000;">));<br></span><span style="color: #008080;"> 91</span>                 info.setDownloadSuccess(cursor.getInt(4<span style="color: #000000;">));<br></span><span style="color: #008080;"> 92</span>                 info.setUrl(cursor.getString(3<span style="color: #000000;">));<br></span><span style="color: #008080;"> 93</span> <span style="color: #000000;">                list.add(info);<br></span><span style="color: #008080;"> 94</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 95</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 96</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;"> 97</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 98</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;"> 99</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;">100</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">101</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> cursor) {<br></span><span style="color: #008080;">102</span> <span style="color: #000000;">                cursor.close();<br></span><span style="color: #008080;">103</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">105</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> list;<br></span><span style="color: #008080;">106</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">107</span><br><span style="color: #008080;">108</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">109</span> <span style="color: #008000;">     </span></em> 根据taskid和url获取下载信息<br><span style="color: #008080;">110</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> taskId<br></span><span style="color: #008080;">111</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> url<br></span><span style="color: #008080;">112</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">113</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">114</span>     <span style="color: #0000ff;">public</span> DownloadInfo getDownloadInfoByTaskIdAndUrl(<span style="color: #0000ff;">int</span><span style="color: #000000;"> taskId, String url) {<br></span><span style="color: #008080;">115</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(TextUtils.isEmpty(url)) {<br></span><span style="color: #008080;">116</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">117</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">118</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;">119</span>         DownloadInfo info = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">120</span>         Cursor cursor = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">121</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">122</span>             String sql = “select <em> from download_info where url=? and task_id=?”<span style="color: #000000;">;<br></span><span style="color: #008080;">123</span>             cursor = database.rawQuery(sql, <span style="color: #0000ff;">new</span><span style="color: #000000;"> String[] { url, String.valueOf(taskId) });<br></span><span style="color: #008080;">124</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (cursor.moveToNext()) {<br></span><span style="color: #008080;">125</span>                 info = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadInfo();<br></span><span style="color: #008080;">126</span>                 info.setTaskId(cursor.getInt(1<span style="color: #000000;">));<br></span><span style="color: #008080;">127</span>                 info.setDownloadLength(cursor.getLong(2<span style="color: #000000;">));<br></span><span style="color: #008080;">128</span>                 info.setDownloadSuccess(cursor.getInt(4<span style="color: #000000;">));<br></span><span style="color: #008080;">129</span>                 info.setUrl(cursor.getString(3<span style="color: #000000;">));<br></span><span style="color: #008080;">130</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">131</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">132</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">133</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">134</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;">135</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;">136</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">137</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> cursor) {<br></span><span style="color: #008080;">138</span> <span style="color: #000000;">                cursor.close();<br></span><span style="color: #008080;">139</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">140</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">141</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> info;<br></span><span style="color: #008080;">142</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">143</span><br><span style="color: #008080;">144</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">145</span> <span style="color: #008000;">     </span></em> 更新下载信息<br><span style="color: #008080;">146</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> downloadInfo<br></span><span style="color: #008080;">147</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">148</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> updateDownloadInfo(DownloadInfo downloadInfo) {<br></span><span style="color: #008080;">149</span>         <span style="color: #0000ff;">if</span>(downloadInfo == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">150</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">151</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">152</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;">153</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">154</span>             String sql = “update download_info set download_length=?, is_success=? where task_id=? and url=?”<span style="color: #000000;">;<br></span><span style="color: #008080;">155</span>             Object[] bindArgs =<span style="color: #000000;"> { downloadInfo.getDownloadLength(), downloadInfo.isDownloadSuccess(),<br></span><span style="color: #008080;">156</span> <span style="color: #000000;">                    downloadInfo.getTaskId(), downloadInfo.getUrl() };<br></span><span style="color: #008080;">157</span> <span style="color: #000000;">            database.execSQL(sql, bindArgs);<br></span><span style="color: #008080;">158</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">159</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">160</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">161</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;">162</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;">163</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">164</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">165</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">166</span><br><span style="color: #008080;">167</span> }</downloadinfo></downloadinfo></downloadinfo></pre><br></div>

<p>　　<span style="font-size: 15px;">具体的界面和使用代码我就不贴代码了，代码有点多。需要的可以下载Demo的源码看看。</span></p>
<p><span style="font-size: 15px;">　　因为还没有花太多时间去测，里面难免会有些bug，如果大家发现什么问题，欢迎留言探讨，谢谢！</span></p>
<p><span style="color: #ff0000;"><strong>源码下载：</strong><a href="https://github.com/liuling07/MultiTaskAndThreadDownload" title="https://github.com/liuling07/MultiTaskAndThreadDownload" target="_blank" rel="external"><span style="color: #000000;">https://github.com/liuling07/MultiTaskAndThreadDownload</span></a></span></p>
<p>&nbsp;</p>
<p>原创内容，转载请注明出处：<a href="http://www.cnblogs.com/liuling/p/2015-10-16-01.html" title="http://www.cnblogs.com/liuling/p/2015-10-16-01.html" target="_blank" rel="external">http://www.cnblogs.com/liuling/p/2015-10-16-01.html</a></p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://www.liuling123.com/2015/10/asynctask-multi-task-thread.html" data-id="cipzhfvhg00f2jvd0h1dc4uif" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://www.liuling123.com/2015/10/asynctask-multi-task-thread.html#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://www.liuling123.com/2015/10/asynctask-multi-task-thread.html">评论</a>
    

        </footer>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2015/10/listview-partial-refresh.html" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">上一篇</strong>
            <div class="article-nav-title">
                
                    ListView实现Item局部刷新
                
            </div>
        </a>
    
    
        <a href="/2015/10/customview-download-percent.html" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">下一篇</strong>
            <div class="article-nav-title">Android中使用自定义View实现下载进度的显示</div>
        </a>
    
</nav>


    
</article>


    
    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>

</section>
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">最新博文</h3>
        <div class="widget">
            <ul id="recent-post" class="no-thumbnail">
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Linux/">Linux</a></p>
                            <p class="item-title"><a href="/2016/06/ubuntu-adb-devices.html" class="title">Ubuntu下adb无法识别手机设备</a></p>
                            <p class="item-date"><time datetime="2016-06-21T13:14:00.000Z" itemprop="datePublished">2016-06-21</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/JNI-amp-NDK/">JNI&amp;NDK</a></p>
                            <p class="item-title"><a href="/2016/06/jni-type-change.html" class="title">JNI与C/C++数据类型的转换</a></p>
                            <p class="item-date"><time datetime="2016-06-21T12:52:00.000Z" itemprop="datePublished">2016-06-21</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/JNI-amp-NDK/">JNI&amp;NDK</a></p>
                            <p class="item-title"><a href="/2016/06/ndk-stack.html" class="title">JNI崩溃问题定位</a></p>
                            <p class="item-date"><time datetime="2016-06-20T13:37:00.000Z" itemprop="datePublished">2016-06-20</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Kotlin/">Kotlin</a></p>
                            <p class="item-title"><a href="/2016/06/android_studio_kotlin.html" class="title">初次尝试Kotlin</a></p>
                            <p class="item-date"><time datetime="2016-06-13T14:27:00.000Z" itemprop="datePublished">2016-06-13</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/JNI-amp-NDK/">JNI&amp;NDK</a></p>
                            <p class="item-title"><a href="/2016/06/so_method_mix.html" class="title">so库中JNI方法混淆</a></p>
                            <p class="item-date"><time datetime="2016-06-02T14:51:00.000Z" itemprop="datePublished">2016-06-02</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">博文分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Framework/">Framework</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hadoop/">Hadoop</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JNI-amp-NDK/">JNI&amp;NDK</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a><span class="category-list-count">35</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kotlin/">Kotlin</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NoSQL/">NoSQL</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/人生感悟/">人生感悟</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他技术/">其他技术</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后端/">后端</a><span class="category-list-count">29</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构和算法/">数据结构和算法</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">7</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/AsyncTask/" style="font-size: 11.54px;">AsyncTask</a> <a href="/tags/EventBus/" style="font-size: 10.77px;">EventBus</a> <a href="/tags/Kotlin/" style="font-size: 10px;">Kotlin</a> <a href="/tags/LruCache/" style="font-size: 10px;">LruCache</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/NDK/" style="font-size: 11.54px;">NDK</a> <a href="/tags/NoSQL/" style="font-size: 13.08px;">NoSQL</a> <a href="/tags/android/" style="font-size: 19.23px;">android</a> <a href="/tags/android-studio/" style="font-size: 10px;">android studio</a> <a href="/tags/c/" style="font-size: 10px;">c++</a> <a href="/tags/camera/" style="font-size: 10px;">camera</a> <a href="/tags/framework/" style="font-size: 10.77px;">framework</a> <a href="/tags/hadoop/" style="font-size: 14.62px;">hadoop</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/jni/" style="font-size: 16.15px;">jni</a> <a href="/tags/linux/" style="font-size: 16.15px;">linux</a> <a href="/tags/mysql/" style="font-size: 11.54px;">mysql</a> <a href="/tags/redis/" style="font-size: 13.08px;">redis</a> <a href="/tags/spring/" style="font-size: 10.77px;">spring</a> <a href="/tags/sqlite/" style="font-size: 10px;">sqlite</a> <a href="/tags/web后端/" style="font-size: 18.46px;">web后端</a> <a href="/tags/内存缓存/" style="font-size: 10px;">内存缓存</a> <a href="/tags/前端/" style="font-size: 13.85px;">前端</a> <a href="/tags/反射/" style="font-size: 10px;">反射</a> <a href="/tags/反编译/" style="font-size: 10px;">反编译</a> <a href="/tags/图片选择/" style="font-size: 10.77px;">图片选择</a> <a href="/tags/多线程/" style="font-size: 17.69px;">多线程</a> <a href="/tags/布局/" style="font-size: 12.31px;">布局</a> <a href="/tags/布局优化/" style="font-size: 10.77px;">布局优化</a> <a href="/tags/开源/" style="font-size: 10.77px;">开源</a> <a href="/tags/断点续传/" style="font-size: 11.54px;">断点续传</a> <a href="/tags/科学上网/" style="font-size: 10px;">科学上网</a> <a href="/tags/自定义控件/" style="font-size: 10px;">自定义控件</a> <a href="/tags/解决方案/" style="font-size: 16.92px;">解决方案</a> <a href="/tags/设计模式/" style="font-size: 15.38px;">设计模式</a> <a href="/tags/译文/" style="font-size: 11.54px;">译文</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">友情链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://blog.daimajia.com">代码家</a>
                    </li>
                
                    <li>
                        <a href="http://www.trinea.cn">Trinea</a>
                    </li>
                
                    <li>
                        <a href="https://www.aswifter.com">APP开发者</a>
                    </li>
                
                    <li>
                        <a href="http://blog.seoui.com">笑松小站</a>
                    </li>
                
                    <li>
                        <a href="http://www.apkfuns.com">舞影凌风</a>
                    </li>
                
                    <li>
                        <a href="http://www.ttfde.org">TTF的家园</a>
                    </li>
                
                    <li>
                        <a href="http://rocko.xyz">Rocko&#39;s blog</a>
                    </li>
                
                    <li>
                        <a href="http://www.lcode.org">江清清技术专栏</a>
                    </li>
                
                    <li>
                        <a href="http://www.deanhan.cn">逐梦博客</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2016 Lauren<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
             &nbsp;粤ICP备15082212号-2 &nbsp;
			<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1256697778'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1256697778%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_config = function () {
        
            this.page.url = 'http://www.liuling123.com/2015/10/asynctask-multi-task-thread.html';
        
        this.page.identifier = 'asynctask-multi-task-thread';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + '＃hexo-theme-icarus' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>



    
        <script src="/vendor/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js" type="text/javascript"></script>

    </div>
</body>
</html>