<!DOCTYPE html>
<html lang=zh>
<head>
    <meta charset="utf-8">
    
    <title>Android自定义相机拍照、图片裁剪的实现 | 残剑博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="最近项目里面又要加一个拍照搜题的功能，也就是用户对着不会做的题目拍一张照片，将照片的文字使用ocr识别出来，再调用题库搜索接口搜索出来展示给用户，类似于小猿搜题、学霸君等app。
　　其实Android提供Intent让我们打开系统的相机，但是系统相机跟自己app风格不搭，而且用起来体验不好。所以我使用了SDK提供的camera API自定义了一个相机，并且在相机界面上面添加了参考线，有助于用户将">
<meta property="og:type" content="article">
<meta property="og:title" content="Android自定义相机拍照、图片裁剪的实现">
<meta property="og:url" content="http://www.liuling123.com/2015/10/custom-camera.html">
<meta property="og:site_name" content="残剑博客">
<meta property="og:description" content="最近项目里面又要加一个拍照搜题的功能，也就是用户对着不会做的题目拍一张照片，将照片的文字使用ocr识别出来，再调用题库搜索接口搜索出来展示给用户，类似于小猿搜题、学霸君等app。
　　其实Android提供Intent让我们打开系统的相机，但是系统相机跟自己app风格不搭，而且用起来体验不好。所以我使用了SDK提供的camera API自定义了一个相机，并且在相机界面上面添加了参考线，有助于用户将">
<meta property="og:image" content="http://www.liuling123.com/wp-content/uploads/2015/11/420264-20151028225216372-729805796.png">
<meta property="og:updated_time" content="2016-01-03T07:09:29.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android自定义相机拍照、图片裁剪的实现">
<meta name="twitter:description" content="最近项目里面又要加一个拍照搜题的功能，也就是用户对着不会做的题目拍一张照片，将照片的文字使用ocr识别出来，再调用题库搜索接口搜索出来展示给用户，类似于小猿搜题、学霸君等app。
　　其实Android提供Intent让我们打开系统的相机，但是系统相机跟自己app风格不搭，而且用起来体验不好。所以我使用了SDK提供的camera API自定义了一个相机，并且在相机界面上面添加了参考线，有助于用户将">
    

    

    

    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/vendor/open-sans/styles.css" type="text/css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css" type="text/css">

    <link rel="stylesheet" href="/css/style.css" type="text/css">

    <script src="/vendor/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
    
    
        <link rel="stylesheet" href="/vendor/fancybox/jquery.fancybox.css" type="text/css">
    
    
    
    

</head>
<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">残剑博客</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/categories">Categories</a>
                
                    <a class="main-nav-link" href="/tags">Tags</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/protrait.jpg" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js" type="text/javascript"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/categories">Categories</a></td>
                
                    <td><a class="main-nav-link" href="/tags">Tags</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/protrait.jpg" />
            <h2 id="name">Lauren</h2>
            <h3 id="title">Android Developer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Shenzhen, China</span>
            <a id="follow" target="_blank" href="https://github.com/liuling07">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                149
                <span>文章</span>
            </div>
            <div class="article-info-block">
                38
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/liuling07" target="_blank" title="github" >
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="http://weibo.com/LaurenLiuling/" target="_blank" title="weibo" >
                            <i class="fa fa-weibo"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://plus.google.com/u/0/107098505138563589748/" target="_blank" title="google-plus" >
                            <i class="fa fa-google-plus"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="http://stackoverflow.com/users/5629327/lauren-liuling" target="_blank" title="stack-overflow" >
                            <i class="fa fa-stack-overflow"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://twitter.com/lauren_liuLing/" target="_blank" title="twitter" >
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://www.facebook.com/lauren.liuling/" target="_blank" title="facebook" >
                            <i class="fa fa-facebook"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/atom.xml" target="_blank" title="rss" >
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main"><article id="post-custom-camera" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            Android自定义相机拍照、图片裁剪的实现
        </h1>
    

                <div class="article-meta">
                    
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2015/10/custom-camera.html">
            <time datetime="2015-10-28T07:00:00.000Z" itemprop="datePublished">2015-10-28</time>
        </a>
    </div>


                    
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>

                    
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/android/">android</a>, <a class="tag-link" href="/tags/camera/">camera</a>
    </div>

                </div>
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>　　<span style="font-size: 15px;">最近项目里面又要加一个拍照搜题的功能，也就是用户对着不会做的题目拍一张照片，将照片的文字使用ocr识别出来，再调用题库搜索接口搜索出来展示给用户，类似于小猿搜题、学霸君等app。<br></span></p>
<p>　　<span style="font-size: 15px;">其实Android提供Intent让我们打开系统的相机，但是系统相机跟自己app风格不搭，而且用起来体验不好。所以我使用了SDK提供的camera API自定义了一个相机，并且在相机界面上面添加了参考线，有助于用户将题目拍正，提高ocr的识别率。</span><br><a id="more"></a><br><span style="font-size: 15px;">　　1、绘制参考线的代码</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> ReferenceLine <span style="color: #0000ff;">extends</span><span style="color: #000000;"> View {<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Paint mLinePaint;<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ReferenceLine(Context context) {<br></span><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">        init();<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ReferenceLine(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">        init();<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">public</span> ReferenceLine(Context context, AttributeSet attrs, <span style="color: #0000ff;">int</span><span style="color: #000000;"> defStyleAttr) {<br></span><span style="color: #008080;">16</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs, defStyleAttr);<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">        init();<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> init() {<br></span><span style="color: #008080;">21</span>         mLinePaint = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Paint();<br></span><span style="color: #008080;">22</span>         mLinePaint.setAntiAlias(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">23</span>         mLinePaint.setColor(Color.parseColor(“#45e0e0e0”<span style="color: #000000;">));<br></span><span style="color: #008080;">24</span>         mLinePaint.setStrokeWidth(1<span style="color: #000000;">);<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span><br><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">30</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDraw(Canvas canvas) {<br></span><span style="color: #008080;">31</span>         <span style="color: #0000ff;">int</span> screenWidth =<span style="color: #000000;"> Utils.getScreenWH(getContext()).widthPixels;<br></span><span style="color: #008080;">32</span>         <span style="color: #0000ff;">int</span> screenHeight =<span style="color: #000000;"> Utils.getScreenWH(getContext()).heightPixels;<br></span><span style="color: #008080;">33</span><br><span style="color: #008080;">34</span>         <span style="color: #0000ff;">int</span> width = screenWidth/3<span style="color: #000000;">;<br></span><span style="color: #008080;">35</span>         <span style="color: #0000ff;">int</span> height = screenHeight/3<span style="color: #000000;">;<br></span><span style="color: #008080;">36</span><br><span style="color: #008080;">37</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = width, j = 0;i &lt; screenWidth &amp;&amp; j<2;i +="width," j++<span="" style="color: #000000;">) {<br><span style="color: #008080;">38</span>             canvas.drawLine(i, 0<span style="color: #000000;">, i, screenHeight, mLinePaint);<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">40</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> j = height,i = 0;j &lt; screenHeight &amp;&amp; i &lt; 2;j += height,i++<span style="color: #000000;">) {<br></span><span style="color: #008080;">41</span>             canvas.drawLine(0<span style="color: #000000;">, j, screenWidth, j, mLinePaint);<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">44</span><br><span style="color: #008080;">45</span><br><span style="color: #008080;">46</span> }</2;i></pre><br></div>

<p>&nbsp;</p>
<p>　　<span style="font-size: 15px;">2、自定义相机代码</span></p>
<p><span style="font-size: 15px;">　　这里主要是要创建一个SurfaceView，将摄像头的预览界面放到SurfaceView中显示。</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.camerademo.camare;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.res.Configuration;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.graphics.PixelFormat;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.graphics.Rect;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.hardware.Camera;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.hardware.Camera.AutoFocusCallback;<br></span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.hardware.Camera.PictureCallback;<br></span><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.AttributeSet;<br></span><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.Log;<br></span><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.MotionEvent;<br></span><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.SurfaceHolder;<br></span><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.SurfaceView;<br></span><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.RelativeLayout;<br></span><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.Toast;<br></span><span style="color: #008080;"> 18</span><br><span style="color: #008080;"> 19</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.camerademo.utils.Utils;<br></span><span style="color: #008080;"> 20</span><br><span style="color: #008080;"> 21</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.IOException;<br></span><span style="color: #008080;"> 22</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;"> 23</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Date;<br></span><span style="color: #008080;"> 24</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;"> 25</span><br><span style="color: #008080;"> 26</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 27</span> <span style="color: #008000;"> <em> @Class: CameraPreview<br></em></span><span style="color: #008080;"> 28</span> <span style="color: #008000;">  @Description: 自定义相机<br></span><span style="color: #008080;"> 29</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;">: lling(www.cnblogs.com/liuling)<br></span><span style="color: #008080;"> 30</span> <span style="color: #008000;">  @Date: 2015/10/25<br></span><span style="color: #008080;"> 31</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 32</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> CameraPreview <span style="color: #0000ff;">extends</span> SurfaceView <span style="color: #0000ff;">implements</span><br><span style="color: #008080;"> 33</span> <span style="color: #000000;">        SurfaceHolder.Callback, AutoFocusCallback {<br></span><span style="color: #008080;"> 34</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “CameraPreview”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 35</span><br><span style="color: #008080;"> 36</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> viewWidth = 0<span style="color: #000000;">;<br></span><span style="color: #008080;"> 37</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> viewHeight = 0<span style="color: #000000;">;<br></span><span style="color: #008080;"> 38</span><br><span style="color: #008080;"> 39</span>     <span style="color: #008000;">/</span><span style="color: #008000;"> 监听接口 </span><span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 40</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> OnCameraStatusListener listener;<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> SurfaceHolder holder;<br></span><span style="color: #008080;"> 43</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Camera camera;<br></span><span style="color: #008080;"> 44</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> FocusView mFocusView;<br></span><span style="color: #008080;"> 45</span><br><span style="color: #008080;"> 46</span>     <span style="color: #008000;">//</span><span style="color: #008000;">创建一个PictureCallback对象，并实现其中的onPictureTaken方法</span><br><span style="color: #008080;"> 47</span>     <span style="color: #0000ff;">private</span> PictureCallback pictureCallback = <span style="color: #0000ff;">new</span><span style="color: #000000;"> PictureCallback() {<br></span><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 该方法用于处理拍摄后的照片数据</span><br><span style="color: #008080;"> 50</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;"> 51</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onPictureTaken(<span style="color: #0000ff;">byte</span><span style="color: #000000;">[] data, Camera camera) {<br></span><span style="color: #008080;"> 52</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 停止照片拍摄</span><br><span style="color: #008080;"> 53</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 54</span> <span style="color: #000000;">                camera.stopPreview();<br></span><span style="color: #008080;"> 55</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 56</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 57</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 调用结束事件</span><br><span style="color: #008080;"> 58</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> listener) {<br></span><span style="color: #008080;"> 59</span> <span style="color: #000000;">                listener.onCameraStopped(data);<br></span><span style="color: #008080;"> 60</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 62</span> <span style="color: #000000;">    };<br></span><span style="color: #008080;"> 63</span><br><span style="color: #008080;"> 64</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> Preview类的构造方法</span><br><span style="color: #008080;"> 65</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> CameraPreview(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;"> 66</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);<br></span><span style="color: #008080;"> 67</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获得SurfaceHolder对象</span><br><span style="color: #008080;"> 68</span>         holder =<span style="color: #000000;"> getHolder();<br></span><span style="color: #008080;"> 69</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 指定用于捕捉拍照事件的SurfaceHolder.Callback对象</span><br><span style="color: #008080;"> 70</span>         holder.addCallback(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 71</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置SurfaceHolder对象的类型</span><br><span style="color: #008080;"> 72</span> <span style="color: #000000;">        holder.setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS);<br></span><span style="color: #008080;"> 73</span> <span style="color: #000000;">        setOnTouchListener(onTouchListener);<br></span><span style="color: #008080;"> 74</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 75</span><br><span style="color: #008080;"> 76</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 在surface创建时激发</span><br><span style="color: #008080;"> 77</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> surfaceCreated(SurfaceHolder holder) {<br></span><span style="color: #008080;"> 78</span>         Log.e(TAG, “==surfaceCreated==”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 79</span>         <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">Utils.checkCameraHardware(getContext())) {<br></span><span style="color: #008080;"> 80</span>             Toast.makeText(getContext(), “摄像头打开失败！”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;"> 81</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 82</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 83</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获得Camera对象</span><br><span style="color: #008080;"> 84</span>         camera =<span style="color: #000000;"> getCameraInstance();<br></span><span style="color: #008080;"> 85</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 86</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 设置用于显示拍照摄像的SurfaceHolder对象</span><br><span style="color: #008080;"> 87</span> <span style="color: #000000;">            camera.setPreviewDisplay(holder);<br></span><span style="color: #008080;"> 88</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;"> 89</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;"> 90</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 释放手机摄像头</span><br><span style="color: #008080;"> 91</span> <span style="color: #000000;">            camera.release();<br></span><span style="color: #008080;"> 92</span>             camera = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 93</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 94</span> <span style="color: #000000;">        updateCameraParameters();<br></span><span style="color: #008080;"> 95</span>         <span style="color: #0000ff;">if</span> (camera != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 96</span> <span style="color: #000000;">            camera.startPreview();<br></span><span style="color: #008080;"> 97</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 98</span> <span style="color: #000000;">        setFocus();<br></span><span style="color: #008080;"> 99</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">100</span><br><span style="color: #008080;">101</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 在surface销毁时激发</span><br><span style="color: #008080;">102</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> surfaceDestroyed(SurfaceHolder holder) {<br></span><span style="color: #008080;">103</span>         Log.e(TAG, “==surfaceDestroyed==”<span style="color: #000000;">);<br></span><span style="color: #008080;">104</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 释放手机摄像头</span><br><span style="color: #008080;">105</span> <span style="color: #000000;">        camera.release();<br></span><span style="color: #008080;">106</span>         camera = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">107</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">108</span><br><span style="color: #008080;">109</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 在surface的大小发生改变时激发</span><br><span style="color: #008080;">110</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> surfaceChanged(<span style="color: #0000ff;">final</span> SurfaceHolder holder, <span style="color: #0000ff;">int</span> format, <span style="color: #0000ff;">int</span><span style="color: #000000;"> w,<br></span><span style="color: #008080;">111</span>             <span style="color: #0000ff;">int</span><span style="color: #000000;"> h) {<br></span><span style="color: #008080;">112</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> stop preview before making changes</span><br><span style="color: #008080;">113</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">114</span> <span style="color: #000000;">            camera.stopPreview();<br></span><span style="color: #008080;">115</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e){<br></span><span style="color: #008080;">116</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> ignore: tried to stop a non-existent preview</span><br><span style="color: #008080;">117</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">118</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> set preview size and make any resize, rotate or<br></span><span style="color: #008080;">119</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> reformatting changes here</span><br><span style="color: #008080;">120</span> <span style="color: #000000;">        updateCameraParameters();<br></span><span style="color: #008080;">121</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> start preview with new settings</span><br><span style="color: #008080;">122</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">123</span> <span style="color: #000000;">            camera.setPreviewDisplay(holder);<br></span><span style="color: #008080;">124</span> <span style="color: #000000;">            camera.startPreview();<br></span><span style="color: #008080;">125</span><br><span style="color: #008080;">126</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e){<br></span><span style="color: #008080;">127</span>             Log.d(TAG, “Error starting camera preview: “ +<span style="color: #000000;"> e.getMessage());<br></span><span style="color: #008080;">128</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">129</span> <span style="color: #000000;">        setFocus();<br></span><span style="color: #008080;">130</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">131</span><br><span style="color: #008080;">132</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">133</span> <span style="color: #008000;">      点击显示焦点区域<br></span><span style="color: #008080;">134</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">135</span>     OnTouchListener onTouchListener = <span style="color: #0000ff;">new</span><span style="color: #000000;"> OnTouchListener() {<br></span><span style="color: #008080;">136</span>         @SuppressWarnings(“deprecation”<span style="color: #000000;">)<br></span><span style="color: #008080;">137</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">138</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onTouch(View v, MotionEvent event) {<br></span><span style="color: #008080;">139</span>             <span style="color: #0000ff;">if</span> (event.getAction() ==<span style="color: #000000;"> MotionEvent.ACTION_DOWN) {<br></span><span style="color: #008080;">140</span>                 <span style="color: #0000ff;">int</span> width =<span style="color: #000000;"> mFocusView.getWidth();<br></span><span style="color: #008080;">141</span>                 <span style="color: #0000ff;">int</span> height =<span style="color: #000000;"> mFocusView.getHeight();<br></span><span style="color: #008080;">142</span>                 mFocusView.setX(event.getX() - (width / 2<span style="color: #000000;">));<br></span><span style="color: #008080;">143</span>                 mFocusView.setY(event.getY() - (height / 2<span style="color: #000000;">));<br></span><span style="color: #008080;">144</span> <span style="color: #000000;">                mFocusView.beginFocus();<br></span><span style="color: #008080;">145</span>             } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (event.getAction() ==<span style="color: #000000;"> MotionEvent.ACTION_UP) {<br></span><span style="color: #008080;">146</span> <span style="color: #000000;">                focusOnTouch(event);<br></span><span style="color: #008080;">147</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">148</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">149</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">150</span> <span style="color: #000000;">    };<br></span><span style="color: #008080;">151</span><br><span style="color: #008080;">152</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">153</span> <span style="color: #008000;">      获取摄像头实例<br></span><span style="color: #008080;">154</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">155</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">156</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Camera getCameraInstance() {<br></span><span style="color: #008080;">157</span>         Camera c = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">158</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">159</span>             <span style="color: #0000ff;">int</span> cameraCount = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">160</span>             Camera.CameraInfo cameraInfo = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Camera.CameraInfo();<br></span><span style="color: #008080;">161</span>             cameraCount = Camera.getNumberOfCameras(); <span style="color: #008000;">//</span><span style="color: #008000;"> get cameras number</span><br><span style="color: #008080;">162</span><br><span style="color: #008080;">163</span>             <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> camIdx = 0; camIdx &lt; cameraCount; camIdx++<span style="color: #000000;">) {<br></span><span style="color: #008080;">164</span>                 Camera.getCameraInfo(camIdx, cameraInfo); <span style="color: #008000;">//</span><span style="color: #008000;"> get camerainfo<br></span><span style="color: #008080;">165</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 代表摄像头的方位，目前有定义值两个分别为CAMERA_FACING_FRONT前置和CAMERA_FACING_BACK后置</span><br><span style="color: #008080;">166</span>                 <span style="color: #0000ff;">if</span> (cameraInfo.facing ==<span style="color: #000000;"> Camera.CameraInfo.CAMERA_FACING_BACK) {<br></span><span style="color: #008080;">167</span>                     <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">168</span>                         c = Camera.open(camIdx);   <span style="color: #008000;">//</span><span style="color: #008000;">打开后置摄像头</span><br><span style="color: #008080;">169</span>                     } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (RuntimeException e) {<br></span><span style="color: #008080;">170</span>                         Toast.makeText(getContext(), “摄像头打开失败！”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">171</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">172</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">173</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">174</span>             <span style="color: #0000ff;">if</span> (c == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">175</span>                 c = Camera.open(0); <span style="color: #008000;">//</span><span style="color: #008000;"> attempt to get a Camera instance</span><br><span style="color: #008080;">176</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">177</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">178</span>             Toast.makeText(getContext(), “摄像头打开失败！”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">179</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">180</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> c;<br></span><span style="color: #008080;">181</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">182</span><br><span style="color: #008080;">183</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> updateCameraParameters() {<br></span><span style="color: #008080;">184</span>         <span style="color: #0000ff;">if</span> (camera != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">185</span>             Camera.Parameters p =<span style="color: #000000;"> camera.getParameters();<br></span><span style="color: #008080;">186</span><br><span style="color: #008080;">187</span> <span style="color: #000000;">            setParameters(p);<br></span><span style="color: #008080;">188</span><br><span style="color: #008080;">189</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">190</span> <span style="color: #000000;">                camera.setParameters(p);<br></span><span style="color: #008080;">191</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">192</span>                 Camera.Size previewSize =<span style="color: #000000;"> findBestPreviewSize(p);<br></span><span style="color: #008080;">193</span> <span style="color: #000000;">                p.setPreviewSize(previewSize.width, previewSize.height);<br></span><span style="color: #008080;">194</span> <span style="color: #000000;">                p.setPictureSize(previewSize.width, previewSize.height);<br></span><span style="color: #008080;">195</span> <span style="color: #000000;">                camera.setParameters(p);<br></span><span style="color: #008080;">196</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">197</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">198</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">199</span><br><span style="color: #008080;">200</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">201</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> p<br></span><span style="color: #008080;">202</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">203</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setParameters(Camera.Parameters p) {<br></span><span style="color: #008080;">204</span>         List<string> focusModes =<span style="color: #000000;"> p.getSupportedFocusModes();<br></span><span style="color: #008080;">205</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (focusModes<br></span><span style="color: #008080;">206</span> <span style="color: #000000;">                .contains(Camera.Parameters.FOCUS_MODE_CONTINUOUS_PICTURE)) {<br></span><span style="color: #008080;">207</span> <span style="color: #000000;">            p.setFocusMode(Camera.Parameters.FOCUS_MODE_CONTINUOUS_PICTURE);<br></span><span style="color: #008080;">208</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">209</span><br><span style="color: #008080;">210</span>         <span style="color: #0000ff;">long</span> time = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Date().getTime();<br></span><span style="color: #008080;">211</span> <span style="color: #000000;">        p.setGpsTimestamp(time);<br></span><span style="color: #008080;">212</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置照片格式</span><br><span style="color: #008080;">213</span> <span style="color: #000000;">        p.setPictureFormat(PixelFormat.JPEG);<br></span><span style="color: #008080;">214</span>         Camera.Size previewSize =<span style="color: #000000;"> findPreviewSizeByScreen(p);<br></span><span style="color: #008080;">215</span> <span style="color: #000000;">        p.setPreviewSize(previewSize.width, previewSize.height);<br></span><span style="color: #008080;">216</span> <span style="color: #000000;">        p.setPictureSize(previewSize.width, previewSize.height);<br></span><span style="color: #008080;">217</span> <span style="color: #000000;">        p.setFocusMode(Camera.Parameters.FOCUS_MODE_AUTO);<br></span><span style="color: #008080;">218</span>         <span style="color: #0000ff;">if</span> (getContext().getResources().getConfiguration().orientation !=<span style="color: #000000;"> Configuration.ORIENTATION_LANDSCAPE) {<br></span><span style="color: #008080;">219</span>             camera.setDisplayOrientation(90<span style="color: #000000;">);<br></span><span style="color: #008080;">220</span>             p.setRotation(90<span style="color: #000000;">);<br></span><span style="color: #008080;">221</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">222</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">223</span><br><span style="color: #008080;">224</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 进行拍照，并将拍摄的照片传入PictureCallback接口的onPictureTaken方法</span><br><span style="color: #008080;">225</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> takePicture() {<br></span><span style="color: #008080;">226</span>         <span style="color: #0000ff;">if</span> (camera != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">227</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">228</span>                 camera.takePicture(<span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span><span style="color: #000000;">, pictureCallback);<br></span><span style="color: #008080;">229</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">230</span> <span style="color: #000000;">                e.printStackTrace();<br></span><span style="color: #008080;">231</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">232</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">233</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">234</span><br><span style="color: #008080;">235</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 设置监听事件</span><br><span style="color: #008080;">236</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnCameraStatusListener(OnCameraStatusListener listener) {<br></span><span style="color: #008080;">237</span>         <span style="color: #0000ff;">this</span>.listener =<span style="color: #000000;"> listener;<br></span><span style="color: #008080;">238</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">239</span><br><span style="color: #008080;">240</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">241</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onAutoFocus(<span style="color: #0000ff;">boolean</span><span style="color: #000000;"> success, Camera camera) {<br></span><span style="color: #008080;">242</span><br><span style="color: #008080;">243</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">244</span><br><span style="color: #008080;">245</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> start() {<br></span><span style="color: #008080;">246</span>         <span style="color: #0000ff;">if</span> (camera != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">247</span> <span style="color: #000000;">            camera.startPreview();<br></span><span style="color: #008080;">248</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">249</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">250</span><br><span style="color: #008080;">251</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> stop() {<br></span><span style="color: #008080;">252</span>         <span style="color: #0000ff;">if</span> (camera != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">253</span> <span style="color: #000000;">            camera.stopPreview();<br></span><span style="color: #008080;">254</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">255</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">256</span><br><span style="color: #008080;">257</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">258</span> <span style="color: #008000;">     <em> 相机拍照监听接口<br></em></span><span style="color: #008080;">259</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">260</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> OnCameraStatusListener {<br></span><span style="color: #008080;">261</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 相机拍照结束事件</span><br><span style="color: #008080;">262</span>         <span style="color: #0000ff;">void</span> onCameraStopped(<span style="color: #0000ff;">byte</span><span style="color: #000000;">[] data);<br></span><span style="color: #008080;">263</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">264</span><br><span style="color: #008080;">265</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">266</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> onMeasure(<span style="color: #0000ff;">int</span> widthSpec, <span style="color: #0000ff;">int</span><span style="color: #000000;"> heightSpec) {<br></span><span style="color: #008080;">267</span>         viewWidth =<span style="color: #000000;"> MeasureSpec.getSize(widthSpec);<br></span><span style="color: #008080;">268</span>         viewHeight =<span style="color: #000000;"> MeasureSpec.getSize(heightSpec);<br></span><span style="color: #008080;">269</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onMeasure(<br></span><span style="color: #008080;">270</span> <span style="color: #000000;">                MeasureSpec.makeMeasureSpec(viewWidth, MeasureSpec.EXACTLY),<br></span><span style="color: #008080;">271</span> <span style="color: #000000;">                MeasureSpec.makeMeasureSpec(viewHeight, MeasureSpec.EXACTLY));<br></span><span style="color: #008080;">272</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">273</span><br><span style="color: #008080;">274</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">275</span> <span style="color: #008000;">     <em> 将预览大小设置为屏幕大小<br></em></span><span style="color: #008080;">276</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> parameters<br></span><span style="color: #008080;">277</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">278</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">279</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Camera.Size findPreviewSizeByScreen(Camera.Parameters parameters) {<br></span><span style="color: #008080;">280</span>         <span style="color: #0000ff;">if</span> (viewWidth != 0 &amp;&amp; viewHeight != 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">281</span>             <span style="color: #0000ff;">return</span> camera.<span style="color: #0000ff;">new</span><span style="color: #000000;"> Size(Math.max(viewWidth, viewHeight),<br></span><span style="color: #008080;">282</span> <span style="color: #000000;">                    Math.min(viewWidth, viewHeight));<br></span><span style="color: #008080;">283</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">284</span>             <span style="color: #0000ff;">return</span> camera.<span style="color: #0000ff;">new</span><span style="color: #000000;"> Size(Utils.getScreenWH(getContext()).heightPixels,<br></span><span style="color: #008080;">285</span> <span style="color: #000000;">                    Utils.getScreenWH(getContext()).widthPixels);<br></span><span style="color: #008080;">286</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">287</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">288</span><br><span style="color: #008080;">289</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">290</span> <span style="color: #008000;">     <em> 找到最合适的显示分辨率 （防止预览图像变形）<br></em></span><span style="color: #008080;">291</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> parameters<br></span><span style="color: #008080;">292</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">293</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">294</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Camera.Size findBestPreviewSize(Camera.Parameters parameters) {<br></span><span style="color: #008080;">295</span><br><span style="color: #008080;">296</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 系统支持的所有预览分辨率</span><br><span style="color: #008080;">297</span>         String previewSizeValueString = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">298</span>         previewSizeValueString = parameters.get(“preview-size-values”<span style="color: #000000;">);<br></span><span style="color: #008080;">299</span><br><span style="color: #008080;">300</span>         <span style="color: #0000ff;">if</span> (previewSizeValueString == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">301</span>             previewSizeValueString = parameters.get(“preview-size-value”<span style="color: #000000;">);<br></span><span style="color: #008080;">302</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">303</span><br><span style="color: #008080;">304</span>         <span style="color: #0000ff;">if</span> (previewSizeValueString == <span style="color: #0000ff;">null</span>) { <span style="color: #008000;">//</span><span style="color: #008000;"> 有些手机例如m9获取不到支持的预览大小 就直接返回屏幕大小</span><br><span style="color: #008080;">305</span>             <span style="color: #0000ff;">return</span> camera.<span style="color: #0000ff;">new</span><span style="color: #000000;"> Size(Utils.getScreenWH(getContext()).widthPixels,<br></span><span style="color: #008080;">306</span> <span style="color: #000000;">                    Utils.getScreenWH(getContext()).heightPixels);<br></span><span style="color: #008080;">307</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">308</span>         <span style="color: #0000ff;">float</span> bestX = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">309</span>         <span style="color: #0000ff;">float</span> bestY = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">310</span><br><span style="color: #008080;">311</span>         <span style="color: #0000ff;">float</span> tmpRadio = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">312</span>         <span style="color: #0000ff;">float</span> viewRadio = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">313</span><br><span style="color: #008080;">314</span>         <span style="color: #0000ff;">if</span> (viewWidth != 0 &amp;&amp; viewHeight != 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">315</span>             viewRadio = Math.min((<span style="color: #0000ff;">float</span>) viewWidth, (<span style="color: #0000ff;">float</span><span style="color: #000000;">) viewHeight)<br></span><span style="color: #008080;">316</span>                     / Math.max((<span style="color: #0000ff;">float</span>) viewWidth, (<span style="color: #0000ff;">float</span><span style="color: #000000;">) viewHeight);<br></span><span style="color: #008080;">317</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">318</span><br><span style="color: #008080;">319</span>         String[] COMMA_PATTERN = previewSizeValueString.split(“,”<span style="color: #000000;">);<br></span><span style="color: #008080;">320</span>         <span style="color: #0000ff;">for</span><span style="color: #000000;"> (String prewsizeString : COMMA_PATTERN) {<br></span><span style="color: #008080;">321</span>             prewsizeString =<span style="color: #000000;"> prewsizeString.trim();<br></span><span style="color: #008080;">322</span><br><span style="color: #008080;">323</span>             <span style="color: #0000ff;">int</span> dimPosition = prewsizeString.indexOf(‘x’<span style="color: #000000;">);<br></span><span style="color: #008080;">324</span>             <span style="color: #0000ff;">if</span> (dimPosition == -1<span style="color: #000000;">) {<br></span><span style="color: #008080;">325</span>                 <span style="color: #0000ff;">continue</span><span style="color: #000000;">;<br></span><span style="color: #008080;">326</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">327</span><br><span style="color: #008080;">328</span>             <span style="color: #0000ff;">float</span> newX = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">329</span>             <span style="color: #0000ff;">float</span> newY = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">330</span><br><span style="color: #008080;">331</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">332</span>                 newX = Float.parseFloat(prewsizeString.substring(0<span style="color: #000000;">, dimPosition));<br></span><span style="color: #008080;">333</span>                 newY = Float.parseFloat(prewsizeString.substring(dimPosition + 1<span style="color: #000000;">));<br></span><span style="color: #008080;">334</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (NumberFormatException e) {<br></span><span style="color: #008080;">335</span>                 <span style="color: #0000ff;">continue</span><span style="color: #000000;">;<br></span><span style="color: #008080;">336</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">337</span><br><span style="color: #008080;">338</span>             <span style="color: #0000ff;">float</span> radio = Math.min(newX, newY) /<span style="color: #000000;"> Math.max(newX, newY);<br></span><span style="color: #008080;">339</span>             <span style="color: #0000ff;">if</span> (tmpRadio == 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">340</span>                 tmpRadio =<span style="color: #000000;"> radio;<br></span><span style="color: #008080;">341</span>                 bestX =<span style="color: #000000;"> newX;<br></span><span style="color: #008080;">342</span>                 bestY =<span style="color: #000000;"> newY;<br></span><span style="color: #008080;">343</span>             } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (tmpRadio != 0 &amp;&amp; (Math.abs(radio - viewRadio)) &lt; (Math.abs(tmpRadio -<span style="color: #000000;"> viewRadio))) {<br></span><span style="color: #008080;">344</span>                 tmpRadio =<span style="color: #000000;"> radio;<br></span><span style="color: #008080;">345</span>                 bestX =<span style="color: #000000;"> newX;<br></span><span style="color: #008080;">346</span>                 bestY =<span style="color: #000000;"> newY;<br></span><span style="color: #008080;">347</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">348</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">349</span><br><span style="color: #008080;">350</span>         <span style="color: #0000ff;">if</span> (bestX &gt; 0 &amp;&amp; bestY &gt; 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">351</span>             <span style="color: #0000ff;">return</span> camera.<span style="color: #0000ff;">new</span> Size((<span style="color: #0000ff;">int</span>) bestX, (<span style="color: #0000ff;">int</span><span style="color: #000000;">) bestY);<br></span><span style="color: #008080;">352</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">353</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">354</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">355</span><br><span style="color: #008080;">356</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">357</span> <span style="color: #008000;">     <em> 设置焦点和测光区域<br></em></span><span style="color: #008080;">358</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">359</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> event<br></span><span style="color: #008080;">360</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">361</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> focusOnTouch(MotionEvent event) {<br></span><span style="color: #008080;">362</span><br><span style="color: #008080;">363</span>         <span style="color: #0000ff;">int</span>[] location = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">int</span>[2<span style="color: #000000;">];<br></span><span style="color: #008080;">364</span>         RelativeLayout relativeLayout =<span style="color: #000000;"> (RelativeLayout)getParent();<br></span><span style="color: #008080;">365</span> <span style="color: #000000;">        relativeLayout.getLocationOnScreen(location);<br></span><span style="color: #008080;">366</span><br><span style="color: #008080;">367</span>         Rect focusRect =<span style="color: #000000;"> Utils.calculateTapArea(mFocusView.getWidth(),<br></span><span style="color: #008080;">368</span> <span style="color: #000000;">                mFocusView.getHeight(), 1f, event.getRawX(), event.getRawY(),<br></span><span style="color: #008080;">369</span>                 location[0], location[0] + relativeLayout.getWidth(), location[1<span style="color: #000000;">],<br></span><span style="color: #008080;">370</span>                 location[1] +<span style="color: #000000;"> relativeLayout.getHeight());<br></span><span style="color: #008080;">371</span>         Rect meteringRect =<span style="color: #000000;"> Utils.calculateTapArea(mFocusView.getWidth(),<br></span><span style="color: #008080;">372</span>                 mFocusView.getHeight(), 1.5f<span style="color: #000000;">, event.getRawX(), event.getRawY(),<br></span><span style="color: #008080;">373</span>                 location[0], location[0] + relativeLayout.getWidth(), location[1<span style="color: #000000;">],<br></span><span style="color: #008080;">374</span>                 location[1] +<span style="color: #000000;"> relativeLayout.getHeight());<br></span><span style="color: #008080;">375</span><br><span style="color: #008080;">376</span>         Camera.Parameters parameters =<span style="color: #000000;"> camera.getParameters();<br></span><span style="color: #008080;">377</span> <span style="color: #000000;">        parameters.setFocusMode(Camera.Parameters.FOCUS_MODE_AUTO);<br></span><span style="color: #008080;">378</span><br><span style="color: #008080;">379</span>         <span style="color: #0000ff;">if</span> (parameters.getMaxNumFocusAreas() &gt; 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">380</span>             List<camera.area> focusAreas = <span style="color: #0000ff;">new</span> ArrayList<camera.area><span style="color: #000000;">();<br></span><span style="color: #008080;">381</span>             focusAreas.add(<span style="color: #0000ff;">new</span> Camera.Area(focusRect, 1000<span style="color: #000000;">));<br></span><span style="color: #008080;">382</span><br><span style="color: #008080;">383</span> <span style="color: #000000;">            parameters.setFocusAreas(focusAreas);<br></span><span style="color: #008080;">384</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">385</span><br><span style="color: #008080;">386</span>         <span style="color: #0000ff;">if</span> (parameters.getMaxNumMeteringAreas() &gt; 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">387</span>             List<camera.area> meteringAreas = <span style="color: #0000ff;">new</span> ArrayList<camera.area><span style="color: #000000;">();<br></span><span style="color: #008080;">388</span>             meteringAreas.add(<span style="color: #0000ff;">new</span> Camera.Area(meteringRect, 1000<span style="color: #000000;">));<br></span><span style="color: #008080;">389</span><br><span style="color: #008080;">390</span> <span style="color: #000000;">            parameters.setMeteringAreas(meteringAreas);<br></span><span style="color: #008080;">391</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">392</span><br><span style="color: #008080;">393</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">394</span> <span style="color: #000000;">            camera.setParameters(parameters);<br></span><span style="color: #008080;">395</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">396</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">397</span>         camera.autoFocus(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">398</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">399</span><br><span style="color: #008080;">400</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">401</span> <span style="color: #008000;">     <em> 设置聚焦的图片<br></em></span><span style="color: #008080;">402</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> focusView<br></span><span style="color: #008080;">403</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">404</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setFocusView(FocusView focusView) {<br></span><span style="color: #008080;">405</span>         <span style="color: #0000ff;">this</span>.mFocusView =<span style="color: #000000;"> focusView;<br></span><span style="color: #008080;">406</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">407</span><br><span style="color: #008080;">408</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">409</span> <span style="color: #008000;">      设置自动聚焦，并且聚焦的圈圈显示在屏幕中间位置<br></span><span style="color: #008080;">410</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">411</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setFocus() {<br></span><span style="color: #008080;">412</span>         <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">mFocusView.isFocusing()) {<br></span><span style="color: #008080;">413</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">414</span>                 camera.autoFocus(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">415</span>                 mFocusView.setX((Utils.getWidthInPx(getContext())-mFocusView.getWidth()) / 2<span style="color: #000000;">);<br></span><span style="color: #008080;">416</span>                 mFocusView.setY((Utils.getHeightInPx(getContext())-mFocusView.getHeight()) / 2<span style="color: #000000;">);<br></span><span style="color: #008080;">417</span> <span style="color: #000000;">                mFocusView.beginFocus();<br></span><span style="color: #008080;">418</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">419</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">420</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">421</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">422</span><br><span style="color: #008080;">423</span> }</camera.area></camera.area></camera.area></camera.area></string></pre><br></div>

<p>　　<span style="font-size: 15px;">3、Activity中使用自定义相机</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TakePhoteActivity <span style="color: #0000ff;">extends</span> Activity <span style="color: #0000ff;">implements</span><span style="color: #000000;"> CameraPreview.OnCameraStatusListener,<br></span><span style="color: #008080;">  2</span> <span style="color: #000000;">        SensorEventListener {<br></span><span style="color: #008080;">  3</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “TakePhoteActivity”<span style="color: #000000;">;<br></span><span style="color: #008080;">  4</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> Uri IMAGE_URI =<span style="color: #000000;"> MediaStore.Images.Media.EXTERNAL_CONTENT_URI;<br></span><span style="color: #008080;">  5</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String PATH =<span style="color: #000000;"> Environment.getExternalStorageDirectory()<br></span><span style="color: #008080;">  6</span>             .toString() + “/AndroidMedia/“<span style="color: #000000;">;<br></span><span style="color: #008080;">  7</span> <span style="color: #000000;">    CameraPreview mCameraPreview;<br></span><span style="color: #008080;">  8</span> <span style="color: #000000;">    CropImageView mCropImageView;<br></span><span style="color: #008080;">  9</span> <span style="color: #000000;">    RelativeLayout mTakePhotoLayout;<br></span><span style="color: #008080;"> 10</span> <span style="color: #000000;">    LinearLayout mCropperLayout;<br></span><span style="color: #008080;"> 11</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 12</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;"> 13</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;"> 14</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置横屏<br></span><span style="color: #008080;"> 15</span> <span style="color: #008000;">//</span><span style="color: #008000;">        setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE);<br></span><span style="color: #008080;"> 16</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置全屏</span><br><span style="color: #008080;"> 17</span> <span style="color: #000000;">        requestWindowFeature(Window.FEATURE_NO_TITLE);<br></span><span style="color: #008080;"> 18</span> <span style="color: #000000;">        getWindow().setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN,<br></span><span style="color: #008080;"> 19</span> <span style="color: #000000;">                WindowManager.LayoutParams.FLAG_FULLSCREEN);<br></span><span style="color: #008080;"> 20</span> <span style="color: #000000;">        setContentView(R.layout.activity_take_phote);<br></span><span style="color: #008080;"> 21</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> Initialize components of the app</span><br><span style="color: #008080;"> 22</span>         mCropImageView =<span style="color: #000000;"> (CropImageView) findViewById(R.id.CropImageView);<br></span><span style="color: #008080;"> 23</span>         mCameraPreview =<span style="color: #000000;"> (CameraPreview) findViewById(R.id.cameraPreview);<br></span><span style="color: #008080;"> 24</span>         FocusView focusView =<span style="color: #000000;"> (FocusView) findViewById(R.id.view_focus);<br></span><span style="color: #008080;"> 25</span>         mTakePhotoLayout =<span style="color: #000000;"> (RelativeLayout) findViewById(R.id.take_photo_layout);<br></span><span style="color: #008080;"> 26</span>         mCropperLayout =<span style="color: #000000;"> (LinearLayout) findViewById(R.id.cropper_layout);<br></span><span style="color: #008080;"> 27</span><br><span style="color: #008080;"> 28</span> <span style="color: #000000;">        mCameraPreview.setFocusView(focusView);<br></span><span style="color: #008080;"> 29</span>         mCameraPreview.setOnCameraStatusListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 30</span>         mCropImageView.setGuidelines(2<span style="color: #000000;">);<br></span><span style="color: #008080;"> 31</span><br><span style="color: #008080;"> 32</span>         mSensorManager =<span style="color: #000000;"> (SensorManager) getSystemService(Context.<br></span><span style="color: #008080;"> 33</span> <span style="color: #000000;">                SENSOR_SERVICE);<br></span><span style="color: #008080;"> 34</span>         mAccel =<span style="color: #000000;"> mSensorManager.getDefaultSensor(Sensor.<br></span><span style="color: #008080;"> 35</span> <span style="color: #000000;">                TYPE_ACCELEROMETER);<br></span><span style="color: #008080;"> 36</span><br><span style="color: #008080;"> 37</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 38</span><br><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">boolean</span> isRotated = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 40</span><br><span style="color: #008080;"> 41</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 42</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onResume() {<br></span><span style="color: #008080;"> 43</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onResume();<br></span><span style="color: #008080;"> 44</span>         <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">isRotated) {<br></span><span style="color: #008080;"> 45</span>             TextView hint_tv =<span style="color: #000000;"> (TextView) findViewById(R.id.hint);<br></span><span style="color: #008080;"> 46</span>             ObjectAnimator animator = ObjectAnimator.ofFloat(hint_tv, “rotation”<span style="color: #000000;">, 0f, 90f);<br></span><span style="color: #008080;"> 47</span>             animator.setStartDelay(800<span style="color: #000000;">);<br></span><span style="color: #008080;"> 48</span>             animator.setDuration(1000<span style="color: #000000;">);<br></span><span style="color: #008080;"> 49</span>             animator.setInterpolator(<span style="color: #0000ff;">new</span><span style="color: #000000;"> LinearInterpolator());<br></span><span style="color: #008080;"> 50</span> <span style="color: #000000;">            animator.start();<br></span><span style="color: #008080;"> 51</span>             View view =<span style="color: #000000;">  findViewById(R.id.crop_hint);<br></span><span style="color: #008080;"> 52</span>             AnimatorSet animSet = <span style="color: #0000ff;">new</span><span style="color: #000000;"> AnimatorSet();<br></span><span style="color: #008080;"> 53</span>             ObjectAnimator animator1 = ObjectAnimator.ofFloat(view, “rotation”<span style="color: #000000;">, 0f, 90f);<br></span><span style="color: #008080;"> 54</span>             ObjectAnimator moveIn = ObjectAnimator.ofFloat(view, “translationX”, 0f, -<span style="color: #000000;">50f);<br></span><span style="color: #008080;"> 55</span> <span style="color: #000000;">            animSet.play(animator1).before(moveIn);<br></span><span style="color: #008080;"> 56</span>             animSet.setDuration(10<span style="color: #000000;">);<br></span><span style="color: #008080;"> 57</span> <span style="color: #000000;">            animSet.start();<br></span><span style="color: #008080;"> 58</span>             isRotated = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 59</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 60</span>         mSensorManager.registerListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">, mAccel, SensorManager.SENSOR_DELAY_UI);<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 62</span><br><span style="color: #008080;"> 63</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 64</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPause() {<br></span><span style="color: #008080;"> 65</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPause();<br></span><span style="color: #008080;"> 66</span>         mSensorManager.unregisterListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 68</span><br><span style="color: #008080;"> 69</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 70</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onConfigurationChanged(Configuration newConfig) {<br></span><span style="color: #008080;"> 71</span>         Log.e(TAG, “onConfigurationChanged”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 72</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onConfigurationChanged(newConfig);<br></span><span style="color: #008080;"> 73</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 74</span><br><span style="color: #008080;"> 75</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> takePhoto(View view) {<br></span><span style="color: #008080;"> 76</span>         <span style="color: #0000ff;">if</span>(mCameraPreview != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 77</span> <span style="color: #000000;">            mCameraPreview.takePicture();<br></span><span style="color: #008080;"> 78</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 79</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 80</span><br><span style="color: #008080;"> 81</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> close(View view) {<br></span><span style="color: #008080;"> 82</span> <span style="color: #000000;">        finish();<br></span><span style="color: #008080;"> 83</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 84</span><br><span style="color: #008080;"> 85</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 86</span> <span style="color: #008000;">     <em> 关闭截图界面<br></em></span><span style="color: #008080;"> 87</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> view<br></span><span style="color: #008080;"> 88</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 89</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> closeCropper(View view) {<br></span><span style="color: #008080;"> 90</span> <span style="color: #000000;">        showTakePhotoLayout();<br></span><span style="color: #008080;"> 91</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 92</span><br><span style="color: #008080;"> 93</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 94</span> <span style="color: #008000;">     <em> 开始截图，并保存图片<br></em></span><span style="color: #008080;"> 95</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> view<br></span><span style="color: #008080;"> 96</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 97</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> startCropper(View view) {<br></span><span style="color: #008080;"> 98</span>         <span style="color: #008000;">//</span><span style="color: #008000;">获取截图并旋转90度</span><br><span style="color: #008080;"> 99</span>         CropperImage cropperImage =<span style="color: #000000;"> mCropImageView.getCroppedImage();<br></span><span style="color: #008080;">100</span>         Log.e(TAG, cropperImage.getX() + “,” +<span style="color: #000000;"> cropperImage.getY());<br></span><span style="color: #008080;">101</span>         Log.e(TAG, cropperImage.getWidth() + “,” +<span style="color: #000000;"> cropperImage.getHeight());<br></span><span style="color: #008080;">102</span>         Bitmap bitmap = Utils.rotate(cropperImage.getBitmap(), -90<span style="color: #000000;">);<br></span><span style="color: #008080;">103</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Bitmap bitmap = mCropImageView.getCroppedImage();<br></span><span style="color: #008080;">104</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 系统时间</span><br><span style="color: #008080;">105</span>         <span style="color: #0000ff;">long</span> dateTaken =<span style="color: #000000;"> System.currentTimeMillis();<br></span><span style="color: #008080;">106</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 图像名称</span><br><span style="color: #008080;">107</span>         String filename = DateFormat.format(“yyyy-MM-dd kk.mm.ss”<span style="color: #000000;">, dateTaken)<br></span><span style="color: #008080;">108</span>                 .toString() + “.jpg”<span style="color: #000000;">;<br></span><span style="color: #008080;">109</span>         Uri uri =<span style="color: #000000;"> insertImage(getContentResolver(), filename, dateTaken, PATH,<br></span><span style="color: #008080;">110</span>                 filename, bitmap, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">111</span> <span style="color: #000000;">        cropperImage.getBitmap().recycle();<br></span><span style="color: #008080;">112</span>         cropperImage.setBitmap(<span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">113</span>         Intent intent = <span style="color: #0000ff;">new</span> Intent(<span style="color: #0000ff;">this</span>, ShowCropperedActivity.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;">114</span> <span style="color: #000000;">        intent.setData(uri);<br></span><span style="color: #008080;">115</span>         intent.putExtra(“path”, PATH +<span style="color: #000000;"> filename);<br></span><span style="color: #008080;">116</span>         intent.putExtra(“width”<span style="color: #000000;">, bitmap.getWidth());<br></span><span style="color: #008080;">117</span>         intent.putExtra(“height”<span style="color: #000000;">, bitmap.getHeight());<br></span><span style="color: #008080;">118</span>         intent.putExtra(“cropperImage”<span style="color: #000000;">, cropperImage);<br></span><span style="color: #008080;">119</span> <span style="color: #000000;">        startActivity(intent);<br></span><span style="color: #008080;">120</span> <span style="color: #000000;">        bitmap.recycle();<br></span><span style="color: #008080;">121</span> <span style="color: #000000;">        finish();<br></span><span style="color: #008080;">122</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.overridePendingTransition(R.anim.fade_in,<br></span><span style="color: #008080;">123</span> <span style="color: #000000;">                R.anim.fade_out);<br></span><span style="color: #008080;">124</span> <span style="color: #008000;">//</span><span style="color: #008000;">        doAnimation(cropperImage);</span><br><span style="color: #008080;">125</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">126</span><br><span style="color: #008080;">127</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> doAnimation(CropperImage cropperImage) {<br></span><span style="color: #008080;">128</span>         ImageView imageView = <span style="color: #0000ff;">new</span> ImageView(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">129</span>         View view = LayoutInflater.from(<span style="color: #0000ff;">this</span><span style="color: #000000;">).inflate(<br></span><span style="color: #008080;">130</span>                 R.layout.image_view_layout, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">131</span> <span style="color: #000000;">        ((RelativeLayout) view.findViewById(R.id.root_layout)).addView(imageView);<br></span><span style="color: #008080;">132</span>         RelativeLayout relativeLayout =<span style="color: #000000;"> ((RelativeLayout) findViewById(R.id.root_layout));<br></span><span style="color: #008080;">133</span> <span style="color: #008000;">//</span><span style="color: #008000;">        relativeLayout.addView(imageView);</span><br><span style="color: #008080;">134</span> <span style="color: #000000;">        imageView.setX(cropperImage.getX());<br></span><span style="color: #008080;">135</span> <span style="color: #000000;">        imageView.setY(cropperImage.getY());<br></span><span style="color: #008080;">136</span>         ViewGroup.LayoutParams lp =<span style="color: #000000;"> imageView.getLayoutParams();<br></span><span style="color: #008080;">137</span>         lp.width = (<span style="color: #0000ff;">int</span><span style="color: #000000;">)cropperImage.getWidth();<br></span><span style="color: #008080;">138</span>         lp.height = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) cropperImage.getHeight();<br></span><span style="color: #008080;">139</span> <span style="color: #000000;">        imageView.setLayoutParams(lp);<br></span><span style="color: #008080;">140</span> <span style="color: #000000;">        imageView.setImageBitmap(cropperImage.getBitmap());<br></span><span style="color: #008080;">141</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">142</span> <span style="color: #000000;">            getWindow().addContentView(view, lp);<br></span><span style="color: #008080;">143</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">144</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;">145</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">146</span>         <span style="color: #008000;">/</span><span style="color: #008000;">AnimatorSet animSet = new AnimatorSet();<br></span><span style="color: #008080;">147</span> <span style="color: #008000;">        ObjectAnimator translationX = ObjectAnimator.ofFloat(this, “translationX”, cropperImage.getX(), 0);<br></span><span style="color: #008080;">148</span> <span style="color: #008000;">        ObjectAnimator translationY = ObjectAnimator.ofFloat(this, “translationY”, cropperImage.getY(), 0);</span><span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">149</span><br><span style="color: #008080;">150</span>         TranslateAnimation translateAnimation = <span style="color: #0000ff;">new</span><span style="color: #000000;"> TranslateAnimation(<br></span><span style="color: #008080;">151</span>                 0, -cropperImage.getX(), 0, -(Math.abs(cropperImage.getHeight() - cropperImage.getY())));<span style="color: #008000;">//</span><span style="color: #008000;"> 当前位置移动到指定位置</span><br><span style="color: #008080;">152</span>         RotateAnimation rotateAnimation = <span style="color: #0000ff;">new</span> RotateAnimation(0, -90<span style="color: #000000;">,<br></span><span style="color: #008080;">153</span> <span style="color: #000000;">                Animation.ABSOLUTE, cropperImage.getX() ,Animation.ABSOLUTE, cropperImage.getY());<br></span><span style="color: #008080;">154</span>         AnimationSet animationSet = <span style="color: #0000ff;">new</span> AnimationSet(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">155</span> <span style="color: #000000;">        animationSet.addAnimation(translateAnimation);<br></span><span style="color: #008080;">156</span> <span style="color: #000000;">        animationSet.addAnimation(rotateAnimation);<br></span><span style="color: #008080;">157</span>         animationSet.setFillAfter(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">158</span>         animationSet.setDuration(2000L<span style="color: #000000;">);<br></span><span style="color: #008080;">159</span> <span style="color: #000000;">        imageView.startAnimation(animationSet);<br></span><span style="color: #008080;">160</span> <span style="color: #008000;">//</span><span style="color: #008000;">        finish();</span><br><span style="color: #008080;">161</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">162</span><br><span style="color: #008080;">163</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">164</span> <span style="color: #008000;">      拍照成功后回调<br></span><span style="color: #008080;">165</span> <span style="color: #008000;">     <em> 存储图片并显示截图界面<br></em></span><span style="color: #008080;">166</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> data<br></span><span style="color: #008080;">167</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">168</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">169</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCameraStopped(<span style="color: #0000ff;">byte</span><span style="color: #000000;">[] data) {<br></span><span style="color: #008080;">170</span>         Log.i(“TAG”, “==onCameraStopped==”<span style="color: #000000;">);<br></span><span style="color: #008080;">171</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 创建图像</span><br><span style="color: #008080;">172</span>         Bitmap bitmap = BitmapFactory.decodeByteArray(data, 0<span style="color: #000000;">, data.length);<br></span><span style="color: #008080;">173</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 系统时间</span><br><span style="color: #008080;">174</span>         <span style="color: #0000ff;">long</span> dateTaken =<span style="color: #000000;"> System.currentTimeMillis();<br></span><span style="color: #008080;">175</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 图像名称</span><br><span style="color: #008080;">176</span>         String filename = DateFormat.format(“yyyy-MM-dd kk.mm.ss”<span style="color: #000000;">, dateTaken)<br></span><span style="color: #008080;">177</span>                 .toString() + “.jpg”<span style="color: #000000;">;<br></span><span style="color: #008080;">178</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 存储图像（PATH目录）</span><br><span style="color: #008080;">179</span>         Uri source =<span style="color: #000000;"> insertImage(getContentResolver(), filename, dateTaken, PATH,<br></span><span style="color: #008080;">180</span> <span style="color: #000000;">                filename, bitmap, data);<br></span><span style="color: #008080;">181</span>         <span style="color: #008000;">//</span><span style="color: #008000;">准备截图</span><br><span style="color: #008080;">182</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">183</span>             mCropImageView.setImageBitmap(MediaStore.Images.Media.getBitmap(<span style="color: #0000ff;">this</span><span style="color: #000000;">.getContentResolver(), source));<br></span><span style="color: #008080;">184</span> <span style="color: #008000;">//</span><span style="color: #008000;">            mCropImageView.rotateImage(90);</span><br><span style="color: #008080;">185</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;">186</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">187</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">188</span> <span style="color: #000000;">        showCropperLayout();<br></span><span style="color: #008080;">189</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">190</span><br><span style="color: #008080;">191</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">192</span> <span style="color: #008000;">      存储图像并将信息添加入媒体数据库<br></span><span style="color: #008080;">193</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">194</span>     <span style="color: #0000ff;">private</span> Uri insertImage(ContentResolver cr, String name, <span style="color: #0000ff;">long</span><span style="color: #000000;"> dateTaken,<br></span><span style="color: #008080;">195</span>                             String directory, String filename, Bitmap source, <span style="color: #0000ff;">byte</span><span style="color: #000000;">[] jpegData) {<br></span><span style="color: #008080;">196</span>         OutputStream outputStream = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">197</span>         String filePath = directory +<span style="color: #000000;"> filename;<br></span><span style="color: #008080;">198</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">199</span>             File dir = <span style="color: #0000ff;">new</span><span style="color: #000000;"> File(directory);<br></span><span style="color: #008080;">200</span>             <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">dir.exists()) {<br></span><span style="color: #008080;">201</span> <span style="color: #000000;">                dir.mkdirs();<br></span><span style="color: #008080;">202</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">203</span>             File file = <span style="color: #0000ff;">new</span><span style="color: #000000;"> File(directory, filename);<br></span><span style="color: #008080;">204</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (file.createNewFile()) {<br></span><span style="color: #008080;">205</span>                 outputStream = <span style="color: #0000ff;">new</span><span style="color: #000000;"> FileOutputStream(file);<br></span><span style="color: #008080;">206</span>                 <span style="color: #0000ff;">if</span> (source != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">207</span>                     source.compress(Bitmap.CompressFormat.JPEG, 100<span style="color: #000000;">, outputStream);<br></span><span style="color: #008080;">208</span>                 } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">209</span> <span style="color: #000000;">                    outputStream.write(jpegData);<br></span><span style="color: #008080;">210</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">211</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">212</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (FileNotFoundException e) {<br></span><span style="color: #008080;">213</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">214</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">215</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;">216</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">217</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">218</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">219</span>             <span style="color: #0000ff;">if</span> (outputStream != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">220</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">221</span> <span style="color: #000000;">                    outputStream.close();<br></span><span style="color: #008080;">222</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Throwable t) {<br></span><span style="color: #008080;">223</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">224</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">225</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">226</span>         ContentValues values = <span style="color: #0000ff;">new</span> ContentValues(7<span style="color: #000000;">);<br></span><span style="color: #008080;">227</span> <span style="color: #000000;">        values.put(MediaStore.Images.Media.TITLE, name);<br></span><span style="color: #008080;">228</span> <span style="color: #000000;">        values.put(MediaStore.Images.Media.DISPLAY_NAME, filename);<br></span><span style="color: #008080;">229</span> <span style="color: #000000;">        values.put(MediaStore.Images.Media.DATE_TAKEN, dateTaken);<br></span><span style="color: #008080;">230</span>         values.put(MediaStore.Images.Media.MIME_TYPE, “image/jpeg”<span style="color: #000000;">);<br></span><span style="color: #008080;">231</span> <span style="color: #000000;">        values.put(MediaStore.Images.Media.DATA, filePath);<br></span><span style="color: #008080;">232</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> cr.insert(IMAGE_URI, values);<br></span><span style="color: #008080;">233</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">234</span><br><span style="color: #008080;">235</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> showTakePhotoLayout() {<br></span><span style="color: #008080;">236</span> <span style="color: #000000;">        mTakePhotoLayout.setVisibility(View.VISIBLE);<br></span><span style="color: #008080;">237</span> <span style="color: #000000;">        mCropperLayout.setVisibility(View.GONE);<br></span><span style="color: #008080;">238</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">239</span><br><span style="color: #008080;">240</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> showCropperLayout() {<br></span><span style="color: #008080;">241</span> <span style="color: #000000;">        mTakePhotoLayout.setVisibility(View.GONE);<br></span><span style="color: #008080;">242</span> <span style="color: #000000;">        mCropperLayout.setVisibility(View.VISIBLE);<br></span><span style="color: #008080;">243</span>         mCameraPreview.start();   <span style="color: #008000;">//</span><span style="color: #008000;">继续启动摄像头</span><br><span style="color: #008080;">244</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">245</span><br><span style="color: #008080;">246</span><br><span style="color: #008080;">247</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">float</span> mLastX = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">248</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">float</span> mLastY = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">249</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">float</span> mLastZ = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">250</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> mInitialized = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">251</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> SensorManager mSensorManager;<br></span><span style="color: #008080;">252</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Sensor mAccel;<br></span><span style="color: #008080;">253</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">254</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onSensorChanged(SensorEvent event) {<br></span><span style="color: #008080;">255</span><br><span style="color: #008080;">256</span>         <span style="color: #0000ff;">float</span> x = event.values[0<span style="color: #000000;">];<br></span><span style="color: #008080;">257</span>         <span style="color: #0000ff;">float</span> y = event.values[1<span style="color: #000000;">];<br></span><span style="color: #008080;">258</span>         <span style="color: #0000ff;">float</span> z = event.values[2<span style="color: #000000;">];<br></span><span style="color: #008080;">259</span>         <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">mInitialized){<br></span><span style="color: #008080;">260</span>             mLastX =<span style="color: #000000;"> x;<br></span><span style="color: #008080;">261</span>             mLastY =<span style="color: #000000;"> y;<br></span><span style="color: #008080;">262</span>             mLastZ =<span style="color: #000000;"> z;<br></span><span style="color: #008080;">263</span>             mInitialized = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">264</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">265</span>         <span style="color: #0000ff;">float</span> deltaX  = Math.abs(mLastX -<span style="color: #000000;"> x);<br></span><span style="color: #008080;">266</span>         <span style="color: #0000ff;">float</span> deltaY = Math.abs(mLastY -<span style="color: #000000;"> y);<br></span><span style="color: #008080;">267</span>         <span style="color: #0000ff;">float</span> deltaZ = Math.abs(mLastZ -<span style="color: #000000;"> z);<br></span><span style="color: #008080;">268</span><br><span style="color: #008080;">269</span>         <span style="color: #0000ff;">if</span>(deltaX &gt; 0.8 || deltaY &gt; 0.8 || deltaZ &gt; 0.8<span style="color: #000000;">){<br></span><span style="color: #008080;">270</span> <span style="color: #000000;">            mCameraPreview.setFocus();<br></span><span style="color: #008080;">271</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">272</span>         mLastX =<span style="color: #000000;"> x;<br></span><span style="color: #008080;">273</span>         mLastY =<span style="color: #000000;"> y;<br></span><span style="color: #008080;">274</span>         mLastZ =<span style="color: #000000;"> z;<br></span><span style="color: #008080;">275</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">276</span><br><span style="color: #008080;">277</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">278</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onAccuracyChanged(Sensor sensor, <span style="color: #0000ff;">int</span><span style="color: #000000;"> accuracy) {<br></span><span style="color: #008080;">279</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">280</span> }</pre><br></div>

<p>　　<span style="font-size: 15px;">actiity中注册了SensorEventListener，也就是使用传感器监听用户手机的移动，如果有一定距离的移动，则自动聚焦，这样体验好一点。</span></p>
<p><span style="font-size: 15px;">　　我对比了一下小猿搜题和学霸君两款app的拍照功能，个人感觉小猿搜题的体验要好一些，因为从主界面进入拍照界面，连个界面没有一个旋转的过渡，而学霸君就有一个过渡，有一丝丝的影响体验。也就是说学霸君的拍照界面是横屏的，在activity的onCreate方法里面调用了</span>setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE)来设置全屏，而切换界面的时候又从竖屏切换为横屏，就会有个过渡的效果，影响了体验。</p>
<p>　　<span style="font-size: 15px;">个人猜测小猿搜题是将拍照界面的activity设置为竖屏，而将摄像头直接旋转90度，这样就强制用户横屏拍摄，当然，拍完之后还要将图片旋转回来。所以我参考小猿搜题来实现的，毕竟体验为王嘛。</span></p>
<p><span style="font-size: 15px;"><img src="http://www.liuling123.com/wp-content/uploads/2015/11/420264-20151028225216372-729805796.png" alt=""></span></p>
<p>&nbsp;</p>
<p>　　<span style="font-size: 15px;">如上图（其实是竖屏），红色圈起来的其实是放到底部，然后将屏幕中间的文字旋转90度（带有动画，起了提示用户横屏拍照的作用），就给人的感觉是横屏的。了。</span></p>
<p><span style="font-size: 15px;">　　还有一点就是小猿搜题拍完照到截图过渡的很自然，感觉很流畅，估计是拍照和截图放在同一个activity中的，如果是两个activty，涉及到界面切换，肯定不会那么自然。所以我也将拍照和截图放在一个界面，拍照完就将自定义相机隐藏，将截图界面显示出来，这样切换就很流畅了。</span></p>
<p><span style="font-size: 15px;">　　项目中截图的功能我是从github上面找的一个开源库cropper：<a href="https://github.com/edmodo/cropper" title="https://github.com/edmodo/cropper" target="_blank" rel="external">https://github.com/edmodo/cropper</a></span></p>
<p>&nbsp;　 &nbsp;<span style="font-size: 15px;">&nbsp;</span><span style="font-size: 15px;">因为ocr图片识别的代码是公司的，所以识别的功能没有添加到demo里面去。</span><span style="font-size: 15px;"><br></span></p>
<p>&nbsp;</p>
<p>　　<span style="color: #ff0000;">Demo<span style="font-size: 15px;">源码下载：<span style="color: #000000;"><a href="https://github.com/liuling07/CustomCameraDemo" title="https://github.com/liuling07/CustomCameraDemo" target="_blank" rel="external">https://github.com/liuling07/CustomCameraDemo</a></span></span></span></p>

            
              <! -- 添加捐赠图标 -->
              <div class ="post-donate" style="border-top:1px solid #f0f0f0;margin－top:38px;margin-bottom:18px;text-align:center">
                <div id="donate_board" class="donate_bar center" style=" margin:12px;">
                  <a id="btn_donate" class="btn_donate" href="javascript:;" title="Donate 打赏"></a>
                  <span class="donate_txt" style="font-size:16px; font-weight:bolder;">
                     如果文章对您有帮助，请随意打赏支持！  
                  </span>
                </div>  
            
              <!-- 支付宝打赏图案 -->
                <div style="text-align:center">
                    <a href="http://7xnqm4.com1.z0.glb.clouddn.com/pay%2Falipay.png" title="支付宝打赏"   style="float:left;margin-right:8px;text-align:center">
                    <img src="http://7xnqm4.com1.z0.glb.clouddn.com/pay%2Falipay.png" title="支付宝打赏" height="200px" width="200px">
                    </a> 
                </div>

              <!-- 微信打赏图案 -->
                <div style="text-align:center">
                    <a href="http://7xnqm4.com1.z0.glb.clouddn.com/pay%2Fweipay.png" title="微信打赏" >
                    <img src="http://7xnqm4.com1.z0.glb.clouddn.com/pay%2Fweipay.png" title="微信打赏" height="200px" width="200px">
                    </a> 
                </div>
              </div>  
              <! -- 添加捐赠图标 -->
              
              <! -- 广告开始 -->

              <! -- 广告结束 -->

            
        
        </div>
        <footer class="article-footer">
            <div class="share-container">


    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
    <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
    <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>


</div>

            
    
        <a href="http://www.liuling123.com/2015/10/custom-camera.html#ds-thread" class="article-comment-link"><span class="ds-thread-count" data-thread-key="post-custom-camera" data-count-type="comments"></span></a>
    

        </footer>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2015/11/recyclerview-example.html" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">上一篇</strong>
            <div class="article-nav-title">
                
                    RecyclerView的使用
                
            </div>
        </a>
    
    
        <a href="/2015/10/listview-partial-refresh.html" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">下一篇</strong>
            <div class="article-nav-title">ListView实现Item局部刷新</div>
        </a>
    
</nav>


    
</article>


    
    <section id="comments">
    
        
    <div class="ds-thread" data-thread-key="post-custom-camera" data-title="Android自定义相机拍照、图片裁剪的实现" data-url="http://www.liuling123.com/2015/10/custom-camera.html"></div>
    <style>
        #ds-thread #ds-reset .ds-textarea-wrapper {
            background: none;
        }
        #ds-reset .ds-avatar img {
            box-shadow: none;
        }
        #ds-reset .ds-gradient-bg {
            background: #f7f7f7;
        }
        #ds-thread #ds-reset li.ds-tab a {
            border-radius: 3px;
        }
        #ds-thread #ds-reset .ds-post-button {
            color: white;
            border: none;
            box-shadow: none;
            background: #d32;
            text-shadow: none;
            font-weight: normal;
            font-family: 'Microsoft Yahei';
        }
        #ds-thread #ds-reset .ds-post-button:hover {
            color: white;
            background: #DE594C;
        }
        #ds-thread #ds-reset .ds-post-button:active {
            background: #d32;
        }
        #ds-smilies-tooltip ul.ds-smilies-tabs li a.ds-current {
            color: white;
            background: #d32;
            box-shadow: none;
            text-shadow: none;
            font-weight: normal;
        }
    </style>

    
    </section>

</section>
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">最新博文</h3>
        <div class="widget">
            <ul id="recent-post" class="no-thumbnail">
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/读书笔记/">读书笔记</a></p>
                            <p class="item-title"><a href="/2016/07/influence-reading-notes2.html" class="title">《影响力》读书笔记（二）</a></p>
                            <p class="item-date"><time datetime="2016-07-26T13:09:00.000Z" itemprop="datePublished">2016-07-26</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/读书笔记/">读书笔记</a></p>
                            <p class="item-title"><a href="/2016/07/influence-reading-notes.html" class="title">《影响力》读书笔记（一）</a></p>
                            <p class="item-date"><time datetime="2016-07-07T14:00:00.000Z" itemprop="datePublished">2016-07-07</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/版本控制/">版本控制</a></p>
                            <p class="item-title"><a href="/2016/07/git-note.html" class="title">git使用小记</a></p>
                            <p class="item-date"><time datetime="2016-07-05T13:41:00.000Z" itemprop="datePublished">2016-07-05</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Linux/">Linux</a></p>
                            <p class="item-title"><a href="/2016/06/ubuntu-adb-devices.html" class="title">Ubuntu下adb无法识别手机设备</a></p>
                            <p class="item-date"><time datetime="2016-06-21T13:14:00.000Z" itemprop="datePublished">2016-06-21</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/JNI-amp-NDK/">JNI&amp;NDK</a></p>
                            <p class="item-title"><a href="/2016/06/jni-type-change.html" class="title">JNI与C/C++数据类型的转换</a></p>
                            <p class="item-date"><time datetime="2016-06-21T12:52:00.000Z" itemprop="datePublished">2016-06-21</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">博文分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Framework/">Framework</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hadoop/">Hadoop</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JNI-amp-NDK/">JNI&amp;NDK</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a><span class="category-list-count">35</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kotlin/">Kotlin</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NoSQL/">NoSQL</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/人生感悟/">人生感悟</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他技术/">其他技术</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后端/">后端</a><span class="category-list-count">29</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构和算法/">数据结构和算法</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/版本控制/">版本控制</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">2</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/AsyncTask/" style="font-size: 11.54px;">AsyncTask</a> <a href="/tags/EventBus/" style="font-size: 10.77px;">EventBus</a> <a href="/tags/Kotlin/" style="font-size: 10px;">Kotlin</a> <a href="/tags/LruCache/" style="font-size: 10px;">LruCache</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/NDK/" style="font-size: 11.54px;">NDK</a> <a href="/tags/NoSQL/" style="font-size: 13.08px;">NoSQL</a> <a href="/tags/android/" style="font-size: 19.23px;">android</a> <a href="/tags/android-studio/" style="font-size: 10px;">android studio</a> <a href="/tags/c/" style="font-size: 10px;">c++</a> <a href="/tags/camera/" style="font-size: 10px;">camera</a> <a href="/tags/framework/" style="font-size: 10.77px;">framework</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/hadoop/" style="font-size: 14.62px;">hadoop</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/jni/" style="font-size: 16.15px;">jni</a> <a href="/tags/linux/" style="font-size: 16.15px;">linux</a> <a href="/tags/mysql/" style="font-size: 11.54px;">mysql</a> <a href="/tags/redis/" style="font-size: 13.08px;">redis</a> <a href="/tags/spring/" style="font-size: 10.77px;">spring</a> <a href="/tags/sqlite/" style="font-size: 10px;">sqlite</a> <a href="/tags/web后端/" style="font-size: 18.46px;">web后端</a> <a href="/tags/内存缓存/" style="font-size: 10px;">内存缓存</a> <a href="/tags/前端/" style="font-size: 13.85px;">前端</a> <a href="/tags/反射/" style="font-size: 10px;">反射</a> <a href="/tags/反编译/" style="font-size: 10px;">反编译</a> <a href="/tags/图片选择/" style="font-size: 10.77px;">图片选择</a> <a href="/tags/多线程/" style="font-size: 17.69px;">多线程</a> <a href="/tags/布局/" style="font-size: 12.31px;">布局</a> <a href="/tags/布局优化/" style="font-size: 10.77px;">布局优化</a> <a href="/tags/开源/" style="font-size: 10.77px;">开源</a> <a href="/tags/断点续传/" style="font-size: 11.54px;">断点续传</a> <a href="/tags/科学上网/" style="font-size: 10px;">科学上网</a> <a href="/tags/自定义控件/" style="font-size: 10px;">自定义控件</a> <a href="/tags/解决方案/" style="font-size: 16.92px;">解决方案</a> <a href="/tags/设计模式/" style="font-size: 15.38px;">设计模式</a> <a href="/tags/译文/" style="font-size: 11.54px;">译文</a> <a href="/tags/读书笔记/" style="font-size: 10.77px;">读书笔记</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">友情链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://blog.daimajia.com">代码家</a>
                    </li>
                
                    <li>
                        <a href="http://www.trinea.cn">Trinea</a>
                    </li>
                
                    <li>
                        <a href="https://www.aswifter.com">APP开发者</a>
                    </li>
                
                    <li>
                        <a href="http://blog.seoui.com">笑松小站</a>
                    </li>
                
                    <li>
                        <a href="http://www.apkfuns.com">舞影凌风</a>
                    </li>
                
                    <li>
                        <a href="http://www.ttfde.org">TTF的家园</a>
                    </li>
                
                    <li>
                        <a href="http://rocko.xyz">Rocko&#39;s blog</a>
                    </li>
                
                    <li>
                        <a href="http://www.lcode.org">江清清技术专栏</a>
                    </li>
                
                    <li>
                        <a href="http://www.deanhan.cn">逐梦博客</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2016 Lauren<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
             &nbsp;粤ICP备15082212号-2 &nbsp;
			<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1256697778'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1256697778%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
        </div>
    </div>
</footer>
        
    
    <script type="text/javascript">
    var duoshuoQuery = {short_name:'liuling123'};
    (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
    || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>



    
        <script src="/vendor/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js" type="text/javascript"></script>

    </div>
</body>
</html>