<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>残剑博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Hexo theme - Icarus">
<meta property="og:type" content="website">
<meta property="og:title" content="残剑博客">
<meta property="og:url" content="http://liuling07.github.io/page/6/index.html">
<meta property="og:site_name" content="残剑博客">
<meta property="og:description" content="Hexo theme - Icarus">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="残剑博客">
<meta name="twitter:description" content="Hexo theme - Icarus">
  
  
    <link rel="icon" href="favicon.png">
  
  
 <link href='//fonts.lug.ustc.edu.cn/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
 <link href="//fonts.lug.ustc.edu.cn/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">


  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css" type="text/css">
  

  

  
</head>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo"><i class="logo" style="background-image: url(/css/images/logo.png)"></i><span class="site-title">残剑博客</span></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/.">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="/css/images/protrait.jpg"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
      
      <div id="search-form-wrap">
        
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="http://liuling07.github.io"></form>
        
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
        
          <td><a class="main-nav-link" href="/.">Home</a></td>
        
          <td><a class="main-nav-link" href="/archives">Archives</a></td>
        
          <td><a class="main-nav-link" href="/categories">Categories</a></td>
        
          <td><a class="main-nav-link" href="/tags">Tags</a></td>
        
          <td><a class="main-nav-link" href="/about">About</a></td>
        
        <td>
          
            <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://liuling07.github.io"></form>
          
        </td>
      </tr>
    </table>
  </div>
</header>

    <div class="outer">
      
        <aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      <img id="avatar" src="/css/images/protrait.jpg">
      <h2 id="name">Lauren</h2>
      <h3 id="title">Android Developer</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Shenzhen, China</span>
      <a id="follow" href="https://github.com/liuling07">FOLLOW</a>
    </div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        135
        <span>posts</span>
      </div>
      <div class="article-info-block">
        32
        <span>tags</span>
      </div>
    </div>
    
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
          
          <td><a href="https://github.com/liuling07" target="_blank" title="github"><i class="fa fa-github"></i></a></td>
          
          <td><a href="http://weibo.com/LaurenLiuling/" target="_blank" title="weibo"><i class="fa fa-weibo"></i></a></td>
          
          <td><a href="https://plus.google.com/u/0/107098505138563589748/" target="_blank" title="google-plus"><i class="fa fa-google-plus"></i></a></td>
          
          <td><a href="http://stackoverflow.com/users/5629327/lauren-liuling" target="_blank" title="stack-overflow"><i class="fa fa-stack-overflow"></i></a></td>
          
          <td><a href="https://twitter.com/lauren_liuLing/" target="_blank" title="twitter"><i class="fa fa-twitter"></i></a></td>
          
          <td><a href="https://www.facebook.com/lauren.liuling/" target="_blank" title="facebook"><i class="fa fa-facebook"></i></a></td>
          
          <td><a href="/atom.xml" target="_blank" title="rss"><i class="fa fa-rss"></i></a></td>
          
        </tr>
      </table>
    </div>
    
    
  </div>
</aside>

      
      <section id="main">
      <article id="post-reentrantreadwritelock" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/08/reentrantreadwritelock.html">ReentrantReadWriteLock读写锁的使用</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/08/reentrantreadwritelock.html">
      <time datetime="2013-08-20T19:12:00.000Z" itemprop="datePublished">2013-08-21</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Java基础/">Java基础</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　Lock比传统线程模型中的synchronized方式更加面向对象，与生活中的锁类似，锁本身也应该是一个对象。两个线程执行的代码片段要实现同步互斥的效果，它们必须用同一个Lock对象。</p>
<p>　　读写锁：分为读锁和写锁，多个读锁不互斥，读锁与写锁互斥，这是由jvm自己控制的，你只要上好相应的锁即可。如果你的代码只读数据，可以很多人同时读，但不能同时写，那就上读锁；如果你的代码修改数据，只能有一个人在写，且不能同时读取，那就上写锁。总之，读的时候上读锁，写的时候上写锁！</p>
<p>　　<span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">ReentrantReadWriteLock会使用两把锁来解决问题，一个读锁，一个写锁</span><br><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">线程进入读锁的前提条件：</span><br><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp; 没有其他线程的写锁，</span><br><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp; 没有写请求或者有写请求，但调用线程和持有锁的线程是同一个</span></p>
<p><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">线程进入写锁的前提条件：</span><br><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp; 没有其他线程的读锁</span><br><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp; 没有其他线程的写锁</span></p>
<p><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">到ReentrantReadWriteLock，首先要做的是与ReentrantLock划清界限。它和后者都是单独的实现，彼此之间没有继承或实现的关系。然后就是总结这个锁机制的特性了：&nbsp;</span><br><span style="font: 14px/25px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp; &nbsp; &nbsp;(a).重入方面其内部的WriteLock可以获取ReadLock，但是反过来ReadLock想要获得WriteLock则永远都不要想。&nbsp;</span><br><span style="font: 14px/25px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp; &nbsp; &nbsp;(b).WriteLock可以降级为ReadLock，顺序是：先获得WriteLock再获得ReadLock，然后释放WriteLock，这时候线程将保持Readlock的持有。反过来ReadLock想要升级为WriteLock则不可能，为什么？参看(a)，呵呵.&nbsp;</span><br><span style="font: 14px/25px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp; (c).ReadLock可以被多个线程持有并且在作用时排斥任何的WriteLock，而WriteLock则是完全的互斥。这一特性最为重要，因为对于高读取频率而相对较低写入的数据结构，使用此类锁同步机制则可以提高并发量。&nbsp;</span><br><span style="font: 14px/25px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp; (d).不管是ReadLock还是WriteLock都支持Interrupt，语义与ReentrantLock一致。&nbsp;</span><br><span style="font: 14px/25px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;&nbsp;&nbsp;&nbsp; (e).WriteLock支持Condition并且与ReentrantLock语义一致，而ReadLock则不能使用Condition，否则抛出UnsupportedOperationException异常。&nbsp;</span></span></p>
<p><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">下面看一个读写锁的例子：</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.thread;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Random;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.locks.ReentrantReadWriteLock;<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ReadWriteLockTest {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">final</span> Queue3 q3 = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Queue3();<br></span><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i=0;i<3;i++<span style="color: #000000;">)<br><span style="color: #008080;">10</span> <span style="color: #000000;">        {<br></span><span style="color: #008080;">11</span>             <span style="color: #0000ff;">new</span><span style="color: #000000;"> Thread(){<br></span><span style="color: #008080;">12</span>                 <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run(){<br></span><span style="color: #008080;">13</span>                     <span style="color: #0000ff;">while</span>(<span style="color: #0000ff;">true</span><span style="color: #000000;">){<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">                        q3.get();<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span> <span style="color: #000000;">            }.start();<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">20</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i=0;i<3;i++<span style="color: #000000;">)<br><span style="color: #008080;">21</span> <span style="color: #000000;">        {<br></span><span style="color: #008080;">22</span>             <span style="color: #0000ff;">new</span><span style="color: #000000;"> Thread(){<br></span><span style="color: #008080;">23</span>                 <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run(){<br></span><span style="color: #008080;">24</span>                     <span style="color: #0000ff;">while</span>(<span style="color: #0000ff;">true</span><span style="color: #000000;">){<br></span><span style="color: #008080;">25</span>                         q3.put(<span style="color: #0000ff;">new</span> Random().nextInt(10000<span style="color: #000000;">));<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> <span style="color: #000000;">            }.start();<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">        }<br><br></span><span style="color: #008080;">31</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">33</span><br><span style="color: #008080;">34</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Queue3{<br></span><span style="color: #008080;">35</span>     <span style="color: #0000ff;">private</span> Object data = <span style="color: #0000ff;">null</span>;<span style="color: #008000;">//</span><span style="color: #008000;">共享数据，只能有一个线程能写该数据，但可以有多个线程同时读该数据。</span><br><span style="color: #008080;">36</span>     <span style="color: #0000ff;">private</span> ReentrantReadWriteLock rwl = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ReentrantReadWriteLock();<br></span><span style="color: #008080;">37</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> get(){<br></span><span style="color: #008080;">38</span>         rwl.readLock().lock();<span style="color: #008000;">//</span><span style="color: #008000;">上读锁，其他线程只能读不能写</span><br><span style="color: #008080;">39</span>         System.out.println(Thread.currentThread().getName() + “ be ready to read data!”<span style="color: #000000;">);<br></span><span style="color: #008080;">40</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">41</span>             Thread.sleep((<span style="color: #0000ff;">long</span>)(Math.random()<em>1000<span style="color: #000000;">));<br></span><span style="color: #008080;">42</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">45</span>         System.out.println(Thread.currentThread().getName() + “have read data :” +<span style="color: #000000;"> data);<br></span><span style="color: #008080;">46</span>         rwl.readLock().unlock(); <span style="color: #008000;">//</span><span style="color: #008000;">释放读锁，最好放在finnaly里面</span><br><span style="color: #008080;">47</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">48</span><br><span style="color: #008080;">49</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> put(Object data){<br></span><span style="color: #008080;">50</span><br><span style="color: #008080;">51</span>         rwl.writeLock().lock();<span style="color: #008000;">//</span><span style="color: #008000;">上写锁，不允许其他线程读也不允许写</span><br><span style="color: #008080;">52</span>         System.out.println(Thread.currentThread().getName() + “ be ready to write data!”<span style="color: #000000;">);<br></span><span style="color: #008080;">53</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">54</span>             Thread.sleep((<span style="color: #0000ff;">long</span>)(Math.random()</em>1000<span style="color: #000000;">));<br></span><span style="color: #008080;">55</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;">56</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;">57</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">58</span>         <span style="color: #0000ff;">this</span>.data =<span style="color: #000000;"> data;<br></span><span style="color: #008080;">59</span>         System.out.println(Thread.currentThread().getName() + “ have write data: “ +<span style="color: #000000;"> data);<br></span><span style="color: #008080;">60</span><br><span style="color: #008080;">61</span>         rwl.writeLock().unlock();<span style="color: #008000;">//</span><span style="color: #008000;">释放写锁    </span><br><span style="color: #008080;">62</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">63</span> }</3;i++<span></3;i++<span></pre><br></div>

<p>&nbsp;</p>
<div class="cnblogs_code"><br><pre>Thread-0 be ready to read data!<span style="color: #000000;"><br>Thread</span>-1 be ready to read data!<span style="color: #000000;"><br>Thread</span>-2 be ready to read data!<span style="color: #000000;"><br>Thread</span>-0have read data :<span style="color: #0000ff;">null</span><span style="color: #000000;"><br>Thread</span>-2have read data :<span style="color: #0000ff;">null</span><span style="color: #000000;"><br>Thread</span>-1have read data :<span style="color: #0000ff;">null</span><span style="color: #000000;"><br>Thread</span>-5 be ready to write data!<span style="color: #000000;"><br>Thread</span>-5 have write data: 6934<span style="color: #000000;"><br>Thread</span>-5 be ready to write data!<span style="color: #000000;"><br>Thread</span>-5 have write data: 8987<span style="color: #000000;"><br>Thread</span>-5 be ready to write data!<span style="color: #000000;"><br>Thread</span>-5 have write data: 8496</pre><br></div>

<p><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">下面使用读写锁模拟一个缓存器：</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.thread;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.HashMap;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Map;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.locks.ReadWriteLock;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.locks.ReentrantReadWriteLock;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> CacheDemo {<br></span><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">private</span> Map<string, object=""> map = <span style="color: #0000ff;">new</span> HashMap<string, object="">();<span style="color: #008000;">//</span><span style="color: #008000;">缓存器</span><br><span style="color: #008080;">10</span>     <span style="color: #0000ff;">private</span> ReadWriteLock rwl = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ReentrantReadWriteLock();<br></span><span style="color: #008080;">11</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">14</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Object get(String id){<br></span><span style="color: #008080;">15</span>         Object value = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">16</span>         rwl.readLock().lock();<span style="color: #008000;">//</span><span style="color: #008000;">首先开启读锁，从缓存中去取</span><br><span style="color: #008080;">17</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;">{<br></span><span style="color: #008080;">18</span>             value =<span style="color: #000000;"> map.get(id);<br></span><span style="color: #008080;">19</span>             <span style="color: #0000ff;">if</span>(value == <span style="color: #0000ff;">null</span>){  <span style="color: #008000;">//</span><span style="color: #008000;">如果缓存中没有释放读锁，上写锁</span><br><span style="color: #008080;">20</span> <span style="color: #000000;">                rwl.readLock().unlock();<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">                rwl.writeLock().lock();<br></span><span style="color: #008080;">22</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;">{<br></span><span style="color: #008080;">23</span>                     <span style="color: #0000ff;">if</span>(value == <span style="color: #0000ff;">null</span><span style="color: #000000;">){<br></span><span style="color: #008080;">24</span>                         value = “aaa”;  <span style="color: #008000;">//</span><span style="color: #008000;">此时可以去数据库中查找，这里简单的模拟一下</span><br><span style="color: #008080;">25</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">26</span>                 }<span style="color: #0000ff;">finally</span><span style="color: #000000;">{<br></span><span style="color: #008080;">27</span>                     rwl.writeLock().unlock(); <span style="color: #008000;">//</span><span style="color: #008000;">释放写锁</span><br><span style="color: #008080;">28</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">29</span>                 rwl.readLock().lock(); <span style="color: #008000;">//</span><span style="color: #008000;">然后再上读锁</span><br><span style="color: #008080;">30</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">31</span>         }<span style="color: #0000ff;">finally</span><span style="color: #000000;">{<br></span><span style="color: #008080;">32</span>             rwl.readLock().unlock(); <span style="color: #008000;">//</span><span style="color: #008000;">最后释放读锁</span><br><span style="color: #008080;">33</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">34</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> value;<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">36</span><br><span style="color: #008080;">37</span> }</string,></string,></pre><br></div>

<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/08/reentrantreadwritelock.html" data-id="ciiy5f4qm002sq1d0v8l4cjs4" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/08/reentrantreadwritelock.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多线程/">多线程</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-exchanger-demo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/08/exchanger-demo.html">Exchanger的使用</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/08/exchanger-demo.html">
      <time datetime="2013-08-20T18:33:00.000Z" itemprop="datePublished">2013-08-21</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Java基础/">Java基础</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　两个线程可以交换对象的同步点。每个线程都在进入 <code>exchange</code>方法时给出某个对象，并接受其他线程返回时给出的对象。</p>
<div class="O1">　　用于实现两个人之间的数据交换，每个人在完成一定的事务后想与对方交换数据，第一个先拿出数据的人将一直等待第二个人拿着数据到来时，才能彼此交换数据。</div><br><div class="O1"><br><table style="width: 100%;" summary="" border="1" cellspacing="0" cellpadding="3"><br><tbody><br><tr class="TableHeadingColor" bgcolor="#ccccff"><th colspan="2" align="left"><span style="font-size: 14px;"><strong>构造方法摘要</strong></span></th></tr><br><tr class="TableRowColor" bgcolor="white"><br><td><span style="font-size: 14px;"><code>**[Exchanger](http://www.cnblogs.com/java/util/concurrent/Exchanger.html#Exchanger())**()</code> </span><br><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 创建一个新的 Exchanger。</span></td><br><br></tr><br><br></tbody><br><br></table><br><br>&nbsp; </div><br><div class="O1"><!-- ========== METHOD SUMMARY =========== --><!-- --><br><table style="width: 100%;" summary="" border="1" cellspacing="0" cellpadding="3"><br><tbody><br><tr class="TableHeadingColor" bgcolor="#ccccff"><th colspan="2" align="left"><span style="font-size: 14px;"><strong>方法摘要</strong></span></th></tr><br><tr class="TableRowColor" bgcolor="white"><br><td align="right" valign="top" width="1%"><span style="font-size: 14px;"><code>[V](http://www.cnblogs.com/java/util/concurrent/Exchanger.html &quot;Exchanger 中的类型参数&quot;)</code></span></td><br><td><span style="font-size: 14px;"><code>**[exchange](http://www.cnblogs.com/java/util/concurrent/Exchanger.html#exchange(V))**([V](http://www.cnblogs.com/java/util/concurrent/Exchanger.html &quot;Exchanger 中的类型参数&quot;) x)</code> </span><br><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 等待另一个线程到达此交换点（除非它被<a href="http://www.cnblogs.com/java/lang/Thread.html#interrupt(" target="_blank" rel="external"><code>中断</code></a>)），然后将给定的对象传送给该线程，并接收该线程的对象。</span></td><br><br></tr><br><tr class="TableRowColor" bgcolor="white"><br><td align="right" valign="top" width="1%"><span style="font-size: 14px;"><code>[V](http://www.cnblogs.com/java/util/concurrent/Exchanger.html &quot;Exchanger 中的类型参数&quot;)</code></span></td><br><td><span style="font-size: 14px;"><code>**[exchange](http://www.cnblogs.com/java/util/concurrent/Exchanger.html#exchange(V, long, java.util.concurrent.TimeUnit))**([V](http://www.cnblogs.com/java/util/concurrent/Exchanger.html &quot;Exchanger 中的类型参数&quot;) x, long timeout, [TimeUnit](http://www.cnblogs.com/java/util/concurrent/TimeUnit.html &quot;java.util.concurrent 中的枚举&quot;) unit)</code> </span><br><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 等待另一个线程到达此交换点（除非它被<a href="http://www.cnblogs.com/java/lang/Thread.html#interrupt(" target="_blank" rel="external"><code>中断</code></a>)，或者超出了指定的等待时间），然后将给定的对象传送给该线程，同时接收该线程的对象。</span></td><br><br></tr><br><br></tbody><br><br></table><br></div><br><div class="O1">&nbsp;</div><br><div class="O1"><br><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.thread;<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Exchanger;<br></span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.ExecutorService;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Executors;<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ExchangerTest {<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;"> 9</span>         ExecutorService service =<span style="color: #000000;"> Executors.newCachedThreadPool();<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">final</span> Exchanger exchanger = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Exchanger();<br></span><span style="color: #008080;">11</span>         service.execute(<span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable(){<br></span><span style="color: #008080;">12</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;">13</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">14</span>                     Thread.sleep((<span style="color: #0000ff;">long</span>)(Math.random()<em>10000<span style="color: #000000;">));<br></span><span style="color: #008080;">15</span>                     String data1 = “zxx”<span style="color: #000000;">;<br></span><span style="color: #008080;">16</span>                     System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">17</span>                     “正在把数据” + data1 +”换出去”<span style="color: #000000;">);<br></span><span style="color: #008080;">18</span>                     String data2 =<span style="color: #000000;"> (String)exchanger.exchange(data1);<br></span><span style="color: #008080;">19</span>                     System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">20</span>                     “换回的数据为” +<span style="color: #000000;"> data2);<br></span><span style="color: #008080;">21</span>                 }<span style="color: #0000ff;">catch</span><span style="color: #000000;">(Exception e){<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">26</span>         service.execute(<span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable(){<br></span><span style="color: #008080;">27</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;">28</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">29</span>                     Thread.sleep((<span style="color: #0000ff;">long</span>)(Math.random()</em>10000<span style="color: #000000;">));<br></span><span style="color: #008080;">30</span>                     String data1 = “lhm”<span style="color: #000000;">;<br></span><span style="color: #008080;">31</span>                     System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">32</span>                     “正在把数据” + data1 +”换出去”<span style="color: #000000;">);<br></span><span style="color: #008080;">33</span>                     String data2 =<span style="color: #000000;"> (String)exchanger.exchange(data1);<br></span><span style="color: #008080;">34</span>                     System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">35</span>                     “换回的数据为” +<span style="color: #000000;"> data2);<br></span><span style="color: #008080;">36</span>                 }<span style="color: #0000ff;">catch</span><span style="color: #000000;">(Exception e){<br></span><span style="color: #008080;">37</span><br><span style="color: #008080;">38</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">41</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">42</span> }</pre><br></div>

<p>运行结果如下：</p>
<div class="cnblogs_code"><br><pre>线程pool-1-thread-<span style="color: #000000;">1正在把数据zxx换出去<br>线程pool</span>-1-thread-<span style="color: #000000;">2正在把数据lhm换出去<br>线程pool</span>-1-thread-<span style="color: #000000;">1换回的数据为lhm<br>线程pool</span>-1-thread-2换回的数据为zxx</pre><br></div>

<p>&nbsp;</p>
<p></p></div><p></p>
<div class="O1">&nbsp;</div><br><div class="O1">&nbsp;</div><br><div class="O1">&nbsp;</div>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/08/exchanger-demo.html" data-id="ciiy5f4w200bfq1d0t4h4f555" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/08/exchanger-demo.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多线程/">多线程</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-cyclicbarrier-demo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/08/cyclicbarrier-demo.html">CyclicBarrier的用法</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/08/cyclicbarrier-demo.html">
      <time datetime="2013-08-20T18:10:00.000Z" itemprop="datePublished">2013-08-21</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Java基础/">Java基础</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　CyclicBarrier是一个同步辅助类，它允许一组线程互相等待，直到到达某个公共屏障点 (common barrier point)。在涉及一组固定大小的线程的程序中，这些线程必须不时地互相等待，此时 CyclicBarrier 很有用。因为该 barrier 在释放等待线程后可以重用，所以称它为<em>循环</em> 的 barrier。</p>
<p>　　CyclicBarrier类似于CountDownLatch也是个计数器， 不同的是CyclicBarrier数的是调用了CyclicBarrier.await()进入等待的线程数， 当线程数达到了CyclicBarrier初始时规定的数目时，所有进入等待状态的线程被唤醒并继续。 CyclicBarrier就象它名字的意思一样，可看成是个障碍， 所有的线程必须到齐后才能一起通过这个障碍。 CyclicBarrier初始时还可带一个Runnable的参数，此Runnable任务在CyclicBarrier的数目达到后，所有其它线程被唤醒前被执行。</p>
<table style="width: 100%;" summary="" border="1" cellspacing="0" cellpadding="3"><br><tbody><br><tr class="TableHeadingColor" bgcolor="#ccccff"><th colspan="2" align="left"><span style="font-size: 14px;"><strong>构造方法摘要</strong></span></th></tr><br><tr class="TableRowColor" bgcolor="white"><br><td><span style="font-size: 14px;"><code>**[CyclicBarrier](http://www.cnblogs.com/java/util/concurrent/CyclicBarrier.html#CyclicBarrier(int))**(int parties)</code> </span><br><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 创建一个新的 <tt>CyclicBarrier</tt>，它将在给定数量的参与者（线程）处于等待状态时启动，但它不会在每个  barrier 上执行预定义的操作。</span></td><br><br></tr><br><tr class="TableRowColor" bgcolor="white"><br><td><span style="font-size: 14px;"><code>**[CyclicBarrier](http://www.cnblogs.com/java/util/concurrent/CyclicBarrier.html#CyclicBarrier(int, java.lang.Runnable))**(int parties,  [Runnable](http://www.cnblogs.com/java/lang/Runnable.html &quot;java.lang 中的接口&quot;) barrierAction)</code> </span><br><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 创建一个新的 <tt>CyclicBarrier</tt>，它将在给定数量的参与者（线程）处于等待状态时启动，并在启动  barrier 时执行给定的屏障操作，该操作由最后一个进入 barrier 的线程执行</span></td><br><br></tr><br><br></tbody><br><br></table>

<p>&nbsp;</p>
<table style="width: 100%;" summary="" border="1" cellspacing="0" cellpadding="3"><br><tbody><br><tr class="TableHeadingColor" bgcolor="#ccccff"><th colspan="2" align="left"><span style="font-size: 14px;"><strong>方法摘要</strong></span></th></tr><br><tr class="TableRowColor" bgcolor="white"><br><td align="right" valign="top" width="1%"><span style="font-size: 14px;"><code>int</code></span></td><br><td><span style="font-size: 14px;"><code>**[await](http://www.cnblogs.com/java/util/concurrent/CyclicBarrier.html#await())**()</code> </span><br><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在所有<a href="http://www.cnblogs.com/java/util/concurrent/CyclicBarrier.html#getParties(" target="_blank" rel="external"><code>参与者</code></a>)都已经在此  barrier 上调用 <tt>await</tt> 方法之前，将一直等待。</span></td><br><br></tr><br><tr class="TableRowColor" bgcolor="white"><br><td align="right" valign="top" width="1%"><span style="font-size: 14px;"><code>int</code></span></td><br><td><span style="font-size: 14px;"><code>**[await](http://www.cnblogs.com/java/util/concurrent/CyclicBarrier.html#await(long, java.util.concurrent.TimeUnit))**(long timeout,  [TimeUnit](http://www.cnblogs.com/java/util/concurrent/TimeUnit.html &quot;java.util.concurrent 中的枚举&quot;) unit)</code> </span><br><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在所有<a href="http://www.cnblogs.com/java/util/concurrent/CyclicBarrier.html#getParties(" target="_blank" rel="external"><code>参与者</code></a>)都已经在此屏障上调用  <tt>await</tt> 方法之前，将一直等待。</span></td><br><br></tr><br><tr class="TableRowColor" bgcolor="white"><br><td align="right" valign="top" width="1%"><span style="font-size: 14px;"><code>int</code></span></td><br><td><span style="font-size: 14px;"><code>**[getNumberWaiting](http://www.cnblogs.com/java/util/concurrent/CyclicBarrier.html#getNumberWaiting())**()</code> </span><br><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 返回当前在屏障处等待的参与者数目。</span></td><br><br></tr><br><tr class="TableRowColor" bgcolor="white"><br><td align="right" valign="top" width="1%"><span style="font-size: 14px;"><code>int</code></span></td><br><td><span style="font-size: 14px;"><code>**[getParties](http://www.cnblogs.com/java/util/concurrent/CyclicBarrier.html#getParties())**()</code> </span><br><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 返回要求启动此 barrier 的参与者数目。</span></td><br><br></tr><br><tr class="TableRowColor" bgcolor="white"><br><td align="right" valign="top" width="1%"><span style="font-size: 14px;"><code>boolean</code></span></td><br><td><span style="font-size: 14px;"><code>**[isBroken](http://www.cnblogs.com/java/util/concurrent/CyclicBarrier.html#isBroken())**()</code> </span><br><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 查询此屏障是否处于损坏状态。</span></td><br><br></tr><br><tr class="TableRowColor" bgcolor="white"><br><td align="right" valign="top" width="1%"><span style="font-size: 14px;"><code>void</code></span></td><br><td><span style="font-size: 14px;"><code>**[reset](http://www.cnblogs.com/java/util/concurrent/CyclicBarrier.html#reset())**()</code> </span><br><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 将屏障重置为其初始状态。</span></td><br><br></tr><br><br></tbody><br><br></table>

<p>&nbsp;</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.thread;<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.CyclicBarrier;<br></span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.ExecutorService;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Executors;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Semaphore;<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> CyclicBarrierTest {<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;">10</span>         ExecutorService service =<span style="color: #000000;"> Executors.newCachedThreadPool();<br></span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">final</span>  CyclicBarrier cb = <span style="color: #0000ff;">new</span> CyclicBarrier(3);<span style="color: #008000;">//</span><span style="color: #008000;">创建CyclicBarrier对象并设置3个公共屏障点</span><br><span style="color: #008080;">12</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i=0;i<3;i++<span style="color: #000000;">){<br><span style="color: #008080;">13</span>             Runnable runnable = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable(){<br></span><span style="color: #008080;">14</span>                     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run(){<br></span><span style="color: #008080;">15</span>                     <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">16</span>                         Thread.sleep((<span style="color: #0000ff;">long</span>)(Math.random()<em>10000<span style="color: #000000;">));<br></span><span style="color: #008080;">17</span>                         System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">18</span>                                 “即将到达集合地点1，当前已有” + cb.getNumberWaiting() + “个已经到达，正在等候”<span style="color: #000000;">);<br></span><span style="color: #008080;">19</span>                         cb.await();<span style="color: #008000;">//</span><span style="color: #008000;">到此如果没有达到公共屏障点，则该线程处于等待状态，如果达到公共屏障点则所有处于等待的线程都继续往下运行</span><br><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>                         Thread.sleep((<span style="color: #0000ff;">long</span>)(Math.random()</em>10000<span style="color: #000000;">));<br></span><span style="color: #008080;">22</span>                         System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">23</span>                                 “即将到达集合地点2，当前已有” + cb.getNumberWaiting() + “个已经到达，正在等候”<span style="color: #000000;">);<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">                        cb.await();<br></span><span style="color: #008080;">25</span>                         Thread.sleep((<span style="color: #0000ff;">long</span>)(Math.random()*10000<span style="color: #000000;">));<br></span><span style="color: #008080;">26</span>                         System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">27</span>                                 “即将到达集合地点3，当前已有” + cb.getNumberWaiting() + “个已经到达，正在等候”<span style="color: #000000;">);<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">                        cb.await();<br></span><span style="color: #008080;">29</span>                     } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">                        e.printStackTrace();<br></span><span style="color: #008080;">31</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">            };<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">            service.execute(runnable);<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">        service.shutdown();<br></span><span style="color: #008080;">37</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">38</span> }</3;i++<span></pre><br></div><br><div class="cnblogs_code"><br><pre>线程pool-1-thread-<span style="color: #000000;">1即将到达集合地点1，当前已有0个已经到达，正在等候<br>线程pool</span>-1-thread-<span style="color: #000000;">3即将到达集合地点1，当前已有1个已经到达，正在等候<br>线程pool</span>-1-thread-<span style="color: #000000;">2即将到达集合地点1，当前已有2个已经到达，正在等候<br>线程pool</span>-1-thread-<span style="color: #000000;">3即将到达集合地点2，当前已有0个已经到达，正在等候<br>线程pool</span>-1-thread-<span style="color: #000000;">2即将到达集合地点2，当前已有1个已经到达，正在等候<br>线程pool</span>-1-thread-<span style="color: #000000;">1即将到达集合地点2，当前已有2个已经到达，正在等候<br>线程pool</span>-1-thread-<span style="color: #000000;">1即将到达集合地点3，当前已有0个已经到达，正在等候<br>线程pool</span>-1-thread-<span style="color: #000000;">3即将到达集合地点3，当前已有1个已经到达，正在等候<br>线程pool</span>-1-thread-2即将到达集合地点3，当前已有2个已经到达，正在等候</pre><br></div>

<p>&nbsp;</p>
<p>　　如果在构造CyclicBarrier对象的时候传了一个Runnable对象进去，则每次到达公共屏障点的时候都最先执行这个传进去的Runnable，然后再执行处于等待的Runnable。如果把上面的例子改成下面这样：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.thread;<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.CyclicBarrier;<br></span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.ExecutorService;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Executors;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Semaphore;<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> CyclicBarrierTest {<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;">10</span>         ExecutorService service =<span style="color: #000000;"> Executors.newCachedThreadPool();<br></span><span style="color: #008080;">11</span>         <span style="color: #008000;">//</span><span style="color: #008000;">final  CyclicBarrier cb = new CyclicBarrier(3);</span><span style="color: #008000;">//</span><span style="color: #008000;">创建CyclicBarrier对象并设置3个公共屏障点</span><br><span style="color: #008080;">12</span>         <span style="color: #0000ff;">final</span>  CyclicBarrier cb = <span style="color: #0000ff;">new</span> CyclicBarrier(3,<span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable(){<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">14</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;">15</span>                 System.out.println(“<strong><em>**</em></strong>我最先执行<strong><strong><em>*</em></strong></strong>“<span style="color: #000000;">);<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">18</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i=0;i<3;i++<span style="color: #000000;">){<br><span style="color: #008080;">19</span>             Runnable runnable = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable(){<br></span><span style="color: #008080;">20</span>                     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run(){<br></span><span style="color: #008080;">21</span>                     <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">22</span>                         Thread.sleep((<span style="color: #0000ff;">long</span>)(Math.random()<em>10000<span style="color: #000000;">));<br></span><span style="color: #008080;">23</span>                         System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">24</span>                                 “即将到达集合地点1，当前已有” + cb.getNumberWaiting() + “个已经到达，正在等候”<span style="color: #000000;">);<br></span><span style="color: #008080;">25</span>                         cb.await();<span style="color: #008000;">//</span><span style="color: #008000;">到此如果没有达到公共屏障点，则该线程处于等待状态，如果达到公共屏障点则所有处于等待的线程都继续往下运行</span><br><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span>                         Thread.sleep((<span style="color: #0000ff;">long</span>)(Math.random()</em>10000<span style="color: #000000;">));<br></span><span style="color: #008080;">28</span>                         System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">29</span>                                 “即将到达集合地点2，当前已有” + cb.getNumberWaiting() + “个已经到达，正在等候”<span style="color: #000000;">);<br></span><span style="color: #008080;">30</span>                         cb.await();    <span style="color: #008000;">//</span><span style="color: #008000;">这里CyclicBarrier对象又可以重用</span><br><span style="color: #008080;">31</span>                         Thread.sleep((<span style="color: #0000ff;">long</span>)(Math.random()*10000<span style="color: #000000;">));<br></span><span style="color: #008080;">32</span>                         System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">33</span>                                 “即将到达集合地点3，当前已有” + cb.getNumberWaiting() + “个已经到达，正在等候”<span style="color: #000000;">);<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">                        cb.await();<br></span><span style="color: #008080;">35</span>                     } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">                        e.printStackTrace();<br></span><span style="color: #008080;">37</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">38</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">            };<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">            service.execute(runnable);<br></span><span style="color: #008080;">41</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">        service.shutdown();<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">44</span> }</3;i++<span></pre><br></div>

<p>则结果如下：</p>
<div class="cnblogs_code"><br><pre>线程pool-1-thread-<span style="color: #000000;">1即将到达集合地点1，当前已有0个已经到达，正在等候<br>线程pool</span>-1-thread-<span style="color: #000000;">3即将到达集合地点1，当前已有1个已经到达，正在等候<br>线程pool</span>-1-thread-<span style="color: #000000;">2即将到达集合地点1，当前已有2个已经到达，正在等候<br></span><strong><em>**</em></strong>我最先执行<strong><strong><em>*</em></strong></strong><span style="color: #000000;"><br>线程pool</span>-1-thread-<span style="color: #000000;">1即将到达集合地点2，当前已有0个已经到达，正在等候<br>线程pool</span>-1-thread-<span style="color: #000000;">3即将到达集合地点2，当前已有1个已经到达，正在等候<br>线程pool</span>-1-thread-<span style="color: #000000;">2即将到达集合地点2，当前已有2个已经到达，正在等候<br></span><strong><em>**</em></strong>我最先执行<strong><strong><em>*</em></strong></strong><span style="color: #000000;"><br>线程pool</span>-1-thread-<span style="color: #000000;">1即将到达集合地点3，当前已有0个已经到达，正在等候<br>线程pool</span>-1-thread-<span style="color: #000000;">3即将到达集合地点3，当前已有1个已经到达，正在等候<br>线程pool</span>-1-thread-<span style="color: #000000;">2即将到达集合地点3，当前已有2个已经到达，正在等候<br></span><strong><em>**</em></strong>我最先执行<strong><strong><em>*</em></strong></strong></pre><br></div>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/08/cyclicbarrier-demo.html" data-id="ciiy5f4wv00ciq1d0nvw2p6fe" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/08/cyclicbarrier-demo.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多线程/">多线程</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-semaphore-demo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/08/semaphore-demo.html">Semaphore的使用</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/08/semaphore-demo.html">
      <time datetime="2013-08-20T07:20:00.000Z" itemprop="datePublished">2013-08-20</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Java基础/">Java基础</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　Semaphore也是一个线程同步的辅助类，可以维护当前访问自身的线程个数，并提供了同步机制。使用Semaphore可以控制同时访问资源的线程个数，例如，实现一个文件允许的并发访问数。</p>
<p><strong>Semaphore的主要方法摘要：</strong></p>
<p>　　void acquire()<code>**:**从此信号量获取一个许可，在提供一个许可前一直将线程阻塞，否则线程被中断。</code></p>
<p>　　void release():释放一个许可，将其返回给信号量。</p>
<p>　　int availablePermits():返回此信号量中当前可用的许可数。</p>
<p>　　boolean hasQueuedThreads():查询是否有线程正在等待获取。</p>
<p>下面是一个例子：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.thread;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.ExecutorService;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Executors;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Semaphore;<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> SemaphoreTest {<br></span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;"> 9</span>         ExecutorService service =<span style="color: #000000;"> Executors.newCachedThreadPool();<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">final</span>  Semaphore sp = <span style="color: #0000ff;">new</span> Semaphore(3);<span style="color: #008000;">//</span><span style="color: #008000;">创建Semaphore信号量，初始化许可大小为3</span><br><span style="color: #008080;">11</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i=0;i<10;i++<span style="color: #000000;">){<br><span style="color: #008080;">12</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">13</span>                 Thread.sleep(100<span style="color: #000000;">);<br></span><span style="color: #008080;">14</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e2) {<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">                e2.printStackTrace();<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">17</span>             Runnable runnable = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable(){<br></span><span style="color: #008080;">18</span>                     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run(){<br></span><span style="color: #008080;">19</span>                     <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">20</span>                         sp.acquire();<span style="color: #008000;">//</span><span style="color: #008000;">请求获得许可，如果有可获得的许可则继续往下执行，许可数减1。否则进入阻塞状态</span><br><span style="color: #008080;">21</span>                     } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e1) {<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">                        e1.printStackTrace();<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">24</span>                     System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">25</span>                             “进入，当前已有” + (3-sp.availablePermits()) + “个并发”<span style="color: #000000;">);<br></span><span style="color: #008080;">26</span>                     <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">27</span>                         Thread.sleep((<span style="color: #0000ff;">long</span>)(Math.random()*10000<span style="color: #000000;">));<br></span><span style="color: #008080;">28</span>                     } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">                        e.printStackTrace();<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">31</span>                     System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">32</span>                             “即将离开”<span style="color: #000000;">);<br></span><span style="color: #008080;">33</span>                     sp.release();<span style="color: #008000;">//</span><span style="color: #008000;">释放许可，许可数加1<br></span><span style="color: #008080;">34</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">下面代码有时候执行不准确，因为其没有和上面的代码合成原子单元</span><br><span style="color: #008080;">35</span>                     System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">36</span>                             “已离开，当前已有” + (3-sp.availablePermits()) + “个并发”<span style="color: #000000;">);<br></span><span style="color: #008080;">37</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">38</span> <span style="color: #000000;">            };<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">            service.execute(runnable);<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">41</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">42</span><br><span style="color: #008080;">43</span> }</10;i++<span></pre><br></div><br><div>　　</div><br><div>　　单个信号量的Semaphore对象可以实现互斥锁的功能，并且可以是由一个线程获得了&ldquo;锁&rdquo;，再由另一个线程释放&ldquo;锁&rdquo;，这可应用于死锁恢复的一些场合。</div><br><div><br><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.thread;<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.ExecutorService;<br></span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Executors;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Semaphore;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.locks.Lock;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.locks.ReentrantLock;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> LockTest {<br></span><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">final</span> Business business = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Business();<br></span><span style="color: #008080;">11</span>         ExecutorService executor =  Executors.newFixedThreadPool(3<span style="color: #000000;">);<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i=0;i<3;i++<span style="color: #000000;">)<br><span style="color: #008080;">13</span> <span style="color: #000000;">        {<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">            executor.execute(<br></span><span style="color: #008080;">15</span>                     <span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable()<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">                    {<br></span><span style="color: #008080;">17</span>                         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run()<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">                        {<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">                            business.service();<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">                        }<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> <span style="color: #000000;">            );<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">        executor.shutdown();<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">27</span><br><span style="color: #008080;">28</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Business<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">    {<br></span><span style="color: #008080;">30</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> count;<br></span><span style="color: #008080;">31</span>         Lock lock = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ReentrantLock();<br></span><span style="color: #008080;">32</span>         Semaphore sp = <span style="color: #0000ff;">new</span> Semaphore(1<span style="color: #000000;">);<br></span><span style="color: #008080;">33</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> service()<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">        {<br></span><span style="color: #008080;">35</span>             <span style="color: #008000;">//</span><span style="color: #008000;">lock.lock();</span><br><span style="color: #008080;">36</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">37</span>                 sp.acquire(); <span style="color: #008000;">//</span><span style="color: #008000;">当前线程使用count变量的时候将其锁住，不允许其他线程访问</span><br><span style="color: #008080;">38</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e1) {<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">                e1.printStackTrace();<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">41</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">42</span>                 count++<span style="color: #000000;">;<br></span><span style="color: #008080;">43</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">44</span>                     Thread.sleep(1000<span style="color: #000000;">);<br></span><span style="color: #008080;">45</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;">46</span> <span style="color: #000000;">                    e.printStackTrace();<br></span><span style="color: #008080;">47</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">48</span> <span style="color: #000000;">                System.out.println(count);<br></span><span style="color: #008080;">49</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (RuntimeException e) {<br></span><span style="color: #008080;">50</span> <span style="color: #000000;">                e.printStackTrace();<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">52</span>             <span style="color: #0000ff;">finally</span><br><span style="color: #008080;">53</span> <span style="color: #000000;">            {<br></span><span style="color: #008080;">54</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">lock.unlock();</span><br><span style="color: #008080;">55</span>                 sp.release();  <span style="color: #008000;">//</span><span style="color: #008000;">释放锁</span><br><span style="color: #008080;">56</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">57</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">58</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">59</span><br><span style="color: #008080;">60</span> }</3;i++<span></pre><br></div>

<p>&nbsp;</p>
<p></p></div><p></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/08/semaphore-demo.html" data-id="ciiy5f4qg002lq1d0hdsg09ad" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/08/semaphore-demo.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多线程/">多线程</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-countdownlatch-demo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/08/countdownlatch-demo.html">CountDownLatch的使用</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/08/countdownlatch-demo.html">
      <time datetime="2013-08-20T06:28:00.000Z" itemprop="datePublished">2013-08-20</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Java基础/">Java基础</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <div class="O1">　　CountDownLatch是一个同步辅助类，犹如倒计时计数器，创建对象时通过构造方法设置初始值，调用CountDownLatch对象的await()方法则处于等待状态，调用countDown()方法就将计数器减1，当计数到达0时，则所有等待者或单个等待者开始执行。</div><br><div class="O1">&nbsp;<br><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.thread;<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.CountDownLatch;<br></span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.CyclicBarrier;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.ExecutorService;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Executors;<br></span><span style="color: #008080;"> 6</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 7</span> <span style="color: #008000;"> <br></span><span style="color: #008080;"> 8</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> Administrator<br></span><span style="color: #008080;"> 9</span> <span style="color: #008000;"> 该程序用来模拟发送命令与执行命令，主线程代表指挥官，新建3个线程代表战士，战士一直等待着指挥官下达命令，<br></span><span style="color: #008080;">10</span> <span style="color: #008000;"> <em>若指挥官没有下达命令，则战士们都必须等待。一旦命令下达，战士们都去执行自己的任务，指挥官处于等待状态，战士们任务执行完毕则报告给<br></em></span><span style="color: #008080;">11</span> <span style="color: #008000;"> 指挥官，指挥官则结束等待。<br></span><span style="color: #008080;">12</span>  <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> CountdownLatchTest {<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;">16</span>         ExecutorService service = Executors.newCachedThreadPool(); <span style="color: #008000;">//</span><span style="color: #008000;">创建一个线程池</span><br><span style="color: #008080;">17</span>         <span style="color: #0000ff;">final</span> CountDownLatch cdOrder = <span style="color: #0000ff;">new</span> CountDownLatch(1);<span style="color: #008000;">//</span><span style="color: #008000;">指挥官的命令，设置为1，指挥官一下达命令，则cutDown,变为0，战士们执行任务</span><br><span style="color: #008080;">18</span>         <span style="color: #0000ff;">final</span> CountDownLatch cdAnswer = <span style="color: #0000ff;">new</span> CountDownLatch(3);<span style="color: #008000;">//</span><span style="color: #008000;">因为有三个战士，所以初始值为3，每一个战士执行任务完毕则cutDown一次，当三个都执行完毕，变为0，则指挥官停止等待。        </span><br><span style="color: #008080;">19</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i=0;i<3;i++<span style="color: #000000;">){<br><span style="color: #008080;">20</span>             Runnable runnable = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable(){<br></span><span style="color: #008080;">21</span>                     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run(){<br></span><span style="color: #008080;">22</span>                     <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">23</span>                         System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">24</span>                                 “正准备接受命令”<span style="color: #000000;">);<br></span><span style="color: #008080;">25</span>                         cdOrder.await(); <span style="color: #008000;">//</span><span style="color: #008000;">战士们都处于等待命令状态</span><br><span style="color: #008080;">26</span>                         System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">27</span>                         “已接受命令”<span style="color: #000000;">);<br></span><span style="color: #008080;">28</span>                         Thread.sleep((<span style="color: #0000ff;">long</span>)(Math.random()10000<span style="color: #000000;">));<br></span><span style="color: #008080;">29</span>                         System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">30</span>                                 “回应命令处理结果”<span style="color: #000000;">);<br></span><span style="color: #008080;">31</span>                         cdAnswer.countDown(); <span style="color: #008000;">//</span><span style="color: #008000;">任务执行完毕，返回给指挥官，cdAnswer减1。                    </span><br><span style="color: #008080;">32</span>                     } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">                        e.printStackTrace();<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">            };<br></span><span style="color: #008080;">37</span>             service.execute(runnable);<span style="color: #008000;">//</span><span style="color: #008000;">为线程池添加任务</span><br><span style="color: #008080;">38</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">39</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">40</span>             Thread.sleep((<span style="color: #0000ff;">long</span>)(Math.random()*10000<span style="color: #000000;">));<br></span><span style="color: #008080;">41</span><br><span style="color: #008080;">42</span>             System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">43</span>                     “即将发布命令”<span style="color: #000000;">);<br></span><span style="color: #008080;">44</span>             cdOrder.countDown(); <span style="color: #008000;">//</span><span style="color: #008000;">发送命令，cdOrder减1，处于等待的战士们停止等待转去执行任务。</span><br><span style="color: #008080;">45</span>             System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">46</span>             “已发送命令，正在等待结果”<span style="color: #000000;">);<br></span><span style="color: #008080;">47</span>             cdAnswer.await(); <span style="color: #008000;">//</span><span style="color: #008000;">命令发送后指挥官处于等待状态，一旦cdAnswer为0时停止等待继续往下执行</span><br><span style="color: #008080;">48</span>             System.out.println(“线程” + Thread.currentThread().getName() +<br><span style="color: #008080;">49</span>             “已收到所有响应结果”<span style="color: #000000;">);<br></span><span style="color: #008080;">50</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;">52</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">53</span>         service.shutdown(); <span style="color: #008000;">//</span><span style="color: #008000;">任务结束，停止线程池的所有线程</span><br><span style="color: #008080;">54</span><br><span style="color: #008080;">55</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">56</span> }</3;i++<span></pre><br></div>

<p>程序运行结果如下：</p>
<div class="cnblogs_code"><br><pre>线程pool-1-thread-<span style="color: #000000;">2正准备接受命令<br>线程pool</span>-1-thread-<span style="color: #000000;">3正准备接受命令<br>线程pool</span>-1-thread-<span style="color: #000000;">1正准备接受命令<br>线程main即将发布命令<br>线程pool</span>-1-thread-<span style="color: #000000;">2已接受命令<br>线程pool</span>-1-thread-<span style="color: #000000;">3已接受命令<br>线程pool</span>-1-thread-<span style="color: #000000;">1已接受命令<br>线程main已发送命令，正在等待结果<br>线程pool</span>-1-thread-<span style="color: #000000;">2回应命令处理结果<br>线程pool</span>-1-thread-<span style="color: #000000;">1回应命令处理结果<br>线程pool</span>-1-thread-<span style="color: #000000;">3回应命令处理结果<br>线程main已收到所有响应结果</span></pre><br></div>

<p>&nbsp;</p>
<p></p></div><p></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/08/countdownlatch-demo.html" data-id="ciiy5f4x700d3q1d0r5mx5638" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/08/countdownlatch-demo.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多线程/">多线程</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-blockingqueue-demo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/08/blockingqueue-demo.html">BlockingQueue的使用</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/08/blockingqueue-demo.html">
      <time datetime="2013-08-20T05:44:00.000Z" itemprop="datePublished">2013-08-20</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Java基础/">Java基础</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>本例介绍一个特殊的队列:BlockingQueue,如果BlockQueue是空的,从BlockingQueue取东西的操作将会被阻断进入等待状态,直到BlockingQueue进了东西才会被唤醒.同样,如果BlockingQueue是满的,任何试图往里存东西的操作也会被阻断进入等待状态,直到BlockingQueue里有空间才会被唤醒继续操作.<br>&nbsp;&nbsp;&nbsp; 使用BlockingQueue的关键技术点如下:<br>&nbsp;&nbsp;&nbsp; 1.BlockingQueue定义的常用方法如下:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1)add(anObject):把anObject加到BlockingQueue里,即如果BlockingQueue可以容纳,则返回true,否则报异常<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2)offer(anObject):表示如果可能的话,将anObject加到BlockingQueue里,即如果BlockingQueue可以容纳,则返回true,否则返回false.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3)put(anObject):把anObject加到BlockingQueue里,如果BlockQueue没有空间,则调用此方法的线程被阻断直到BlockingQueue里面有空间再继续.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4)poll(time):取走BlockingQueue里排在首位的对象,若不能立即取出,则可以等time参数规定的时间,取不到时返回null<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5)take():取走BlockingQueue里排在首位的对象,若BlockingQueue为空,阻断进入等待状态直到Blocking有新的对象被加入为止<br>&nbsp;&nbsp;&nbsp; 2.BlockingQueue有四个具体的实现类,根据不同需求,选择不同的实现类<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1)ArrayBlockingQueue:规定大小的BlockingQueue,其构造函数必须带一个int参数来指明其大小.其所含的对象是以FIFO(先入先出)顺序排序的.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2)LinkedBlockingQueue:大小不定的BlockingQueue,若其构造函数带一个规定大小的参数,生成的BlockingQueue有大小限制,若不带大小参数,所生成的BlockingQueue的大小由Integer.MAX_VALUE来决定.其所含的对象是以FIFO(先入先出)顺序排序的<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3)PriorityBlockingQueue:类似于LinkedBlockQueue,但其所含对象的排序不是FIFO,而是依据对象的自然排序顺序或者是构造函数的Comparator决定的顺序.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4)SynchronousQueue:特殊的BlockingQueue,对其的操作必须是放和取交替完成的.<br>&nbsp;&nbsp;&nbsp; 3.LinkedBlockingQueue和ArrayBlockingQueue比较起来,它们背后所用的数据结构不一样,导致LinkedBlockingQueue的数据吞吐量要大于ArrayBlockingQueue,但在线程数量很大时其性能的可预见性低于ArrayBlockingQueue.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
<p>　　下面是两个使用BlockingQueue的例子：&nbsp;&nbsp;</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.thread;<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.ArrayBlockingQueue;<br></span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.BlockingQueue;<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> BlockingQueueTest {<br></span><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">final</span> BlockingQueue queue = <span style="color: #0000ff;">new</span> ArrayBlockingQueue(3<span style="color: #000000;">);<br></span><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i=0;i<2;i++<span style="color: #000000;">){<br><span style="color: #008080;"> 9</span>             <span style="color: #0000ff;">new</span><span style="color: #000000;"> Thread(){<br></span><span style="color: #008080;">10</span>                 <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run(){<br></span><span style="color: #008080;">11</span>                     <span style="color: #0000ff;">while</span>(<span style="color: #0000ff;">true</span><span style="color: #000000;">){<br></span><span style="color: #008080;">12</span>                         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">13</span>                             Thread.sleep((<span style="color: #0000ff;">long</span>)(Math.random()*1000<span style="color: #000000;">));<br></span><span style="color: #008080;">14</span>                             System.out.println(Thread.currentThread().getName() + “准备放数据!”<span style="color: #000000;">);<br></span><span style="color: #008080;">15</span>                             queue.put(1<span style="color: #000000;">);<br></span><span style="color: #008080;">16</span>                             System.out.println(Thread.currentThread().getName() + “已经放了数据，” +<br><span style="color: #008080;">17</span>                                         “队列目前有” + queue.size() + “个数据”<span style="color: #000000;">);<br></span><span style="color: #008080;">18</span>                         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">                            e.printStackTrace();<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">                        }<br></span><span style="color: #008080;">21</span><br><span style="color: #008080;">22</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span> <span style="color: #000000;">            }.start();<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">27</span><br><span style="color: #008080;">28</span>         <span style="color: #0000ff;">new</span><span style="color: #000000;"> Thread(){<br></span><span style="color: #008080;">29</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run(){<br></span><span style="color: #008080;">30</span>                 <span style="color: #0000ff;">while</span>(<span style="color: #0000ff;">true</span><span style="color: #000000;">){<br></span><span style="color: #008080;">31</span>                     <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">32</span>                         <span style="color: #008000;">//</span><span style="color: #008000;">将此处的睡眠时间分别改为100和1000，观察运行结果</span><br><span style="color: #008080;">33</span>                         Thread.sleep(1000<span style="color: #000000;">);<br></span><span style="color: #008080;">34</span>                         System.out.println(Thread.currentThread().getName() + “准备取数据!”<span style="color: #000000;">);<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">                        queue.take();<br></span><span style="color: #008080;">36</span>                         System.out.println(Thread.currentThread().getName() + “已经取走数据，” +<br><span style="color: #008080;">37</span>                                 “队列目前有” + queue.size() + “个数据”<span style="color: #000000;">);<br></span><span style="color: #008080;">38</span>                     } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">                        e.printStackTrace();<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">41</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">43</span><br><span style="color: #008080;">44</span> <span style="color: #000000;">        }.start();<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">46</span> }</2;i++<span></pre><br></div>

<p>&nbsp;</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.thread;<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.ArrayBlockingQueue;<br></span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.BlockingQueue;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.ExecutorService;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Executors;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.locks.Condition;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.locks.Lock;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.locks.ReentrantLock;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> BlockingQueueCondition {<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;">13</span>         ExecutorService service =<span style="color: #000000;"> Executors.newSingleThreadExecutor();<br></span><span style="color: #008080;">14</span>         <span style="color: #0000ff;">final</span> Business3 business = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Business3();<br></span><span style="color: #008080;">15</span>         service.execute(<span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable(){<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;">18</span>                 <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i=0;i<50;i++<span style="color: #000000;">){<br><span style="color: #008080;">19</span> <span style="color: #000000;">                    business.sub();<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span>         <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i=0;i<50;i++<span style="color: #000000;">){<br><span style="color: #008080;">26</span> <span style="color: #000000;">            business.main();<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">29</span><br><span style="color: #008080;">30</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">31</span><br><span style="color: #008080;">32</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Business3{<br></span><span style="color: #008080;">33</span>     BlockingQueue subQueue = <span style="color: #0000ff;">new</span> ArrayBlockingQueue(1<span style="color: #000000;">);<br></span><span style="color: #008080;">34</span>     BlockingQueue mainQueue = <span style="color: #0000ff;">new</span> ArrayBlockingQueue(1<span style="color: #000000;">);<br></span><span style="color: #008080;">35</span>     <span style="color: #008000;">//</span><span style="color: #008000;">这里是匿名构造方法，只要new一个对象都会调用这个匿名构造方法，它与静态块不同，静态块只会执行一次，<br></span><span style="color: #008080;">36</span>     <span style="color: #008000;">//</span><span style="color: #008000;">在类第一次加载到JVM的时候执行<br></span><span style="color: #008080;">37</span>     <span style="color: #008000;">//</span><span style="color: #008000;">这里主要是让main线程首先put一个，就有东西可以取，如果不加这个匿名构造方法put一个的话程序就死锁了</span><br><span style="color: #008080;">38</span> <span style="color: #000000;">    {<br></span><span style="color: #008080;">39</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">40</span>             mainQueue.put(1<span style="color: #000000;">);<br></span><span style="color: #008080;">41</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">45</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> sub(){<br></span><span style="color: #008080;">46</span>         <span style="color: #0000ff;">try</span><br><span style="color: #008080;">47</span> <span style="color: #000000;">        {<br></span><span style="color: #008080;">48</span> <span style="color: #000000;">            mainQueue.take();<br></span><span style="color: #008080;">49</span>             <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i=0;i<10;i++<span style="color: #000000;">){<br><span style="color: #008080;">50</span>                 System.out.println(Thread.currentThread().getName() + “ : “ +<span style="color: #000000;"> i);<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">52</span>             subQueue.put(1<span style="color: #000000;">);<br></span><span style="color: #008080;">53</span>         }<span style="color: #0000ff;">catch</span><span style="color: #000000;">(Exception e){<br></span><span style="color: #008080;">54</span><br><span style="color: #008080;">55</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">56</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">57</span><br><span style="color: #008080;">58</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(){<br></span><span style="color: #008080;">59</span><br><span style="color: #008080;">60</span>         <span style="color: #0000ff;">try</span><br><span style="color: #008080;">61</span> <span style="color: #000000;">        {<br></span><span style="color: #008080;">62</span> <span style="color: #000000;">            subQueue.take();<br></span><span style="color: #008080;">63</span>             <span style="color: #0000ff;">for</span>(<span style="color: #0000ff;">int</span> i=0;i<5;i++<span style="color: #000000;">){<br><span style="color: #008080;">64</span>                 System.out.println(Thread.currentThread().getName() + “ : “ +<span style="color: #000000;"> i);<br></span><span style="color: #008080;">65</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">66</span>             mainQueue.put(1<span style="color: #000000;">);<br></span><span style="color: #008080;">67</span>         }<span style="color: #0000ff;">catch</span><span style="color: #000000;">(Exception e){<br></span><span style="color: #008080;">68</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">69</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">70</span> }</5;i++<span></10;i++<span></50;i++<span></50;i++<span></pre><br></div>

<p>&nbsp;</p>
<p>&nbsp;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/08/blockingqueue-demo.html" data-id="ciiy5f4xq00dvq1d068tbqog2" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/08/blockingqueue-demo.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多线程/">多线程</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-string-summarize" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/08/string-summarize.html">对字符串操作的各种笔试题</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/08/string-summarize.html">
      <time datetime="2013-08-11T01:00:00.000Z" itemprop="datePublished">2013-08-11</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Java基础/">Java基础</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　下面列出一些在笔试中常出现的对字符串操作的题目，都是本人自己写的，如果哪里不对或者有更好的实现欢迎大家指出！如果有其他题目也欢迎大家贴出来！谢谢！</p>
<p>一、实现字符串的反转，如输入”abc”，返回”cba”</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.others;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> 字符串反转 {<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;"> 6</span>         System.out.println(inverse(“liuling”<span style="color: #000000;">));<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> String inverse(String str){<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">char</span>[] chars = str.toCharArray(); <span style="color: #008000;">//</span><span style="color: #008000;">得到字符数组</span><br><span style="color: #008080;">11</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; chars.length/2; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;">12</span>             <span style="color: #0000ff;">char</span> temp =<span style="color: #000000;"> chars[i];<br></span><span style="color: #008080;">13</span>             chars[i] = chars[chars.length-i-1<span style="color: #000000;">];<br></span><span style="color: #008080;">14</span>             chars[chars.length-i-1] =<span style="color: #000000;"> temp;<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> String.copyValueOf(chars);<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span> }</pre><br></div>

<p>&nbsp;</p>
<p>二、找字符串中最长对称串</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.others;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> 找字符串中最长对称串 {<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;"> 7</span>         System.out.println(findSymmetry(“dgaabcddcbadfabcdefghijkkjihgfedcbagaaabbccddddccbbaaaf”<span style="color: #000000;">));<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 9</span>     <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">10</span> <span style="color: #008000;">      找最长对称字符串，应该重最大长度开始找，找到就返回<br></span><span style="color: #008080;">11</span> <span style="color: #008000;">     <em> 如果从最小开始找的话，效率好低，那找到一个还要继续找，直到找到最长的为止<br></em></span><span style="color: #008080;">12</span> <span style="color: #008000;">      如果找对称的个数的话那就另当别论了，必须得所有都判断<br></span><span style="color: #008080;">13</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">14</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> String findSymmetry(String str){<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        String symmetryStr;<br></span><span style="color: #008080;">16</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = str.length()-1; i &gt; 0; i–) { <span style="color: #008000;">//</span><span style="color: #008000;">找是否有长度为i的对称串，i从最大开始</span><br><span style="color: #008080;">17</span>             <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> j = 0; j<str.length() &&="" j+i<str.length();="" j++<span="" style="color: #000000;">) {<br><span style="color: #008080;">18</span>                 symmetryStr = str.substring(j, j+i+1<span style="color: #000000;">);<br></span><span style="color: #008080;">19</span>                 <span style="color: #0000ff;">char</span>[] chars =<span style="color: #000000;"> symmetryStr.toCharArray();<br></span><span style="color: #008080;">20</span>                 <span style="color: #0000ff;">int</span><span style="color: #000000;"> k;<br></span><span style="color: #008080;">21</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">判断是否为对称串</span><br><span style="color: #008080;">22</span>                 <span style="color: #0000ff;">for</span> (k = 0; k &lt; chars.length/2; k++<span style="color: #000000;">) {<br></span><span style="color: #008080;">23</span>                     <span style="color: #0000ff;">if</span>(chars[k] != chars[chars.length-k-1<span style="color: #000000;">]){<br></span><span style="color: #008080;">24</span>                         <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">27</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">如果对称则返回</span><br><span style="color: #008080;">28</span>                 <span style="color: #0000ff;">if</span>(k == chars.length/2<span style="color: #000000;">){<br></span><span style="color: #008080;">29</span>                     <span style="color: #0000ff;">return</span><span style="color: #000000;"> symmetryStr;<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">31</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">33</span>         <span style="color: #0000ff;">return</span> “”<span style="color: #000000;">;<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">35</span> }</str.length()></pre><br></div>

<p>&nbsp;</p>
<p>三、求字符串中对称串的个数</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.others;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> 求字符串中对称串的个数 {<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;"> 7</span>         System.out.println(findSymmetryCount(“aabbaaffddphpaffa”<span style="color: #000000;">));<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> findSymmetryCount(String str){<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">int</span> count = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">        String symmetryStr;<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 1; i &lt; str.length(); i++<span style="color: #000000;">) {<br></span><span style="color: #008080;">13</span>             <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> j = 0; j<str.length() &&="" j+i<str.length();="" j++<span="" style="color: #000000;">) {<br><span style="color: #008080;">14</span>                 symmetryStr = str.substring(j, j+i+1<span style="color: #000000;">);<br></span><span style="color: #008080;">15</span>                 <span style="color: #0000ff;">char</span>[] chars =<span style="color: #000000;"> symmetryStr.toCharArray();<br></span><span style="color: #008080;">16</span>                 <span style="color: #0000ff;">int</span><span style="color: #000000;"> k;<br></span><span style="color: #008080;">17</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">判断是否为对称串</span><br><span style="color: #008080;">18</span>                 <span style="color: #0000ff;">for</span> (k = 0; k &lt; chars.length/2; k++<span style="color: #000000;">) {<br></span><span style="color: #008080;">19</span>                     <span style="color: #0000ff;">if</span>(chars[k] != chars[chars.length-k-1<span style="color: #000000;">]){<br></span><span style="color: #008080;">20</span>                         <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">23</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">如果对称则count+1</span><br><span style="color: #008080;">24</span>                 <span style="color: #0000ff;">if</span>(k == chars.length/2<span style="color: #000000;">){<br></span><span style="color: #008080;">25</span>                     count++<span style="color: #000000;">;<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">29</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> count;<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">31</span> }</str.length()></pre><br></div>

<p>&nbsp;</p>
<p>四、求字符串中出现频率最高的字符</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.others;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.HashMap;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Map;<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> 求字符串中出现频率最高的字符 {<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;"> 9</span>         System.out.println(findHighRateChar(“abcdfeeafdaf”<span style="color: #000000;">));<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">11</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">char</span><span style="color: #000000;"> findHighRateChar(String str){<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">int</span> max = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">13</span>         <span style="color: #0000ff;">char</span> c = ‘ ‘<span style="color: #000000;">;<br></span><span style="color: #008080;">14</span>         Map<character, integer=""> map = <span style="color: #0000ff;">new</span> HashMap<character, integer=""><span style="color: #000000;">();<br></span><span style="color: #008080;">15</span>         <span style="color: #0000ff;">char</span>[] chars =<span style="color: #000000;"> str.toCharArray();<br></span><span style="color: #008080;">16</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; chars.length; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;">17</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;">(map.containsKey(chars[i])){<br></span><span style="color: #008080;">18</span>                 map.put(chars[i], map.get(chars[i])+1<span style="color: #000000;">);<br></span><span style="color: #008080;">19</span>                 <span style="color: #0000ff;">if</span>(map.get(chars[i])&gt;<span style="color: #000000;">max){<br></span><span style="color: #008080;">20</span>                     max =<span style="color: #000000;"> map.get(chars[i]);<br></span><span style="color: #008080;">21</span>                     c =<span style="color: #000000;"> chars[i];<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">23</span>             }<span style="color: #0000ff;">else</span><span style="color: #000000;">{<br></span><span style="color: #008080;">24</span>                 map.put(chars[i], 1<span style="color: #000000;">);<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">27</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> c;<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">29</span> }</character,></character,></pre><br></div>

<p>&nbsp;</p>
<p><span style="color: #ff0000;">有待补充……</span></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/08/string-summarize.html" data-id="ciiy5f4pd000wq1d0s4sgy2wv" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/08/string-summarize.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-struts2-source" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/08/struts2-source.html">struts2请求过程源码分析</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/08/struts2-source.html">
      <time datetime="2013-08-09T19:15:00.000Z" itemprop="datePublished">2013-08-10</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/后端/">后端</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　Struts2是Struts社区和WebWork社区的共同成果，我们甚至可以说，Struts2是WebWork的升级版，他采用的正是WebWork的核心，所以，Struts2并不是一个不成熟的产品，相反，构建在WebWork基础之上的Struts2是一个运行稳定、性能优异、设计成熟的WEB框架。</p>
<p>　　我这里的struts2源码是从官网下载的一个最新的struts-2.3.15.1-src.zip，将其解压即可。里面的目录页文件非常的多，我们只需要定位到struts-2.3.15.1\src\core\src\main\java\org\apache\struts2查看源文件。目录结构如下图<img src="http://www.liuling123.com/wp-content/uploads/2015/11/09202011-2fea5e8ff5b04a50b1ea62caee458465.jpg" alt=""></p>
<p>　　Struts2框架的正常运行，除了占核心地位的xwork的支持以外，Struts2本身也提供了许多类，这些类被分门别类组织到不同的包中。从源代码中发现，基本上每一个Struts2类都访问了WebWork提供的功能，从而也可以看出Struts2与WebWork千丝万缕的联系。但无论如何，Struts2的核心功能比如将请求委托给哪个Action处理都是由xwork完成的，Struts2只是在WebWork的基础上做了适当的简化、加强和封装，并少量保留Struts1.x中的习惯。</p>
<p><span style="color: #000000; font-size: 14px;">以下是包说明：</span></p>
<table style="font: 12px/18px tahoma, arial, sans-serif; margin: 0px; padding: 0px; border: 1px solid #c0c0c0; color: #444444; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; border-collapse: collapse; border-spacing: 0px; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" border="0" align="left"><br><tbody style="margin: 0px; padding: 0px;"><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2. components</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><br><br><span style="font-size: 14px;">该包封装视图组件，Struts2在视图组件上有了很大加强，不仅增加了组件的属性个数，更新增了几个非常有用的组件，如updownselect、doubleselect、datetimepicker、token、tree等。</span><br><br><span style="font-size: 14px;">&nbsp;另外，Struts2可视化视图组件开始支持主题(theme)，缺省情况下，使用自带的缺省主题，如果要自定义页面效果，需要将组件的theme属性设置为simple。</span><br><br></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2. config</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">该包定义与配置相关的接口和类。实际上，工程中的xml和properties文件的读取和解析都是由WebWork完成的，Struts只做了少量的工作。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2.dispatcher</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">Struts2的核心包，最重要的类都放在该包中。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2.impl</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">该包只定义了3个类，他们是StrutsActionProxy、StrutsActionProxyFactory、StrutsObjectFactory，这三个类都是对xwork的扩展。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2.interceptor</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">定义内置的截拦器。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2.servlet</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">用HttpServletRequest相关方法<span style="margin: 0px; padding: 0px;">实现</span>principalproxy接口。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2.util</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">实用包。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2.views</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">提供freemarker、jsp、velocity等不同类型的页面呈现。</span></td><br></tr><br></tbody><br></table>

<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="color: #000000; font-size: 14px;">&nbsp;根目录下的5个文件说明：</span></p>
<table style="font: 12px/18px tahoma, arial, sans-serif; margin: 0px; padding: 0px; border: 1px solid #c0c0c0; color: #444444; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; border-collapse: collapse; border-spacing: 0px; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" border="0" align="left"><br><tbody style="margin: 0px; padding: 0px;"><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">StrutsStatics</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">Struts常数。常数可以用来获取或设置对象从行动中或其他集合。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">RequestUtils</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">请求处理程序类。此类只有一个方法getServletPath，作用检索当前请求的servlet路径</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">ServletActionContext</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">网站的特定的上下文信息</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">StrutsConstants</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">该类提供了框架配置键的中心位置用于存储和检索配置设置。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">StrutsException</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">通用运行时异常类</span></td><br></tr><br></tbody><br></table>

<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">&nbsp; &nbsp;</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p>&nbsp;</p>
<p><span style="color: #000000;"><span style="font-size: 14px;">s</span><span style="font-size: 14px;">truts2 架构图如下图所示：</span></span></p>
<p><span style="font-size: 14px;"><img src="http://www.liuling123.com/wp-content/uploads/2015/11/09202934-b79818718d674f9c86a3d687a14a0779.jpg" alt=""></span></p>
<p><span style="color: #000000; font-size: 14px;">依照上图，我们可以看出一个请求在struts的处理大概有如下步骤：</span></p>
<p>　　1、客户端初始化一个指向Servlet容器（例如Tomcat）的请求；</p>
<p>　　2、这个请求经过一系列的过滤器（Filter）（这些过滤器中有一个叫做ActionContextCleanUp的可选过滤器，这个过滤器对于Struts2和其他框架的集成很有帮助，例如：SiteMesh Plugin）；</p>
<p>　　3、接着<span style="color: #000000;">StrutsPrepareAndExecuteFilter</span>被调用，<span style="color: #000000;">StrutsPrepareAndExecuteFilter</span>询问ActionMapper来决定这个请求是否需要调用某个Action；</p>
<p>　　4、如果ActionMapper决定需要调用某个Action，FilterDispatcher把请求的处理交给ActionProxy；</p>
<p>　　5、ActionProxy通过Configuration Manager询问框架的配置文件，找到需要调用的Action类；</p>
<p>　　6、ActionProxy创建一个ActionInvocation的实例。</p>
<p>　　7、ActionInvocation实例使用命名模式来调用，在调用Action的过程前后，涉及到相关拦截器（Intercepter）的调用。</p>
<p>　　8、一旦Action执行完毕，ActionInvocation负责根据struts.xml中的配置找到对应的返回结果。返回结果通常是（但不总是，也可能是另外的一个Action链）一个需要被表示的JSP或者FreeMarker的模版。在表示的过程中可以使用Struts2 框架中继承的标签。在这个过程中需要涉及到ActionMapper。</p>
<p>&nbsp;</p>
<p>strut2源码分析：</p>
<p>　　首先我们使用struts2框架都会在web.xml中注册和映射struts2，配置内容如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">filter</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">2</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">filter-name</span><span style="color: #0000ff;">&gt;</span>struts2<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">filter-name</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">3</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">filter-class</span><span style="color: #0000ff;">&gt;</span>org.apache.struts2.dispatcher.ng.filter.StrutsPrepareAndExecuteFilter<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">filter-class</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">4</span>   <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">filter</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">5</span>   <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">filter-mapping</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">6</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">filter-name</span><span style="color: #0000ff;">&gt;</span>struts2<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">filter-name</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">7</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">url-pattern</span><span style="color: #0000ff;">&gt;</span>/*<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">url-pattern</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">8</span>   <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">filter-mapping</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p><span style="color: #ff0000;">注：在早期的struts2中，都是使用FilterDispathcer，从Struts 2.1.3开始，它已不推荐使用。如果你使用的Struts的版本 &gt;= 2.1.3，推荐升级到新的Filter，StrutsPrepareAndExecuteFilter。在此研究的是StrutsPrepareAndExecuteFilter。</span></p>
<p><span style="color: #ff0000;">　　<span style="color: #000000;">StrutsPrepareAndExecuteFilter中的方法：</span></span></p>
<table border="1"><br><tbody><br><tr><br><td><span style="color: #000000; font-size: 14px;">void init(FilterConfig filterConfig)</span></td><br><td><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;继承自Filter，过滤器的初始化</span></td><br></tr><br><tr><br><td><span style="color: #000000; font-size: 14px;">doFilter(ServletRequest req, ServletResponse res, FilterChain chain)</span></td><br><td><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;<span style="text-align: left; text-transform: none; line-height: 26px; text-indent: 0px; letter-spacing: normal; font-family: Arial; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">继承自Filter，执行过滤器</span></span></td><br></tr><br><tr><br><td><span style="color: #000000; font-size: 14px;">void destroy()</span></td><br><td><span style="color: #000000; font-size: 14px;">继承自Filter，用于资源释放</span></td><br></tr><br><tr><br><td><span style="color: #000000; font-size: 14px;">void postInit(Dispatcher dispatcher, FilterConfig filterConfig)</span></td><br><td><span style="color: #000000; font-size: 14px;"><span style="text-align: left; text-transform: none; line-height: 26px; text-indent: 0px; letter-spacing: normal; font-family: Arial; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;Callback for post initialization（一个空的方法，用于方法回调初始化）</span></span></td><br></tr><br></tbody><br></table>

<p>&nbsp;web容器一启动，就会初始化核心过滤器<span style="color: #000000;">StrutsPrepareAndExecuteFilter</span>，并执行初始化方法，初始化方法如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> init(FilterConfig filterConfig) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> ServletException {<br></span><span style="color: #008080;"> 2</span>         InitOperations init = <span style="color: #0000ff;">new</span><span style="color: #000000;"> InitOperations();<br></span><span style="color: #008080;"> 3</span>         Dispatcher dispatcher = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 5</span>             <span style="color: #008000;">//</span><span style="color: #008000;">封装filterConfig，其中有个主要方法getInitParameterNames将参数名字以String格式存储在List中</span><br><span style="color: #008080;"> 6</span>             FilterHostConfig config = <span style="color: #0000ff;">new</span><span style="color: #000000;"> FilterHostConfig(filterConfig);<br></span><span style="color: #008080;"> 7</span>             <span style="color: #008000;">//</span><span style="color: #008000;">初始化struts内部日志</span><br><span style="color: #008080;"> 8</span> <span style="color: #000000;">            init.initLogging(config);<br></span><span style="color: #008080;"> 9</span>             <span style="color: #008000;">//</span><span style="color: #008000;">创建dispatcher ，并初始化</span><br><span style="color: #008080;">10</span>             dispatcher =<span style="color: #000000;"> init.initDispatcher(config);<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">            init.initStaticContentLoader(config, dispatcher);<br></span><span style="color: #008080;">12</span>             <span style="color: #008000;">//</span><span style="color: #008000;">初始化类属性：prepare 、execute</span><br><span style="color: #008080;">13</span>             prepare = <span style="color: #0000ff;">new</span><span style="color: #000000;"> PrepareOperations(filterConfig.getServletContext(), dispatcher);<br></span><span style="color: #008080;">14</span>             execute = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ExecuteOperations(filterConfig.getServletContext(), dispatcher);<br></span><span style="color: #008080;">15</span>             <span style="color: #0000ff;">this</span>.excludedPatterns =<span style="color: #000000;"> init.buildExcludedPatternsList(dispatcher);<br></span><span style="color: #008080;">16</span>             <span style="color: #008000;">//</span><span style="color: #008000;">回调空的postInit方法</span><br><span style="color: #008080;">17</span> <span style="color: #000000;">            postInit(dispatcher, filterConfig);<br></span><span style="color: #008080;">18</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">19</span>             <span style="color: #0000ff;">if</span> (dispatcher != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">                dispatcher.cleanUpAfterInit();<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">            init.cleanup();<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">24</span>     }</pre><br></div>

<p><span style="font: 14px/26px Arial; text-align: left; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">&nbsp;关于封装filterConfig，</span>首先看下FilterHostConfig ，源码如下：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> FilterHostConfig <span style="color: #0000ff;">implements</span><span style="color: #000000;"> HostConfig {<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> FilterConfig config;<br></span><span style="color: #008080;"> 4</span>     <span style="color: #008000;">//</span><span style="color: #008000;">构造方法</span><br><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> FilterHostConfig(FilterConfig config) {<br></span><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">this</span>.config =<span style="color: #000000;"> config;<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 8</span>     <span style="color: #008000;">//</span><span style="color: #008000;">根据init-param配置的param-name获取param-value的值  </span><br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String getInitParameter(String key) {<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> config.getInitParameter(key);<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">12</span>     <span style="color: #008000;">//</span><span style="color: #008000;">返回初始化参数名的迭代器 </span><br><span style="color: #008080;">13</span>     <span style="color: #0000ff;">public</span> Iterator<string><span style="color: #000000;"> getInitParameterNames() {<br></span><span style="color: #008080;">14</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> MakeIterator.convert(config.getInitParameterNames());<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">16</span>     <span style="color: #008000;">//</span><span style="color: #008000;">返回Servlet上下文</span><br><span style="color: #008080;">17</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ServletContext getServletContext() {<br></span><span style="color: #008080;">18</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> config.getServletContext();<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">20</span> }</string></pre><br></div>

<p><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　只有短短的几行代码，getInitParameterNames是这个类的核心，将Filter初始化参数名称有枚举类型转为Iterator。此类的主要作为是对filterConfig 封装。</span></p>
<p><span style="font-size: 14px;">　　接下来，看下<span style="color: #000000;">StrutsPrepareAndExecuteFilter</span>中init方法中dispatcher = init.initDispatcher(config);这是初始化dispatcher的，是通过init对象的initDispatcher方法来初始化的，init是InitOperations类的对象，我们看看InitOperations中initDispatcher方法：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span>  <span style="color: #0000ff;">public</span><span style="color: #000000;"> Dispatcher initDispatcher( HostConfig filterConfig ) {<br></span><span style="color: #008080;">2</span>         Dispatcher dispatcher =<span style="color: #000000;"> createDispatcher(filterConfig);<br></span><span style="color: #008080;">3</span> <span style="color: #000000;">        dispatcher.init();<br></span><span style="color: #008080;">4</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> dispatcher;<br></span><span style="color: #008080;">5</span>     }</pre><br></div>

<p><span style="color: #000000; font-size: 14px;"><span style="font: 14px/26px Arial; text-align: left; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　创建Dispatcher，会读取 filterConfig 中的配置信息，将配置信息解析出来，封装成为一个Map，然后根绝servlet上下文和参数Map构造Dispatcher ：</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">private</span><span style="color: #000000;"> Dispatcher createDispatcher( HostConfig filterConfig ) {<br></span><span style="color: #008080;"> 2</span>         <span style="color: #008000;">//</span><span style="color: #008000;">存放参数的Map</span><br><span style="color: #008080;"> 3</span>         Map<string, string=""> params = <span style="color: #0000ff;">new</span> HashMap<string, string=""><span style="color: #000000;">();<br></span><span style="color: #008080;"> 4</span>         <span style="color: #008000;">//</span><span style="color: #008000;">将参数存放到Map</span><br><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">for</span> ( Iterator e =<span style="color: #000000;"> filterConfig.getInitParameterNames(); e.hasNext(); ) {<br></span><span style="color: #008080;"> 6</span>             String name =<span style="color: #000000;"> (String) e.next();<br></span><span style="color: #008080;"> 7</span>             String value =<span style="color: #000000;"> filterConfig.getInitParameter(name);<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">            params.put(name, value);<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">10</span>         <span style="color: #008000;">//</span><span style="color: #008000;">根据servlet上下文和参数Map构造Dispatcher </span><br><span style="color: #008080;">11</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> Dispatcher(filterConfig.getServletContext(), params);<br></span><span style="color: #008080;">12</span>     }</string,></string,></pre><br></div>

<p>　　这样dispatcher对象创建完成，接着就是dispatcher对象的初始化，打开Dispatcher类，看到它的init方法如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> init() {<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">if</span> (configurationManager == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 4</span>             configurationManager =<span style="color: #000000;"> createConfigurationManager(BeanSelectionProvider.DEFAULT_BEAN_NAME);<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">            init_FileManager();<br></span><span style="color: #008080;"> 9</span>             <span style="color: #008000;">//</span><span style="color: #008000;">加载org/apache/struts2/default.properties</span><br><span style="color: #008080;">10</span>             init_DefaultProperties(); <span style="color: #008000;">//</span><span style="color: #008000;"> [1]<br></span><span style="color: #008080;">11</span>             <span style="color: #008000;">//</span><span style="color: #008000;">加载struts-default.xml,struts-plugin.xml,struts.xml</span><br><span style="color: #008080;">12</span>             init_TraditionalXmlConfigurations(); <span style="color: #008000;">//</span><span style="color: #008000;"> [2]</span><br><span style="color: #008080;">13</span>             init_LegacyStrutsProperties(); <span style="color: #008000;">//</span><span style="color: #008000;"> [3]<br></span><span style="color: #008080;">14</span>             <span style="color: #008000;">//</span><span style="color: #008000;">用户自己实现的ConfigurationProviders类 </span><br><span style="color: #008080;">15</span>             init_CustomConfigurationProviders(); <span style="color: #008000;">//</span><span style="color: #008000;"> [5]<br></span><span style="color: #008080;">16</span>             <span style="color: #008000;">//</span><span style="color: #008000;">Filter的初始化参数 </span><br><span style="color: #008080;">17</span>             init_FilterInitParameters() ; <span style="color: #008000;">//</span><span style="color: #008000;"> [6]</span><br><span style="color: #008080;">18</span>             init_AliasStandardObjects() ; <span style="color: #008000;">//</span><span style="color: #008000;"> [7]</span><br><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>             Container container =<span style="color: #000000;"> init_PreloadConfiguration();<br></span><span style="color: #008080;">21</span>             container.inject(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">            init_CheckWebLogicWorkaround(container);<br></span><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span>             <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">dispatcherListeners.isEmpty()) {<br></span><span style="color: #008080;">25</span>                 <span style="color: #0000ff;">for</span><span style="color: #000000;"> (DispatcherListener l : dispatcherListeners) {<br></span><span style="color: #008080;">26</span>                     l.dispatcherInitialized(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">29</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception ex) {<br></span><span style="color: #008080;">30</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (LOG.isErrorEnabled())<br></span><span style="color: #008080;">31</span>                 LOG.error(“Dispatcher initialization failed”<span style="color: #000000;">, ex);<br></span><span style="color: #008080;">32</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> StrutsException(ex);<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">34</span>     }</pre><br></div>

<p>　　这里主要是加载一些配置文件的，<span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">将按照顺序逐一加载：default.properties，struts-default.xml,struts-plugin.xml,struts.xml，&hellip;&hellip;关于文件是如何加载的，大家可以自己取看源文件，主要是由xwork核心类加载的，代码在xwork-core\src\main\java\com\opensymphony\xwork2\config\providers包里面。</span></p>
<p><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　现在，我们回到StrutsPrepareAndExecuteFilter类中，刚才我们分析了StrutsPrepareAndExecuteFilter类的init方法，该方法在web容器一启动就会调用的，当用户访问某个action的时候，首先调用核心过滤器StrutsPrepareAndExecuteFilter的doFilter方法，该方法内容如下：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> doFilter(ServletRequest req, ServletResponse res, FilterChain chain) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException, ServletException {<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span>         HttpServletRequest request =<span style="color: #000000;"> (HttpServletRequest) req;<br></span><span style="color: #008080;"> 4</span>         HttpServletResponse response =<span style="color: #000000;"> (HttpServletResponse) res;<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 7</span>             <span style="color: #008000;">//</span><span style="color: #008000;">设置编码和国际化</span><br><span style="color: #008080;"> 8</span> <span style="color: #000000;">            prepare.setEncodingAndLocale(request, response);<br></span><span style="color: #008080;"> 9</span>             <span style="color: #008000;">//</span><span style="color: #008000;">创建action上下文</span><br><span style="color: #008080;">10</span> <span style="color: #000000;">            prepare.createActionContext(request, response);<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">            prepare.assignDispatcherToThread();<br></span><span style="color: #008080;">12</span>             <span style="color: #0000ff;">if</span> (excludedPatterns != <span style="color: #0000ff;">null</span> &amp;&amp;<span style="color: #000000;"> prepare.isUrlExcluded(request, excludedPatterns)) {<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">                chain.doFilter(request, response);<br></span><span style="color: #008080;">14</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">15</span>                 request =<span style="color: #000000;"> prepare.wrapRequest(request);<br></span><span style="color: #008080;">16</span>                 ActionMapping mapping = prepare.findActionMapping(request, response, <span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">17</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">如果mapping为空，则认为不是调用action,会调用下一个过滤器链，直到获取到mapping才调用action</span><br><span style="color: #008080;">18</span>                 <span style="color: #0000ff;">if</span> (mapping == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">19</span>                     <span style="color: #0000ff;">boolean</span> handled =<span style="color: #000000;"> execute.executeStaticResourceRequest(request, response);<br></span><span style="color: #008080;">20</span>                     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">handled) {<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">                        chain.doFilter(request, response);<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">23</span>                 } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">24</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">执行action</span><br><span style="color: #008080;">25</span> <span style="color: #000000;">                    execute.executeAction(request, response, mapping);<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">28</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">            prepare.cleanupRequest(request);<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">31</span>     }</pre><br></div>

<p>　　下面对doFilter方法中的重点部分一一讲解：</p>
<p>(1)prepare.setEncodingAndLocale(request, response);</p>
<p>　　第8行是调用prepare对象的setEncodingAndLocale方法，prepare是PrepareOperations类的对象，PrepareOperations类是用来做请求准备工作的。我们看下PrepareOperations类中的setEncodingAndLocale方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setEncodingAndLocale(HttpServletRequest request, HttpServletResponse response) {<br></span><span style="color: #008080;">2</span> <span style="color: #000000;">        dispatcher.prepare(request, response);<br></span><span style="color: #008080;">3</span>     }</pre><br></div>

<p>　　在这方法里面我们可以看到它只是调用了dispatcher的prepare方法而已，下面我们看看dispatcher的prepare方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> prepare(HttpServletRequest request, HttpServletResponse response) {<br></span><span style="color: #008080;"> 2</span>         String encoding = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">if</span> (defaultEncoding != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 4</span>             encoding =<span style="color: #000000;"> defaultEncoding;<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 6</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> check for Ajax request to use UTF-8 encoding strictly </span><span style="color: #008000; text-decoration: underline;"><a href="http://www.w3.org/TR/XMLHttpRequest/" target="_blank" rel="external">http://www.w3.org/TR/XMLHttpRequest/</a></span><span style="color: #008000;">#the-send-method</span><br><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">if</span> (“XMLHttpRequest”.equals(request.getHeader(“X-Requested-With”<span style="color: #000000;">))) {<br></span><span style="color: #008080;"> 8</span>             encoding = “UTF-8”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span>         Locale locale = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">if</span> (defaultLocale != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">13</span>             locale =<span style="color: #000000;"> LocalizedTextUtil.localeFromString(defaultLocale, request.getLocale());<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span>         <span style="color: #0000ff;">if</span> (encoding != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">            applyEncoding(request, encoding);<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>         <span style="color: #0000ff;">if</span> (locale != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">            response.setLocale(locale);<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (paramsWorkaroundEnabled) {<br></span><span style="color: #008080;">25</span>             request.getParameter(“foo”); <span style="color: #008000;">//</span><span style="color: #008000;"> simply read any parameter (existing or not) to “prime” the request</span><br><span style="color: #008080;">26</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">27</span>     }</pre><br></div>

<p>　　我们可以看到该方法只是简单的设置了<span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">encoding 和locale ，做的只是一些辅助的工作。</span></p>
<p><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">(2)prepare.createActionContext(request, response)</span></p>
<p><span style="color: #000000; font-size: 14px;"><span style="font: 14px/26px Arial; text-align: left; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　我们回到StrutsPrepareAndExecuteFilter的doFilter方法，看到第10行代码：prepare.createActionContext(request, response);这是action上下文的创建，<span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">ActionContext是一个容器，这个容易主要存储request、session、application、parameters等相关信 息.ActionContext是一个线程的本地变量，这意味着不同的action之间不会共享ActionContext，所以也不用考虑线程安全问 题。其实质是一个Map，key是标示request、session、&hellip;&hellip;的字符串，值是其对应的对象，我们可以看到com.opensymphony.xwork2.ActionContext类中时如下定义的：</span></span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">static</span> ThreadLocal<actioncontext> actionContext = <span style="color: #0000ff;">new</span> ThreadLocal<actioncontext>();</actioncontext></actioncontext></pre><br></div>

<p><span style="color: #000000; font-size: 14px;"><span style="font: 14px/26px Arial; text-align: left; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">我们看下PrepareOperations类的createActionContext方法：</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">      Creates the action context and initializes the thread local<br></span><span style="color: #008080;"> 3</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ActionContext createActionContext(HttpServletRequest request, HttpServletResponse response) {<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">        ActionContext ctx;<br></span><span style="color: #008080;"> 6</span>         Integer counter = 1<span style="color: #000000;">;<br></span><span style="color: #008080;"> 7</span>         Integer oldCounter =<span style="color: #000000;"> (Integer) request.getAttribute(CLEANUP_RECURSION_COUNTER);<br></span><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">if</span> (oldCounter != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 9</span>             counter = oldCounter + 1<span style="color: #000000;">;<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">11</span>         <span style="color: #008000;">//</span><span style="color: #008000;">此处是从ThreadLocal中获取此ActionContext变量</span><br><span style="color: #008080;">12</span>         ActionContext oldContext =<span style="color: #000000;"> ActionContext.getContext();<br></span><span style="color: #008080;">13</span>         <span style="color: #0000ff;">if</span> (oldContext != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">14</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> detected existing context, so we are probably in a forward</span><br><span style="color: #008080;">15</span>             ctx = <span style="color: #0000ff;">new</span> ActionContext(<span style="color: #0000ff;">new</span> HashMap<string, object=""><span style="color: #000000;">(oldContext.getContextMap()));<br></span><span style="color: #008080;">16</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">17</span>             ValueStack stack = dispatcher.getContainer().getInstance(ValueStackFactory.<span style="color: #0000ff;">class</span><span style="color: #000000;">).createValueStack();<br></span><span style="color: #008080;">18</span>             stack.getContext().putAll(dispatcher.createContextMap(request, response, <span style="color: #0000ff;">null</span><span style="color: #000000;">, servletContext));<br></span><span style="color: #008080;">19</span>             <span style="color: #008000;">//</span><span style="color: #008000;">stack.getContext()返回的是一个Map<string，object>，根据此Map构造一个ActionContext</string，object></span><br><span style="color: #008080;">20</span>             ctx = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ActionContext(stack.getContext());<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">        request.setAttribute(CLEANUP_RECURSION_COUNTER, counter);<br></span><span style="color: #008080;">23</span>         <span style="color: #008000;">//</span><span style="color: #008000;">将ActionContext存到ThreadLocal </span><br><span style="color: #008080;">24</span> <span style="color: #000000;">        ActionContext.setContext(ctx);<br></span><span style="color: #008080;">25</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> ctx;<br></span><span style="color: #008080;">26</span>     }</string,></pre><br></div>

<p><span style="font: 14px/26px Arial; text-align: left; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp; 　　上面第18行代码中dispatcher.createContextMap，如何封装相关参数：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> Map<string,object><span style="color: #000000;"> createContextMap(HttpServletRequest request, HttpServletResponse response,<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">            ActionMapping mapping, ServletContext context) {<br></span><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> request map wrapping the http request objects</span><br><span style="color: #008080;"> 5</span>         Map requestMap = <span style="color: #0000ff;">new</span><span style="color: #000000;"> RequestMap(request);<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> parameters map wrapping the http parameters.  ActionMapping parameters are now handled and applied separately</span><br><span style="color: #008080;"> 8</span>         Map params = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HashMap(request.getParameterMap());<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> session map wrapping the http session</span><br><span style="color: #008080;">11</span>         Map session = <span style="color: #0000ff;">new</span><span style="color: #000000;"> SessionMap(request);<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> application map wrapping the ServletContext</span><br><span style="color: #008080;">14</span>         Map application = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ApplicationMap(context);<br></span><span style="color: #008080;">15</span>         <span style="color: #008000;">//</span><span style="color: #008000;">requestMap、params、session等Map封装成为一个上下文Map </span><br><span style="color: #008080;">16</span>         Map<string,object> extraContext =<span style="color: #000000;"> createContextMap(requestMap, params, session, application, request, response, context);<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>         <span style="color: #0000ff;">if</span> (mapping != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">            extraContext.put(ServletActionContext.ACTION_MAPPING, mapping);<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">21</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> extraContext;<br></span><span style="color: #008080;">22</span>     }</string,object></string,object></pre><br></div>

<p>(3)request = prepare.wrapRequest(request)</p>
<p>　　我们再次回到StrutsPrepareAndExecuteFilter的doFilter方法中，看到第15行：request = prepare.wrapRequest(request);这一句是对request进行包装的，我们看下prepare的wrapRequest方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> HttpServletRequest wrapRequest(HttpServletRequest oldRequest) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> ServletException {<br></span><span style="color: #008080;"> 2</span>         HttpServletRequest request =<span style="color: #000000;"> oldRequest;<br></span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 4</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> Wrap request first, just in case it is multipart/form-data<br></span><span style="color: #008080;"> 5</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> parameters might not be accessible through before encoding (ww-1278)</span><br><span style="color: #008080;"> 6</span>             request =<span style="color: #000000;"> dispatcher.wrapRequest(request, servletContext);<br></span><span style="color: #008080;"> 7</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;"> 8</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> ServletException(“Could not wrap servlet request with MultipartRequestWrapper!”<span style="color: #000000;">, e);<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> request;<br></span><span style="color: #008080;">11</span>     }</pre><br></div>

<p>　　由第6行我们可以看到它里面调用的是dispatcher的wrapRequest方法，并且将servletContext对象也传进去了，我们看下dispatcher的wrapRequest：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> HttpServletRequest wrapRequest(HttpServletRequest request, ServletContext servletContext) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {<br></span><span style="color: #008080;"> 2</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> don’t wrap more than once</span><br><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">if</span> (request <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> StrutsRequestWrapper) {<br></span><span style="color: #008080;"> 4</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> request;<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>         String content_type =<span style="color: #000000;"> request.getContentType();<br></span><span style="color: #008080;"> 8</span>         <span style="color: #008000;">//</span><span style="color: #008000;">如果content_type是multipart/form-data类型，则将request包装成MultiPartRequestWrapper对象，否则包装成StrutsRequestWrapper对象</span><br><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">if</span> (content_type != <span style="color: #0000ff;">null</span> &amp;&amp; content_type.contains(“multipart/form-data”<span style="color: #000000;">)) {<br></span><span style="color: #008080;">10</span>             MultiPartRequest mpr =<span style="color: #000000;"> getMultiPartRequest();<br></span><span style="color: #008080;">11</span>             LocaleProvider provider = getContainer().getInstance(LocaleProvider.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;">12</span>             request = <span style="color: #0000ff;">new</span><span style="color: #000000;"> MultiPartRequestWrapper(mpr, request, getSaveDir(servletContext), provider);<br></span><span style="color: #008080;">13</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">14</span>             request = <span style="color: #0000ff;">new</span><span style="color: #000000;"> StrutsRequestWrapper(request, disableRequestAttributeValueStackLookup);<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> request;<br></span><span style="color: #008080;">18</span>     }</pre><br></div>

<p>　　此次包装根据请求内容的类型不同，返回不同的对象，如果为multipart/form-data类型，则返回MultiPartRequestWrapper类型的对象，该对象服务于文件上传，否则返回StrutsRequestWrapper类型的对象，MultiPartRequestWrapper是StrutsRequestWrapper的子类，而这两个类都是HttpServletRequest接口的实现。</p>
<p>(4)ActionMapping mapping = prepare.findActionMapping(request, response, true)</p>
<p>　　包装request后，通过ActionMapper的getMapping()方法得到请求的Action，Action的配置信息存储在ActionMapping对象中，如StrutsPrepareAndExecuteFilter的doFilter方法中第16行：ActionMapping mapping = prepare.findActionMapping(request, response, true);我们找到prepare对象的findActionMapping方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> ActionMapping findActionMapping(HttpServletRequest request, HttpServletResponse response, <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> forceLookup) {<br></span><span style="color: #008080;"> 2</span>         <span style="color: #008000;">//</span><span style="color: #008000;">首先从request对象中取mapping对象，看是否存在</span><br><span style="color: #008080;"> 3</span>         ActionMapping mapping =<span style="color: #000000;"> (ActionMapping) request.getAttribute(STRUTS_ACTION_MAPPING_KEY);<br></span><span style="color: #008080;"> 4</span>         <span style="color: #008000;">//</span><span style="color: #008000;">不存在就创建一个</span><br><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">if</span> (mapping == <span style="color: #0000ff;">null</span> ||<span style="color: #000000;"> forceLookup) {<br></span><span style="color: #008080;"> 6</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 7</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">首先创建ActionMapper对象，通过ActionMapper对象创建mapping对象</span><br><span style="color: #008080;"> 8</span>                 mapping = dispatcher.getContainer().getInstance(ActionMapper.<span style="color: #0000ff;">class</span><span style="color: #000000;">).getMapping(request, dispatcher.getConfigurationManager());<br></span><span style="color: #008080;"> 9</span>                 <span style="color: #0000ff;">if</span> (mapping != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">                    request.setAttribute(STRUTS_ACTION_MAPPING_KEY, mapping);<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">12</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception ex) {<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">                dispatcher.sendError(request, response, servletContext, HttpServletResponse.SC_INTERNAL_SERVER_ERROR, ex);<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> mapping;<br></span><span style="color: #008080;">18</span>     }</pre><br></div>

<p>　　下面是ActionMapper接口的实现类DefaultActionMapper的getMapping()方法的源代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span><span style="color: #000000;"> ActionMapping getMapping(HttpServletRequest request, ConfigurationManager configManager) {<br></span><span style="color: #008080;"> 2</span>         ActionMapping mapping = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ActionMapping();<br></span><span style="color: #008080;"> 3</span>         <span style="color: #008000;">//</span><span style="color: #008000;">获得请求的uri，即请求路径URL中工程名以后的部分，如/userAction.action</span><br><span style="color: #008080;"> 4</span>         String uri =<span style="color: #000000;"> getUri(request);<br></span><span style="color: #008080;"> 5</span>         <span style="color: #008000;">//</span><span style="color: #008000;">修正url的带;jsessionid 时找不到的bug</span><br><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">int</span> indexOfSemicolon = uri.indexOf(“;”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 7</span>         uri = (indexOfSemicolon &gt; -1) ? uri.substring(0<span style="color: #000000;">, indexOfSemicolon) : uri;<br></span><span style="color: #008080;"> 8</span>         <span style="color: #008000;">//</span><span style="color: #008000;">删除扩展名，如.action或者.do</span><br><span style="color: #008080;"> 9</span>         uri =<span style="color: #000000;"> dropExtension(uri, mapping);<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">if</span> (uri == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">11</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">13</span>         <span style="color: #008000;">//</span><span style="color: #008000;">从uri中分离得到请求的action名、命名空间。</span><br><span style="color: #008080;">14</span> <span style="color: #000000;">        parseNameAndNamespace(uri, mapping, configManager);<br></span><span style="color: #008080;">15</span>         <span style="color: #008000;">//</span><span style="color: #008000;">处理特殊的请求参数</span><br><span style="color: #008080;">16</span> <span style="color: #000000;">        handleSpecialParameters(request, mapping);<br></span><span style="color: #008080;">17</span>         <span style="color: #008000;">//</span><span style="color: #008000;">如果允许动态方法调用，即形如/userAction!getAll.action的请求，分离action名和方法名</span><br><span style="color: #008080;">18</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> parseActionName(mapping);<br></span><span style="color: #008080;">19</span>     }</pre><br></div>

<p>　　下面对getMapping方法中的重要部分一一讲解：</p>
<p>　　①：parseNameAndNamespace(uri, mapping, configManager)</p>
<p>　　我们主要看下第14行的parseNameAndNamespace(uri, mapping, configManager);这个方法的主要作用是分离出action名和命名空间：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> parseNameAndNamespace(String uri, ActionMapping mapping, ConfigurationManager configManager) {<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">        String namespace, name;<br></span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">int</span> lastSlash = uri.lastIndexOf(“/“); <span style="color: #008000;">//</span><span style="color: #008000;">最后的斜杆的位置</span><br><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">if</span> (lastSlash == -1<span style="color: #000000;">) {<br></span><span style="color: #008080;"> 5</span>             namespace = “”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 6</span>             name =<span style="color: #000000;"> uri;<br></span><span style="color: #008080;"> 7</span>         } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (lastSlash == 0<span style="color: #000000;">) {<br></span><span style="color: #008080;"> 8</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> ww-1046, assume it is the root namespace, it will fallback to<br></span><span style="color: #008080;"> 9</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> default<br></span><span style="color: #008080;">10</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> namespace anyway if not found in root namespace.</span><br><span style="color: #008080;">11</span>             namespace = “/“<span style="color: #000000;">;<br></span><span style="color: #008080;">12</span>             name = uri.substring(lastSlash + 1<span style="color: #000000;">);<br></span><span style="color: #008080;">13</span>         <span style="color: #008000;">//</span><span style="color: #008000;">允许采用完整的命名空间,即设置命名空间是否必须进行精确匹配</span><br><span style="color: #008080;">14</span>         } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span><span style="color: #000000;"> (alwaysSelectFullNamespace) {<br></span><span style="color: #008080;">15</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> Simply select the namespace as everything before the last slash</span><br><span style="color: #008080;">16</span>             namespace = uri.substring(0<span style="color: #000000;">, lastSlash);<br></span><span style="color: #008080;">17</span>             name = uri.substring(lastSlash + 1<span style="color: #000000;">);<br></span><span style="color: #008080;">18</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">19</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> Try to find the namespace in those defined, defaulting to “”</span><br><span style="color: #008080;">20</span>             Configuration config =<span style="color: #000000;"> configManager.getConfiguration();<br></span><span style="color: #008080;">21</span>             String prefix = uri.substring(0, lastSlash); <span style="color: #008000;">//</span><span style="color: #008000;">临时的命名空间，将会用来进行匹配</span><br><span style="color: #008080;">22</span>             namespace = “”;<span style="color: #008000;">//</span><span style="color: #008000;">将命名空间暂时设为””</span><br><span style="color: #008080;">23</span>             <span style="color: #0000ff;">boolean</span> rootAvailable = <span style="color: #0000ff;">false</span>;<span style="color: #008000;">//</span><span style="color: #008000;">rootAvailable作用是判断配置文件中是否配置了命名空间”/“<br></span><span style="color: #008080;">24</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> Find the longest matching namespace, defaulting to the default</span><br><span style="color: #008080;">25</span>             <span style="color: #0000ff;">for</span> (Object cfg : config.getPackageConfigs().values()) { <span style="color: #008000;">//</span><span style="color: #008000;">循环遍历配置文件中的package标签</span><br><span style="color: #008080;">26</span>                 String ns = ((PackageConfig) cfg).getNamespace();    <span style="color: #008000;">//</span><span style="color: #008000;">获取每个package标签的namespace属性<br></span><span style="color: #008080;">27</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">进行匹配</span><br><span style="color: #008080;">28</span>                 <span style="color: #0000ff;">if</span> (ns != <span style="color: #0000ff;">null</span> &amp;&amp; prefix.startsWith(ns) &amp;&amp; (prefix.length() == ns.length() || prefix.charAt(ns.length()) == ‘/‘<span style="color: #000000;">)) {<br></span><span style="color: #008080;">29</span>                     <span style="color: #0000ff;">if</span> (ns.length() &gt;<span style="color: #000000;"> namespace.length()) {<br></span><span style="color: #008080;">30</span>                         namespace =<span style="color: #000000;"> ns;<br></span><span style="color: #008080;">31</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">33</span>                 <span style="color: #0000ff;">if</span> (“/“<span style="color: #000000;">.equals(ns)) {<br></span><span style="color: #008080;">34</span>                     rootAvailable = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">37</span><br><span style="color: #008080;">38</span>             name = uri.substring(namespace.length() + 1<span style="color: #000000;">);<br></span><span style="color: #008080;">39</span><br><span style="color: #008080;">40</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> Still none found, use root namespace if found</span><br><span style="color: #008080;">41</span>             <span style="color: #0000ff;">if</span> (rootAvailable &amp;&amp; “”<span style="color: #000000;">.equals(namespace)) {<br></span><span style="color: #008080;">42</span>                 namespace = “/“<span style="color: #000000;">;<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">45</span><br><span style="color: #008080;">46</span>         <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">allowSlashesInActionNames) {<br></span><span style="color: #008080;">47</span>             <span style="color: #0000ff;">int</span> pos = name.lastIndexOf(‘/‘<span style="color: #000000;">);<br></span><span style="color: #008080;">48</span>             <span style="color: #0000ff;">if</span> (pos &gt; -1 &amp;&amp; pos &lt; name.length() - 1<span style="color: #000000;">) {<br></span><span style="color: #008080;">49</span>                 name = name.substring(pos + 1<span style="color: #000000;">);<br></span><span style="color: #008080;">50</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">52</span>         <span style="color: #008000;">//</span><span style="color: #008000;">将分离后的acion名和命名空间保存到mapping对象</span><br><span style="color: #008080;">53</span> <span style="color: #000000;">        mapping.setNamespace(namespace);<br></span><span style="color: #008080;">54</span> <span style="color: #000000;">        mapping.setName(cleanupActionName(name));<br></span><span style="color: #008080;">55</span>     }</pre><br></div>

<p>　　看到上面代码的第14行，<span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">参数alwaysSelectFullNamespace我们可以通过名字就能大概猜出来”允许采用完整的命名空间”，即设置命名空间是否必须进行精确匹配，true必须，false可以模糊匹配，默认是false。进行精确匹配时要求请求url中的命名空间必须与配置文件中配置的某个命名空间必须相同，如果没有找到相同的则匹配失败。这个参数可通过struts2的”struts.mapper.alwaysSelectFullNamespace”常量配置，如：<constant name="struts.mapper.alwaysSelectFullNamespace" value="true">。当</constant></span></span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">alwaysSelectFullNamespace为true时，将uri以lastSlash为分割，左边的为namespace，右边的为name。如：</span><span style="line-height: 1.5; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;"><a href="http://localhost:8080/myproject/" target="_blank" rel="external">http://localhost:8080/myproject/</a></span></span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">home/<span style="color: #000000;">actionName</span>!method.action,此时uri为</span><span style="line-height: 1.5; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">/</span></span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">home/<span style="color: #000000;">actionName</span>!method.action(不过前面把后缀名去掉了，变成<span style="line-height: 1.5; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">/</span></span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">home/<span style="color: #000000;">actionName</span>!method</span>)，</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">lastSlash的,当前值是5，这样namespace为”/home”, name为<span style="color: #000000;">actionName</span>!method。</span></p>
<p><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">　　我们再看到上面代码第18行到第44行：</span>当上面的所有条件都不满足时，其中包括<span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">alwaysSelectFullNamespace 为false(命名空间进行模糊匹配)，将由此部分处理，进行模糊匹配。第1句，通过</span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">configManager.getConfiguration()从配置管理器中获得配置对象Configuration，Configuration中存放着struts2的所有配置，形式是将xml文档的相应元素封装为java bean，如<package< span=""></package<></span><span style="line-height: 1.5; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">&gt;</span></span><span style="line-height: 1.5; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">元素被封装到</span></span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">PackageConfig类中，这个一会儿会用到。第2句按lastSlash将uri截取出prefix，这是一个临时的命名空间，之后将会拿prefix进行模糊匹配。第3句namespace = “”，将命名空间暂时设为””。第4句创建并设置rootAvailable，</span></span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">rootAvailable作用是判断配置文件中是否配置了命名空间”/“，true为配置了，false未配置，下面for语句将会遍历我们配置的所有包(&lt;</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">package</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">&gt;</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">)，同时设置</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">rootAvailable。第5句for，通过</span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">config.getPackageConfigs()获得所有已经配置的包，然后遍历。String ns = ((PackageConfig) cfg).getNamespace()获得当前包的命名空间ns，之后的if句是进行模糊匹配的核心，我摘出来单独说，如下：</span></span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">if</span> (ns != <span style="color: #0000ff;">null</span> &amp;&amp; prefix.startsWith(ns) &amp;&amp; (prefix.length() == ns.length() || prefix.charAt(ns.length()) == ‘/‘<span style="color: #000000;">)) {<br></span><span style="color: #008080;">2</span>                     <span style="color: #0000ff;">if</span> (ns.length() &gt;<span style="color: #000000;"> namespace.length()) {<br></span><span style="color: #008080;">3</span>                         namespace =<span style="color: #000000;"> ns;<br></span><span style="color: #008080;">4</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">5</span>                 }</pre><br></div>

<p><span style="line-height: 24px; font-size: 14px;">　　ns != null &amp;&amp; prefix.startsWith(ns)这部分判断当ns不等于空并且ns是</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">prefix的前缀。</span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">prefix.length() == ns.length()当二者长度相等时，结合前面部分就是ns是</span></span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">prefix的前缀并且二者长度相等，最终结论就是ns和</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">prefix相等。如果前面的条件不成立，则说明prefix的长度大于ns。</span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">prefix.charAt(ns.length()) == ‘/‘)意思是prefix中与ns不相等的字符中的第一个字符必须是”/“，也就是说，在命名空间采用斜杠分级的形式中，ns必须是prefix的某一子集，如：/common/home 是用户配置的命名空间，则在http的请求url中，/common/home/index1、</span></span><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">/common/home/index2</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">、</span><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">/common/home/index/aaa 都是正确的，都可以成功的匹配到</span><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">/common/home，而/common/homeaa、/common/homea/aaa都是错误的。接着</span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">if (ns.length() &gt; namespace.length()) 句，目的是找出字符长度最长的。因为命名空间采用的是分级的，则长度越长所表示的越精确，如/common/home/index比/common/home精确。之后将namespace = ns。</span></span></p>
<p><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">　　我们接着往下看</span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">if (“/“.equals(ns)) 当我们配置了”/“这个命名空间时，将rootAvailable = true。</span></span><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">name = uri.substring(namespace.length() + 1)句不涉及到命名空间就不说了。</span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">if (rootAvailable &amp;&amp; “”.equals(namespace))如果通过上面的for循环没有找到匹配的命名空间即namespace的值仍然是当初设置的””，但却配置了”/“时，将命名空间设为”/“。</span></span></p>
<p><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">　　我们再看到第46到51行那个if语句：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">allowSlashesInActionNames) {<br></span><span style="color: #008080;">2</span>      <span style="color: #0000ff;">int</span> pos = name.lastIndexOf(‘/‘<span style="color: #000000;">);<br></span><span style="color: #008080;">3</span>      <span style="color: #0000ff;">if</span> (pos &gt; -1 &amp;&amp; pos &lt; name.length() - 1<span style="color: #000000;">) {<br></span><span style="color: #008080;">4</span>           name = name.substring(pos + 1<span style="color: #000000;">);<br></span><span style="color: #008080;">5</span> <span style="color: #000000;">     }<br></span><span style="color: #008080;">6</span> }</pre><br></div>

<p><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">　　allowSlashesInActionNames代表是否允许”/“出现在Action的名称中，默认为false，如果不允许”/“出现在Action名中，并且这时的Action名中有”/“，则取”/“后面的部分。</span></p>
<p><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">下面是命名空间匹配规则的总结：</span></p>
<p><span style="color: #ff0000; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">(1). 如果请求url中没有命名空间时，将采用”/“作为命名空间。</span></span></p>
<p><span style="color: #ff0000; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">(2). 当我们将常量 struts.mapper.alwaysSelectFullNamespace设为true时，那么请求url的命名空间必须和配置文件配置的完全相同才能匹配。</span></span></p>
<p><span style="color: #ff0000; line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">当将常量 struts.mapper.alwaysSelectFullNamespace设为false时，那么请求url的命名空间和配置文件配置的可按模糊匹配。规则：</span></p>
<p><span style="color: #ff0000; line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">　　a.如果配置文件中配置了/common 而url中的命名空间/common、/common/home、/common/home/index等等都是可匹配的，即子命名空间可匹配父命名空间。</span></p>
<p><span style="color: #ff0000;"><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">　　b.如果对于某个url请求中的命名空间同时匹配了俩个或俩个以上的配置文件中配置的命名空间，则选字符最长的，如：</span><span style="line-height: 1.5; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">当前请求的命名空间为/common/home/index/aaaa,&nbsp; 而我们在配置时同时配置&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 了/common/home、/common/home/index&nbsp; 则将会匹配命名空间最长的，即</span></span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">/common/home/index。</span></span></p>
<p><span style="color: #ff0000; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">(3).最后，如果请求的命名空间在配置中没有匹配到时，将采用””作为命名空间。如果没有设置为””的命名空间将抛出404错误。</span></span></p>
<p>　　②：parseActionName(mapping)</p>
<p><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">　　好了，到这里parseNameAndNamespace方法已经分析完了，我们再次回到getMapping方法中去，看到16行：handleSpecialParameters(request, mapping);好像是处理特殊参数的函数吧，里面有点看不懂，暂时就不管，以后有时间再研究。我们看到18行：return parseActionName(mapping);主要是用来处理形如/userAction!getAll.action的请求，分离action名和方法名：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">protected</span><span style="color: #000000;"> ActionMapping parseActionName(ActionMapping mapping) {<br></span><span style="color: #008080;"> 2</span>         <span style="color: #0000ff;">if</span> (mapping.getName() == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 3</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 4</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 5</span>         <span style="color: #008000;">//</span><span style="color: #008000;">如果允许动态方法调用</span><br><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (allowDynamicMethodCalls) {<br></span><span style="color: #008080;"> 7</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> handle “name!method” convention.</span><br><span style="color: #008080;"> 8</span>             String name =<span style="color: #000000;"> mapping.getName();<br></span><span style="color: #008080;"> 9</span>             <span style="color: #0000ff;">int</span> exclamation = name.lastIndexOf(“!”<span style="color: #000000;">);<br></span><span style="color: #008080;">10</span>             <span style="color: #008000;">//</span><span style="color: #008000;">如果包含”!”就进行分离</span><br><span style="color: #008080;">11</span>             <span style="color: #0000ff;">if</span> (exclamation != -1<span style="color: #000000;">) {<br></span><span style="color: #008080;">12</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">分离出action名</span><br><span style="color: #008080;">13</span>                 mapping.setName(name.substring(0<span style="color: #000000;">, exclamation));<br></span><span style="color: #008080;">14</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">分离出方法名</span><br><span style="color: #008080;">15</span>                 mapping.setMethod(name.substring(exclamation + 1<span style="color: #000000;">));<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">18</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> mapping;<br></span><span style="color: #008080;">19</span>     }</pre><br></div>

<p><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">　　到此为止getMapping方法已经分析结束了！</span></p>
<p>(5)execute.executeAction(request, response, mapping)</p>
<p>　　上面我们分析完了mapping的获取，继续看doFilter方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">//</span><span style="color: #008000;">如果mapping为空，则认为不是调用action,会调用下一个过滤器链，直到获取到mapping才调用action</span><br><span style="color: #008080;"> 2</span>                 <span style="color: #0000ff;">if</span> (mapping == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 3</span>                     <span style="color: #0000ff;">boolean</span> handled =<span style="color: #000000;"> execute.executeStaticResourceRequest(request, response);<br></span><span style="color: #008080;"> 4</span>                     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">handled) {<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">                        chain.doFilter(request, response);<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;"> 7</span>                 } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 8</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">执行action</span><br><span style="color: #008080;"> 9</span> <span style="color: #000000;">                    execute.executeAction(request, response, mapping);<br></span><span style="color: #008080;">10</span>                 }</pre><br></div>

<p>　　如果mapping对象不为空，则会执行action，我们看到上面代码第9行：execute是ExecuteOperations类的对象，ExecuteOperations类在包org.apache.struts2.dispatcher.ng下面，我们找到它里面的executeAction方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> executeAction(HttpServletRequest request, HttpServletResponse response, ActionMapping mapping) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> ServletException {<br></span><span style="color: #008080;">2</span> <span style="color: #000000;">        dispatcher.serviceAction(request, response, servletContext, mapping);<br></span><span style="color: #008080;">3</span>     }</pre><br></div>

<p>我们可以看到它里面只是简单的调用了dispatcher的serviceAction方法：我们找到dispatcher的serviceAction方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> serviceAction(HttpServletRequest request, HttpServletResponse response, ServletContext context,<br></span><span style="color: #008080;"> 2</span>                               ActionMapping mapping) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> ServletException {<br></span><span style="color: #008080;"> 3</span>         <span style="color: #008000;">//</span><span style="color: #008000;">封转上下文环境，主要将requestMap、params、session等Map封装成为一个上下文Map</span><br><span style="color: #008080;"> 4</span>         Map<string, object=""> extraContext =<span style="color: #000000;"> createContextMap(request, response, mapping, context);<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> If there was a previous value stack, then create a new copy and pass it in to be used by the new Action</span><br><span style="color: #008080;"> 7</span>         ValueStack stack =<span style="color: #000000;"> (ValueStack) request.getAttribute(ServletActionContext.STRUTS_VALUESTACK_KEY);<br></span><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">boolean</span> nullStack = stack == <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (nullStack) {<br></span><span style="color: #008080;">10</span>             ActionContext ctx =<span style="color: #000000;"> ActionContext.getContext();<br></span><span style="color: #008080;">11</span>             <span style="color: #0000ff;">if</span> (ctx != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">12</span>                 stack =<span style="color: #000000;"> ctx.getValueStack();<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">15</span>         <span style="color: #0000ff;">if</span> (stack != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">            extraContext.put(ActionContext.VALUE_STACK, valueStackFactory.createValueStack(stack));<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span>         String timerKey = “Handling request from Dispatcher”<span style="color: #000000;">;<br></span><span style="color: #008080;">20</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">            UtilTimerStack.push(timerKey);<br></span><span style="color: #008080;">22</span>             String namespace = mapping.getNamespace();<span style="color: #008000;">//</span><span style="color: #008000;">从mapping对象获取命名空间</span><br><span style="color: #008080;">23</span>             String name = mapping.getName();          <span style="color: #008000;">//</span><span style="color: #008000;">获取请求的action名</span><br><span style="color: #008080;">24</span>             String method = mapping.getMethod();      <span style="color: #008000;">//</span><span style="color: #008000;">获取请求方法<br></span><span style="color: #008080;">25</span>             <span style="color: #008000;">//</span><span style="color: #008000;">得到配置对象</span><br><span style="color: #008080;">26</span>             Configuration config =<span style="color: #000000;"> configurationManager.getConfiguration();<br></span><span style="color: #008080;">27</span>             <span style="color: #008000;">//</span><span style="color: #008000;">根据执行上下文参数，命名空间，名称等创建用户自定义Action的代理对象  </span><br><span style="color: #008080;">28</span>             ActionProxy proxy = config.getContainer().getInstance(ActionProxyFactory.<span style="color: #0000ff;">class</span><span style="color: #000000;">).createActionProxy(<br></span><span style="color: #008080;">29</span>                     namespace, name, method, extraContext, <span style="color: #0000ff;">true</span>, <span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span> <span style="color: #000000;">            request.setAttribute(ServletActionContext.STRUTS_VALUESTACK_KEY, proxy.getInvocation().getStack());<br></span><span style="color: #008080;">32</span><br><span style="color: #008080;">33</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> if the ActionMapping says to go straight to a result, do it!<br></span><span style="color: #008080;">34</span>             <span style="color: #008000;">//</span><span style="color: #008000;">如果配置文件中执行的这个action配置了result，就直接转到result</span><br><span style="color: #008080;">35</span>             <span style="color: #0000ff;">if</span> (mapping.getResult() != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">36</span>                 Result result =<span style="color: #000000;"> mapping.getResult();<br></span><span style="color: #008080;">37</span> <span style="color: #000000;">                result.execute(proxy.getInvocation());<br></span><span style="color: #008080;">38</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">                proxy.execute();<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">41</span><br><span style="color: #008080;">42</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> If there was a previous value stack then set it back onto the request</span><br><span style="color: #008080;">43</span>             <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">nullStack) {<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">                request.setAttribute(ServletActionContext.STRUTS_VALUESTACK_KEY, stack);<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">46</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (ConfigurationException e) {<br></span><span style="color: #008080;">47</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> WW-2874 Only log error if in devMode</span><br><span style="color: #008080;">48</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (devMode) {<br></span><span style="color: #008080;">49</span>                 String reqStr =<span style="color: #000000;"> request.getRequestURI();<br></span><span style="color: #008080;">50</span>                 <span style="color: #0000ff;">if</span> (request.getQueryString() != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">51</span>                     reqStr = reqStr + “?” +<span style="color: #000000;"> request.getQueryString();<br></span><span style="color: #008080;">52</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">53</span>                 LOG.error(“Could not find action or result\n” +<span style="color: #000000;"> reqStr, e);<br></span><span style="color: #008080;">54</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">55</span>                 <span style="color: #0000ff;">if</span><span style="color: #000000;"> (LOG.isWarnEnabled()) {<br></span><span style="color: #008080;">56</span>                     LOG.warn(“Could not find action or result”<span style="color: #000000;">, e);<br></span><span style="color: #008080;">57</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">58</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">59</span> <span style="color: #000000;">            sendError(request, response, context, HttpServletResponse.SC_NOT_FOUND, e);<br></span><span style="color: #008080;">60</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">61</span>             <span style="color: #0000ff;">if</span> (handleException ||<span style="color: #000000;"> devMode) {<br></span><span style="color: #008080;">62</span> <span style="color: #000000;">                sendError(request, response, context, HttpServletResponse.SC_INTERNAL_SERVER_ERROR, e);<br></span><span style="color: #008080;">63</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">64</span>                 <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ServletException(e);<br></span><span style="color: #008080;">65</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">66</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">67</span> <span style="color: #000000;">            UtilTimerStack.pop(timerKey);<br></span><span style="color: #008080;">68</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">69</span>     }</string,></pre><br></div>

<p>　　最后通过Result完成页面跳转！</p>
<p>&nbsp;</p>
<p>总结：以前总是只会用struts2框架，对里面的原理没有一个很清晰的认识，这两天花时间把struts2框架的源码分析了一下，对它的工作原理有个更深的认识。既然是开源框架，有时间久得去研究研究它的源码，不然开源就失去了意义了，不要只停留在会用的层面上！</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/08/struts2-source.html" data-id="ciiy5f4p8000pq1d0qdfngxqt" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/08/struts2-source.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web后端/">web后端</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-shell" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/08/shell.html">shell语法使用</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/08/shell.html">
      <time datetime="2013-08-03T08:48:00.000Z" itemprop="datePublished">2013-08-03</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　这两天初次接触shell编程，所谓shell编程其实就是用一定的语法将各种基本的命令组合起来，让shell程序去解释执行。如果对windows的dos有了解，可以这样理解，其实shell脚本文件和.bat批处理文件差不多，不过linux下的shell比起windows的dos强大很多。</p>
<p>　　shell有很多种，如bash、sh 、tcsh、 ksh等，linux系统里面默认使用的是bash。</p>
<p>　　下面看一下学习shell的第一个程序：</p>
<p>　　输入命令vi my_01.sh，创建一个my_01.sh文件并用vi编辑器打开。编辑内容如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> #!/bin/<span style="color: #000000;">bash<br></span><span style="color: #008080;">2</span> <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">aaaa</span><span style="color: #800000;">“</span><br><span style="color: #008080;">3</span> <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">第一次接触shell</span><span style="color: #800000;">“</span></pre><br></div>

<p>　　这里第一行是指让bash这个shell去执行这个shell程序。echo是用来输出的，第二行和第三行分别输出两句话。</p>
<p>执行这个shell程序可以用如下几种方法：</p>
<p>　　1&nbsp; ./my_01.sh</p>
<p>　　2&nbsp; . my_01.sh</p>
<p>　　3&nbsp; bash my_01.sh</p>
<p><span style="color: #ff0000;">注：新创建的文件默认是没有执行权限的，所以必须给该文件授予执行权限后才能执行。授权命令：chmod u+x my_01.sh或者chmod 755 my_01.sh</span></p>
<p>　　下面是第二个shell程序：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> #!/bin/<span style="color: #000000;">bash<br></span><span style="color: #008080;">2</span> #my_02.<span style="color: #0000ff;">sh</span><br><span style="color: #008080;">3</span> read -p <span style="color: #800000;">“</span><span style="color: #800000;">please input your name:</span><span style="color: #800000;">“</span><span style="color: #000000;"> name<br></span><span style="color: #008080;">4</span> <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">$name,welcome!</span><span style="color: #800000;">“</span></pre><br></div>

<p>　　这里第三行read命令是指等待用户输入，-p后面是指提示，它还有一个参数-t是设置等待时间的。这个程序运行结果如下：</p>
<p>[liuling@bogon test]$ ./my_02.sh<br>please input your name:liuling<br>liuling,welcome!</p>
<p>　<span style="background-color: #ffffff;">　<span style="color: #ff0000;">注：第四行echo使用的是双引号，如果使用单引号的话，则这句就会直接输出 $name,welcome! 。双引号是可以解析里面的变量的，而单引号则不行。</span></span></p>
<p><strong><span style="color: #808080; background-color: #ffffff;"><span style="color: #000000;">下面看看shell脚本的语法：</span></span></strong></p>
<p><span style="color: #808080; background-color: #ffffff;"><span style="color: #000000;">一、条件判断if else的使用</span></span></p>
<p><span style="color: #808080; background-color: #ffffff;"><span style="color: #000000;">if分支语句的写法：</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">if</span><span style="color: #000000;"> 条件测试<br>    </span><span style="color: #0000ff;">then</span><span style="color: #000000;"> 满足条件执行什么<br>    </span><span style="color: #0000ff;">else</span><span style="color: #000000;"> 不满足条件执行什么<br></span><span style="color: #0000ff;">fi</span></pre><br></div>

<p><span style="color: #808080; background-color: #ffffff;"><span style="color: #000000;">多分支写法：</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">if</span><span style="color: #000000;"> 条件1<br>    </span><span style="color: #0000ff;">then</span><span style="color: #000000;"><br>    执行命令2<br></span><span style="color: #0000ff;">elif</span><span style="color: #000000;"> 条件1<br>    </span><span style="color: #0000ff;">then</span><span style="color: #000000;"><br>    执行命令2<br></span><span style="color: #0000ff;">else</span><span style="color: #000000;"><br>    执行命令3<br></span><span style="color: #0000ff;">fi</span></pre><br></div>

<p><span style="color: #808080; background-color: #ffffff;"><span style="color: #000000;">　　　<span style="color: #ff0000;">注：if和fi要配对，以fi结束这个条件判断。在不满足第一个条件下再判断使用的是elif，而不是else if。then必须独占一行。</span></span></span></p>
<p>&nbsp;下面看几个例子：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> #!/bin/<span style="color: #000000;">bash<br></span><span style="color: #008080;"> 2</span> #my_03.<span style="color: #0000ff;">sh</span><br><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span> read -p <span style="color: #800000;">“</span><span style="color: #800000;">pelease input your name:</span><span style="color: #800000;">“</span><span style="color: #000000;"> name<br></span><span style="color: #008080;"> 5</span> read -p <span style="color: #800000;">“</span><span style="color: #800000;">pleaase input your password:</span><span style="color: #800000;">“</span> <span style="color: #0000ff;">passwd</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">#if</span> test $name = “liuling”<br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">if</span> [ $name = <span style="color: #800000;">“</span><span style="color: #800000;">liuling</span><span style="color: #800000;">“</span> -a $<span style="color: #0000ff;">passwd</span> = <span style="color: #800000;">“</span><span style="color: #800000;">lz19921009</span><span style="color: #800000;">“</span><span style="color: #000000;"> ]<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">then</span><br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">登录成功！</span><span style="color: #800000;">“</span><br><span style="color: #008080;">10</span> <span style="color: #0000ff;">else</span><br><span style="color: #008080;">11</span>     <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">登录失败！</span><span style="color: #800000;">“</span><br><span style="color: #008080;">12</span> <span style="color: #0000ff;">fi</span></pre><br></div><br><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> #!/bin/<span style="color: #000000;">bash<br></span><span style="color: #008080;"> 2</span> #my_04.<span style="color: #0000ff;">sh</span><br><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span> read -p <span style="color: #800000;">“</span><span style="color: #800000;">please input your score:</span><span style="color: #800000;">“</span><span style="color: #000000;"> score<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">if</span> [ $score -gt <span style="color: #800080;">90</span><span style="color: #000000;"> ]<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">then</span><br><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">优秀！</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">elif</span> [ $score -gt <span style="color: #800080;">80</span> -a $score -le <span style="color: #800080;">90</span><span style="color: #000000;"> ]<br></span><span style="color: #008080;">10</span> <span style="color: #0000ff;">then</span><br><span style="color: #008080;">11</span>     <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">良好！</span><span style="color: #800000;">“</span><br><span style="color: #008080;">12</span> <span style="color: #0000ff;">else</span><br><span style="color: #008080;">13</span>     <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">一般！</span><span style="color: #800000;">“</span><br><span style="color: #008080;">14</span> <span style="color: #0000ff;">fi</span></pre><br></div><br><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> #!/bin/<span style="color: #000000;">bash<br></span><span style="color: #008080;"> 2</span> #my_05.<span style="color: #0000ff;">sh</span><br><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span> read -p <span style="color: #800000;">“</span><span style="color: #800000;">please input your score:</span><span style="color: #800000;">“</span><span style="color: #000000;"> score<br></span><span style="color: #008080;"> 5</span> #如果使用(())的话，只能用&lt; &gt; &gt;= &lt;=<br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">if</span> (( $score &gt; <span style="color: #800080;">90</span><span style="color: #000000;"> ))<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">then</span><br><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">优秀！</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">elif</span> [[ $score -gt <span style="color: #800080;">80</span> &amp;&amp; $score -le <span style="color: #800080;">90</span><span style="color: #000000;"> ]]<br></span><span style="color: #008080;">10</span> <span style="color: #0000ff;">then</span><br><span style="color: #008080;">11</span>     <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">良好！</span><span style="color: #800000;">“</span><br><span style="color: #008080;">12</span> <span style="color: #0000ff;">else</span><br><span style="color: #008080;">13</span>     <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">一般！</span><span style="color: #800000;">“</span><br><span style="color: #008080;">14</span> <span style="color: #0000ff;">fi</span></pre><br></div>

<p>　　测试用户输入的文件名是目录还是文件：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> #!/bin/<span style="color: #000000;">bash<br></span><span style="color: #008080;"> 2</span> #my_06.<span style="color: #0000ff;">sh</span><br><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span> read -p <span style="color: #800000;">“</span><span style="color: #800000;">请输入一个目录或者文件名：</span><span style="color: #800000;">“</span><span style="color: #000000;"> name<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">if</span> [ -<span style="color: #000000;">z $name ]<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">then</span><br><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">你输入的信息为空！</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">else</span><br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">if</span> [ -<span style="color: #000000;">f $name ]<br></span><span style="color: #008080;">10</span>     <span style="color: #0000ff;">then</span><br><span style="color: #008080;">11</span>         <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">这是一个文件！</span><span style="color: #800000;">“</span><br><span style="color: #008080;">12</span>     <span style="color: #0000ff;">elif</span> [ -<span style="color: #000000;">d $name ]<br></span><span style="color: #008080;">13</span>     <span style="color: #0000ff;">then</span><br><span style="color: #008080;">14</span>         <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">这是一个目录！</span><span style="color: #800000;">“</span><br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">else</span><br><span style="color: #008080;">16</span>         <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">不存在这样一个目录或者文件！</span><span style="color: #800000;">“</span><br><span style="color: #008080;">17</span>     <span style="color: #0000ff;">fi</span><br><span style="color: #008080;">18</span> <span style="color: #0000ff;">fi</span></pre><br></div>

<p>&nbsp;</p>
<p>　　这三个例子都是关于if条件判断的用法。条件有这么几种写法:[ 条件 ]、test 条件、[[ 条件 ]]、(( 条件 ))，用的最多的是第一种。常用判断符号如下</p>
<p>①、逻辑运算符</p>
<p>　　-a　　expr1 -a expr2　　逻辑与</p>
<p>　　-o　　expr1 -o expr2　　逻辑或</p>
<p>　　！　　!expr1　　　　　　逻辑非</p>
<p>②、数值判断</p>
<p>　　-eq　　num1 -eq num2　　是否相等</p>
<p>　　-ne　　num1 -ne num2　　是否不相等</p>
<p>　　-gt　　num1 -gt num2　　是否大于</p>
<p>　　-ge　　num1 -ge num2　　是否大于等于</p>
<p>　　-lt　　num1 -lt num2　　是否小于</p>
<p>　　-le　　num1 -le num2　　是否小于等于</p>
<p>③、字符串判断</p>
<p>　　=　　str1 = str2　　字符串是否相等</p>
<p>　　!=　　str1 != str2　　字符串是否不等</p>
<p>　　-n　　-n str1　　　　字符串长度是否不等于0</p>
<p>　　-z　　-z str2　　　　字符串长度是否等于0</p>
<p>④、文件判断</p>
<p>　　-r　　-r filename　　文件是否存在且可读</p>
<p>　　-w　　-w filename　　文件是否存在且可写</p>
<p>　　-s　　-s filename　　文件是否存在且长度非0</p>
<p>　　-f　　-f filename　　文件是否存在且是普通文件</p>
<p>　　-d　　-d filename　　文件是否存在且是一个目录</p>
<p>&nbsp;</p>
<p>　　<span style="color: #ff0000;">在使用条件判断的时候一定要注意空格，如if [ $name = “liuling” -a $passwd = “lz19921009” ]，[]里面前后要有一个空格，所有的判断符号以及逻辑运算符号前后都要有空格，否则会报错。使用[[&nbsp;条件 ]]的时候只能使用”&amp;&amp;”符号作为逻辑与来代替”-a”，如果使用(( 条件 ))的话，只能用&lt; &gt; &gt;= &lt;=符号，而不能使用&ldquo;-eq&rdquo;等符号。</span></p>
<p><span style="color: #000000;">二、case的用法</span></p>
<p><span style="color: #000000;">　　这里的case优点类似于java中的swith case</span></p>
<p><span style="color: #000000;">case语法如下:</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">case</span> var <span style="color: #0000ff;">in</span><span style="color: #000000;"><br>pattern </span><span style="color: #800080;">1</span><span style="color: #000000;">)<br>    执行语句1<br>    ;;<br>pattern </span><span style="color: #800080;">2</span><span style="color: #000000;">)<br>    执行语句2<br>    ;;<br>pattern </span><span style="color: #800080;">3</span><span style="color: #000000;">)<br>    执行语句3<br>    ;;<br></span>*<span style="color: #000000;">)<br>    执行语句4<br>    ;;<br></span><span style="color: #0000ff;">esac</span></pre><br></div>

<p><span style="color: #ff0000;">注意：*）指匹配其他任意字符串</span><br><span style="color: #ff0000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 每种情况都以;;结束</span></p>
<p>下面是几个case用法的例子</p>
<p>　　1.模拟菜单的选择</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> #!/bin/<span style="color: #000000;">bash<br></span><span style="color: #008080;"> 2</span> #my_07.<span style="color: #0000ff;">sh</span><br><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">1 - 普通显示</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">2 - 详细显示</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">3 - 显示隐藏文件</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">4 - 推出</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> read -p <span style="color: #800000;">“</span><span style="color: #800000;">请选择操作号：</span><span style="color: #800000;">“</span><span style="color: #000000;"> num<br></span><span style="color: #008080;">10</span> <span style="color: #0000ff;">case</span> $num <span style="color: #0000ff;">in</span><br><span style="color: #008080;">11</span>     <span style="color: #800080;">1</span><span style="color: #000000;">)<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">ls</span><span style="color: #000000;"> ;;<br></span><span style="color: #008080;">13</span>     <span style="color: #800080;">2</span><span style="color: #000000;">)<br></span><span style="color: #008080;">14</span>         <span style="color: #0000ff;">ls</span> -<span style="color: #000000;">l ;;<br></span><span style="color: #008080;">15</span>     <span style="color: #800080;">3</span><span style="color: #000000;">)<br></span><span style="color: #008080;">16</span>         <span style="color: #0000ff;">ls</span> -<span style="color: #000000;">al ;;<br></span><span style="color: #008080;">17</span>     <span style="color: #800080;">4</span><span style="color: #000000;">)<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">        exit ;;<br></span><span style="color: #008080;">19</span>     *<span style="color: #000000;">)<br></span><span style="color: #008080;">20</span>         <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">请输入正确的操作（1–4）</span><span style="color: #800000;">“</span><br><span style="color: #008080;">21</span> <span style="color: #000000;">        exit ;;<br></span><span style="color: #008080;">22</span> <span style="color: #0000ff;">esac</span></pre><br></div>

<p>&nbsp;</p>
<p>三、循环语句的使用</p>
<p>1、for循环</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">for</span> 变量名 <span style="color: #0000ff;">in</span><span style="color: #000000;"> 取值列表<br></span><span style="color: #0000ff;">do</span><span style="color: #000000;"><br>    命令序列<br></span><span style="color: #0000ff;">done</span></pre><br></div>

<p>下面是for循环使用的小例子：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> #!/bin/<span style="color: #000000;">bash<br></span><span style="color: #008080;"> 2</span> #my_08.<span style="color: #0000ff;">sh</span><br><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">for</span> a <span style="color: #0000ff;">in</span> <code>&lt;span style=&quot;color: #0000ff;&quot;&gt;seq&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;3&lt;/span&gt; &lt;span style=&quot;color: #800080;&quot;&gt;10&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;</code><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">do</span><br><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">echo</span><span style="color: #000000;"> $a<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">done</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">——————-</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">for</span> ((i=<span style="color: #800080;">1</span>;i&lt;=<span style="color: #800080;">10</span>;i++<span style="color: #000000;">))<br></span><span style="color: #008080;">10</span> <span style="color: #0000ff;">do</span><br><span style="color: #008080;">11</span>     <span style="color: #0000ff;">echo</span><span style="color: #000000;"> $i<br></span><span style="color: #008080;">12</span> <span style="color: #0000ff;">done</span></pre><br></div>

<p>　　<span style="color: #ff0000;">这里第四行使用了<code>seq 1 3 10</code>，<code>是反引号，也就是键盘上Esc下面的一个键，</code>里面可以写执行命令，把执行后的结果返回。</span></p>
<p><span style="color: #ff0000;">　　seq命令是指序列，seq start size max，start是起始，size是步长，max就是限制的数，比如seq 1 3 10，则返回的是1 4 7 10。</span></p>
<p><span style="color: #ff0000;">　　第9行代码也有点特别，有点像java里面的for循环，不过是双重小括号，在shell中这样也是可以的。</span></p>
<p>　　下面是一个统计文件数目的小程序：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> #!/bin/<span style="color: #000000;">bash<br></span><span style="color: #008080;"> 2</span> #my_09.<span style="color: #0000ff;">sh</span><br><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span> i=<span style="color: #800080;">0</span><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">for</span> name1 <span style="color: #0000ff;">in</span> <code>&lt;span style=&quot;color: #0000ff;&quot;&gt;ls&lt;/span&gt; /&lt;span style=&quot;color: #000000;&quot;&gt;etc</code><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">do</span><br><span style="color: #008080;"> 7</span>    # i=<code>&lt;span style=&quot;color: #0000ff;&quot;&gt;expr&lt;/span&gt; $i + &lt;span style=&quot;color: #800080;&quot;&gt;1&lt;/span&gt;&lt;span style=&quot;color: #000000;&quot;&gt;</code><br><span style="color: #008080;"> 8</span>    # let i++<br><span style="color: #008080;"> 9</span>    # i=$[$i + <span style="color: #800080;">1</span><span style="color: #000000;">]<br></span><span style="color: #008080;">10</span>    # i=$(($i + <span style="color: #800080;">1</span><span style="color: #000000;">))<br></span><span style="color: #008080;">11</span>    ((i++<span style="color: #000000;">))<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">done</span><br><span style="color: #008080;">14</span> <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">文件总数为：$i</span><span style="color: #800000;">“</span></pre><br></div>

<p>　　<span style="color: #ff0000;">注：7、8、9、10、11行是数字自增的不同写法，都可以。</span></p>
<p><span style="color: #000000;">2、while循环</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">while</span><span style="color: #000000;"> 条件<br></span><span style="color: #0000ff;">do</span><span style="color: #000000;"><br>    命令序列<br></span><span style="color: #0000ff;">done</span></pre><br></div>

<p>下面是一个录入客户资料的shell脚本：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> #!/bin/<span style="color: #000000;">bash<br></span><span style="color: #008080;"> 2</span> #my_10.<span style="color: #0000ff;">sh</span><br><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">while</span> <span style="color: #0000ff;">true</span><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">do</span><br><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">登记客户资料(c继续，q退出)：</span><span style="color: #800000;">“</span><br><span style="color: #008080;"> 7</span> <span style="color: #000000;">        read choice<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">case</span> $choice <span style="color: #0000ff;">in</span><br><span style="color: #008080;">10</span> <span style="color: #000000;">                c)<br></span><span style="color: #008080;">11</span>                         <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">请输入客户名字:</span><span style="color: #800000;">“</span><br><span style="color: #008080;">12</span> <span style="color: #000000;">                        read name1<br></span><span style="color: #008080;">13</span>                         <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">请输入客户年龄:</span><span style="color: #800000;">“</span><br><span style="color: #008080;">14</span> <span style="color: #000000;">                        read age1<br></span><span style="color: #008080;">15</span>                         <span style="color: #0000ff;">echo</span> <span style="color: #800000;">“</span><span style="color: #800000;">姓名:</span><span style="color: #800000;">“</span>${name1}<span style="color: #800000;">“</span><span style="color: #800000;"> - 年龄:</span><span style="color: #800000;">“</span>${age1} &gt;&gt;<span style="color: #000000;">customer.txt<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">                        ;;<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">                q)<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">                        exit<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">                        ;;<br></span><span style="color: #008080;">20</span>         <span style="color: #0000ff;">esac</span><br><span style="color: #008080;">21</span> <span style="color: #0000ff;">done</span></pre><br></div>

<p><span style="color: #ff0000;">注：</span><br><span style="color: #ff0000;">&gt;&gt;是指重定向，将标准输出重定向到其他的输出流中，如上面15行是指将标准输出重定向到customer.txt文件。所以echo输出的内容会输出到customer.txt文件中去。</span></p>
<p><span style="color: #ff0000;">&gt;&gt; 和 &gt; 区别</span></p>
<p><span style="color: #ff0000;">&gt;&gt;customer.txt 追加保存到customer.txt文件中， 如果文件不存在会自动创建。</span></p>
<p><span style="color: #ff0000;">&gt;customer.txt 就会重新写入， 覆盖原有的数据</span></p>
<p>&nbsp;</p>
<p>四、函数的应用</p>
<div class="cnblogs_code"><br><pre><span style="color: #0000ff;">function</span><span style="color: #000000;"> 函数名(){<br><br>}<br>or<br>函数名(){<br><br>}<br><br>函数调用：<br>函数名<br>函数名 参数1 参数2</span></pre><br></div>

<p>下面是一个小例子程序：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> #!/bin/<span style="color: #000000;">bash<br></span><span style="color: #008080;">2</span> #fun.<span style="color: #0000ff;">sh</span><br><span style="color: #008080;">3</span> <span style="color: #0000ff;">function</span><span style="color: #000000;"> add(){<br></span><span style="color: #008080;">4</span>     <span style="color: #0000ff;">echo</span> $(($<span style="color: #800080;">1</span>+$<span style="color: #800080;">2</span><span style="color: #000000;">))<br></span><span style="color: #008080;">5</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">6</span> add <span style="color: #800080;">20</span> <span style="color: #800080;">30</span><br><span style="color: #008080;">7</span> add <span style="color: #800080;">20</span> <span style="color: #800080;">90</span></pre><br></div>

<p>&nbsp;</p>
<p>　　</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/08/shell.html" data-id="ciiy5f4q40021q1d0n4d7x50k" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/08/shell.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-hibernate-mysql-proceduce" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/07/hibernate-mysql-proceduce.html">hibernate调用mysql存储过程</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/07/hibernate-mysql-proceduce.html">
      <time datetime="2013-07-29T00:08:00.000Z" itemprop="datePublished">2013-07-29</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/后端/">后端</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　在mysql中创建两个存储过程，如下：</p>
<p>1、根据id查找某条数据：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">CREATE</span> <span style="color: #0000ff;">PROCEDURE</span> <code>findEmpById</code>(<span style="color: #808080;">IN</span> id <span style="color: #0000ff;">INTEGER</span>(<span style="color: #800000; font-weight: bold;">11</span><span style="color: #000000;">))<br></span><span style="color: #008080;">2</span> <span style="color: #0000ff;">begin</span><br><span style="color: #008080;">3</span>      <span style="color: #0000ff;">select</span> <span style="color: #808080;">*</span> <span style="color: #0000ff;">from</span> emp <span style="color: #0000ff;">where</span> empId<span style="color: #808080;">=</span><span style="color: #000000;">id;<br></span><span style="color: #008080;">4</span> <span style="color: #0000ff;">end</span>;</pre><br></div>

<p>2、根据id查找某个字段，并返回</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">CREATE</span> <span style="color: #0000ff;">PROCEDURE</span> <code>getNameById</code>(<span style="color: #808080;">in</span> id <span style="color: #0000ff;">integer</span>(<span style="color: #800000; font-weight: bold;">11</span>),out eName <span style="color: #0000ff;">varchar</span>(<span style="color: #800000; font-weight: bold;">50</span><span style="color: #000000;">))<br></span><span style="color: #008080;">2</span> <span style="color: #0000ff;">begin</span><br><span style="color: #008080;">3</span>      <span style="color: #0000ff;">select</span> empName <span style="color: #0000ff;">into</span> eName <span style="color: #0000ff;">from</span> emp <span style="color: #0000ff;">where</span> empId<span style="color: #808080;">=</span><span style="color: #000000;">id;<br></span><span style="color: #008080;">4</span> <span style="color: #0000ff;">end</span>;</pre><br></div>

<p>　　在存储过程的参数列表里面，in修饰的参数代表输入参数，out修饰的代表输出参数。</p>
<p>使用hibernate调用上面两个存储过程：</p>
<p>　　（1）调用第一个存储过程</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.test;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.sql.CallableStatement;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.sql.Connection;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.sql.ResultSet;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.sql.SQLException;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.hibernate.Session;<br></span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.hibernate.SessionFactory;<br></span><span style="color: #008080;">10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.hibernate.cfg.Configuration;<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> 调用存储过程 {<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span>     <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">16</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> args<br></span><span style="color: #008080;">17</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@throws</span><span style="color: #008000;"> SQLException<br></span><span style="color: #008080;">18</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">19</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> SQLException {<br></span><span style="color: #008080;">20</span>         Configuration cfg = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Configuration().configure();<br></span><span style="color: #008080;">21</span>         SessionFactory factory =<span style="color: #000000;"> cfg.buildSessionFactory();<br></span><span style="color: #008080;">22</span>         Session session =<span style="color: #000000;"> factory.openSession();<br></span><span style="color: #008080;">23</span>         Connection con =<span style="color: #000000;"> session.connection();<br></span><span style="color: #008080;">24</span>         String sql = “{call findEmpById(?)}”<span style="color: #000000;">;<br></span><span style="color: #008080;">25</span>         CallableStatement cs =<span style="color: #000000;"> con.prepareCall(sql);<br></span><span style="color: #008080;">26</span>         cs.setObject(1, 2<span style="color: #000000;">);<br></span><span style="color: #008080;">27</span>         ResultSet rs =<span style="color: #000000;"> cs.executeQuery();<br></span><span style="color: #008080;">28</span>         <span style="color: #0000ff;">while</span><span style="color: #000000;">(rs.next()){<br></span><span style="color: #008080;">29</span>             <span style="color: #0000ff;">int</span> id = rs.getInt(“empId”<span style="color: #000000;">);<br></span><span style="color: #008080;">30</span>             String name = rs.getString(“empName”<span style="color: #000000;">);<br></span><span style="color: #008080;">31</span>             System.out.println(id+”\t”+<span style="color: #000000;">name);<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">34</span><br><span style="color: #008080;">35</span> }</pre><br></div>

<p>&nbsp;&nbsp; 　调用存储过程的sql语句为:call 存储过程名(参数…)，不过在java中调用存储过程一般都加{}。调用存储过程使用的是CallableStatement。</p>
<p>　　（2）调用第二个存储过程</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.test;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.sql.CallableStatement;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.sql.Connection;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.sql.SQLException;<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.hibernate.Session;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.hibernate.SessionFactory;<br></span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.hibernate.cfg.Configuration;<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> 调用存储过程1 {<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> SQLException {<br></span><span style="color: #008080;">15</span>         Configuration config = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Configuration().configure();<br></span><span style="color: #008080;">16</span>         SessionFactory sessionFactory =<span style="color: #000000;"> config.buildSessionFactory();<br></span><span style="color: #008080;">17</span>         Session session =<span style="color: #000000;"> sessionFactory.openSession();<br></span><span style="color: #008080;">18</span>         Connection conn =<span style="color: #000000;"> session.connection();<br></span><span style="color: #008080;">19</span>         String sql = “{call getNameById(?,?)}”<span style="color: #000000;">;<br></span><span style="color: #008080;">20</span>         CallableStatement cs =<span style="color: #000000;"> conn.prepareCall(sql);<br></span><span style="color: #008080;">21</span>         cs.setObject(1, 3); <span style="color: #008000;">//</span><span style="color: #008000;">设置输出参数</span><br><span style="color: #008080;">22</span>         cs.registerOutParameter(2, java.sql.Types.VARCHAR); <span style="color: #008000;">//</span><span style="color: #008000;">设置第二个参数为输出参数</span><br><span style="color: #008080;">23</span>         cs.execute(); <span style="color: #008000;">//</span><span style="color: #008000;">调用存储过程</span><br><span style="color: #008080;">24</span>         String name = cs.getString(2);<span style="color: #008000;">//</span><span style="color: #008000;">获取输出参数</span><br><span style="color: #008080;">25</span> <span style="color: #000000;">        System.out.println(name);<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">27</span><br><span style="color: #008080;">28</span> }</pre><br></div>

<p>　　如果有输出参数，需要特别指出，如上面的代码22行。</p>
<p>&nbsp;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/07/hibernate-mysql-proceduce.html" data-id="ciiy5f4v9009tq1d0p0wb7rbx" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/07/hibernate-mysql-proceduce.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web后端/">web后端</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/page/5/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/7/">Next &raquo;</a>
      </nav>
    </section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新博文</h3>
    <div class="widget">
      <ul id="recent-post" class="no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/人生感悟/">人生感悟</a></p>
              <p class="item-title"><a href="/2015/12/say-bye-to-my-2015.html" class="title">Say bye to my 2015</a></p>
              <p class="item-date"><time datetime="2015-12-25T09:25:10.000Z" itemprop="datePublished">2015-12-25</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/12/mvp-pattern-android.html" class="title">MVP模式在Android项目中的使用</a></p>
              <p class="item-date"><time datetime="2015-12-23T14:16:04.000Z" itemprop="datePublished">2015-12-23</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/12/intent-resolving-in-android-m.html" class="title">【译文】Android M中Intent的解析</a></p>
              <p class="item-date"><time datetime="2015-12-04T06:52:06.000Z" itemprop="datePublished">2015-12-04</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/12/performance-listviews.html" class="title">【译文】高性能ListViews</a></p>
              <p class="item-date"><time datetime="2015-12-02T10:22:14.000Z" itemprop="datePublished">2015-12-02</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/11/android-multi-photo-picker.html" class="title">Android带多选功能的PhotoPicker</a></p>
              <p class="item-date"><time datetime="2015-11-21T07:46:03.000Z" itemprop="datePublished">2015-11-21</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">博文分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Framework/">Framework</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hadoop/">Hadoop</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JNI-amp-NDK/">JNI&amp;NDK</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a><span class="category-list-count">35</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NoSQL/">NoSQL</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/人生感悟/">人生感悟</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他技术/">其他技术</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后端/">后端</a><span class="category-list-count">29</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构和算法/">数据结构和算法</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">7</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/AsyncTask/" style="font-size: 11.54px;">AsyncTask</a> <a href="/tags/LruCache/" style="font-size: 10px;">LruCache</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/NoSQL/" style="font-size: 13.08px;">NoSQL</a> <a href="/tags/android/" style="font-size: 18.46px;">android</a> <a href="/tags/android-studio/" style="font-size: 10px;">android studio</a> <a href="/tags/c/" style="font-size: 10px;">c++</a> <a href="/tags/camera/" style="font-size: 10px;">camera</a> <a href="/tags/framework/" style="font-size: 10.77px;">framework</a> <a href="/tags/hadoop/" style="font-size: 14.62px;">hadoop</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/jni/" style="font-size: 13.08px;">jni</a> <a href="/tags/linux/" style="font-size: 16.15px;">linux</a> <a href="/tags/mysql/" style="font-size: 11.54px;">mysql</a> <a href="/tags/redis/" style="font-size: 13.08px;">redis</a> <a href="/tags/spring/" style="font-size: 10.77px;">spring</a> <a href="/tags/sqlite/" style="font-size: 10px;">sqlite</a> <a href="/tags/web后端/" style="font-size: 19.23px;">web后端</a> <a href="/tags/内存缓存/" style="font-size: 10px;">内存缓存</a> <a href="/tags/前端/" style="font-size: 13.85px;">前端</a> <a href="/tags/反射/" style="font-size: 10px;">反射</a> <a href="/tags/图片选择/" style="font-size: 10.77px;">图片选择</a> <a href="/tags/多线程/" style="font-size: 17.69px;">多线程</a> <a href="/tags/布局/" style="font-size: 12.31px;">布局</a> <a href="/tags/布局优化/" style="font-size: 10.77px;">布局优化</a> <a href="/tags/开源/" style="font-size: 10.77px;">开源</a> <a href="/tags/断点续传/" style="font-size: 11.54px;">断点续传</a> <a href="/tags/科学上网/" style="font-size: 10px;">科学上网</a> <a href="/tags/自定义控件/" style="font-size: 10px;">自定义控件</a> <a href="/tags/解决方案/" style="font-size: 16.92px;">解决方案</a> <a href="/tags/设计模式/" style="font-size: 15.38px;">设计模式</a> <a href="/tags/译文/" style="font-size: 10.77px;">译文</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">博文归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">November 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">May 2013</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">August 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a><span class="archive-list-count">8</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap widget-list">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a target="_blank" href="http://blog.daimajia.com">代码家</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.trinea.cn">Trinea</a>
          </li>
        
          <li>
            <a target="_blank" href="https://www.aswifter.com">APP开发者</a>
          </li>
        
          <li>
            <a target="_blank" href="http://blog.seoui.com">笑松小站</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.apkfuns.com">舞影凌风</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.ttfde.org">TTF的家园</a>
          </li>
        
          <li>
            <a target="_blank" href="http://rocko.xyz">Rocko&#39;s blog</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.93sec.cc">教程资源网</a>
          </li>
        
      </ul>
    </div>
  </div>


  
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2000 - 2016 Lauren<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    

<script type="text/javascript">
  var duoshuoQuery = {short_name:"liuling07"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>





 <script src="//ajax.lug.ustc.edu.cn/ajax/libs/jquery/2.1.3/jquery.min.js"></script>




  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>