<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>残剑博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Hexo theme - Icarus">
<meta property="og:type" content="website">
<meta property="og:title" content="残剑博客">
<meta property="og:url" content="http://liuling07.github.io/page/8/index.html">
<meta property="og:site_name" content="残剑博客">
<meta property="og:description" content="Hexo theme - Icarus">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="残剑博客">
<meta name="twitter:description" content="Hexo theme - Icarus">
  
  
    <link rel="icon" href="favicon.png">
  
  
 <link href='//fonts.lug.ustc.edu.cn/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
 <link href="//fonts.lug.ustc.edu.cn/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">


  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css" type="text/css">
  

  

  
</head>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo"><i class="logo" style="background-image: url(/css/images/logo.png)"></i><span class="site-title">残剑博客</span></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/.">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="/css/images/protrait.jpg"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
      
      <div id="search-form-wrap">
        
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="http://liuling07.github.io"></form>
        
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
        
          <td><a class="main-nav-link" href="/.">Home</a></td>
        
          <td><a class="main-nav-link" href="/archives">Archives</a></td>
        
          <td><a class="main-nav-link" href="/categories">Categories</a></td>
        
          <td><a class="main-nav-link" href="/tags">Tags</a></td>
        
          <td><a class="main-nav-link" href="/about">About</a></td>
        
        <td>
          
            <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://liuling07.github.io"></form>
          
        </td>
      </tr>
    </table>
  </div>
</header>

    <div class="outer">
      
        <aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      <img id="avatar" src="/css/images/protrait.jpg">
      <h2 id="name">Lauren</h2>
      <h3 id="title">Android Developer</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Shenzhen, China</span>
      <a id="follow" href="https://github.com/liuling07">FOLLOW</a>
    </div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        135
        <span>posts</span>
      </div>
      <div class="article-info-block">
        32
        <span>tags</span>
      </div>
    </div>
    
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
          
          <td><a href="https://github.com/liuling07" target="_blank" title="github"><i class="fa fa-github"></i></a></td>
          
          <td><a href="http://weibo.com/LaurenLiuling/" target="_blank" title="weibo"><i class="fa fa-weibo"></i></a></td>
          
          <td><a href="https://plus.google.com/u/0/107098505138563589748/" target="_blank" title="google-plus"><i class="fa fa-google-plus"></i></a></td>
          
          <td><a href="http://stackoverflow.com/users/5629327/lauren-liuling" target="_blank" title="stack-overflow"><i class="fa fa-stack-overflow"></i></a></td>
          
          <td><a href="https://twitter.com/lauren_liuLing/" target="_blank" title="twitter"><i class="fa fa-twitter"></i></a></td>
          
          <td><a href="https://www.facebook.com/lauren.liuling/" target="_blank" title="facebook"><i class="fa fa-facebook"></i></a></td>
          
          <td><a href="/atom.xml" target="_blank" title="rss"><i class="fa fa-rss"></i></a></td>
          
        </tr>
      </table>
    </div>
    
    
  </div>
</aside>

      
      <section id="main">
      <article id="post-calltomaster-connection-refused" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/06/calltomaster-connection-refused.html">Call to master/192.168.137.101:9001 failed on connection exception: java.net.ConnectException: Connection refused</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/06/calltomaster-connection-refused.html">
      <time datetime="2013-06-06T05:35:00.000Z" itemprop="datePublished">2013-06-06</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Hadoop/">Hadoop</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>java.net.ConnectException: Call to master/192.168.137.101:9001 failed on connection exception: java.net.ConnectException: Connection refused<br>&nbsp;at org.apache.hadoop.ipc.Client.wrapException(Client.java:1099)<br>&nbsp;at org.apache.hadoop.ipc.Client.call(Client.java:1075)<br>&nbsp;at org.apache.hadoop.ipc.RPC$Invoker.invoke(RPC.java:225)<br>&nbsp;at org.apache.hadoop.mapred.$Proxy10.getProtocolVersion(Unknown Source)<br>&nbsp;at org.apache.hadoop.ipc.RPC.getProxy(RPC.java:396)<br>&nbsp;at org.apache.hadoop.ipc.RPC.getProxy(RPC.java:379)<br>&nbsp;at org.apache.hadoop.mapred.JobClient.createRPCProxy(JobClient.java:480)<br>&nbsp;at org.apache.hadoop.mapred.JobClient.init(JobClient.java:474)<br>&nbsp;at org.apache.hadoop.mapred.JobClient.<init>(JobClient.java:457)<br>&nbsp;at org.apache.hadoop.hive.ql.exec.ExecDriver.execute(ExecDriver.java:418)<br>&nbsp;at org.apache.hadoop.hive.ql.exec.MapRedTask.execute(MapRedTask.java:137)<br>&nbsp;at org.apache.hadoop.hive.ql.exec.Task.executeTask(Task.java:134)<br>&nbsp;at org.apache.hadoop.hive.ql.exec.TaskRunner.runSequential(TaskRunner.java:57)<br>&nbsp;at org.apache.hadoop.hive.ql.Driver.launchTask(Driver.java:1326)<br>&nbsp;at org.apache.hadoop.hive.ql.Driver.execute(Driver.java:1118)<br>&nbsp;at org.apache.hadoop.hive.ql.Driver.run(Driver.java:951)<br>&nbsp;at org.apache.hadoop.hive.cli.CliDriver.processLocalCmd(CliDriver.java:258)<br>&nbsp;at org.apache.hadoop.hive.cli.CliDriver.processCmd(CliDriver.java:215)<br>&nbsp;at org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:406)<br>&nbsp;at org.apache.hadoop.hive.cli.CliDriver.run(CliDriver.java:689)<br>&nbsp;at org.apache.hadoop.hive.cli.CliDriver.main(CliDriver.java:557)<br>&nbsp;at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)<br>&nbsp;at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)<br>&nbsp;at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)<br>&nbsp;at java.lang.reflect.Method.invoke(Method.java:601)<br>&nbsp;at org.apache.hadoop.util.RunJar.main(RunJar.java:156)<br>Caused by: java.net.ConnectException: Connection refused<br>&nbsp;at sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)<br>&nbsp;at sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:692)<br>&nbsp;at org.apache.hadoop.net.SocketIOWithTimeout.connect(SocketIOWithTimeout.java:206)<br>&nbsp;at org.apache.hadoop.net.NetUtils.connect(NetUtils.java:489)<br>&nbsp;at org.apache.hadoop.ipc.Client$Connection.setupConnection(Client.java:434)<br>&nbsp;at org.apache.hadoop.ipc.Client$Connection.setupIOstreams(Client.java:560)<br>&nbsp;at org.apache.hadoop.ipc.Client$Connection.access$2000(Client.java:184)<br>&nbsp;at org.apache.hadoop.ipc.Client.getConnection(Client.java:1206)<br>&nbsp;at org.apache.hadoop.ipc.Client.call(Client.java:1050)<br>&nbsp;… 24 more<br>Job Submission failed with exception ‘java.net.ConnectException(Call to master/192.168.137.101:9001 failed on connection exception: java.net.ConnectException: Connection refused)’<br>FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.MapRedTask</init></p>
<p>&nbsp;</p>
<p>解决方案：执行命令./hadoop namenode -format</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/06/calltomaster-connection-refused.html" data-id="ciiy5f4xn00drq1d0b5ilxyjj" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/06/calltomaster-connection-refused.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hadoop/">hadoop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web后端/">web后端</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-linux-command" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/06/linux-command.html">Linux中常用命令</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/06/linux-command.html">
      <time datetime="2013-06-05T00:14:00.000Z" itemprop="datePublished">2013-06-05</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <div id="a790" class="con"><br><div id="content"><br><br><strong>一、Linux下常用命令：文件与目录操作</strong><br>basename：从文件名中去掉路径和扩展名<br>cd：切换当前工作目录到指定目录<br>chgrp：改变文件所属组<br>chmod：改变文件的权限<br>chown：改变文件的所有者和组<br>cp：复制文件或目录<br>dd：复制文件并转换文件内容<br>file：确定文件类型<br>find：在指定目录下查找文件并执行指定的操作<br>ln：创建文件链接<br>locate/slocate：快速定位文件的路径<br>ls/dir/vdir：显示目录内容<br>mkdir：创建目录<br>mv：移动或重命名文件<br>pwd：显示当前工作目录<br>rename：重命名文件<br>rm：删除文件或目录<br>rmdir：删除空目录<br>touch：修改文件的时间属性<br>updatedb：创建或更新slocate数据库<br>whereis：显示指令程序、源代码和man手册页<br>which：显示指令的绝对路径<br><br><strong>二、Linux下常用命令：备份与压缩
</strong>ar：创建、修改归档文件和从归档文件中提取文件<br>arj：.arj文件压缩指令<br>bunzip2：压缩bzip2格式的压缩文件<br>bzcat：解压缩文件到标准输出<br>bzip2：创建.bz2格式的压缩文件<br>bzip2recover：修复损坏的.bz2文件<br>bzless/bzmore：解压缩.bz2文件并分屏显示内容<br>compress：压缩数据文件<br>cpio：存取归档包中的文件<br>dump：文件系统备份<br>gunzip：解压缩由gzip压缩的文件<br>gzexe：压缩可执行程序<br>gzip：GNU的压缩和解压缩工具<br>lha：压缩和解压缩指令<br>resotre：还原由dump备份的文件或文件系统<br>tar：创建备份档案文件<br>unarj：解压缩.arj文件<br>uncompress：解压缩.Z文件<br>unzip：解压缩.zip文件<br>zcat：解压缩文件并送到标准输出<br>zforce：强制gzip格式的文件加上.gz扩展名<br>zip：压缩文件<br>zipinfo：显示zip压缩文件的详细信息<br>znew：将&ldquo;.Z&rdquo;文件转换成&ldquo;.gz&rdquo;文件<br><br><strong>三、Linux下常用命令：文本处理</strong><br>cat：链接文件并显示到标准输出<br>cksum：检查和计算文件循环冗余校验码<br>cmp：比较两个文件的差异<br>col：过滤控制字符<br>colrm：从输入中过滤掉指定的列<br>comm：比较两个有序文件的不同<br>csplit：分割文件<br>cut：显示文件中每行的指定内容<br>diff3：比较3个文件的不同<br>diff：比较并显示两个文件的不同<br>diffstat：根据diff指令的结果显示统计信息<br>ed：行文本编辑器<br>emacs：全屏文本编辑器<br>ex：文本编辑器<br>expand：将Tab转换为空白（Space）<br>fmt：最优化文本格式<br>fold：设置文件显示的行宽<br>grep/egrep/fgrep：显示文件中匹配的行<br>head：输出文件开头部分内容<br>ispell：交互式拼写检查程序<br>jed：文本编辑器<br>joe：编辑文本文件<br>join：合并两个文件的相同字段<br>less：分屏查看文本文件<br>look：显示文件中以特定字符串开头的行<br>more：分屏查看文本文件<br>od：以数字编码输出文件内容<br>paste：合并文件的内容<br>pico：文本编辑器<br>sed：流文件编辑器<br>sort：排序数据文件<br>spell：拼写检查<br>split：分割文件<br>sum：计算并显示文件的校验码<br>tac：反序显示文件内容<br>tail：输出文件尾部部分内容<br>tee：将输入内容复制到标准输出和指定文件<br>tr：转换或删除文件中的字符<br>unexpand：将空白（Space）转换为Tab<br>uniq：删除文件中的重复行<br>vi：全屏文本编辑器<br>wc：计算文件的字节数、单词数和行数<br><br><strong>四、Linux下常用命令：shell指令</strong><br>alias：定义命令别名<br>bg：将作业（或任务）放到后台运行<br>bind：显示或设置键盘配置<br>declare：声明shell变量<br>dirs：显示shell目录堆栈中的记录<br>echo：打印字符串到标准输出<br>enable：激活与关闭shell内部命令<br>eval：执行指定指令并返回结果<br>exec：执行给定指令后退出登录<br>exit：退出当前shell<br>export：设置与显示环境变量<br>fc：编辑并执行历史命令<br>fg：将后台任务（或作业）切换到前台运行<br>hash：显示与清除指令时运行查询的哈希表<br>history：显示与操纵历史命令<br>jobs：显示shell的作业信息<br>kill：杀死进程或作业<br>logout：退出登录shell<br>popd：从shell目录堆栈中删除记录<br>pushd：向shell目录堆栈中添加记录<br>set：设置shell的执行方式<br>shopt：设置控制shell行为变量的开关值<br>ulimit：设置shell的资源限制<br>umask：设置创建文件的权限掩码<br>unalias：取消由alias定义的命令别名<br>unset：删除定义的变量或函数<br><br><strong>五、Linux下常用命令：打印相关指令
</strong>accept：接受打印请求<br>cancel：取消打印任务<br>disable：停止打印机<br>enable：启动打印机<br>lp：打印文件<br>lpadmin：配置cups打印机和类<br>lpc：控制打印机<br>lpq：显示当前打印队列<br>lpr：打印文件<br>lprm：删除当前打印队列中的作业<br>lpstat：显示CUPS的状态信息<br>pr：打印前转换文本格式<br>reject：拒绝打印请求<br><br><strong>六、Linux下常用命令：其他基础指令
</strong>bc：实现精确计算的计算器<br>cal：显示日历<br>clear：清屏指令<br>consoletype：显示当前使用的终端类型<br>ctrlaltdel：设置热键Ctrl+Alt+Del的功能<br>date：显示和设置系统日期时间<br>dircolors：设置ls指令显示时的颜色<br>eject：弹出可移动设备的介质<br>halt：关闭计算机<br>hostid：显示当前主机的数字标识<br>hwclock：查询和设置系统硬件时钟<br>info：读取帮助文档<br>login：登录系统<br>man：显示联机帮助手册<br>md5sum：计算并显示文件的md5摘要信息<br>mesg：设置终端写权限<br>mtools：显示mtools软件包的指令<br>mtoolstest：测试并显示mtools工具包的配置<br>poweroff：关闭计算机并切断电源<br>reboot：重新启动计算机<br>shutdown：关闭计算机<br>sleep：睡眠指定长的时间<br>stat：显示文件或文件系统的状态<br>talk：与其他用户交谈<br>wall：向所有终端发送信息<br>whatis：在数据库中查询关键字<br>who：显示当前已登录用户的信息<br>whoami：显示当前用户名<br>write：向指定用户终端发送信息<br>yes：不断输出指定字符串<br><br><strong>七、Linux下常用命令：用户管理
</strong>chfn：改变用户的finger信息<br>chsh：改变用户登录时的默认shell<br>finger：用户信息查询程序<br>gpasswd：管理组文件/etc/group<br>groupadd：创建组<br>groupdel：删除组<br>groupmod：修改组信息<br>groups：显示用户所属的组<br>grpck：验证组文件/etc/group的完整性<br>grpconv：启用组的影子口令文件<br>grpunconv：关闭组的影子口令文件<br>logname：显示登录用户名<br>passwd：设置用户密码<br>pwck：验证用户文件密码文件的完整性<br>pwconv：启用用户的影子口令文件<br>pwunconv：关闭用户的影子口令文件<br>su：切换用户<br>useradd：创建用户<br>userdel：删除用户<br>usermod：修改用户的配置信息<br>users：显示当前登录系统的用户名<br><br><strong>八、Linux下常用命令：进程管理
</strong>init：进程初始化控制<br>killall：根据名称结束进程<br>nice：设置进程优先级<br>nohup：以忽略挂起信号方式运行程序<br>pgrep：基于名字查询并显示进程号<br>pidof：查找正在运行程序的进程号<br>pkill：向指定的进程发送信号<br>ps：显示系统当前的进程状态<br>pstree：用树形图显示进程的父子关系<br>renice：调整进程优先级<br>w：显示当前登录用户的相关信息<br>watch：全屏方式显示指定命令的输出信息<br><br><strong>九、Linux下常用命令：磁盘与文件系统管理</strong><br>badblocks：磁盘坏块检查工具<br>blockdev：从命令行调用块设备的ioctl函数<br>chattr：改变文件的第2扩展文件系统属性<br>convertquota：转换quota文件格式<br>df：报告磁盘剩余空间情况<br>dumpe2fs：显示ext2/ext3文件系统信息<br>e2fsck：检查ext2/ext3文件系统<br>e2image：保存ext2/ext3源数据到文件<br>e2label：设置ext2/ext3文件系统标签<br>edquota：编辑用户的磁盘空间配额<br>fdisk：Linux下的分区工具<br>findfs：查找文件系统<br>fsck：检查与修复Linux文件系统<br>grub：Linux下的引导加载器<br>hdparm：调整硬盘I/O性能<br>lilo：Linux加载器<br>lsattr：显示文件的ext2文件系统属性<br>mkbootdisk：为当前系统创建专门的引导软盘<br>mke2fs：创建第2扩展文件系统<br>mkfs：创建各种文件系统<br>mkinitrd：创建初始化ram磁盘映像文件<br>mkisofs：创建光盘映像文件<br>mknod：创建块设备或字符设备文件<br>mkswap：创建交换分区文件系统<br>mktemp：创建临时文件<br>mount：加载文件系统<br>parted：磁盘分区管理工具<br>quota：显示用户磁盘配额<br>quotacheck：创建、检查和修复配额文件<br>quotaoff：关闭文件系统的磁盘配额功能<br>quotaon：打开文件系统的磁盘配额功能<br>quotastat：显示磁盘配额状态<br>repquota：显示文件系统磁盘配额信息报表<br>swapoff：关闭交换空间<br>swapon：激活交换空间<br>sync：强制将缓存数据写入磁盘<br>tune2fs：调整ext2/ext3文件系统的参数<br>umount：卸载已经加载的文件系统<br><br><strong>十、Linux下常用命令：内核与性能</strong><br>depmod：处理内核可加载模块的依赖关系<br>dmesg：显示内核的输出信息<br>free：显示内存使用情况<br>insmod：加载模块到内核<br>iostat：报告CPU、I/O设备及分区状态<br>ipcs：显示进程间通信的状态信息<br>kernelversion：显示内核主版本号<br>lsmod：显示已加载的模块<br>modinfo：显示内核模块信息<br>modprobe：加载内核模块并解决依赖关系<br>mpstat：显示进程相关状态信息<br>rmmod：从内核中删除模块<br>sar：收集、显示和保存系统活动信息<br>slabtop：实时显示内核的slab缓存信息<br>sysctl：运行时修改内核参数<br>tload：监视系统平均负载情况<br>top：显示和管理系统进程<br>uname：显示系统信息<br>uptime：显示系统运行时间及平均负载<br>vmstat：显示虚拟内存的状态<br><br><strong>十一、Linux下常用命令：X-Window系统</strong><br>startx：初始化X-Window会话<br>xauth：X系统授权许可文件管理工具<br>xhost：显示和配置X服务器的访问权限<br>xinit：X-Window系统初始化程序<br>xlsatoms：显示X服务器原子数据定义<br>xlsclients：显示指定显示器上运行的X程序<br>xlsfonts：显示X服务器使用的字体信息<br>xset：设置X系统的用户偏爱属性<br><br><strong>十二、Linux下常用命令：系统安全</strong><br>chroot：以指定根目录运行指令<br>nmap：网络探测工具和安全扫描器<br>scp：加密的远程复制工具<br>sftp：安全文件传输工具<br>slogin：加密的远程登录工具<br>ssh：加密的远程登录工具<br>sudo：以另一个用户身份执行指令<br><br><strong>十三、Linux下常用命令：编程相关指令</strong><br>awk/gawk：模式扫描与处理语言<br>expr：计算表达式的值<br>gcc：GNU的C语言编译器<br>gdb：GNU调试器<br>ldd：显示共享库依赖<br>make：工程编译工具<br>nm：显示目标文件的符号表<br>perl：perl语言的命令行工具<br>php：PHP脚本语言命令行接口<br>test：条件测试<br><br><strong>十四、Linux下常用命令：其他系统管理与维护指令</strong><br>arch：显示当前主机的硬件架构<br>at：按照时间安排任务的执行<br>atq：查询待执行的任务<br>atrm：删除待执行的任务<br>batch：在指定时间运行任务<br>chkconfig：设置系统在不同运行等级下所执行的服务<br>crontab：按照时间设置计划任务<br>last：显示以前登录过系统的用户相关信息<br>lastb：显示登录系统失败的用户相关信息<br>logrotate：系统日志的轮循工具<br>logsave：将命令的输出信息保存到日志文件<br>logwatch：报告和分析系统日志<br>lsusb：显示所有的USB设备<br>patch：补丁与更新文件<br>rpm：Red Hat软件包管理器<br>runlevel：显示当前系统的运行等级<br>service：Linux服务管理和控制工具<br>telinit：切换当前系统的运行等级<br>yum：RPM软件包自动化管理工具<br><br><strong>十五、Linux下常用命令：网络配置</strong><br>dnsdomainname：显示系统的DNS域名<br>domainname：显示和设置主机域名<br>hostname：显示或者设置系统主机名<br>ifcfg：配置网络接口<br>ifconfig：配置网络接口的网络参数<br>ifdown：关闭指定网络接口<br>ifup：启动指定网络接口<br>nisdomainname：显示和设置主机域名<br>route：显示与操纵本机的IP路由表<br>ypdomainname：显示和设置主机域名<br><br><strong>十六、Linux下常用命令：网络测试与应用</strong><br>arp：管理本机arp缓冲区<br>arping：向相邻主机发送ARP请求报文<br>arpwatch：监听网络上的ARP信息<br>dig：域名查询工具<br>elinks：纯文本网页浏览器<br>elm：电子邮件客户端程序<br>ftp：文件传输协议客户端<br>host：DNS域名查询工具<br>ipcalc：IP地址计算器<br>lynx：纯文本网页浏览器<br>mail：电子邮件管理程序<br>ncftp：增强的FTP客户端工具<br>netstat：显示网络状态<br>nslookup：DNS域名查询工具<br>pine：电子邮件和新闻组处理程序<br>ping：测试到达目标主机的网络是否通畅<br>rsh：远程shell<br>telnet：远程登录工具<br>tftp：简单文件传输协议客户端<br>tracepath：追踪数据经过的路由<br>traceroute：追踪数据包到达目的主机经过的路由<br>wget：从指定URL地址下载文件<br><br><strong>十七、Linux下常用命令：高级网络指令
</strong>arptables：管理内核的ARP规则表<br>ip：强大的多功能网络配置工具<br>iptables：IP包过滤与NAT管理工具<br>iptables-save：保存内核中iptables的配置<br>iptables-restore：还原iptables的配置信息<br>tcpdump：监听网络流量<br><br>&nbsp;<br><br><strong>十八、Linux下常用命令：网络服务器指令</strong><br>ab：Web服务器性能测试<br>apachectl：Apache HTTP服务器控制接口<br>exportfs：管理NFS服务器共享的文件系统<br>htdigest：管理用于摘要认证的用户文件<br>htpasswd：管理用于基本认证的用户文件<br>httpd：Apache超文本传输协议服务器<br>mailq：显示待发送的邮件队列<br>mysql：MySQL服务器的客户端工具<br>mysqladmin：MySQL服务器管理工具<br>msqldump：MySQL服务器备份工具<br>mysqlimport：MySQL数据库导入工具<br>mysqlshow：显示MySQL数据库、表和字段信息<br>nfsstat：显示网络文件系统状态<br>sendmail：电子邮件传送代理程序<br>showmount：显示NFS服务器上的加载信息<br>smbclient：samba服务器客户端工具<br>smbmount：加载samba文件系统<br>smbpasswd：改变samba用户的密码<br>squid：HTTP代理服务器程序<br>sshd：OpenSSH守护进程<br><br></div><br><div class="clear">&nbsp;</div><br></div>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/06/linux-command.html" data-id="ciiy5f4sv0069q1d08lfgyjz5" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/06/linux-command.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-virtualbox-centos-network" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/06/virtualbox-centos-network.html">virtualbox虚拟机上安装centOS的网络配置</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/06/virtualbox-centos-network.html">
      <time datetime="2013-06-03T07:06:00.000Z" itemprop="datePublished">2013-06-03</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　最近接触hadoop，需要在在Linux上面开发，所以我装了一个virtualbox虚拟机，在该虚拟机上面安装了一个centOS系统。linux系统是装好了，但是网络配置却另人头疼。我主要是想让宿主机和虚拟机能够互相访问。</p>
<p>　　然后我就百度了一下，根据百度的结果一步一步的配置。</p>
<p>　　安装virtualbox之后它会在宿主机上面安装一个虚拟网卡，如图</p>
<p>　　<img src="http://www.liuling123.com/wp-content/uploads/2015/11/03223024-0039d1288826493ea4bc290cd562b0cb.jpg" alt=""></p>
<p>双击它，查看详情，信息如图所示</p>
<p><img src="http://www.liuling123.com/wp-content/uploads/2015/11/03223147-ba39b13682814ee5a012c316a51254ad.jpg" alt=""></p>
<p>　　在虚拟机上面配置网络我使用的是host-only方式，当然也可以使用桥接的方式，至于他们的区别，网上很多。虚拟机上面主要是使用这块虚拟网卡作为网关。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 进入centOS系统后主要有三个文件需要配置：</p>
<p>　　1、修改ip地址</p>
<p>　　使用命令&nbsp; vi /etc/sysconfig/network-scripts/ifcfg-eth0 修改该文件内容如下</p>
<p>DEVICE=”eth0”<br>BOOTPROTO=”static”&nbsp;&nbsp; 这里改为使用静态ip<br>HWADDR=”08:00:27:0C:33:8F”<br>NM_CONTROLLED=”yes”<br>ONBOOT=”yes”&nbsp;&nbsp; 设置为自动启动<br>TYPE=”Ethernet”<br>UUID=”f4adafbc-322d-4dc8-b549-4291f1c04f01”<br>IPADDR=192.168.137.101&nbsp;&nbsp;&nbsp;&nbsp; 设置该虚拟机的ip地址，要与宿主机在一个网段，但是不能重名<br>NETMASK=255.255.255.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 设置子网掩码</p>
<p>#GATEWAY=192.168.137.1&nbsp;&nbsp; 设置网关，也就是</p>
<p>　　2、修改网关</p>
<p>使用命令：vi /etc/sysconfig/network 修改该文件内容如下：</p>
<p>NETWORKING=yes<br>HOSTNAME=localhost.localdomain<br>GATEWAY=192.168.137.1&nbsp;&nbsp; 这里设置网关，也就是那个虚拟网卡的ip</p>
<p>　　3、修改DNS</p>
<p>使用命令：vi /ect/resolv.conf&nbsp; 修改该文件内容如下：</p>
<p>nameserver 192.168.137.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 增加一个域名服务器</p>
<p>&nbsp;</p>
<p>最后重启一下network服务就ok了，使用命令service network restart.</p>
<p>&nbsp;</p>
<p>开始，我按照这个步骤来，完成好配置。在宿主机上面ping虚拟机，没问题能ping通。但是在虚拟机上面ping宿主机和网关则出问题了，更不用说ping外网了。问题如下：</p>
<p>ping宿主机和网关，并没有提示Ping不通，只是接收不到对方的信息，Packets:Sent = 4,Received = 0,Lost&nbsp;= 4(100% loss)。ping <a href="http://www.baidu.com/" target="_blank" rel="external">www.baidu.com</a> 结果为无效的主机名。 这问题困扰了我整整一天，百度也找不到结果。我知道问题肯定出在ip的配置上面，在今天晚上百度无果后，我想到了那块虚拟网卡，我用上面的方法配置，是用那块虚拟网卡作为网关的，但是那虚拟网卡根本就没有配置，它与我的电脑上的网卡没有一点关系，直接去用它肯定是不行的。后来我又想到我们可以使用宽带共享无线wifi,为什么不能把宽带连接共享给那块虚拟网卡呢？马上试一下，启动共享后，虚拟网卡的ip又改变了，然后重新在centos按照上面步骤配置一下网络信息，结果还真的可以了，困扰我一两天的问题终于解决了。</p>
<p><img src="http://www.liuling123.com/wp-content/uploads/2015/11/03230410-3c0070be3fa54305920c20be3572ad7a.jpg" alt=""></p>
<p>&nbsp;ping 宿主机，ok.</p>
<p>&nbsp;ping <a href="http://www.baidu.com/" target="_blank" rel="external">www.baidu.com</a> 也ok.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/06/virtualbox-centos-network.html" data-id="ciiy5f4ox0006q1d02rqjmyf2" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/06/virtualbox-centos-network.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/">linux</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-asm-java-multi-extends" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/05/asm-java-multi-extends.html">使用 ASM 实现 Java 语言的“多重继承”</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/05/asm-java-multi-extends.html">
      <time datetime="2013-05-31T05:50:00.000Z" itemprop="datePublished">2013-05-31</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Java基础/">Java基础</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p><span class="atitle" style="font-size: 1.5em; font-weight: bold;">问题的提出</span></p>
<p><span style="font-size: 14px;">在大部分情况下，需要多重继承往往意味着糟糕的设计。但在处理一些遗留项目的时候，多重继承可能是我们能做出的选择中代价最小的。由于 Java 语言本身不支持多重继承，这常常会给我们带来麻烦，最后的结果可能就是大量的重复代码。本文试图使用 ASM 框架来解决这一问题。在扩展类的功能的同时，不产生任何重复代码。</span></p>
<p><span style="font-size: 14px;">考虑如下的实际情况：有一组类，名为 SubClass1、SubClass2、SubClass3 和 SubClass4，它们共同继承了同一个父类 SuperClass。现在，我们需要这组类中的一部分，例如 SubClass1 和 SubClass2，这两个类还要实现另外两个接口，它们分别为：IFibonacciComputer 和 ITimeRetriever。然而，这两个接口已经有了各自的实现类 FibonacciComputer 和 TimeRetriever。并且这两个类的实现逻辑就是我们想要的，我们不想做任何改动，只希望在 SubClass1 和 SubClass2 两个类中包含这些实现逻辑。</span></p>
<p><span style="font-size: 14px;">它们的结构如图 1 所示：</span></p>
<p><strong>图 1. 结构类图</strong><br><img src="http://www.liuling123.com/wp-content/uploads/2015/11/image003.jpg" alt="图 1\. 结构类图"><span style="text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">&nbsp;</span></span></p>
<p><span style="font-size: 14px;">由于 SubClass1,SubClass2 已经继承了 SuperClass，所以我们无法让它们再继承 FibonacciComputer 或 TimeRetriever。</span></p>
<p><span style="font-size: 14px;">所以，想要它们再实现 IFibonacciComputer 和 ITimeRetriever 这两个接口，必然会产生重复代码。</span></p>
<p><span style="font-size: 14px;">下面，我们就使用 ASM 来解决这个问题。</span></p>
<div class="ibm-alternate-rule" style="height: 1px; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; clear: both; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; background-image: url('http://1.www.s81c.com/i/solid.gif'); background-repeat: repeat no-repeat; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;</div>

<p>&nbsp;</p>
<p><span class="atitle" style="font-size: 1.5em; font-weight: bold;">Java class 文件格式以及类加载器介绍</span></p>
<p><span style="font-size: 14px;">在后面的内容中，需要对 Java class 文件格式以及类加载器的知识有一定的了解，所以这里先对这些内容做一个简单介绍：</span></p>
<p><span class="smalltitle" style="font-size: 14px; font-weight: bold;">class 文件格式</span></p>
<p><span style="font-size: 14px;">Java class 文件的结构如图 2 所示（图中&ldquo;*&rdquo;表示出现 0 次或任意多次）：</span></p>
<p><strong>图 2.Java class 文件结构</strong><br><img src="http://www.liuling123.com/wp-content/uploads/2015/11/image005.jpg" alt="图 2.Java class 文件结构"><span style="text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">&nbsp;</span></span></p>
<p><span style="font-size: 14px;">详细说明如下：</span></p>
<ul>
<li><span style="font-size: 14px;"><strong>Magic Number</strong>: 每个 class 文件的前 4 个字节被称为&ldquo;魔数&rdquo;，它的内容为：0xCAFEBABE。魔数的作用在于可以轻松地分辨出一个文件是不是 class 文件。</span></li>
<li><span style="font-size: 14px;"><strong>Version</strong>: 该项指明该 class 文件的版本号。</span></li>
<li><span style="font-size: 14px;"><strong>Constant Pool</strong>: 常量池是 class 文件中结构最为复杂，也最为重要的部分。常量池包含了与文件中类和接口相关的常量。常量池中存储了诸如文字字符串，final 变量值。Java 虚拟机把常量池组织为入口列表的形式。常量池中许多入口都指向其他的常量入口，而且 class 文件中紧随着常量池的许多条目也都会指向常量池的入口。除了字面常量之外，常量池还可以容纳以下几种符号引用：类和接口的全限定名，字段的名称和描述符和方法的名称和描述符等。</span></li>
<li><span style="font-size: 14px;"><strong>Modifiers</strong>: 该项指明该文件中定义的是类还是接口，以及声明中用了哪种修饰符，类或接口是私有的，还是公共的，类的类型是否是 final 的，等等。</span></li>
<li><span style="font-size: 14px;"><strong>This class</strong>: 该项是对常量池的索引。在这个位置，Java 虚拟机能够找到一个容纳了类或接口全限定名的入口。这里需要注意的是：在 class 文件中，所有类的全限定名都是以内部名称形式表示的。内部名称是将原先类全限定名中的&ldquo;.&rdquo;替换为&ldquo;/&rdquo;。例如：java.lang.String 的内部名称为 java/lang/String。</span></li>
<li><span style="font-size: 14px;"><strong>Super Class</strong>: 该项也是对常量池的索引，指明了该类超类的内部名称。</span></li>
<li><span style="font-size: 14px;"><strong>Interfaces</strong>: 该项指明了由该类直接实现或由接口扩展的父接口的信息。</span></li>
</ul>
<p><span style="font-size: 14px;"><strong>注</strong>：Modifiers,This Class,Super Class 和 Interfaces 这四项的和就是一个类的声明部分。</span></p>
<ul>
<li><span style="font-size: 14px;"><strong>Annotation</strong>: 该项存储的是注解相关的内容，注解可能是关于类的，方法的以及字段的。</span></li>
<li><span style="font-size: 14px;"><strong>Attribute</strong>: 该项用来存储关于类，字段以及方法的附加信息。在 Java 5 引入了注解之后，该部分内容几乎已经没有用处。</span></li>
<li><p><span style="font-size: 14px;"><strong>Field</strong>: 该项用来存储类的字段信息。</span></p>
</li>
<li><p><span style="font-size: 14px;"><strong>Method</strong>: 该项用来存储类的方法信息。</span></p>
</li>
</ul>
<p><span class="smalltitle" style="font-size: 14px; font-weight: bold;">类装载器介绍</span></p>
<p><span style="font-size: 14px;">类装载器负责查找并装载类。每个类在被使用之前，都必须先通过类装载器装载到 Java 虚拟机当中。Java 虚拟机有两种类装载器 :</span></p>
<ul>
<li><span style="font-size: 14px;"><strong>启动类装载器</strong></span></li>
</ul>
<p><span style="font-size: 14px;">启动类装载器是 Java 虚拟机实现的一部分，每个 Java 虚拟机都必须有一个启动类装载器，它知道怎么装载受信任的类，比如 Java API 的 class 文件。</span></p>
<ul>
<li><span style="font-size: 14px;"><strong>用户自定义装载器</strong></span></li>
</ul>
<p><span style="font-size: 14px;">用户自定义装载器是普通的 Java 对象，它的类必须派生自 java.lang.ClassLoader 类。ClassLoader 类中定义的方法为程序提供了访问类装载机制的接口。</span></p>
<div class="ibm-alternate-rule" style="height: 1px; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; clear: both; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; background-image: url('http://1.www.s81c.com/i/solid.gif'); background-repeat: repeat no-repeat; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;</div>

<p>&nbsp;</p>
<p><span class="atitle" style="font-size: 1.5em; font-weight: bold;">ASM 简介以及编程模型</span></p>
<p><span class="smalltitle" style="font-size: 14px; font-weight: bold;">ASM 简介</span></p>
<p><span style="font-size: 14px;">ASM 是一个可以用来生成\转换和分析 Java 字节码的代码库。其他类似的工具还有<span class="Apple-converted-space">&nbsp;</span><a href="http://cglib.sourceforge.net/" target="_blank" rel="external">cglib</a>、<a href="http://www.ibm.com/developerworks/cn/java/j-lo-asm/serp.sourceforge.net" target="_blank" rel="external">serp</a>和<span class="Apple-converted-space">&nbsp;</span><a href="http://commons.apache.org/bcel/" target="_blank" rel="external">BCEL</a>等。相较于这些工具，ASM 有以下的优点 :</span></p>
<ul>
<li><span style="font-size: 14px;">ASM 具有简单、设计良好的 API，这些 API 易于使用。</span></li>
<li><span style="font-size: 14px;">ASM 有非常良好的开发文档，以及可以帮助简化开发的 Eclipse 插件</span></li>
<li><span style="font-size: 14px;">ASM 支持 Java 6</span></li>
<li><span style="font-size: 14px;">ASM 很小、很快、很健壮</span></li>
<li><span style="font-size: 14px;">ASM 有很大的用户群，可以帮助新手解决开发过程中遇到的问题</span></li>
<li><span style="font-size: 14px;">ASM 的开源许可可以让你几乎以任何方式使用它</span></li>
</ul>
<p><span class="smalltitle" style="font-size: 14px; font-weight: bold;">编程模型</span></p>
<p><span style="font-size: 14px;">ASM 提供了两种编程模型：</span></p>
<ul>
<li><span style="font-size: 14px;">Core API，提供了基于事件形式的编程模型。该模型不需要一次性将整个类的结构读取到内存中，因此这种方式更快，需要更少的内存。但这种编程方式难度较大。</span></li>
<li><span style="font-size: 14px;">Tree API，提供了基于树形的编程模型。该模型需要一次性将一个类的完整结构全部读取到内存当中，所以这种方法需要更多的内存。这种编程方式较简单。</span></li>
</ul>
<p><span style="font-size: 14px;">下文中，我们将只使用 Core API，因此我们只介绍与其相关的类。</span></p>
<p><span style="font-size: 14px;">Core API 中操纵字节码的功能基于 ClassVisitor 接口。这个接口中的每个方法对应了 class 文件中的每一项。Class 文件中的简单项的访问使用一个单独的方法，方法参数描述了这个项的内容。而那些具有任意长度和复杂度的项，使用另外一类方法，这类方法会返回一个辅助的 Visitor 接口，通过这些辅助接口的对象来完成具体内容的访问。例如 visitField 方法和 visitMethod 方法，分别返回 FieldVisitor 和 MethodVisitor 接口的对象。</span></p>
<p><span style="font-size: 14px;">清单 1 为 ClassVisitor 中的方法列表：</span></p>
<p><span style="font-size: 14px;"><strong>清单 1.ClassVisitor 接口中的方法</strong></span></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode"><br> public interface ClassVisitor {<br>   // 访问类的声明部分<br>    void <strong>visit</strong>(int version, int access, String name, String<br> signature,String superName, String[] interfaces);<br>   // 访问类的代码<br>    void <strong>visitSource</strong>(String source, String debug);<br>   // 访问类的外部类<br>    void <strong>visitOuterClass</strong>(String owner, String name, String desc);<br>   // 访问类的注解<br>    AnnotationVisitor <strong>visitAnnotation</strong>(String desc, boolean visible);<br>   // 访问类的属性<br>    void <strong>visitAttribute</strong>(Attribute attr);<br>   // 访问类的内部类<br>    void <strong>visitInnerClass</strong>(String name, String outerName,<br> String innerName,int access);<br>   // 访问类的字段<br>    FieldVisitor <strong>visitField</strong>(int access, String name, String desc,<br> String signature, Object value);<br>   // 访问类的方法<br>    MethodVisitor <strong>visitMethod</strong>(int access, String name,<br> String desc,String signature, String[] exceptions);<br>   // 访问结束<br>    void <strong>visitEnd</strong>();<br> }<br></pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;">ClassVisitor 接口中的方法在被调用的时候是有严格顺序的，其顺序如清单 2 所示（其中&ldquo;？&rdquo;表示被调用 0 次或 1 次。&ldquo;*&rdquo;表示被调用 0 次或任意多次）：</span></p>
<p><strong>清单 2.ClassVisitor 中方法调用的顺序</strong></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode"><br>  visit<br>  visitSource?<br>  visitOuterClass?<br>  ( visitAnnotation| visitAttribute)<em><br>  ( visitInnerClass| visitField| visitMethod)</em><br>  visitEnd<br>            </pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;">这就是说，visit 方法必须最先被调用，然后是最多调用一次 visitSource 方法，然后是最多调用一次 visitOuterClass 方法。然后是 visitAnnotation 和 visitAttribute 方法以任意顺序被调用任意多次。再然后是以任任意顺序调用 visitInnerClass ,visitField 或 visitMethod 方法任意多次。最终，调用一次 visitEnd 方法。</span></p>
<p><span style="font-size: 14px;">ASM 提供了三个基于 ClassVisitor 接口的类来实现 class 文件的生成和转换：</span></p>
<ul>
<li><span style="font-size: 14px;"><strong>ClassReader</strong>：ClassReader 解析一个类的 class 字节码，该类的 accept 方法接受一个 ClassVisitor 的对象，在 accept 方法中，会按上文描述的顺序逐个调用 ClassVisitor 对象的方法。它可以被看做事件的生产者。</span></li>
<li><span style="font-size: 14px;"><strong>ClassAdapter</strong>：ClassAdapter 是 ClassVisitor 的实现类。它的构造方法中需要一个 ClassVisitor 对象，并保存为字段 protected ClassVisitor cv。在它的实现中，每个方法都是原封不动的直接调用 cv 的对应方法，并传递同样的参数。可以通过继承 ClassAdapter 并修改其中的部分方法达到过滤的作用。它可以看做是事件的过滤器。</span></li>
<li><span style="font-size: 14px;"><strong>ClassWriter</strong>：ClassWriter 也是 ClassVisitor 的实现类。ClassWriter 可以用来以二进制的方式创建一个类的字节码。对于 ClassWriter 的每个方法的调用会创建类的相应部分。例如：调用 visit 方法就是创建一个类的声明部分，每调用一次 visitMethod 方法就会在这个类中创建一个新的方法。在调用 visitEnd 方法后即表明该类的创建已经完成。它最终生成一个字节数组，这个字节数组中包含了一个类的 class 文件的完整字节码内容 。可以通过 toByteArray 方法获取生成的字节数组。ClassWriter 可以看做事件的消费者。</span></li>
</ul>
<p><span style="font-size: 14px;">通常情况下，它们是组合起来使用的。</span></p>
<p><span style="font-size: 14px;">下面举一个简单的例子：假设现在需要对 class 文件的版本号进行修改，将其改为 Java 1.5。操作方法如下：</span></p>
<ol>
<li><span style="font-size: 14px;">首先通过 ClassReader 读取这个类；</span></li>
<li><p><span style="font-size: 14px;">然后创建一个 ClassAdapter 的子类 ChangeVersionAdapter。在 ChangeVersionAdapter 中，覆盖 visit 方法，在调用 ClassVisitor#visit 方法时修改其中关于版本号的参数。该方法的签名如下：visit(int version, int access, String name, String signature, String superName, String[] interfaces)，其中每个参数的含义如下：</span></p>
<pre><code>1.  &lt;span style=&quot;font-size: 14px;&quot;&gt;version：class 文件的版本号，这就是我们需要修改的内容；&lt;/span&gt;
</code></pre><ol>
<li><span style="font-size: 14px;">access：该类的访问级别；</span></li>
<li><span style="font-size: 14px;">name：该类的内部名称；</span></li>
<li><span style="font-size: 14px;">signature：该类的签名，如果该类与泛型无关，这个参数就是 null;</span></li>
<li><span style="font-size: 14px;">superName：父类的内部名称；</span></li>
<li><span style="font-size: 14px;">interfaces：该类实现的接口的内部名称；</span></li>
</ol>
</li>
</ol>
<p><span style="font-size: 14px;">明白这些参数的含义之后，修改就很容易，只需要在调用 cv.visit 的时候，将 version 参数指定为 Opcodes.V1_5 即可（Opcodes 是 ASM 中的一个类），其他参数不加修改原样传递。这样，经过该 ClassAdapter 过滤后的类的版本号就都是 Java 1.5 了。</span></p>
<ol>
<li><span style="font-size: 14px;">在创建 ChangeVersionAdapter 对象时，构造方法传递一个 ClassWriter 的对象。该 ClassWriter 会随着 ChangeVersionAdapter 方法的调用按顺序创建出类的每一个部分。由于在 visit 方法中，version 参数已经被过滤为 Opcodes.V1_5，所以该 ClassWriter 最终产生的 class 字节码的版本号就是 V1.5 的；</span></li>
<li><span style="font-size: 14px;">然后通过 ClassWriter#toByteArray 方法获取修改后的类的完整的字节码内容；</span></li>
<li><span style="font-size: 14px;">当然，想要使用这个类，还需要通过一个自定义类加载器，将获得到的字节码加载到虚拟机当中，才可以创建这个类的实例；</span></li>
</ol>
<p><span style="font-size: 14px;">代码片段如清单 3 所示：</span></p>
<p><strong>清单 3. 使用 ASM 的代码示例</strong></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode"><br>&hellip;<br> // 使用 ChangeVersionAdapter 修改 class 文件的版本<br> ClassReader cr = new ClassReader(className);<br> ClasssWriter cw = new ClassWriter(0);<br> // ChangeVersionAdapter 类是我们自定义用来修改 class 文件版本号的类<br> ClassAdapter ca = new ChangeVersionAdapter (cw);<br> cr.accept(ca, 0);<br> byte[] b2 = cw.toByteArray();<br>&hellip;<br></pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;">图 3 是相应的 Sequence 图：</span></p>
<p><strong>图 3. 修改版本号的 Sequence 图</strong><br><img src="http://www.liuling123.com/wp-content/uploads/2015/11/image006.png" alt="图 3\. 修改版本号的 Sequence 图"><span style="text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">&nbsp;</span></span></p>
<p><span class="smalltitle" style="font-size: 14px; font-weight: bold;">代码示例</span></p>
<p><span style="font-size: 14px;">在了解了以上的知识之后再回到我们刚开始提出的问题中，我们希望 SubClass1 和 SubClass2 在继承自 SuperClass 的同时还要实现 IFibonacciComputer 以及 ITimeRetriever 两个接口。</span></p>
<p><span style="font-size: 14px;">为了后文描述方便，这里先确定三个名词：</span></p>
<ul>
<li><span style="font-size: 14px;"><strong>实现类</strong>即完成了接口实现的类，这里为 FibonacciComputer 以及 TimeRetriever。</span></li>
<li><span style="font-size: 14px;"><strong>待增强类</strong>即需要实现功能增强，加入实现逻辑的类，这里为 SubClass1 和 SubClass2。</span></li>
<li><span style="font-size: 14px;"><strong>增强类</strong>即在待增强类的基础上，加入了接口实现的类。这个类目前没有实际的类与之对应。</span></li>
</ul>
<p><span style="font-size: 14px;">如果只能在源代码级别进行修改，我们能做的仅仅是将实现类的代码拷贝进待增强类。（当然，有稍微好一点的做法在每一个待增强类中包含一个实现类，以组合的方式实现接口。但这仍然不能避免多个待增强类中的代码重复。）</span></p>
<p><span style="font-size: 14px;">在学习了 ASM 之后，我们可以直接从字节码的层次来进行修改。回忆一下上文中的内容：使用 ClassWrite 可以直接创建类的字节码，不同的方法创建了 class 文件的不同部分，尤其重要的是以下几个方法：</span></p>
<ul>
<li><span style="font-size: 14px;">visit 方法创建一个类的声明部分</span></li>
<li><span style="font-size: 14px;">visitField 方法创建一个类的字段</span></li>
<li><span style="font-size: 14px;">visitMethod 方法创建一个类的方法</span></li>
<li><span style="font-size: 14px;">visitEnd 方法，表明该类已经创建完成</span></li>
</ul>
<p><span style="font-size: 14px;">所以，现在我们可以直接从字节码的层次完成这一需求：<strong>动态的创建一个新的类（即增强类）继承自待增强类，同时在该类中，将实现类的实现方法**</strong>添加<strong>**进来</strong>。</span></p>
<p><span style="font-size: 14px;">完整的实现逻辑如下：</span></p>
<ol>
<li><span style="font-size: 14px;">创建一个 ClassAdapter 的子类 AddImplementClassAdapter，这个类将被用来访问待增强类。AddImplementClassAdapter 期待一个 ClassWriter 作为 ClassVisitor。该 ClassWriter 在访问待增强类的同时逐步完成增强类的创建。</span></li>
<li><span style="font-size: 14px;">在 AddImplementClassAdapter 中覆盖 visitEnd 方法，在调用 ClassVisitor#visitEnd 方法之前，使用该 ClassVisitor 逐个访问每一个实现类。由于实现类中的内容也需要进行一定的过滤，所以这里的 ClassVisitor 在访问实现类的时候也需要经过一个 ClassAdapter 进行过滤。创建另一个 ClassAdapter 的子类 ImplementClassAdapter 来完成这个过滤。由于这个 ClassVisitor 是一个 ClassWriter。这样做的效果就是将实现类的内容添加到增强类中。</span></li>
<li><span style="font-size: 14px;">在完成了所有实现类的访问之后，调用 ClassVisitor#visitEnd 方法表明增强类已经创建完成。</span></li>
<li><span style="font-size: 14px;">使用一个 ClassReader 的对象读取待增强类。</span></li>
<li><span style="font-size: 14px;">创建一个 AddImplementClassAdapter 的实例，同时提供一个 ClassWriter 作为 ClassVisitor。</span></li>
<li><span style="font-size: 14px;">通过 accept 方法将前面创建的 AddImplementClassAdapter 对象传递给这个 ClassReader 对象。</span></li>
<li><span style="font-size: 14px;">在访问完待增强类之后，ClassWriter 即完成了增强类的创建，所以最后通过 toByteArray 方法获取这个增强类的字节码。</span></li>
<li><span style="font-size: 14px;">最后通过一个自定义类加载器将其加载到虚拟机当中。</span></li>
</ol>
<p><span style="font-size: 14px;">下面是代码示例与讲解：</span></p>
<p><span style="font-size: 14px;">首先需要修改 SubClass1 以及 SubClass2 两个类，使其声明实现 IFibonacciComputer 和 ITimeRetriever 这两个接口。由于这两个类并没有真正的包含实现接口的代码，所以它们现在必须标记为抽象类。修改后的类结构如图 4 所示：</span></p>
<p><strong>图 4. 修改后的类图</strong><br><img src="http://www.liuling123.com/wp-content/uploads/2015/11/image008.jpg" alt="图 4\. 修改后的类图"><span style="text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">&nbsp;</span></span></p>
<p><span style="font-size: 14px;">然后创建以下几个类：</span></p>
<ul>
<li><span style="font-size: 14px;"><strong>AddImplementClassAdapter</strong>: 过滤待增强类，并引导 ClassWriter 创建增强类的适配器。</span></li>
<li><span style="font-size: 14px;"><strong>ImplementClassAdapter</strong>: 实现类的适配器，过滤多余内容，将实现类中的内容通过 ClassWriter 添加到增强类中。</span></li>
<li><span style="font-size: 14px;"><strong>ModifyInitMethodAdapter</strong>: 修改待增强类构造方法的适配器。</span></li>
<li><span style="font-size: 14px;"><strong>SimpleClassLoader</strong>: 自定义类加载器，用来加载动态生成的增强类。</span></li>
<li><span style="font-size: 14px;"><strong>EnhanceFactory</strong>: 提供对外接口，方便使用。</span></li>
<li><span style="font-size: 14px;"><strong>EnhanceException</strong>: 对异常的统一包装，方便异常处理。</span></li>
</ul>
<p><span style="font-size: 14px;">下面，我们来逐一实现这些类：</span></p>
<p><span style="font-size: 14px;"><strong>AddImplementClassAdapter</strong>： 首先在构造方法中，我们需要记录下待增强类的 Class 对象，增强类的类名，实现类的 Class 对象，以及一个 ClassWriter 对象，该构造方法代码如清单 4 所示：</span></p>
<p><strong>清单 4.AddImpelementClassAdapter 构造方法代码</strong></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode"><br> public AddImplementClassAdapter( ClassWriter writer,<br> String enhancedClassName,Class&lt;?&gt; targetClass,<br> Class&lt;?&gt;… implementClasses) {<br>    super(writer);<br>    this.classWriter = writer;<br>    this.implementClasses = implementClasses;<br>    this.originalClassName = targetClass.getName();<br>    this.enhancedClassName = enhancedClassName;<br> }<br></pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;">在 visit 方法中需要完成增强类声明部分的创建，增强类继承自待增强类。该方法代码如清单 6 所示：</span></p>
<p><strong>清单 5.visit 方法代码</strong></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode">// 通过 visit 方法完成增强类的声明部分<br> public void visit(int version, int access, String name,<br> String signature,String superName, String[] interfaces) {<br>      cv.visit(version, Opcodes.ACC_PUBLIC,<br>     // 将 Java 代码中类的名称替换为虚拟机中使用的形式<br>      enhancedClassName.replace(‘.’, ‘/‘),<br>      signature, name,interfaces);<br> }<br></pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;">visitMethod 方法中需要对构造方法做单独处理，因为 class 文件中的构造方法与源代码中的构造方法有三点不一样的地方：</span></p>
<ol>
<li><span style="font-size: 14px;">每个 class 文件中至少有一个构造方法。即便你在类的源代码中没有编写构造方法，编译器也会为你生成一个默认构造方法 ;</span></li>
<li><span style="font-size: 14px;">在 class 文件中与源代码中的构造方法名称不一样，class 文件的构造方法名称都为&ldquo;<init>&rdquo;;</init></span></li>
<li><span style="font-size: 14px;">class 文件中每个构造方法都会最先调用一次父类的构造方法。</span></li>
</ol>
<p><span style="font-size: 14px;">鉴于这些原因，增强类的构造方法需要在待增强类构造方法的基础上进行修改。修改的内容就是对于父构造方法的调用，因为增强类和待增强类的父类是不一样的。</span></p>
<p><span style="font-size: 14px;">visitMethod 方法中需要判断如果是构造方法就通过 ModifyInitMethodAdapter 修改构造方法。其他方法直接返回 null 丢弃（因为增强类已经从待增强类中继承了这些方法，所以这些方法不需要在增强类中再出现一遍），该方法代码如清单 7 所示：</span></p>
<p><strong>清单 6.visitMethod 方法代码</strong></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode"><br> public MethodVisitor visitMethod(int access, String name,<br> String desc,String signature, String[] exceptions) {<br>    if (INTERNAL_INIT_METHOD_NAME.equals(name)) {<br>       // 通过 ModifyInitMethodAdapter 修改构造方法<br>        MethodVisitor mv = classWriter.visitMethod(access,<br>        INTERNAL_INIT_METHOD_NAME, desc, signature, exceptions);<br>        return new ModifyInitMethodAdapter(mv, originalClassName);<br>    }<br>    return null;<br> }<br></pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;">最后，在 visitEnd 方法，使用 ImplementClassAdapter 与 ClassWriter 将实现类的内容添加到增强类中，最后再调用 visitEnd 方法表明增强类已经创建完成：</span></p>
<p><strong>清单 7.visitEnd 方法代码</strong></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode"><br> public void visitEnd() {<br> for (Class&lt;?&gt; clazz : implementClasses) {<br>    try {<br>      // 逐个将实现类的内容添加到增强类中。<br>      ClassReader reader = new ClassReader(clazz.getName());<br>      ClassAdapter adapter =<br>      new ImplementClassAdapter(classWriter);<br>      reader.accept(adapter, 0);<br>    } catch (IOException e) {<br>        e.printStackTrace();<br>    }<br> }<br> cv.visitEnd();<br> }<br></pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;"><strong>ImplementClassAdapter</strong>：该类对实现类进行过滤。</span></p>
<p><span style="font-size: 14px;">首先在 visit 方法中给于空实现将类的声明部分过滤掉，代码如清单 8 所示：</span></p>
<p><strong>清单 8.visit 方法代码</strong></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode"><br> public void visit(int version, int access, String name,<br> String signature,String superName, String[] interfaces) {<br>    // 空实现，将该部分内容过滤掉<br> }<br><br></pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;">然后在 visitMethod 中，将构造方法过滤掉，对于其他方法，调用 ClassVisitor#visitMethod 进行访问。由于这里的 ClassVisitor 是一个 ClassWriter，这就相当于在增强类中创建了该方法，代码如清单 9 所示：</span></p>
<p><strong>清单 9.visitMethod 方法代码</strong></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode"><br> public MethodVisitor visitMethod(int access, String name,<br> String desc,String signature, String[] exceptions) {<br>    // 过滤掉实现类中的构造方法<br>    if (AddImplementClassAdapter.INTERNAL_INIT_METHOD_NAME.equals(name)){<br>        return null;<br>    }<br>    // 其他方法原样保留<br>    return cv.visitMethod(access, name, desc, signature, exceptions);<br> }<br></pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;"><strong>ModifyInitMethodAdapter</strong>：上文中已经提到，ModifyInitMethodAdapter 是用来对增强类的构造方法进行修改的。MethodAdapter 中的 visitMethodInsn 是对方法调用指令的访问。该方法的参数含义如下：</span></p>
<ul>
<li><span style="font-size: 14px;">opcode 为调用方法的 JVM 指令，</span></li>
<li><span style="font-size: 14px;">owner 为被调用方法的类名，</span></li>
<li><span style="font-size: 14px;">name 为方法名，</span></li>
<li><span style="font-size: 14px;">desc 为方法描述。</span></li>
</ul>
<p><span style="font-size: 14px;">所以，我们需要将对于待增强类父类构造方法的调用改为对于待增强类构造方法的调用（因为增强类的父类就是待增强类），其代码如清单 10 所示：</span></p>
<p><strong>清单 10. ModifyInitMethodAdapter 类代码</strong></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode"><br>      /<em>*<br>         专门用来修改构造方法的方法适配器
      </em>/<br> public class ModifyInitMethodAdapter extends MethodAdapter {<br> private String className;<br> public ModifyInitMethodAdapter(MethodVisitor mv, String name) {<br>    super(mv);<br>    this.className = name;<br> }<br> public void visitMethodInsn(int opcode, String owner,<br> String name,String desc) {<br>    // 将 Java 代码中的类全限定名替换为虚拟机中使用的形式<br>    if (name.equals(AddImplementClassAdapter.INTERNAL_INIT_METHOD_NAME)) {<br>    mv.visitMethodInsn(opcode, className.replace(“.”, “/“),<br>    name, desc);<br> }<br> }<br> }<br></pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;"><strong>SimpleClassLoader</strong>：该自定义类装载器通过提供一个 defineClass 方法来装载动态生成的增强类。方法的实现是直接调用父类的 defineClass 方法，其代码如清单 11 所示：</span></p>
<p><strong>清单 11. SimpleClassLoader 类代码</strong></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode"><br> public class SimpleClassLoader extends ClassLoader {<br> public Class&lt;?&gt; defineClass(String className, byte[] byteCodes) {<br>        // 直接通过父类的 defineClass 方法加载类的结构<br>    return super.defineClass(className, byteCodes,<br>    0, byteCodes.length);<br> }<br> }<br></pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;"><strong>EnhanceException</strong>：这是一个异常包装类，其中包含了待增强类和实现类的信息，其逻辑很简单，代码如清单 12 所示：</span></p>
<p><strong>清单 12. EnhanceException 类代码</strong></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode"><br>/<em>*<br> 异常类
</em>/<br> public class EnhanceException extends Exception {<br> private Class&lt;?&gt; enhanceClass;<br> private Class&lt;?&gt; [] implementClasses;<br> // 异常类构造方法<br> public EnhanceException(Exception ex,Class&lt;?&gt; ec,Class&lt;?&gt;… imClazz){<br>    super(ex);<br>    this.enhanceClass = ec;<br>    this.implementClasses = imClazz;<br> }<br> public Class&lt;?&gt; getEnhanceClass() {<br>    return enhanceClass;<br> }<br> public Class&lt;?&gt;[] getImplementClasses() {<br>    return implementClasses;<br> }<br> }<br></pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;"><strong>EnhanceFactory：</strong>最后，通过 EnhanceFactory 提供对外调用接口，调用接口有两个：</span></p>
<ul>
<li><span style="font-size: 14px;"><code>public static &lt;T&gt; Class&lt;T&gt; addImplementation(`` ``Class&lt;T&gt; clazz,Class&lt;?&gt;... implementClasses)</code></span></li>
<li><span style="font-size: 14px;"><code>public static &lt;T&gt; T newInstance(Class&lt;T&gt; clazz,`` ``Class&lt;?&gt;... impls)</code></span></li>
</ul>
<p><span style="font-size: 14px;">为了方便使用，这两个方法都使用了泛型。它们的参数是一样的：第一个参数都是待增强类的 Class 对象，后面是任意多个实现类的 Class 对象，返回的类型和待增强类一致，用户在获取返回值之后不需要进行任何类型转换即可使用。</span></p>
<p><span style="font-size: 14px;">第一个方法创建出增强类的 Class 对象，并通过自定义类加载器加载，其代码如清单 13 所示：</span></p>
<p><strong>清单 13. addImplementation 方法代码</strong></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode"><br>/<em>*<br>静态工具方法，在待增强类中加入实现类的内容，返回增强类。
</em>/<br> public static <t> Class<t> addImplementation(Class<t> clazz,<br> Class&lt;?&gt;… implementClasses) throws EnhanceException {<br>    String enhancedClassName = clazz.getName() + ENHANCED;<br>    try {<br>       // 尝试加载增强类<br>        return  (Class<t>) classLoader.loadClass(enhancedClassName);<br>        }<br>       // 如果没有找到增强类，则尝试直接在内存中构建出增强类的结构<br>    catch (ClassNotFoundException classNotFoundException) {<br>        ClassReader reader = null;<br>        try {<br>            reader = new ClassReader(clazz.getName());<br>        } catch (IOException ioexception) {<br>            throw new EnhanceException(ioexception,<br>            clazz, implementClasses);<br>        }<br>        ClassWriter writer = new ClassWriter(0);<br>       // 通过 AddImplementClassAdapter 完成实现类内容的织入<br>        ClassVisitor visitor = new AddImplementClassAdapter(<br>        enhancedClassName, clazz, writer, implementClasses);<br>        reader.accept(visitor, 0);<br>        byte[] byteCodes = writer.toByteArray();<br>        Class<t> result = (Class<t>) classLoader.defineClass(<br>        enhancedClassName, byteCodes);<br>        return result;<br>    }<br> }<br></t></t></t></t></t></t></pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;">第二个方法先调用前一个方法，获取<span class="Apple-converted-space">&nbsp;</span><code>增强类</code>的<span class="Apple-converted-space">&nbsp;</span><code>Class</code>对象，然后使用反射创建实例，其代码如清单 14 所示：</span></p>
<p><strong>清单 14. newInstance 方法代码</strong></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode"><br>/<em>*<br>通过待增强类和实现类，得到增强类的实例对象
</em>/<br> public static <t> T newInstance(Class<t> clazz, Class&lt;?&gt;… impls)<br> throws EnhanceException {<br> Class<t> c = addImplementation(clazz, impls);<br> if (c == null) {<br>    return null;<br> }<br> try {<br>       // 通过反射创建实例<br>    return c.newInstance();<br> } catch (InstantiationException e) {<br>    throw new EnhanceException(e, clazz, impls);<br> } catch (IllegalAccessException e) {<br>    throw new EnhanceException(e, clazz, impls);<br> }<br> }<br></t></t></t></pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;">下面是测试代码，先通过 EnhanceFactory 创建增强类的实例，然后就可以像普通对象一样的使用，代码如清单 15 所示：</span></p>
<p><strong>清单 15. 使用演示代码</strong></p>
<table style="font: 0.8em/normal Simsun; width: 100%; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" summary="This table contains a code listing." border="0" cellspacing="0" cellpadding="0"><br><tbody><br><tr><br><td class="code-outline" style="padding: 2px 2px 5px; border: 1px solid #cccccc; font-family: arial, nsimsun, sans-serif; background-color: #f7f7f7 !important;"><br><pre class="displaycode"><br> // 不用 new 关键字，而使用 EnhanceFactory.newInstance 创建增强类的实例<br> SubClass1 obj1 = EnhanceFactory.newInstance(SubClass1.class,<br> TimeRetriever.class,FibonacciComputer.class);<br> // 调用待增强类中的方法<br> obj1.methodInSuperClass();<br> obj1.methodDefinedInSubClass1();<br> // 调用实现类中的方法<br> System.out.println(“The Fibonacci number of 10 is “+obj1.compute(10));<br> System.out.println(“Now is :”+obj1.tellMeTheTime());<br> System.out.println(“————————————–”);<br> // 对于 SubClass2 的增强类实例的创建也是一样的<br> SubClass2 obj2 = EnhanceFactory.newInstance(SubClass2.class,<br> TimeRetriever.class,FibonacciComputer.class);<br> // 调用待增强类中的方法<br> obj2.methodInSuperClass();<br> obj2.methodDefinedInSubClass2();<br> // 调用实现类中的方法<br> System.out.println(“The Fibonacci number of 10 is “+obj1.compute(10));<br> System.out.println(“Now is :”+obj1.tellMeTheTime());<br></pre><br></td><br></tr><br></tbody><br></table>

<p>&nbsp;</p>
<p><span style="font-size: 14px;">这里，我们演示了使用 ASM 创建一个新的类，并且修改该类中的内容的方法。而这一切都是在运行的环境中动态生成的，这一点相较于源代码级别的实现有以下的好处：</span></p>
<ul>
<li><span style="font-size: 14px;"><strong>没有重复代码</strong><span class="Apple-converted-space">&nbsp;</span>这是我们的主要目的，由于增强类是在运行的环境中生成的，并且动态的包含了实现类中的内容，所以，不会产生任何重复代码。</span></li>
<li><span style="font-size: 14px;"><strong>灵活性</strong><span class="Apple-converted-space">&nbsp;</span>使用 EnhanceFactory# addImplementation 方法，对于接口的实现完全是在运行时确定的，因此可以灵活的选择。</span></li>
<li><span style="font-size: 14px;"><strong>可复用性</strong><span class="Apple-converted-space">&nbsp;</span>EnhanceFactory# addImplementation 是一个可以完全复用的方法，我们可以在任何需要的地方使用它。</span></li>
</ul>
<p><span style="font-size: 14px;">需要注意的是，这里我们并没有真正的实现&ldquo;多重继承&rdquo;，由于 class 文件格式的限制，我们也不可能真正实现&ldquo;多重继承&rdquo;，我们只是在一个类中包含了多个实现类的内容而已。但是，如果你使用增强类的实例通过 instanceof 之类的方法来判断它是否是实现类的实例的时候，你会得到 false，因为增强类并没有真正的继承自实现类。</span></p>
<p><span style="font-size: 14px;">另外，为了让演示代码足够的简单，对于这个功能的实现还存在一些问题，例如：</span></p>
<ul>
<li><span style="font-size: 14px;">FibonacciComputer 和 TimeRetriever 这两个类中，可能会包含一些其他方法，这些方法并非是为了实现接口的方法，而这些方法也会被增强类所包含。</span></li>
<li><span style="font-size: 14px;">如果多个实现类与待增强类中包含了同样签名的方法时，在创建增强类的过程中会产生异常，因为一个类中不能包含同样方法签名的两个方法。</span></li>
<li><span style="font-size: 14px;">如果实现类中包含了一些字段，并且实现类的构造方法中初始化了这些字段。但增强类中的这些字段并没有被初始化。因为实现类的构造方法被忽略了。</span></li>
<li><span style="font-size: 14px;">无法对同一个类做多次不同类型的增强。</span></li>
</ul>
<p><span style="font-size: 14px;">不过，在理解了上文中的知识之后，这些问题也都是可以解决的。</span></p>
<p><span style="font-size: 14px;">作为一个可以操作字节码的工具而言，ASM 的功能远不止于此。它还可以用来实现 AOP，实现性能监测，方法调用统计等功能。通过 Google，可以很容易的找到这类文章。</span></p>
<p><span style="font-size: 14px;">示例代码包含在 ASMDemo.zip 中，该文件中包含了上文中提到的所有代码。</span></p>
<p><span style="font-size: 14px;">该 zip 文件为 eclipse 项目的归档文件。可以通过 Eclipse 菜单导入至 Eclipse 中，导入方法：File -&gt; Import &hellip; -&gt; Existing Projects into Workspace, 然后选择该 zip 文件即可。</span></p>
<p><span style="font-size: 14px;">想要编译该项目，还需要 ASM 框架的 jar 包。请在以下地址下载 ASM 框架：<a href="http://forge.ow2.org/projects/asm/" target="_blank" rel="external">http://forge.ow2.org/projects/asm/</a></span></p>
<p><span style="font-size: 14px;">目前该框架正式版的版本号为：3.3.1。</span></p>
<p><span style="font-size: 14px;">下载该框架归档文件后解压缩， 并通过 eclipse 将 asm-all-3.3.1.jar（可能是其他版本号）添加到项目编译的类路径中即可。</span></p>
<p><span style="font-size: 14px;">代码中包含的 Main 类，是一个包含了 main 方法的可执行类，在 eclipse 中运行该类即可看到运行结果。</span></p>
<p>&nbsp;</p>
<p><span style="font-size: 14px;">源代码下载：<a href="http://files.cnblogs.com/liuling/ASMDemo.rar" target="_blank" rel="external">http://files.cnblogs.com/liuling/ASMDemo.rar</a></span></p>
<p><span style="font-size: 14px;">本文出自：<a href="http://www.ibm.com/developerworks/cn/java/j-lo-asm/" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/java/j-lo-asm/</a></span></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/05/asm-java-multi-extends.html" data-id="ciiy5f4y400elq1d0de24ap64" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/05/asm-java-multi-extends.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-java-asm" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/05/java-asm.html">关于java字节码框架ASM的学习</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/05/java-asm.html">
      <time datetime="2013-05-24T08:19:00.000Z" itemprop="datePublished">2013-05-24</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Java基础/">Java基础</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　一、什么是ASM</p>
<p>　　ASM是一个java字节码操纵框架，它能被用来动态生成类或者增强既有类的功能。ASM 可以直接产生二进制 class&nbsp;文件，也可以在类被加载入 Java 虚拟机之前动态改变类行为。Java class 被存储在严格格式定义的 .class文件里，这些类文件拥有足够的元数据来解析类中的所有元素：类名称、方法、属性以及 Java 字节码（指令）。ASM从类文件中读入信息后，能够改变类行为，分析类信息，甚至能够根据用户要求生成新类。</p>
<p>　　使用ASM框架需要导入asm的jar包，<span style="color: #ff0000;">下载链接：</span><a href="http://files.cnblogs.com/liuling/asm-3.2.rar" target="_blank" rel="external">asm-3.2.jar</a>。</p>
<p>　　二、如何使用ASM</p>
<p>　　ASM框架中的核心类有以下几个：</p>
<p>　　①&nbsp; ClassReader:该类用来解析编译过的class字节码文件。</p>
<p>　　②&nbsp; ClassWriter:该类用来重新构建编译后的类，比如说修改类名、属性以及方法，甚至可以生成新的类的字节码文件。</p>
<p>　　③&nbsp; ClassAdapter:该类也实现了ClassVisitor接口，它将对它的方法调用委托给另一个ClassVisitor对象。</p>
<p>　　示例1.通过asm生成类的字节码</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.asm3;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.File;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.FileNotFoundException;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.FileOutputStream;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.IOException;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.objectweb.asm.ClassWriter;<br></span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.objectweb.asm.Opcodes;<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">12</span> <span style="color: #008000;">  通过asm生成类的字节码<br></span><span style="color: #008080;">13</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;"> Administrator<br></span><span style="color: #008080;">14</span> <span style="color: #008000;"> <br></span><span style="color: #008080;">15</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;">16</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> GeneratorClass {<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {<br></span><span style="color: #008080;">19</span>         <span style="color: #008000;">//</span><span style="color: #008000;">生成一个类只需要ClassWriter组件即可</span><br><span style="color: #008080;">20</span>         ClassWriter cw = <span style="color: #0000ff;">new</span> ClassWriter(0<span style="color: #000000;">);<br></span><span style="color: #008080;">21</span>         <span style="color: #008000;">//</span><span style="color: #008000;">通过visit方法确定类的头部信息</span><br><span style="color: #008080;">22</span>         cw.visit(Opcodes.V1_5, Opcodes.ACC_PUBLIC+Opcodes.ACC_ABSTRACT+<span style="color: #000000;">Opcodes.ACC_INTERFACE,<br></span><span style="color: #008080;">23</span>                 “com/asm3/Comparable”, <span style="color: #0000ff;">null</span>, “java/lang/Object”, <span style="color: #0000ff;">new</span> String[]{“com/asm3/Mesurable”<span style="color: #000000;">});<br></span><span style="color: #008080;">24</span>         <span style="color: #008000;">//</span><span style="color: #008000;">定义类的属性</span><br><span style="color: #008080;">25</span>         cw.visitField(Opcodes.ACC_PUBLIC+Opcodes.ACC_FINAL+<span style="color: #000000;">Opcodes.ACC_STATIC,<br></span><span style="color: #008080;">26</span>                 “LESS”, “I”, <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">new</span> Integer(-1<span style="color: #000000;">)).visitEnd();<br></span><span style="color: #008080;">27</span>         cw.visitField(Opcodes.ACC_PUBLIC+Opcodes.ACC_FINAL+<span style="color: #000000;">Opcodes.ACC_STATIC,<br></span><span style="color: #008080;">28</span>                 “EQUAL”, “I”, <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">new</span> Integer(0<span style="color: #000000;">)).visitEnd();<br></span><span style="color: #008080;">29</span>         cw.visitField(Opcodes.ACC_PUBLIC+Opcodes.ACC_FINAL+<span style="color: #000000;">Opcodes.ACC_STATIC,<br></span><span style="color: #008080;">30</span>                 “GREATER”, “I”, <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">new</span> Integer(1<span style="color: #000000;">)).visitEnd();<br></span><span style="color: #008080;">31</span>         <span style="color: #008000;">//</span><span style="color: #008000;">定义类的方法</span><br><span style="color: #008080;">32</span>         cw.visitMethod(Opcodes.ACC_PUBLIC+Opcodes.ACC_ABSTRACT, “compareTo”<span style="color: #000000;">,<br></span><span style="color: #008080;">33</span>                 “(Ljava/lang/Object;)I”, <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span><span style="color: #000000;">).visitEnd();<br></span><span style="color: #008080;">34</span>         cw.visitEnd(); <span style="color: #008000;">//</span><span style="color: #008000;">使cw类已经完成<br></span><span style="color: #008080;">35</span>         <span style="color: #008000;">//</span><span style="color: #008000;">将cw转换成字节数组写到文件里面去</span><br><span style="color: #008080;">36</span>         <span style="color: #0000ff;">byte</span>[] data =<span style="color: #000000;"> cw.toByteArray();<br></span><span style="color: #008080;">37</span>         File file = <span style="color: #0000ff;">new</span> File(“D://Comparable.class”<span style="color: #000000;">);<br></span><span style="color: #008080;">38</span>         FileOutputStream fout = <span style="color: #0000ff;">new</span><span style="color: #000000;"> FileOutputStream(file);<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">        fout.write(data);<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">        fout.close();<br></span><span style="color: #008080;">41</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">42</span> }</pre><br></div>

<p>　　生成一个类的字节码文件只需要用到ClassWriter类即可，生成Comparable.class后用javap指令对其进行反编译：javap -c Comparable.class &gt;test.txt&nbsp;&nbsp;,编译后的结果如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span> com.asm3.Comparable <span style="color: #0000ff;">extends</span><span style="color: #000000;"> com.asm3.Mesurable {<br></span><span style="color: #008080;">2</span>   <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> LESS;<br></span><span style="color: #008080;">3</span><br><span style="color: #008080;">4</span>   <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> EQUAL;<br></span><span style="color: #008080;">5</span><br><span style="color: #008080;">6</span>   <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> GREATER;<br></span><span style="color: #008080;">7</span><br><span style="color: #008080;">8</span>   <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> compareTo(java.lang.Object);<br></span><span style="color: #008080;">9</span> }</pre><br></div>

<p>　　<span style="color: #ff0000;">注：一个编译后的java类不包含package和import段，因此在class文件中所有的类型都使用的是全路径。</span></p>
<p>　　示例2.修改类的字节码文件</p>
<p>C.java</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.asm5;<br></span><span style="color: #008080;">2</span><br><span style="color: #008080;">3</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> C {<br></span><span style="color: #008080;">4</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> m() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> InterruptedException{<br></span><span style="color: #008080;">5</span>         Thread.sleep(100<span style="color: #000000;">);<br></span><span style="color: #008080;">6</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">7</span> }</pre><br></div>

<p>将C.java类的内容改为如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.asm5;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> C {<br></span><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> timer;<br></span><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> m() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> InterruptedException{<br></span><span style="color: #008080;"> 6</span>         timer -=<span style="color: #000000;"> System.currentTimeMillis();<br></span><span style="color: #008080;"> 7</span>         Thread.sleep(100<span style="color: #000000;">);<br></span><span style="color: #008080;"> 8</span>         timer +=<span style="color: #000000;"> System.currentTimeMillis();<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">10</span> }</pre><br></div>

<p>　　为了弄清楚ASM是如何实现的，我们先编译这两个类，然后比对它们的TraceClassVisitor的输出，我们可以发现如下的不同（粗体表示）</p>
<p><strong>GETSTATIC C.timer : J</strong><br><strong>INVOKESTATIC java/lang/System.currentTimilis()J</strong><br><strong>LSUB</strong><br><strong>PUTSTATIC C.timer : J</strong><br>LDC 100<br>INVOKESTATIC java/lang/Thread.sleep(J)V<br><strong>GETSTATIC C.timer : J</strong><br><strong>INVOKESTATIC java/lang/System.currentTimilis()J</strong><br><strong>LADD</strong><br><strong>PUTSTATIC C.timer : J</strong><br>RETURN<br>MAXSTACK=4<br>MAXLOCALS=1</p>
<p>　　通过比对上面的指令，我们可以发现必须在m()方法的最前面增加四条指令，在RETURN指令前也增加四条指令，同时这四条必须位于xRETURN和ATHROW之前，因为这些指令都会结束方法的执行。</p>
<p>具体代码如下：</p>
<p>AddTimeClassAdapter.java</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.asm5;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.objectweb.asm.ClassAdapter;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.objectweb.asm.ClassVisitor;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.objectweb.asm.FieldVisitor;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.objectweb.asm.MethodAdapter;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.objectweb.asm.MethodVisitor;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.objectweb.asm.Opcodes;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> AddTimeClassAdapter <span style="color: #0000ff;">extends</span><span style="color: #000000;"> ClassAdapter {<br></span><span style="color: #008080;">11</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String owner;<br></span><span style="color: #008080;">12</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> isInterface;<br></span><span style="color: #008080;">13</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> AddTimeClassAdapter(ClassVisitor cv) {<br></span><span style="color: #008080;">14</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(cv);<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">17</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> visit(<span style="color: #0000ff;">int</span> version, <span style="color: #0000ff;">int</span><span style="color: #000000;"> access, String name, String signature,<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">            String superName, String[] interfaces) {<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">        cv.visit(version, access, name, signature, superName, interfaces);<br></span><span style="color: #008080;">20</span>         owner =<span style="color: #000000;"> name;<br></span><span style="color: #008080;">21</span>         isInterface = (access &amp; Opcodes.ACC_INTERFACE) != 0<span style="color: #000000;">;<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">24</span>     <span style="color: #0000ff;">public</span> MethodVisitor visitMethod(<span style="color: #0000ff;">int</span><span style="color: #000000;"> access, String name, String desc,<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">            String signature, String[] exceptions) {<br></span><span style="color: #008080;">26</span>         MethodVisitor mv =<span style="color: #000000;"> cv.visitMethod(access, name, desc, signature, exceptions);<br></span><span style="color: #008080;">27</span>         <span style="color: #0000ff;">if</span>(!name.equals(“<init>“) &amp;&amp; !isInterface &amp;&amp; mv!=<span style="color: #0000ff;">null</span><span style="color: #000000;">){<br></span><span style="color: #008080;">28</span>             <span style="color: #008000;">//</span><span style="color: #008000;">为方法添加计时功能</span><br><span style="color: #008080;">29</span>             mv = <span style="color: #0000ff;">new</span><span style="color: #000000;"> AddTimeMethodAdapter(mv);<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">31</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> mv;<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">34</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> visitEnd() {<br></span><span style="color: #008080;">35</span>         <span style="color: #008000;">//</span><span style="color: #008000;">添加字段</span><br><span style="color: #008080;">36</span>         <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">isInterface){<br></span><span style="color: #008080;">37</span>             FieldVisitor fv = cv.visitField(Opcodes.ACC_PUBLIC+Opcodes.ACC_STATIC, “timer”, “J”, <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">38</span>             <span style="color: #0000ff;">if</span>(fv!=<span style="color: #0000ff;">null</span><span style="color: #000000;">){<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">                fv.visitEnd();<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">41</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">        cv.visitEnd();<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">44</span><br><span style="color: #008080;">45</span>     <span style="color: #0000ff;">class</span> AddTimeMethodAdapter <span style="color: #0000ff;">extends</span><span style="color: #000000;"> MethodAdapter{<br></span><span style="color: #008080;">46</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> AddTimeMethodAdapter(MethodVisitor mv) {<br></span><span style="color: #008080;">47</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">(mv);<br></span><span style="color: #008080;">48</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">49</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">50</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> visitCode() {<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">            mv.visitCode();<br></span><span style="color: #008080;">52</span>             mv.visitFieldInsn(Opcodes.GETSTATIC, owner, “timer”, “J”<span style="color: #000000;">);<br></span><span style="color: #008080;">53</span>             mv.visitMethodInsn(Opcodes.INVOKESTATIC, “java/lang/System”, “currentTimeMillis”, “()J”<span style="color: #000000;">);<br></span><span style="color: #008080;">54</span> <span style="color: #000000;">            mv.visitInsn(Opcodes.LSUB);<br></span><span style="color: #008080;">55</span>             mv.visitFieldInsn(Opcodes.PUTSTATIC, owner, “timer”, “J”<span style="color: #000000;">);<br></span><span style="color: #008080;">56</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">57</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">58</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> visitInsn(<span style="color: #0000ff;">int</span><span style="color: #000000;"> opcode) {<br></span><span style="color: #008080;">59</span>             <span style="color: #0000ff;">if</span>((opcode&gt;=Opcodes.IRETURN &amp;&amp; opcode&lt;=Opcodes.RETURN) || opcode==<span style="color: #000000;">Opcodes.ATHROW){<br></span><span style="color: #008080;">60</span>                 mv.visitFieldInsn(Opcodes.GETSTATIC, owner, “timer”, “J”<span style="color: #000000;">);<br></span><span style="color: #008080;">61</span>                 mv.visitMethodInsn(Opcodes.INVOKESTATIC, “java/lang/System”, “currentTimeMillis”, “()J”<span style="color: #000000;">);<br></span><span style="color: #008080;">62</span> <span style="color: #000000;">                mv.visitInsn(Opcodes.LADD);<br></span><span style="color: #008080;">63</span>                 mv.visitFieldInsn(Opcodes.PUTSTATIC, owner, “timer”, “J”<span style="color: #000000;">);<br></span><span style="color: #008080;">64</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">65</span> <span style="color: #000000;">            mv.visitInsn(opcode);<br></span><span style="color: #008080;">66</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">67</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">68</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> visitMaxs(<span style="color: #0000ff;">int</span> maxStack, <span style="color: #0000ff;">int</span><span style="color: #000000;"> maxLocal) {<br></span><span style="color: #008080;">69</span>             mv.visitMaxs(maxStack+4<span style="color: #000000;">, maxLocal);<br></span><span style="color: #008080;">70</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">71</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">72</span><br><span style="color: #008080;">73</span> }</init></pre><br></div>

<p>Generator.java</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.asm5;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.File;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.FileNotFoundException;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.FileOutputStream;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.IOException;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.objectweb.asm.ClassAdapter;<br></span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.objectweb.asm.ClassReader;<br></span><span style="color: #008080;">10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.objectweb.asm.ClassWriter;<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Generator {<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args){<br></span><span style="color: #008080;">17</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">18</span>             ClassReader cr = <span style="color: #0000ff;">new</span> ClassReader(“com/asm5/C”<span style="color: #000000;">);<br></span><span style="color: #008080;">19</span>             ClassWriter cw = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ClassWriter(ClassWriter.COMPUTE_MAXS);<br></span><span style="color: #008080;">20</span>             ClassAdapter classAdapter = <span style="color: #0000ff;">new</span><span style="color: #000000;"> AddTimeClassAdapter(cw);<br></span><span style="color: #008080;">21</span>             <span style="color: #008000;">//</span><span style="color: #008000;">使给定的访问者访问Java类的ClassReader</span><br><span style="color: #008080;">22</span> <span style="color: #000000;">            cr.accept(classAdapter, ClassReader.SKIP_DEBUG);<br></span><span style="color: #008080;">23</span>             <span style="color: #0000ff;">byte</span>[] data =<span style="color: #000000;"> cw.toByteArray();<br></span><span style="color: #008080;">24</span>             File file = <span style="color: #0000ff;">new</span> File(System.getProperty(“user.dir”) + “\WebRoot\WEB-INF\classes\com\asm5\C.class”<span style="color: #000000;">);<br></span><span style="color: #008080;">25</span>             FileOutputStream fout = <span style="color: #0000ff;">new</span><span style="color: #000000;"> FileOutputStream(file);<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">            fout.write(data);<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">            fout.close();<br></span><span style="color: #008080;">28</span>             System.out.println(“success!”<span style="color: #000000;">);<br></span><span style="color: #008080;">29</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (FileNotFoundException e) {<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;">31</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">35</span><br><span style="color: #008080;">36</span> }</pre><br></div>

<p>下面是一个测试类：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.asm5;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Test {<br></span><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> InterruptedException, NoSuchFieldException, SecurityException, IllegalArgumentException, IllegalAccessException {<br></span><span style="color: #008080;"> 5</span>         C c = <span style="color: #0000ff;">new</span><span style="color: #000000;"> C();<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">        c.m();<br></span><span style="color: #008080;"> 7</span>         Class cc =<span style="color: #000000;"> c.getClass();<br></span><span style="color: #008080;"> 8</span>         System.out.println(cc.getField(“timer”<span style="color: #000000;">).get(c));<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">10</span> }</pre><br></div>

<p>输出结果为：100</p>
<p><span style="color: #ff0000;">未完待续…….</span></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/05/java-asm.html" data-id="ciiy5f4uu0096q1d0uoabwv5u" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/05/java-asm.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-aop-cglib" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/05/aop-cglib.html">AOP的另一种实现----cglib</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/05/aop-cglib.html">
      <time datetime="2013-05-21T07:16:00.000Z" itemprop="datePublished">2013-05-21</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Java基础/">Java基础</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　大家都知道，动态代理能够实现AOP，但是它有一个缺点，就是所有被代理的对象必须实现一个接口，否则就会报异常。那么如果被代理对象没有实现接口那该如何实现AOP呢？当然是能的，使用<span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">CGlib</span>就可以实现。</p>
<p>　　1、什么是<span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">CGlib</span></p>
<p>　　<span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">CGlib是一个强大的,高性能,高质量的Code生成类库。它可以在运行期扩展Java类与实现Java接口。<span class="Apple-converted-space">&nbsp;</span></span><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">然这些实际的功能是asm所提供的，asm又是什么？Java字节码操控框架，具体是什么大家可以上网查一查，毕竟我们这里所要讨论的是cglib，<span class="Apple-converted-space">&nbsp;</span></span><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">cglib就是封装了asm，简化了asm的操作，实现了在运行期动态生成新的class。<span class="Apple-converted-space">&nbsp;</span></span><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">可能大家还感觉不到它的强大，现在就告诉你。<span class="Apple-converted-space">&nbsp;</span></span><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">实际上CGlib为spring aop提供了底层的一种实现;为hibernate使用cglib动态生成VO/PO (接口层对象)。</span></p>
<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　<span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">它的原理就是用Enhancer生成一个原有类的子类，并且设置好callback ， 则原有类的每个方法调用都会转成调用实现了MethodInterceptor接口的proxy的intercept() 函数：<span class="Apple-converted-space">&nbsp;</span></span><br><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">public Object intercept(Object o,Method method,Object[] args,MethodProxy proxy)<span class="Apple-converted-space">&nbsp;</span></span><br><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　在intercept()函数里，你可以在执行Object result=proxy.invokeSuper(o,args);来执行原有函数，在执行前后加入自己的东西，改变它的参数，也可以瞒天过海，完全干别的。说白了，就是AOP中的around advice。</span></span></p>
<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　2、如何使用<span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">CGlib</span></span></p>
<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　举个例子：比如DAO层有对表的增、删、改、查操作，如果要对原有的DAO层的增、删、改、查增加权限控制的话，修改代码是非常痛苦的。所以可以用AOP来实现。但是DAO层没有使用接口，动态代理不可用。这时候<span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">CGlib</span>是个很好的选择。</span></span></p>
<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">TableDao.java:</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.cglib;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> TableDao {<br></span><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> create(){<br></span><span style="color: #008080;"> 5</span>         System.out.println(“create() is running…”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> delete(){<br></span><span style="color: #008080;"> 8</span>         System.out.println(“delete() is running…”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">10</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> update(){<br></span><span style="color: #008080;">11</span>         System.out.println(“update() is running…”<span style="color: #000000;">);<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">13</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> query(){<br></span><span style="color: #008080;">14</span>         System.out.println(“query() is running…”<span style="color: #000000;">);<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">16</span> }</pre><br></div>

<p>&nbsp;</p>
<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">实现了MethodInterceptor接口的AuthProxy.java：用来对方法进行拦截，增加方法访问的权限控制，这里只允许张三访问。</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.cglib;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Method;<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> net.sf.cglib.proxy.MethodInterceptor;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> net.sf.cglib.proxy.MethodProxy;<br></span><span style="color: #008080;"> 7</span> <span style="color: #008000;">//</span><span style="color: #008000;">方法拦截器</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> AuthProxy <span style="color: #0000ff;">implements</span><span style="color: #000000;"> MethodInterceptor {<br></span><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String userName;<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">    AuthProxy(String userName){<br></span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">this</span>.userName =<span style="color: #000000;"> userName;<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">13</span>     <span style="color: #008000;">//</span><span style="color: #008000;">用来增强原有方法</span><br><span style="color: #008080;">14</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Object intercept(Object arg0, Method arg1, Object[] arg2,<br></span><span style="color: #008080;">15</span>             MethodProxy arg3) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Throwable {<br></span><span style="color: #008080;">16</span>         <span style="color: #008000;">//</span><span style="color: #008000;">权限判断</span><br><span style="color: #008080;">17</span>         <span style="color: #0000ff;">if</span>(!”张三”<span style="color: #000000;">.equals(userName)){<br></span><span style="color: #008080;">18</span>             System.out.println(“你没有权限！”<span style="color: #000000;">);<br></span><span style="color: #008080;">19</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">21</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> arg3.invokeSuper(arg0, arg2);<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">23</span> }</pre><br></div>

<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">TableDAOFactory.java:用来创建TableDao的子类的工厂类</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.cglib;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> net.sf.cglib.proxy.Callback;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> net.sf.cglib.proxy.Enhancer;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> net.sf.cglib.proxy.NoOp;<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> TableDAOFactory {<br></span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> TableDao tDao = <span style="color: #0000ff;">new</span><span style="color: #000000;"> TableDao();<br></span><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> TableDao getInstance(){<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> tDao;<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">12</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> TableDao getAuthInstance(AuthProxy authProxy){<br></span><span style="color: #008080;">13</span>         Enhancer en = <span style="color: #0000ff;">new</span> Enhancer();  <span style="color: #008000;">//</span><span style="color: #008000;">Enhancer用来生成一个原有类的子类<br></span><span style="color: #008080;">14</span>         <span style="color: #008000;">//</span><span style="color: #008000;">进行代理  </span><br><span style="color: #008080;">15</span>         en.setSuperclass(TableDao.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;">16</span>         <span style="color: #008000;">//</span><span style="color: #008000;">设置织入逻辑</span><br><span style="color: #008080;">17</span> <span style="color: #000000;">        en.setCallback(authProxy);<br></span><span style="color: #008080;">18</span>         <span style="color: #008000;">//</span><span style="color: #008000;">生成代理实例  </span><br><span style="color: #008080;">19</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> (TableDao)en.create();<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">21</span>  }</pre><br></div>

<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">测试类Client.java：</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.cglib;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Client {<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;"> 6</span> <span style="color: #008000;">//</span><span style="color: #008000;">        haveAuth(); </span><br><span style="color: #008080;"> 7</span> <span style="color: #000000;">        haveNoAuth();<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> doMethod(TableDao dao){<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">        dao.create();<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">        dao.query();<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">        dao.update();<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">        dao.delete();<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">15</span>     <span style="color: #008000;">//</span><span style="color: #008000;">模拟有权限</span><br><span style="color: #008080;">16</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> haveAuth(){<br></span><span style="color: #008080;">17</span>         TableDao tDao = TableDAOFactory.getAuthInstance(<span style="color: #0000ff;">new</span> AuthProxy(“张三”<span style="color: #000000;">));<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">        doMethod(tDao);<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">20</span>     <span style="color: #008000;">//</span><span style="color: #008000;">模拟无权限</span><br><span style="color: #008080;">21</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> haveNoAuth(){<br></span><span style="color: #008080;">22</span>         TableDao tDao = TableDAOFactory.getAuthInstance(<span style="color: #0000ff;">new</span> AuthProxy(“李四”<span style="color: #000000;">));<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">        doMethod(tDao);<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">25</span> }</pre><br></div>

<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　这样就能够对DAO层的方法进行权限控制了。但是如果又改需求了，要把DAO层的query方法让所有用户都可以访问，而其他方法照样有权限控制，该如何实现呢？这</span></span><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">可难不倒我们了，因为我们使用了CGlib。当然最简单的方式是去修改我们的方法拦截器，不过这样会使逻辑变得复杂，且</span><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">不利于维护。还好CGlib给我们提供了方法过滤器（CallbackFilter）,CallbackFilte可以明确表明，被代理的类中不同的方法，<span class="Apple-converted-space">&nbsp;</span></span><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">被哪个拦截器所拦截。下面我们就来做个过滤器用来过滤query方法。<span class="Apple-converted-space">&nbsp;</span></span></span></span></p>
<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">AuthProxyFilter.java:</span></span></span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.cglib;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Method;<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> net.sf.cglib.proxy.CallbackFilter;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> net.sf.cglib.proxy.NoOp;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> AuthProxyFilter <span style="color: #0000ff;">implements</span><span style="color: #000000;"> CallbackFilter {<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> accept(Method arg0) {<br></span><span style="color: #008080;">11</span>         <span style="color: #008000;">/<em></em></span><br><span style="color: #008080;">12</span> <span style="color: #008000;">          如果调用的不是query方法，则要调用authProxy拦截器去判断权限<br></span><span style="color: #008080;">13</span>          <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">14</span>         <span style="color: #0000ff;">if</span>(!”query”<span style="color: #000000;">.equalsIgnoreCase(arg0.getName())){<br></span><span style="color: #008080;">15</span>             <span style="color: #0000ff;">return</span> 0; <span style="color: #008000;">//</span><span style="color: #008000;">调用第一个方法拦截器，即authProxy</span><br><span style="color: #008080;">16</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">17</span>         <span style="color: #008000;">/</span><br><span style="color: #008080;">18</span> <span style="color: #008000;">         <em> 调用第二个方法拦截器，即NoOp.INSTANCE，NoOp.INSTANCE是指不做任何事情的拦截器<br></em></span><span style="color: #008080;">19</span> <span style="color: #008000;">          在这里就是任何人都有权限访问query方法，所以调用默认拦截器不做任何处理<br></span><span style="color: #008080;">20</span>          <span style="color: #008000;">*/</span><br><span style="color: #008080;">21</span>         <span style="color: #0000ff;">return</span> 1<span style="color: #000000;">;<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span> }</pre><br></div>

<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">　　至于为什么返回0或者1，注释讲的很详细。</span></span></span></span></p>
<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">在<span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">TableDAOFactory.java</span></span>里添加如下方法：</span></span></span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> TableDao getAuthInstanceByFilter(AuthProxy authProxy){<br></span><span style="color: #008080;">2</span>         Enhancer en = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Enhancer();<br></span><span style="color: #008080;">3</span>         en.setSuperclass(TableDao.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;">4</span>         en.setCallbacks(<span style="color: #0000ff;">new</span> Callback[]{authProxy,NoOp.INSTANCE});  <span style="color: #008000;">//</span><span style="color: #008000;">设置两个方法拦截器</span><br><span style="color: #008080;">5</span>         en.setCallbackFilter(<span style="color: #0000ff;">new</span><span style="color: #000000;"> AuthProxyFilter());<br></span><span style="color: #008080;">6</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> (TableDao)en.create();<br></span><span style="color: #008080;">7</span>     }  </pre><br></div>

<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">　　这里得注意，en.setCallbacks()方法里的数组参数顺序就是上面方法的返回值所代表的方法拦截器，如果return 0则使用authProxy拦截器，return 1则使用NoOp.INSTANCE拦截器，NoOp.INSTANCE是默认的方法拦截器，不做什么处理。</span></span></span></span></p>
<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">　　下面在测试类中添加如下方法：</span></span></span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #008000;">//</span><span style="color: #008000;">模拟权限过滤器</span><br><span style="color: #008080;">2</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> haveAuthByFilter(){<br></span><span style="color: #008080;">3</span>         TableDao tDao = TableDAOFactory.getAuthInstanceByFilter(<span style="color: #0000ff;">new</span> AuthProxy(“张三”<span style="color: #000000;">));<br></span><span style="color: #008080;">4</span> <span style="color: #000000;">        doMethod(tDao);<br></span><span style="color: #008080;">5</span>         tDao = TableDAOFactory.getAuthInstanceByFilter(<span style="color: #0000ff;">new</span> AuthProxy(“李四”<span style="color: #000000;">));<br></span><span style="color: #008080;">6</span> <span style="color: #000000;">        doMethod(tDao);<br></span><span style="color: #008080;">7</span>     }  </pre><br></div>

<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">在main方法中调用该方法，程序运行结果如下：</span></span></span></span></p>
<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">create() is running…<br>query() is running…<br>update() is running…<br>delete() is running…<br>你没有权限！<br>query() is running…<br>你没有权限！<br>你没有权限！</span></span></span></span></p>
<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">　　这样的话，所有用户都对query方法有访问权限了，而其他方法只允许张三访问。</span></span></span></span></p>
<p><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">参考资料：<a href="http://llying.iteye.com/blog/220452" target="_blank" rel="external">http://llying.iteye.com/blog/220452</a></span></span></span></span></p>
<p>&nbsp;</p>
<p>　　</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/05/aop-cglib.html" data-id="ciiy5f4y600eoq1d04yal96x8" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/05/aop-cglib.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-dynamic-proxy" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/05/dynamic-proxy.html">动态代理的使用以及其实现机制</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/05/dynamic-proxy.html">
      <time datetime="2013-05-20T23:38:00.000Z" itemprop="datePublished">2013-05-21</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/后端/">后端</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　<span style="font-size: 16px;"><strong>一、动态代理的使用</strong></span></p>
<p><span style="font: 14px/19px Verdana, Geneva, Arial, Helvetica, sans-serif; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　动态代理可以提供对另一个对象的访问，同时隐藏实际对象的具体事实。代理一般会实现它所表示的实际对象的接口。代理可以访问实际对象，但是延迟实现实际对象的部分功能，实际对象实现系统的实际功能，代理对象对客户隐藏了实际对象。客户不知道它是与代理打交道还是与实际对象打交道。</span></p>
<p><span style="font: 14px/19px Verdana, Geneva, Arial, Helvetica, sans-serif; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　动态代理主要包含以下角色：</span></p>
<p><em>　　动态代理类</em>（以下简称为<em>代理类</em>）是一个实现在创建类时在运行时指定的接口列表的类，该类具有下面描述的行为。</p>
<p>　　<em>代理接口</em> 是代理类实现的一个接口。</p>
<p><em>　　代理实例</em> 是代理类的一个实例。</p>
<p>　　每个代理实例都有一个关联的<em>调用处理程序</em> 对象，它可以实现接口 <a href="http://www.cnblogs.com/java/lang/reflect/InvocationHandler.html" title="java.lang.reflect 中的接口" target="_blank" rel="external"><code>InvocationHandler</code></a>。通过其中一个代理接口的代理实例上的方法调用将被指派到实例的调用处理程序的 <a href="http://www.cnblogs.com/java/lang/reflect/InvocationHandler.html#invoke(java.lang.Object, java.lang.reflect.Method, java.lang.Object[]" target="_blank" rel="external"><code>Invoke</code></a>) 方法，并传递代理实例、识别调用方法的 <code>java.lang.reflect.Method</code> 对象以及包含参数的 <code>Object</code> 类型的数组。调用处理程序以适当的方式处理编码的方法调用，并且它返回的结果将作为代理实例上方法调用的结果返回。</p>
<p><span style="color: #000000; font-size: 14px;">　　目前Java开发包中包含了对动态代理的支持，但是其实现只支持对<span style="line-height: 19px;"><strong>接口</strong></span>的的实现。 其实现主要通过java.lang.reflect.Proxy类和java.lang.reflect.InvocationHandler接口。&nbsp;</span><span style="color: #000000; font-size: 14px;">Proxy类主要用来获取动态代理对象，InvocationHandler接口用来约束调用者实现</span></p>
<p><span style="color: #000000; font-size: 14px;">　　下面看一个例子：</span></p>
<p><span style="color: #000000; font-size: 14px;">　　1.代理接口：IComputer.java</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.proxy;<br></span><span style="color: #008080;">2</span><br><span style="color: #008080;">3</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> IComputer {<br></span><span style="color: #008080;">4</span>     <span style="color: #0000ff;">void</span><span style="color: #000000;"> execute();<br></span><span style="color: #008080;">5</span> }</pre><br></div>

<p>　　2.被代理对象：Laptop.java</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.proxy;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #008000;">//</span><span style="color: #008000;">笔记本电脑</span><br><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Laptop <span style="color: #0000ff;">implements</span><span style="color: #000000;"> IComputer {<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> execute() {<br></span><span style="color: #008080;"> 7</span>         System.out.println(“电脑正在执行中……”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> }</pre><br></div>

<p>　　3.调用处理类：TimeHander.java</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.proxy;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.InvocationHandler;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Method;<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TimeHander <span style="color: #0000ff;">implements</span><span style="color: #000000;"> InvocationHandler {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Object object;<br></span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> TimeHander(Object object) {<br></span><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">this</span>.object =<span style="color: #000000;"> object;<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">11</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Object invoke(Object proxy, Method method, Object[] args)<br></span><span style="color: #008080;">12</span>             <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Throwable {<br></span><span style="color: #008080;">13</span>         <span style="color: #0000ff;">long</span> start =<span style="color: #000000;"> System.currentTimeMillis();<br></span><span style="color: #008080;">14</span>         System.out.println(“start:”+<span style="color: #000000;">start);<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        method.invoke(object, args);<br></span><span style="color: #008080;">16</span>         Thread.sleep((<span style="color: #0000ff;">int</span>)(Math.random()*2000<span style="color: #000000;">));<br></span><span style="color: #008080;">17</span>         <span style="color: #0000ff;">long</span> end =<span style="color: #000000;"> System.currentTimeMillis();<br></span><span style="color: #008080;">18</span>         System.out.println(“end:”+<span style="color: #000000;">end);<br></span><span style="color: #008080;">19</span>         System.out.println(“total:”+(end-<span style="color: #000000;">start));<br></span><span style="color: #008080;">20</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> }</pre><br></div>

<p>　　4.测试程序：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.proxy;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Proxy;<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ProxyTest {<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;"> 8</span>         Laptop laptop = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Laptop();<br></span><span style="color: #008080;"> 9</span>         TimeHander hander = <span style="color: #0000ff;">new</span><span style="color: #000000;"> TimeHander(laptop);<br></span><span style="color: #008080;">10</span>         IComputer computer =<span style="color: #000000;"> (IComputer)Proxy.newProxyInstance(laptop.getClass().getClassLoader(), laptop.getClass().getInterfaces(), hander);<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">        computer.execute();<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">13</span><br><span style="color: #008080;">14</span> }</pre><br></div>

<p>程序运行结果：</p>
<p>start:1369118281186<br>电脑正在执行中……<br>end:1369118282849<br>total:1663</p>
<p>&nbsp;</p>
<p>　<strong><span style="font-size: 16px;">　二、动态代理运行机制</span></strong></p>
<p>　　Proxy.<code>&lt;span style=&quot;text-decoration: underline;&quot;&gt;**[newProxyInstance](http://www.cnblogs.com/java/lang/reflect/Proxy.html#newProxyInstance(java.lang.ClassLoader, java.lang.Class[], java.lang.reflect.InvocationHandler))**&lt;/span&gt;([ClassLoader](http://www.cnblogs.com/java/lang/ClassLoader.html &quot;java.lang 中的类&quot;) loader, [Class](http://www.cnblogs.com/java/lang/Class.html &quot;java.lang 中的类&quot;)&lt;?&gt;[] interfaces, [InvocationHandler](http://www.cnblogs.com/java/lang/reflect/InvocationHandler.html &quot;java.lang.reflect 中的接口&quot;) h)</code> 方法会返回一个代理对象类的实例。如上面例子中IComputer computer = (IComputer)Proxy.newProxyInstance(laptop.getClass().getClassLoader(), laptop.getClass().getInterfaces(), hander);执行这一句话的时候会通过反射机制动态的生成一个代理类，该类实现了IComputer接口，并且重写了接口里面的方法（也就是说代理类与被代理类有相同的接口），在该代理类里面有一个InvocationHandler类型的成员变量，也就是调用处理程序，通过调用处理程序来给被代理类增强功能。创建好代理类后就调用类加载器将该类加载到类存，然后再通过反射创建一个该代理类的实例对象。</p>
<p><span style="color: #000000; font-size: 14px;">　　为了能够更加的理解动态代理的运行机制，我自己来实现了一个动态代理：</span></p>
<p><span style="color: #000000; font-size: 14px;">　　1.代理接口：Moveable.java</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.test;<br></span><span style="color: #008080;">2</span><br><span style="color: #008080;">3</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> Moveable {<br></span><span style="color: #008080;">4</span>     <span style="color: #0000ff;">void</span><span style="color: #000000;"> move();<br></span><span style="color: #008080;">5</span> }</pre><br></div>

<p>　　2.被代理对象：Tank.java</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.test;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Random;<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> Tank <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Moveable {<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> move() {<br></span><span style="color: #008080;"> 8</span>         System.out.println(“Tank moving…”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">10</span>             Thread.sleep(<span style="color: #0000ff;">new</span> Random().nextInt(10000<span style="color: #000000;">));<br></span><span style="color: #008080;">11</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> }</pre><br></div>

<p>　　3.下面写一个Proxy类来为被代理对象产生一个代理类对象，来实现增加记录运行时间的功能。</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.test;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.File;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.FileWriter;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Constructor;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Method;<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.tools.JavaCompiler;<br></span><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.tools.StandardJavaFileManager;<br></span><span style="color: #008080;">10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.tools.ToolProvider;<br></span><span style="color: #008080;">11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.tools.JavaCompiler.CompilationTask;<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Proxy {<br></span><span style="color: #008080;">14</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> Object newProxyInstance(Class interfaces,InvocationHandler h)<span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception{<br></span><span style="color: #008080;">15</span>         StringBuffer methodStr = <span style="color: #0000ff;">new</span><span style="color: #000000;"> StringBuffer();<br></span><span style="color: #008080;">16</span>         String tr = “\r\n”<span style="color: #000000;">;<br></span><span style="color: #008080;">17</span>         Method[] methods =<span style="color: #000000;"> interfaces.getMethods();<br></span><span style="color: #008080;">18</span>         <span style="color: #008000;">//</span><span style="color: #008000;">拼接代理类的方法</span><br><span style="color: #008080;">19</span>         <span style="color: #0000ff;">for</span><span style="color: #000000;"> (Method method : methods) {<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">            methodStr.append(<br></span><span style="color: #008080;">21</span>             “    public “+ method.getReturnType()+ “ “ +method.getName()+”() {“ + tr +<br><span style="color: #008080;">22</span>             “        try {“ + tr +<br><span style="color: #008080;">23</span>             “            java.lang.reflect.Method md = “ + interfaces.getName() + “.” + “class.getMethod(\””  + method.getName() + “\”);” + tr +<br><span style="color: #008080;">24</span>             “            h.invoke(this,md);” + tr +<br><span style="color: #008080;">25</span>             “        }catch(Exception e) {e.printStackTrace();}” + tr +<br><span style="color: #008080;">26</span>             “    }” +<span style="color: #000000;"> tr<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">            );<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">29</span><br><span style="color: #008080;">30</span>         <span style="color: #008000;">//</span><span style="color: #008000;">拼接代理类</span><br><span style="color: #008080;">31</span>         String src = “package com.test;” + tr +<br><span style="color: #008080;">32</span>         “import com.test.Moveable;” + tr +<br><span style="color: #008080;">33</span>         “public class TimeProxy implements “ + interfaces.getName() + “ {“ + tr +<br><span style="color: #008080;">34</span>         “    private com.test.InvocationHandler h;” + tr +<br><span style="color: #008080;">35</span>         “    public TimeProxy(com.test.InvocationHandler h) {“ + tr +<br><span style="color: #008080;">36</span>         “        this.h = h;” + tr +<br><span style="color: #008080;">37</span>         “    }” + tr +<br><span style="color: #008080;">38</span>         methodStr.toString() + tr +<br><span style="color: #008080;">39</span>         “}”<span style="color: #000000;">;<br></span><span style="color: #008080;">40</span>         <span style="color: #008000;">//</span><span style="color: #008000;">创建代理类</span><br><span style="color: #008080;">41</span>         String fileName = System.getProperty(“user.dir”) + “/src/com/test/TimeProxy.java”<span style="color: #000000;">;<br></span><span style="color: #008080;">42</span>         File file = <span style="color: #0000ff;">new</span><span style="color: #000000;"> File(fileName);<br></span><span style="color: #008080;">43</span>         FileWriter writer = <span style="color: #0000ff;">new</span><span style="color: #000000;"> FileWriter(file);<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">        writer.write(src);<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">        writer.flush();<br></span><span style="color: #008080;">46</span> <span style="color: #000000;">        writer.close();<br></span><span style="color: #008080;">47</span>         <span style="color: #008000;">//</span><span style="color: #008000;">编译</span><br><span style="color: #008080;">48</span>         JavaCompiler compiler =<span style="color: #000000;"> ToolProvider.getSystemJavaCompiler();<br></span><span style="color: #008080;">49</span>         StandardJavaFileManager fileMgr = compiler.getStandardFileManager(<span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">50</span>         Iterable units =<span style="color: #000000;"> fileMgr.getJavaFileObjects(fileName);<br></span><span style="color: #008080;">51</span>         CompilationTask ct = compiler.getTask(<span style="color: #0000ff;">null</span>, fileMgr, <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span><span style="color: #000000;">, units);<br></span><span style="color: #008080;">52</span> <span style="color: #000000;">        ct.call();<br></span><span style="color: #008080;">53</span> <span style="color: #000000;">        fileMgr.close();<br></span><span style="color: #008080;">54</span>         <span style="color: #008000;">//</span><span style="color: #008000;">加载类到内存：</span><br><span style="color: #008080;">55</span>         Class c = ClassLoader.getSystemClassLoader().loadClass(“com.test.TimeProxy”<span style="color: #000000;">);<br></span><span style="color: #008080;">56</span>         Constructor constructor = c.getConstructor(InvocationHandler.<span style="color: #0000ff;">class</span>); <span style="color: #008000;">//</span><span style="color: #008000;">得到参数为InvocationHandler类型的构造方法</span><br><span style="color: #008080;">57</span>         Object m = constructor.newInstance(h); <span style="color: #008000;">//</span><span style="color: #008000;">通过该构造方法得到实例</span><br><span style="color: #008080;">58</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> m;<br></span><span style="color: #008080;">59</span><br><span style="color: #008080;">60</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">61</span> }</pre><br></div>

<p>　　4.TankProxy.java</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.test;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Method;<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> TankProxy {<br></span><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <t> T getBean(<span style="color: #0000ff;">final</span> Object tank) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception{<br></span><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">return</span> (T)Proxy.newProxyInstance(tank.getClass().getInterfaces()[0], <span style="color: #0000ff;">new</span><span style="color: #000000;"> InvocationHandler(){<br></span><span style="color: #008080;"> 8</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> invoke(Object proxy, Method method) {<br></span><span style="color: #008080;"> 9</span>                 <span style="color: #0000ff;">long</span> start =<span style="color: #000000;"> System.currentTimeMillis();<br></span><span style="color: #008080;">10</span>                 System.out.println(“start:”+<span style="color: #000000;">start);<br></span><span style="color: #008080;">11</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">12</span>                     method.invoke(tank, <span style="color: #0000ff;">new</span><span style="color: #000000;"> Object[]{});<br></span><span style="color: #008080;">13</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">                    e.printStackTrace();<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">16</span>                 <span style="color: #0000ff;">long</span> end =<span style="color: #000000;"> System.currentTimeMillis();<br></span><span style="color: #008080;">17</span>                 System.out.println(“end:”+<span style="color: #000000;">end);<br></span><span style="color: #008080;">18</span>                 System.out.println(“time:”+(end-<span style="color: #000000;">start));<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">23</span> }    </t></pre><br></div>

<p>　　5.测试程序：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.test;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.extend.Tank2;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.extend.Tank3;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.juhe.LogProxy;<br></span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.juhe.TimeProxy;<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Test {<br></span><span style="color: #008080;">11</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {<br></span><span style="color: #008080;">12</span>         Tank tank = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Tank();<br></span><span style="color: #008080;">13</span>         Moveable m =<span style="color: #000000;">  TankProxy.getBean(tank);<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">        m.move();<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span> }</pre><br></div>

<p>执行该程序的结果为：<br>start:1369121253400<br>Tank moving…<br>end:1369121260078<br>time:6678</p>
<p>动态生成的代理类的内容如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.test;<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.test.Moveable;<br></span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TimeProxy <span style="color: #0000ff;">implements</span><span style="color: #000000;"> com.test.Moveable {<br></span><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> com.test.InvocationHandler h;<br></span><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> TimeProxy(com.test.InvocationHandler h) {<br></span><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">this</span>.h =<span style="color: #000000;"> h;<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> move() {<br></span><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">10</span>             java.lang.reflect.Method md = com.test.Moveable.<span style="color: #0000ff;">class</span>.getMethod(“move”<span style="color: #000000;">);<br></span><span style="color: #008080;">11</span>             h.invoke(<span style="color: #0000ff;">this</span><span style="color: #000000;">,md);<br></span><span style="color: #008080;">12</span>         }<span style="color: #0000ff;">catch</span><span style="color: #000000;">(Exception e) {e.printStackTrace();}<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> }</pre><br></div>

<p>　　看了这个例子，对动态代理的实现机制应该会有一定的了解了！</p>
<p>&nbsp;　　小结：<span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #efefef; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">动态代理在运行期通过接口动态生成代理类，这为其带来了一定的灵活性，但这个灵活性却带来了两个问题，第一代理类必须实现一个接口，如果没实现接口会抛出一个异常。第二性能影响，因为动态代理使用反射的机制实现的，首先反射肯定比直接调用要慢，<span style="font: 14px/25.2px Helvetica, Tahoma, Arial, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #efefef; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">其次使用反射大量生成类文件可能引起Full GC造成性能影响，因为字节码文件加载后会存放在JVM运行时区的方法区（或者叫持久代）中，当方法区满的时候，会引起Full GC，所以当你大量使用动态代理时，可以将持久代设置大一些，减少Full GC次数。<span class="Apple-converted-space">&nbsp;</span></span></span></p>
<p>&nbsp;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/05/dynamic-proxy.html" data-id="ciiy5f4w700blq1d0tb9qutjl" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/05/dynamic-proxy.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web后端/">web后端</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-lock-producer-comsumer" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/05/lock-producer-comsumer.html">使用Lock来实现生产者和消费者问题</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/05/lock-producer-comsumer.html">
      <time datetime="2013-05-18T01:55:00.000Z" itemprop="datePublished">2013-05-18</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Java基础/">Java基础</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>前面写过：<a href="http://www.cnblogs.com/liuling/archive/2013/04/17/syncnized.html" target="_blank" rel="external">synchronize来实现生产者和消费者问题</a></p>
<p>现在用Lock来实现它</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.thread;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.LinkedList;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.locks.Condition;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.locks.Lock;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.locks.ReentrantLock;<br></span><span style="color: #008080;">  7</span><br><span style="color: #008080;">  8</span><br><span style="color: #008080;">  9</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 10</span> <span style="color: #008000;">  使用Lock来实现生产者和消费者问题<br></span><span style="color: #008080;"> 11</span> <span style="color: #008000;"> <em><br></em></span><span style="color: #008080;"> 12</span> <span style="color: #008000;">  </span><span style="color: #808080;">@author</span><span style="color: #008000;"> 刘玲<br></span><span style="color: #008080;"> 13</span> <span style="color: #008000;"> <em><br></em></span><span style="color: #008080;"> 14</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ProducerConsumer {<br></span><span style="color: #008080;"> 16</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;"> 17</span>         Basket b = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Basket();<br></span><span style="color: #008080;"> 18</span>         Product p = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Product(b);<br></span><span style="color: #008080;"> 19</span>         Consumer c = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Consumer(b);<br></span><span style="color: #008080;"> 20</span>         Consumer c1 = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Consumer(b);<br></span><span style="color: #008080;"> 21</span>         <span style="color: #0000ff;">new</span><span style="color: #000000;"> Thread(p).start();<br></span><span style="color: #008080;"> 22</span>         <span style="color: #0000ff;">new</span><span style="color: #000000;"> Thread(c).start();<br></span><span style="color: #008080;"> 23</span>         <span style="color: #0000ff;">new</span><span style="color: #000000;"> Thread(c1).start();<br></span><span style="color: #008080;"> 24</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 25</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 26</span> <span style="color: #008000;">//</span><span style="color: #008000;">馒头</span><br><span style="color: #008080;"> 27</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ManTou{<br></span><span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">int</span><span style="color: #000000;"> id;<br></span><span style="color: #008080;"> 29</span>     <span style="color: #0000ff;">public</span> ManTou(<span style="color: #0000ff;">int</span><span style="color: #000000;"> id) {<br></span><span style="color: #008080;"> 30</span>         <span style="color: #0000ff;">this</span>.id =<span style="color: #000000;"> id;<br></span><span style="color: #008080;"> 31</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 32</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 33</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String toString() {<br></span><span style="color: #008080;"> 34</span>         <span style="color: #0000ff;">return</span> “ManTou”+<span style="color: #000000;">id;<br></span><span style="color: #008080;"> 35</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 36</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 37</span><br><span style="color: #008080;"> 38</span> <span style="color: #008000;">//</span><span style="color: #008000;">装馒头的篮子</span><br><span style="color: #008080;"> 39</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Basket{<br></span><span style="color: #008080;"> 40</span>     <span style="color: #0000ff;">int</span> max = 6<span style="color: #000000;">;<br></span><span style="color: #008080;"> 41</span>     LinkedList<mantou> manTous = <span style="color: #0000ff;">new</span> LinkedList<mantou><span style="color: #000000;">();<br></span><span style="color: #008080;"> 42</span>     Lock lock = <span style="color: #0000ff;">new</span> ReentrantLock(); <span style="color: #008000;">//</span><span style="color: #008000;">锁对象</span><br><span style="color: #008080;"> 43</span>     Condition full = lock.newCondition();  <span style="color: #008000;">//</span><span style="color: #008000;">用来监控篮子是否满的Condition实例</span><br><span style="color: #008080;"> 44</span>     Condition empty = lock.newCondition(); <span style="color: #008000;">//</span><span style="color: #008000;">用来监控篮子是否空的Condition实例<br></span><span style="color: #008080;"> 45</span>     <span style="color: #008000;">//</span><span style="color: #008000;">往篮子里面放馒头</span><br><span style="color: #008080;"> 46</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> push(ManTou m){<br></span><span style="color: #008080;"> 47</span> <span style="color: #000000;">        lock.lock();<br></span><span style="color: #008080;"> 48</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 49</span>             <span style="color: #0000ff;">while</span>(max ==<span style="color: #000000;"> manTous.size()){<br></span><span style="color: #008080;"> 50</span>                 System.out.println(“篮子是满的，待会儿再生产…”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 51</span> <span style="color: #000000;">                full.await();<br></span><span style="color: #008080;"> 52</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 53</span> <span style="color: #000000;">            manTous.add(m);<br></span><span style="color: #008080;"> 54</span> <span style="color: #000000;">            empty.signal();<br></span><span style="color: #008080;"> 55</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;"> 56</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;"> 57</span>         }<span style="color: #0000ff;">finally</span><span style="color: #000000;">{<br></span><span style="color: #008080;"> 58</span> <span style="color: #000000;">            lock.unlock();<br></span><span style="color: #008080;"> 59</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 60</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 61</span>     <span style="color: #008000;">//</span><span style="color: #008000;">往篮子里面取馒头</span><br><span style="color: #008080;"> 62</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ManTou pop(){<br></span><span style="color: #008080;"> 63</span>         ManTou m = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 64</span> <span style="color: #000000;">        lock.lock();<br></span><span style="color: #008080;"> 65</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 66</span>             <span style="color: #0000ff;">while</span>(manTous.size() == 0<span style="color: #000000;">){<br></span><span style="color: #008080;"> 67</span>                 System.out.println(“篮子是空的，待会儿再吃…”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 68</span> <span style="color: #000000;">                empty.await();<br></span><span style="color: #008080;"> 69</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 70</span>             m =<span style="color: #000000;"> manTous.removeFirst();<br></span><span style="color: #008080;"> 71</span> <span style="color: #000000;">            full.signal();<br></span><span style="color: #008080;"> 72</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;"> 73</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;"> 74</span>         }<span style="color: #0000ff;">finally</span><span style="color: #000000;">{<br></span><span style="color: #008080;"> 75</span> <span style="color: #000000;">            lock.unlock();<br></span><span style="color: #008080;"> 76</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> m;<br></span><span style="color: #008080;"> 77</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 78</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 79</span> <span style="color: #000000;">}<br></span><span style="color: #008080;"> 80</span> <span style="color: #008000;">//</span><span style="color: #008000;">生产者</span><br><span style="color: #008080;"> 81</span> <span style="color: #0000ff;">class</span> Product <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Runnable{<br></span><span style="color: #008080;"> 82</span> <span style="color: #000000;">    Basket basket;<br></span><span style="color: #008080;"> 83</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Product(Basket basket) {<br></span><span style="color: #008080;"> 84</span>         <span style="color: #0000ff;">this</span>.basket =<span style="color: #000000;"> basket;<br></span><span style="color: #008080;"> 85</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 86</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;"> 87</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; 40; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;"> 88</span>             ManTou m = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ManTou(i);<br></span><span style="color: #008080;"> 89</span> <span style="color: #000000;">            basket.push(m);<br></span><span style="color: #008080;"> 90</span>             System.out.println(“生产了”+<span style="color: #000000;">m);<br></span><span style="color: #008080;"> 91</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 92</span>                 Thread.sleep((<span style="color: #0000ff;">int</span>)(Math.random()<em>2000<span style="color: #000000;">));<br></span><span style="color: #008080;"> 93</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;"> 94</span> <span style="color: #000000;">                e.printStackTrace();<br></span><span style="color: #008080;"> 95</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 96</span><br><span style="color: #008080;"> 97</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 98</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 99</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">100</span><br><span style="color: #008080;">101</span> <span style="color: #008000;">//</span><span style="color: #008000;">消费者</span><br><span style="color: #008080;">102</span> <span style="color: #0000ff;">class</span> Consumer <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Runnable{<br></span><span style="color: #008080;">103</span> <span style="color: #000000;">    Basket basket;<br></span><span style="color: #008080;">104</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Consumer(Basket basket) {<br></span><span style="color: #008080;">105</span>         <span style="color: #0000ff;">this</span>.basket =<span style="color: #000000;"> basket;<br></span><span style="color: #008080;">106</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">107</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;">108</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; 20; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;">109</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">110</span>                 Thread.sleep((<span style="color: #0000ff;">int</span>)(Math.random()</em>2000<span style="color: #000000;">));<br></span><span style="color: #008080;">111</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;">112</span> <span style="color: #000000;">                e.printStackTrace();<br></span><span style="color: #008080;">113</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">114</span>             ManTou m =<span style="color: #000000;"> basket.pop();<br></span><span style="color: #008080;">115</span>             System.out.println(“消费了”+<span style="color: #000000;">m);<br></span><span style="color: #008080;">116</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">117</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">118</span> }</mantou></mantou></pre><br></div>

<p>&nbsp;附：synchronize与Lock的区别</p>
<p><strong>一、synchronized和lock的用法区别</strong><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">synchronized：在需要同步的对象中加入此控制，synchronized可以加在方法上，也可以加在特定代码块中，括号中表示需要锁的对象。</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">lock：需要显示指定起始位置和终止位置。一般使用ReentrantLock类做为锁，多个线程中必须要使用一个ReentrantLock类做为对象才能保证锁的生效。且在加锁和解锁处需要通过lock()和unlock()显示指出。所以一般会在finally块中写unlock()以防死锁。</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">用法区别比较简单，这里不赘述了，如果不懂的可以看看Java基本语法。</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;</span><br><strong>二、synchronized和lock性能区别</strong><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">synchronized是托管给JVM执行的，而lock是java写的控制锁的代码。在Java1.5中，synchronize是性能低效的。因为这是一个重量级操作，需要调用操作接口，导致有可能加锁消耗的系统时间比加锁以外的操作还多。相比之下使用Java提供的Lock对象，性能更高一些。但是到了Java1.6，发生了变化。synchronize在语义上很清晰，可以进行很多优化，有适应自旋，锁消除，锁粗化，轻量级锁，偏向锁等等。导致在Java1.6上synchronize的性能并不比Lock差。官方也表示，他们也更支持synchronize，在未来的版本中还有优化余地。</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">说到这里，还是想提一下这2中机制的具体区别。据我所知，synchronized原始采用的是CPU悲观锁机制，即线程获得的是独占锁。独占锁意味着其他线程只能依靠阻塞来等待线程释放锁。而在CPU转换线程阻塞时会引起线程上下文切换，当有很多线程竞争锁的时候，会引起CPU频繁的上下文切换导致效率很低。</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">而Lock用的是乐观锁方式。所谓乐观锁就是，每次不加锁而是假设没有冲突而去完成某项操作，如果因为冲突失败就重试，直到成功为止。乐观锁实现的机制就是CAS操作（Compare and Swap）。我们可以进一步研究ReentrantLock的源代码，会发现其中比较重要的获得锁的一个方法是compareAndSetState。这里其实就是调用的CPU提供的特殊指令。</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">现代的CPU提供了指令，可以自动更新共享数据，而且能够检测到其他线程的干扰，而 compareAndSet() 就用这些代替了锁定。这个算法称作非阻塞算法，意思是一个线程的失败或者挂起不应该影响其他线程的失败或挂起的算法。</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">我也只是了解到这一步，具体到CPU的算法如果感兴趣的读者还可以在查阅下，如果有更好的解释也可以给我留言，我也学习下。</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;</span><br><strong>三、synchronized和lock用途区别</strong><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">synchronized原语和ReentrantLock在一般情况下没有什么区别，但是在非常复杂的同步应用中，请考虑使用ReentrantLock，特别是遇到下面2种需求的时候。</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">1.某个线程在等待一个锁的控制权的这段时间需要中断</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">2.需要分开处理一些wait-notify，ReentrantLock里面的Condition应用，能够控制notify哪个线程</span><br><span style="font: 14px/18px Arial, Tahoma, Verdana; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">3.具有公平锁功能，每个到来的线程都将排队等候</span></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/05/lock-producer-comsumer.html" data-id="ciiy5f4sh005mq1d0r82fkjkt" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/05/lock-producer-comsumer.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多线程/">多线程</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-dynamic-compile" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/05/dynamic-compile.html">java笔记十一：动态编译</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/05/dynamic-compile.html">
      <time datetime="2013-05-09T06:55:00.000Z" itemprop="datePublished">2013-05-09</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Java基础/">Java基础</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　JDK6.0推出了动态编译的新功能，能够在程序中动态的写一个类，再对之进行编译。编译成class文件后就可以通过类加载方式把动态编译的类加载到内存中。当然也能通过RunTime类调用javac命令来动态编译。</p>
<p>　　动态编译类的主要步骤：</p>
<p>　　①、写一个字符串，这个字符串就是要编译的类的全部内容。</p>
<p>　　②、通过输出流，把该字符串的内容写到工程下面指定的包中。</p>
<p>　　③、对创建的java文件进行编译。</p>
<p>　　　　动态编译涉及的类有JavaCompiler、StandardJavaFileManager，具体如何编译看下面的例子。</p>
<p>　　④、把编译后的字节码加载到内存，然后对其进行操作。</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.compiler;<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">import</span> java.io.<em><span style="color: #000000;">;<br></span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.InvocationTargetException;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.URI;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.URL;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.URLClassLoader;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Arrays;<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.tools.JavaCompiler;<br></span><span style="color: #008080;">10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.tools.SimpleJavaFileObject;<br></span><span style="color: #008080;">11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.tools.StandardJavaFileManager;<br></span><span style="color: #008080;">12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.tools.JavaFileObject;<br></span><span style="color: #008080;">13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> javax.tools.ToolProvider;<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> CompilerAPITester {<br></span><span style="color: #008080;">16</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> String JAVA_SOURCE_FILE = “DynamicObject.java”<span style="color: #000000;">;<br></span><span style="color: #008080;">17</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> String JAVA_CLASS_FILE = “DynamicObject.class”<span style="color: #000000;">;<br></span><span style="color: #008080;">18</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> String JAVA_CLASS_NAME = “DynamicObject”<span style="color: #000000;">;<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException, InterruptedException {<br></span><span style="color: #008080;">21</span>         <span style="color: #008000;">//</span><span style="color: #008000;">创建java文件</span><br><span style="color: #008080;">22</span>         String tr = “\r\n”<span style="color: #000000;">;<br></span><span style="color: #008080;">23</span>         String source = “package com.compiler;” + tr +<br><span style="color: #008080;">24</span>                 “public class “+JAVA_CLASS_NAME+ “{ “ + tr +<br><span style="color: #008080;">25</span>                 “    public static void main(String[] args) {“ + tr +<br><span style="color: #008080;">26</span>                 “        System.out.println(\”Hello World!\”);” + tr +<br><span style="color: #008080;">27</span>                 “    } “ + tr +<br><span style="color: #008080;">28</span>                 “}”<span style="color: #000000;">;<br></span><span style="color: #008080;">29</span>         String fileName = System.getProperty(“user.dir”)+”\src\com\compiler\“+<span style="color: #000000;">JAVA_SOURCE_FILE;<br></span><span style="color: #008080;">30</span>         FileWriter fw = <span style="color: #0000ff;">new</span> FileWriter(fileName); <span style="color: #008000;">//</span><span style="color: #008000;">字符输出流</span><br><span style="color: #008080;">31</span>         PrintWriter pw = <span style="color: #0000ff;">new</span> PrintWriter(fw);     <span style="color: #008000;">//</span><span style="color: #008000;">将字节输出流转为PrintWriter</span><br><span style="color: #008080;">32</span> <span style="color: #000000;">        pw.write(source);<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">        pw.close();<br></span><span style="color: #008080;">34</span>         <span style="color: #008000;">//</span><span style="color: #008000;">编译java文件</span><br><span style="color: #008080;">35</span>         JavaCompiler compiler =<span style="color: #000000;"> ToolProvider.getSystemJavaCompiler();<br></span><span style="color: #008080;">36</span>         StandardJavaFileManager fileManager = compiler.getStandardFileManager(<span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">37</span>         Iterable sourcefiles =<span style="color: #000000;"> fileManager.getJavaFileObjects(fileName);<br></span><span style="color: #008080;">38</span>         <span style="color: #008000;">//</span><span style="color: #008000;">指定编译文件存放位置,如果不指定的话，编译的文件会和java源文件在一个文件夹中<br></span><span style="color: #008080;">39</span>          <span style="color: #008000;">//</span><span style="color: #008000;">这样的话加载类的时候会报java.lang.ClassNotFoundException</span><br><span style="color: #008080;">40</span>         Iterable<string> options = Arrays.asList(“-d”, System.getProperty(“user.dir”)+”\WebRoot\WEB-INF\classes”<span style="color: #000000;">);<br></span><span style="color: #008080;">41</span>         compiler.getTask(<span style="color: #0000ff;">null</span>, fileManager, <span style="color: #0000ff;">null</span>, options, <span style="color: #0000ff;">null</span><span style="color: #000000;">, sourcefiles).call();<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">        fileManager.close();<br></span><span style="color: #008080;">43</span>         <span style="color: #008000;">//</span><span style="color: #008000;">方法二：</span><br><span style="color: #008080;">44</span>         <span style="color: #008000;">/</span></string></em><span style="color: #008000;">Runtime runtime = Runtime.getRuntime();<br></span><span style="color: #008080;">45</span> <span style="color: #008000;">        runtime.exec(“javac -d “+ System.getProperty(“user.dir”)+”\WebRoot\WEB-INF\classes “ +fileName);<br></span><span style="color: #008080;">46</span> <span style="color: #008000;">        Thread.sleep(1000);</span><span style="color: #008000;">*/</span> <span style="color: #008000;">//</span><span style="color: #008000;">因为这种方法时调用一个线程取编译，所以要让主线程睡一会儿，否则还没编译完主线程就加载类了，会导致报类无法找到的异常</span><br><span style="color: #008080;">47</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">48</span>             <span style="color: #008000;">//</span><span style="color: #008000;">加载类到内存<br></span><span style="color: #008080;">49</span>             <span style="color: #008000;">//</span><span style="color: #008000;">方法一：<br></span><span style="color: #008080;">50</span>             <span style="color: #008000;">//</span><span style="color: #008000;">Class c = Class.forName(“com.compiler.”+JAVA_CLASS_NAME);<br></span><span style="color: #008080;">51</span>             <span style="color: #008000;">//</span><span style="color: #008000;">方法二：<br></span><span style="color: #008080;">52</span>             <span style="color: #008000;">//</span><span style="color: #008000;">Class c = ClassLoader.getSystemClassLoader().loadClass(“com.compiler.”+JAVA_CLASS_NAME);<br></span><span style="color: #008080;">53</span>             <span style="color: #008000;">//</span><span style="color: #008000;">方法三：</span><br><span style="color: #008080;">54</span>             URL[] urls = <span style="color: #0000ff;">new</span> URL[] {<span style="color: #0000ff;">new</span> URL(“file:/“+System.getProperty(“user.dir”)+”/src”<span style="color: #000000;">)};<br></span><span style="color: #008080;">55</span>             URLClassLoader loader = <span style="color: #0000ff;">new</span><span style="color: #000000;"> URLClassLoader(urls);<br></span><span style="color: #008080;">56</span>             Class c = loader.loadClass(“com.compiler.”+<span style="color: #000000;">JAVA_CLASS_NAME);<br></span><span style="color: #008080;">57</span>             <span style="color: #008000;">//</span><span style="color: #008000;">调用加载类的main方法</span><br><span style="color: #008080;">58</span>             c.getMethod(“main”,String[].<span style="color: #0000ff;">class</span>).invoke(<span style="color: #0000ff;">null</span>, (Object)<span style="color: #0000ff;">new</span> String[]{“a”<span style="color: #000000;">});<br></span><span style="color: #008080;">59</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">60</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated catch block</span><br><span style="color: #008080;">61</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;">62</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">63</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">64</span><br><span style="color: #008080;">65</span> } </pre><br></div>

<p>&nbsp;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/05/dynamic-compile.html" data-id="ciiy5f4w900bpq1d0bg3wcvbo" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/05/dynamic-compile.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-java-reflex" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2013/05/java-reflex.html">java笔记十：java中的反射</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/05/java-reflex.html">
      <time datetime="2013-05-08T20:16:00.000Z" itemprop="datePublished">2013-05-09</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Java基础/">Java基础</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　<span style="font: 14px/21px arial, helvetica, sans-serif; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: pre-wrap; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: none; -webkit-text-stroke-width: 0px;">Java中，反射是一种强大的工具。它使您能够创建灵活的代码，这些代码可以在运行时装配，无需在组件之间进行源代表链接。反射允许我们在编写与执行时，使我们的程序代码能够接入装载到JVM中的类的内部信息，而不是源代码中选定的类协作的代码。这使反射成为构建灵活的应用的主要工具。但需注意的是：如果使用不当，反射的成本很高。</span></p>
<p><span style="font: 14px/21px arial, helvetica, sans-serif; text-align: left; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: pre-wrap; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: none; -webkit-text-stroke-width: 0px;">　　</span><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 14px;"><span style="text-align: left; text-transform: none; line-height: 21px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: pre-wrap; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: none; -webkit-text-stroke-width: 0px;"><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">Java的类反射所需要的类并不多，它们分别是：Field、Constructor、Method、Class、Object，下面我将对这些类做一个简单的说明。</span></span><span style="text-align: left; text-transform: none; line-height: 21px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: pre-wrap; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: none; -webkit-text-stroke-width: 0px;"><br><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">Field类：提供有关类或接口的属性的信息，以及对它的动态访问权限。反射的字段可能是一个类（静态）属性或实例属性，简单的理解可以把它看成一个封装反射类的属性的类。</span><br><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">Constructor类：提供关于类的单个构造方法的信息以及对它的访问权限。这个类和Field类不同，Field类封装了反射类的属性，而Constructor类则封装了反射类的构造方法。</span><br><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">Method类：提供关于类或接口上单独某个方法的信息。所反映的方法可能是类方法或实例方法（包括抽象方法）。 这个类不难理解，它是用来封装反射类方法的一个类。</span><br><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">Class类：类的实例表示正在运行的 Java 应用程序中的类和接口。枚举是一种类，注释是一种接口。每个数组属于被映射为 Class 对象的一个类，所有具有相同元素类型和维数的数组都共享该 Class 对象。</span><br><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">Object类：每个类都使用 Object 作为超类。所有对象（包括数组）都实现这个类的方法。</span></span></span></p>
<p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 14px;"><span style="text-align: left; text-transform: none; line-height: 21px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: pre-wrap; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: none; -webkit-text-stroke-width: 0px;"><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　下面举几个例子：</span></span></span></p>
<p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 14px;"><span style="text-align: left; text-transform: none; line-height: 21px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: pre-wrap; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: none; -webkit-text-stroke-width: 0px;"><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">①、反射类中的属性</span></span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.reflect;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.awt.event.ActionEvent;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.awt.event.ActionListener;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Field;<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">class</span> A <span style="color: #0000ff;">extends</span> Object <span style="color: #0000ff;">implements</span><span style="color: #000000;"> ActionListener{<br></span><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">public</span> String s = “aaa”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> a = 3<span style="color: #000000;">;<br></span><span style="color: #008080;">10</span>     <span style="color: #0000ff;">private</span> Integer b = <span style="color: #0000ff;">new</span> Integer(4<span style="color: #000000;">);<br></span><span style="color: #008080;">11</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> A(){}<br></span><span style="color: #008080;">12</span>     <span style="color: #0000ff;">public</span> A(<span style="color: #0000ff;">int</span><span style="color: #000000;"> id,String name){}<br></span><span style="color: #008080;">13</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> abc(<span style="color: #0000ff;">int</span><span style="color: #000000;"> id,String name){<br></span><span style="color: #008080;">14</span>         <span style="color: #0000ff;">return</span> 0<span style="color: #000000;">;<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">16</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> actionPerformed(ActionEvent e) {<br></span><span style="color: #008080;">17</span>         System.out.println(“actionPerformed()”<span style="color: #000000;">);<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">19</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> f1(<span style="color: #0000ff;">int</span><span style="color: #000000;"> a){System.out.println(a);}<br></span><span style="color: #008080;">20</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> f2(<span style="color: #0000ff;">int</span><span style="color: #000000;"> a){<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">        System.out.println(a);<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">24</span><br><span style="color: #008080;">25</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> TestReflect {<br></span><span style="color: #008080;">26</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> SecurityException, NoSuchFieldException, IllegalArgumentException, IllegalAccessException {<br></span><span style="color: #008080;">27</span>         A a = <span style="color: #0000ff;">new</span><span style="color: #000000;"> A();<br></span><span style="color: #008080;">28</span>         Class c =<span style="color: #000000;"> a.getClass();<br></span><span style="color: #008080;">29</span>         <span style="color: #008000;">//</span><span style="color: #008000;">反射属性</span><br><span style="color: #008080;">30</span>         Field[] fields = c.getFields();<span style="color: #008000;">//</span><span style="color: #008000;">得到公有属性<br></span><span style="color: #008080;">31</span>         <span style="color: #008000;">//</span><span style="color: #008000;">Field[] fields = c.getDeclaredFields(); </span><span style="color: #008000;">//</span><span style="color: #008000;">得到所有属性</span><br><span style="color: #008080;">32</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; fields.length; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;">33</span>             Class c1 = fields[i].getType(); <span style="color: #008000;">//</span><span style="color: #008000;">得到属性类型</span><br><span style="color: #008080;">34</span> <span style="color: #000000;">            System.out.println(c1);<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">36</span>         System.out.println(“反射类中的私有属性”<span style="color: #000000;">);<br></span><span style="color: #008080;">37</span>         Field f = c.getDeclaredField(“a”<span style="color: #000000;">);<br></span><span style="color: #008080;">38</span>         f.setAccessible(<span style="color: #0000ff;">true</span>);  <span style="color: #008000;">//</span><span style="color: #008000;">如果是私有成员，则要加这句，否则无法访问</span><br><span style="color: #008080;">39</span>         System.out.println(f.get(a));<span style="color: #008000;">//</span><span style="color: #008000;">f.get(o)返回o对象的f属性</span><br><span style="color: #008080;">40</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">41</span><br><span style="color: #008080;">42</span> }</pre><br></div>

<p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 14px;"><span style="text-align: left; text-transform: none; line-height: 21px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: pre-wrap; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: none; -webkit-text-stroke-width: 0px;"><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　反射类中的属性主要有两个方法：getFields()和getDeclaredFielda(),这两个方法返回的都是一个Field数组。getFields()得到的是public修饰的属性，而getDeclaredFielda()得到的是所有的属性。当然也可以得到某一个属性，如Field f = c.getDeclaredField(“a”)，如果该属性是私有的话，必须加上f.setAccessible(true)，否则用到的时候会报java.lang.IllegalAccessException异常。</span></span></span></p>
<p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 14px;"><span style="text-align: left; text-transform: none; line-height: 21px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: pre-wrap; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: none; -webkit-text-stroke-width: 0px;"><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">②、反射类中的构造方法</span></span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.reflect;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Constructor;<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> RefectConstructors {<br></span><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> NoSuchMethodException, SecurityException {<br></span><span style="color: #008080;"> 7</span>         Class c = A.<span style="color: #0000ff;">class</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 8</span>         String className = c.getName();<span style="color: #008000;">//</span><span style="color: #008000;">得到类名</span><br><span style="color: #008080;"> 9</span>         Constructor[] cons = c.getConstructors();  <span style="color: #008000;">//</span><span style="color: #008000;">得到所有构造方法</span><br><span style="color: #008080;">10</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; cons.length; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;">11</span>             Class[] parameterTypes =<span style="color: #000000;"> cons[i].getParameterTypes();<br></span><span style="color: #008080;">12</span>             System.out.print(className+”(“<span style="color: #000000;">);<br></span><span style="color: #008080;">13</span>             <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> j = 0; j &lt; parameterTypes.length; j++<span style="color: #000000;">) {<br></span><span style="color: #008080;">14</span>                 System.out.print(parameterTypes[j].getName()+” “<span style="color: #000000;">);<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">16</span>             System.out.print(“)”<span style="color: #000000;">);<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">            System.out.println();<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">19</span>         Constructor con = c.getConstructor(<span style="color: #0000ff;">int</span>.<span style="color: #0000ff;">class</span>,String.<span style="color: #0000ff;">class</span>);  <span style="color: #008000;">//</span><span style="color: #008000;">得到某个具体的构造方法</span><br><span style="color: #008080;">20</span> <span style="color: #000000;">        System.out.println(con.getName());<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">22</span><br><span style="color: #008080;">23</span> }</pre><br></div>

<p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 14px;"><span style="text-align: left; text-transform: none; line-height: 21px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: pre-wrap; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: none; -webkit-text-stroke-width: 0px;"><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　通过反射得到某个类的构造方法可以通过c.getConstructors()来获得，返回的是Constructor数组，也可以用c.getConstructor(Class …)方法来获得某个具体构造方法这个方法的参数是构造方法的参数类class对象。</span></span></span></p>
<p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 14px;"><span style="text-align: left; text-transform: none; line-height: 21px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: pre-wrap; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: none; -webkit-text-stroke-width: 0px;"><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">③、反射接口和父类</span></span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.reflect;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ReflectInterface {<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> main(String[] args) {<br></span><span style="color: #008080;"> 6</span>         Class c = A.<span style="color: #0000ff;">class</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 7</span>         <span style="color: #008000;">//</span><span style="color: #008000;">反射得到所有的接口</span><br><span style="color: #008080;"> 8</span>         Class[] interfaces =<span style="color: #000000;"> c.getInterfaces();<br></span><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; interfaces.length; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">            System.out.println(interfaces[i].getName());<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">12</span>         <span style="color: #008000;">//</span><span style="color: #008000;">反射得到所有的父类</span><br><span style="color: #008080;">13</span>         Class superClass =<span style="color: #000000;"> c.getSuperclass();<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">        System.out.println(superClass.getName());<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">16</span> }</pre><br></div>

<p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 14px;"><span style="text-align: left; text-transform: none; line-height: 21px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: pre-wrap; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: none; -webkit-text-stroke-width: 0px;"><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">④、反射得到方法</span></span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.reflect;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.InvocationTargetException;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.lang.reflect.Method;<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ReflectMethod {<br></span><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">void</span> main(String[] args) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> SecurityException, NoSuchMethodException, IllegalArgumentException, IllegalAccessException, InvocationTargetException {<br></span><span style="color: #008080;"> 8</span>         Class c = A.<span style="color: #0000ff;">class</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 9</span>         A a = <span style="color: #0000ff;">new</span><span style="color: #000000;"> A();<br></span><span style="color: #008080;">10</span>         <span style="color: #008000;">//</span><span style="color: #008000;">Method[] methods = c.getDeclaredMethods();  </span><span style="color: #008000;">//</span><span style="color: #008000;">返回该类定义的所有方法。父类的方法若没有被重写则不会返回</span><br><span style="color: #008080;">11</span>         Method[] methods = c.getMethods();  <span style="color: #008000;">//</span><span style="color: #008000;">得到public方法，包括从父类继承的方法</span><br><span style="color: #008080;">12</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; methods.length; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;">13</span>             <span style="color: #008000;">//</span><span style="color: #008000;">输出方法的返回类型</span><br><span style="color: #008080;">14</span> <span style="color: #000000;">            System.out.print(methods[i].getReturnType());<br></span><span style="color: #008080;">15</span>             <span style="color: #008000;">//</span><span style="color: #008000;">输出方法名</span><br><span style="color: #008080;">16</span>             System.out.print(“ “+methods[i].getName()+”(“<span style="color: #000000;">);<br></span><span style="color: #008080;">17</span>             <span style="color: #008000;">//</span><span style="color: #008000;">获取方法的参数</span><br><span style="color: #008080;">18</span>             Class[] paramTypes =<span style="color: #000000;"> methods[i].getParameterTypes();<br></span><span style="color: #008080;">19</span>             <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> j = 0; j &lt; paramTypes.length; j++<span style="color: #000000;">) {<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">                System.out.print(paramTypes[j].getName());<br></span><span style="color: #008080;">21</span>                 <span style="color: #0000ff;">if</span>(paramTypes.length&gt;j+1<span style="color: #000000;">){<br></span><span style="color: #008080;">22</span>                     System.out.print(“,”<span style="color: #000000;">);<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">24</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">25</span>             System.out.print(“)”<span style="color: #000000;">);<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">            System.out.println();<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">28</span>         <span style="color: #008000;">//</span><span style="color: #008000;">得到指定私有方法名</span><br><span style="color: #008080;">29</span>         Method m = c.getDeclaredMethod(“f2”,<span style="color: #0000ff;">int</span>.<span style="color: #0000ff;">class</span>); <span style="color: #008000;">//</span><span style="color: #008000;">方法名、方法中的参数<br></span><span style="color: #008080;">30</span>         <span style="color: #008000;">//</span><span style="color: #008000;">私有方法需要让其能够被访问</span><br><span style="color: #008080;">31</span>         m.setAccessible(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">32</span>         m.invoke(a, 5<span style="color: #000000;">);<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">34</span><br><span style="color: #008080;">35</span> }</pre><br></div>

<p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 14px;"><span style="text-align: left; text-transform: none; line-height: 21px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: pre-wrap; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: none; -webkit-text-stroke-width: 0px;"><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　c.getDeclaredMethods()：返回该类定义的所有方法。父类的方法若没有被重写则不会返回。</span></span></span></p>
<p><span style="color: #000000; font-family: arial,helvetica,sans-serif; font-size: 14px;"><span style="text-align: left; text-transform: none; line-height: 21px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: pre-wrap; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: none; -webkit-text-stroke-width: 0px;"><span style="text-align: left; text-transform: none; line-height: 19px; text-indent: 0px; letter-spacing: normal; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #fefef2; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　c.getMethods()： 得到所有public方法，包括从父类继承的方法</span></span></span></p>
<p>　　c.getDeclaredMethod(String methodName,Class param) :得到某个具体的方法，要传入方法名和方法的参数。</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2013/05/java-reflex.html" data-id="ciiy5f4u70084q1d0ojtsrew5" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2013/05/java-reflex.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/反射/">反射</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/page/7/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/9/">Next &raquo;</a>
      </nav>
    </section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新博文</h3>
    <div class="widget">
      <ul id="recent-post" class="no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/人生感悟/">人生感悟</a></p>
              <p class="item-title"><a href="/2015/12/say-bye-to-my-2015.html" class="title">Say bye to my 2015</a></p>
              <p class="item-date"><time datetime="2015-12-25T09:25:10.000Z" itemprop="datePublished">2015-12-25</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/12/mvp-pattern-android.html" class="title">MVP模式在Android项目中的使用</a></p>
              <p class="item-date"><time datetime="2015-12-23T14:16:04.000Z" itemprop="datePublished">2015-12-23</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/12/intent-resolving-in-android-m.html" class="title">【译文】Android M中Intent的解析</a></p>
              <p class="item-date"><time datetime="2015-12-04T06:52:06.000Z" itemprop="datePublished">2015-12-04</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/12/performance-listviews.html" class="title">【译文】高性能ListViews</a></p>
              <p class="item-date"><time datetime="2015-12-02T10:22:14.000Z" itemprop="datePublished">2015-12-02</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/11/android-multi-photo-picker.html" class="title">Android带多选功能的PhotoPicker</a></p>
              <p class="item-date"><time datetime="2015-11-21T07:46:03.000Z" itemprop="datePublished">2015-11-21</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">博文分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Framework/">Framework</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hadoop/">Hadoop</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JNI-amp-NDK/">JNI&amp;NDK</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a><span class="category-list-count">35</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NoSQL/">NoSQL</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/人生感悟/">人生感悟</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他技术/">其他技术</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后端/">后端</a><span class="category-list-count">29</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构和算法/">数据结构和算法</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">7</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/AsyncTask/" style="font-size: 11.54px;">AsyncTask</a> <a href="/tags/LruCache/" style="font-size: 10px;">LruCache</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/NoSQL/" style="font-size: 13.08px;">NoSQL</a> <a href="/tags/android/" style="font-size: 18.46px;">android</a> <a href="/tags/android-studio/" style="font-size: 10px;">android studio</a> <a href="/tags/c/" style="font-size: 10px;">c++</a> <a href="/tags/camera/" style="font-size: 10px;">camera</a> <a href="/tags/framework/" style="font-size: 10.77px;">framework</a> <a href="/tags/hadoop/" style="font-size: 14.62px;">hadoop</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/jni/" style="font-size: 13.08px;">jni</a> <a href="/tags/linux/" style="font-size: 16.15px;">linux</a> <a href="/tags/mysql/" style="font-size: 11.54px;">mysql</a> <a href="/tags/redis/" style="font-size: 13.08px;">redis</a> <a href="/tags/spring/" style="font-size: 10.77px;">spring</a> <a href="/tags/sqlite/" style="font-size: 10px;">sqlite</a> <a href="/tags/web后端/" style="font-size: 19.23px;">web后端</a> <a href="/tags/内存缓存/" style="font-size: 10px;">内存缓存</a> <a href="/tags/前端/" style="font-size: 13.85px;">前端</a> <a href="/tags/反射/" style="font-size: 10px;">反射</a> <a href="/tags/图片选择/" style="font-size: 10.77px;">图片选择</a> <a href="/tags/多线程/" style="font-size: 17.69px;">多线程</a> <a href="/tags/布局/" style="font-size: 12.31px;">布局</a> <a href="/tags/布局优化/" style="font-size: 10.77px;">布局优化</a> <a href="/tags/开源/" style="font-size: 10.77px;">开源</a> <a href="/tags/断点续传/" style="font-size: 11.54px;">断点续传</a> <a href="/tags/科学上网/" style="font-size: 10px;">科学上网</a> <a href="/tags/自定义控件/" style="font-size: 10px;">自定义控件</a> <a href="/tags/解决方案/" style="font-size: 16.92px;">解决方案</a> <a href="/tags/设计模式/" style="font-size: 15.38px;">设计模式</a> <a href="/tags/译文/" style="font-size: 10.77px;">译文</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">博文归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">November 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">May 2013</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">August 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a><span class="archive-list-count">8</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap widget-list">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a target="_blank" href="http://blog.daimajia.com">代码家</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.trinea.cn">Trinea</a>
          </li>
        
          <li>
            <a target="_blank" href="https://www.aswifter.com">APP开发者</a>
          </li>
        
          <li>
            <a target="_blank" href="http://blog.seoui.com">笑松小站</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.apkfuns.com">舞影凌风</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.ttfde.org">TTF的家园</a>
          </li>
        
          <li>
            <a target="_blank" href="http://rocko.xyz">Rocko&#39;s blog</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.93sec.cc">教程资源网</a>
          </li>
        
      </ul>
    </div>
  </div>


  
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2000 - 2016 Lauren<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    

<script type="text/javascript">
  var duoshuoQuery = {short_name:"liuling07"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>





 <script src="//ajax.lug.ustc.edu.cn/ajax/libs/jquery/2.1.3/jquery.min.js"></script>




  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>