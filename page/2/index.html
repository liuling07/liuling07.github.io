<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>残剑博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Hexo theme - Icarus">
<meta property="og:type" content="website">
<meta property="og:title" content="残剑博客">
<meta property="og:url" content="http://liuling07.github.io/page/2/index.html">
<meta property="og:site_name" content="残剑博客">
<meta property="og:description" content="Hexo theme - Icarus">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="残剑博客">
<meta name="twitter:description" content="Hexo theme - Icarus">
  
  
    <link rel="icon" href="favicon.png">
  
  
 <link href='//fonts.lug.ustc.edu.cn/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
 <link href="//fonts.lug.ustc.edu.cn/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">


  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css" type="text/css">
  

  

  
</head>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo"><i class="logo" style="background-image: url(/css/images/logo.png)"></i><span class="site-title">残剑博客</span></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/.">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="/css/images/protrait.jpg"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
      
      <div id="search-form-wrap">
        
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="http://liuling07.github.io"></form>
        
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
        
          <td><a class="main-nav-link" href="/.">Home</a></td>
        
          <td><a class="main-nav-link" href="/archives">Archives</a></td>
        
          <td><a class="main-nav-link" href="/categories">Categories</a></td>
        
          <td><a class="main-nav-link" href="/tags">Tags</a></td>
        
          <td><a class="main-nav-link" href="/about">About</a></td>
        
        <td>
          
            <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://liuling07.github.io"></form>
          
        </td>
      </tr>
    </table>
  </div>
</header>

    <div class="outer">
      
        <aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      <img id="avatar" src="/css/images/protrait.jpg">
      <h2 id="name">Lauren</h2>
      <h3 id="title">Android Developer</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Shenzhen, China</span>
      <a id="follow" href="https://github.com/liuling07">FOLLOW</a>
    </div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        135
        <span>posts</span>
      </div>
      <div class="article-info-block">
        32
        <span>tags</span>
      </div>
    </div>
    
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
          
          <td><a href="https://github.com/liuling07" target="_blank" title="github"><i class="fa fa-github"></i></a></td>
          
          <td><a href="http://weibo.com/LaurenLiuling/" target="_blank" title="weibo"><i class="fa fa-weibo"></i></a></td>
          
          <td><a href="https://plus.google.com/u/0/107098505138563589748/" target="_blank" title="google-plus"><i class="fa fa-google-plus"></i></a></td>
          
          <td><a href="http://stackoverflow.com/users/5629327/lauren-liuling" target="_blank" title="stack-overflow"><i class="fa fa-stack-overflow"></i></a></td>
          
          <td><a href="https://twitter.com/lauren_liuLing/" target="_blank" title="twitter"><i class="fa fa-twitter"></i></a></td>
          
          <td><a href="https://www.facebook.com/lauren.liuling/" target="_blank" title="facebook"><i class="fa fa-facebook"></i></a></td>
          
          <td><a href="/atom.xml" target="_blank" title="rss"><i class="fa fa-rss"></i></a></td>
          
        </tr>
      </table>
    </div>
    
    
  </div>
</aside>

      
      <section id="main">
      <article id="post-custom-camera" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/custom-camera.html">Android自定义相机拍照、图片裁剪的实现</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2015/10/custom-camera.html">
      <time datetime="2015-10-28T07:00:00.000Z" itemprop="datePublished">2015-10-28</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　<span style="font-size: 15px;">最近项目里面又要加一个拍照搜题的功能，也就是用户对着不会做的题目拍一张照片，将照片的文字使用ocr识别出来，再调用题库搜索接口搜索出来展示给用户，类似于小猿搜题、学霸君等app。<br></span></p>
<p>　　<span style="font-size: 15px;">其实Android提供Intent让我们打开系统的相机，但是系统相机跟自己app风格不搭，而且用起来体验不好。所以我使用了SDK提供的camera API自定义了一个相机，并且在相机界面上面添加了参考线，有助于用户将题目拍正，提高ocr的识别率。</span></p>
<p><span style="font-size: 15px;">　　1、绘制参考线的代码</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> ReferenceLine <span style="color: #0000ff;">extends</span><span style="color: #000000;"> View {<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Paint mLinePaint;<br></span><span style="color: #008080;"> 4</span><br><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ReferenceLine(Context context) {<br></span><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context);<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">        init();<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ReferenceLine(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">        init();<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">public</span> ReferenceLine(Context context, AttributeSet attrs, <span style="color: #0000ff;">int</span><span style="color: #000000;"> defStyleAttr) {<br></span><span style="color: #008080;">16</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs, defStyleAttr);<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">        init();<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> init() {<br></span><span style="color: #008080;">21</span>         mLinePaint = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Paint();<br></span><span style="color: #008080;">22</span>         mLinePaint.setAntiAlias(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">23</span>         mLinePaint.setColor(Color.parseColor(“#45e0e0e0”<span style="color: #000000;">));<br></span><span style="color: #008080;">24</span>         mLinePaint.setStrokeWidth(1<span style="color: #000000;">);<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span><br><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">30</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDraw(Canvas canvas) {<br></span><span style="color: #008080;">31</span>         <span style="color: #0000ff;">int</span> screenWidth =<span style="color: #000000;"> Utils.getScreenWH(getContext()).widthPixels;<br></span><span style="color: #008080;">32</span>         <span style="color: #0000ff;">int</span> screenHeight =<span style="color: #000000;"> Utils.getScreenWH(getContext()).heightPixels;<br></span><span style="color: #008080;">33</span><br><span style="color: #008080;">34</span>         <span style="color: #0000ff;">int</span> width = screenWidth/3<span style="color: #000000;">;<br></span><span style="color: #008080;">35</span>         <span style="color: #0000ff;">int</span> height = screenHeight/3<span style="color: #000000;">;<br></span><span style="color: #008080;">36</span><br><span style="color: #008080;">37</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = width, j = 0;i &lt; screenWidth &amp;&amp; j<2;i +="width," j++<span="" style="color: #000000;">) {<br><span style="color: #008080;">38</span>             canvas.drawLine(i, 0<span style="color: #000000;">, i, screenHeight, mLinePaint);<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">40</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> j = height,i = 0;j &lt; screenHeight &amp;&amp; i &lt; 2;j += height,i++<span style="color: #000000;">) {<br></span><span style="color: #008080;">41</span>             canvas.drawLine(0<span style="color: #000000;">, j, screenWidth, j, mLinePaint);<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">44</span><br><span style="color: #008080;">45</span><br><span style="color: #008080;">46</span> }</2;i></pre><br></div>

<p>&nbsp;</p>
<p>　　<span style="font-size: 15px;">2、自定义相机代码</span></p>
<p><span style="font-size: 15px;">　　这里主要是要创建一个SurfaceView，将摄像头的预览界面放到SurfaceView中显示。</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.camerademo.camare;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.res.Configuration;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.graphics.PixelFormat;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.graphics.Rect;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.hardware.Camera;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.hardware.Camera.AutoFocusCallback;<br></span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.hardware.Camera.PictureCallback;<br></span><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.AttributeSet;<br></span><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.Log;<br></span><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.MotionEvent;<br></span><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.SurfaceHolder;<br></span><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.SurfaceView;<br></span><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.RelativeLayout;<br></span><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.Toast;<br></span><span style="color: #008080;"> 18</span><br><span style="color: #008080;"> 19</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.camerademo.utils.Utils;<br></span><span style="color: #008080;"> 20</span><br><span style="color: #008080;"> 21</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.IOException;<br></span><span style="color: #008080;"> 22</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;"> 23</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.Date;<br></span><span style="color: #008080;"> 24</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;"> 25</span><br><span style="color: #008080;"> 26</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 27</span> <span style="color: #008000;"> <em> @Class: CameraPreview<br></em></span><span style="color: #008080;"> 28</span> <span style="color: #008000;">  @Description: 自定义相机<br></span><span style="color: #008080;"> 29</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;">: lling(www.cnblogs.com/liuling)<br></span><span style="color: #008080;"> 30</span> <span style="color: #008000;">  @Date: 2015/10/25<br></span><span style="color: #008080;"> 31</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 32</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> CameraPreview <span style="color: #0000ff;">extends</span> SurfaceView <span style="color: #0000ff;">implements</span><br><span style="color: #008080;"> 33</span> <span style="color: #000000;">        SurfaceHolder.Callback, AutoFocusCallback {<br></span><span style="color: #008080;"> 34</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “CameraPreview”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 35</span><br><span style="color: #008080;"> 36</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> viewWidth = 0<span style="color: #000000;">;<br></span><span style="color: #008080;"> 37</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> viewHeight = 0<span style="color: #000000;">;<br></span><span style="color: #008080;"> 38</span><br><span style="color: #008080;"> 39</span>     <span style="color: #008000;">/</span><span style="color: #008000;"> 监听接口 </span><span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 40</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> OnCameraStatusListener listener;<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> SurfaceHolder holder;<br></span><span style="color: #008080;"> 43</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Camera camera;<br></span><span style="color: #008080;"> 44</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> FocusView mFocusView;<br></span><span style="color: #008080;"> 45</span><br><span style="color: #008080;"> 46</span>     <span style="color: #008000;">//</span><span style="color: #008000;">创建一个PictureCallback对象，并实现其中的onPictureTaken方法</span><br><span style="color: #008080;"> 47</span>     <span style="color: #0000ff;">private</span> PictureCallback pictureCallback = <span style="color: #0000ff;">new</span><span style="color: #000000;"> PictureCallback() {<br></span><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 该方法用于处理拍摄后的照片数据</span><br><span style="color: #008080;"> 50</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;"> 51</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onPictureTaken(<span style="color: #0000ff;">byte</span><span style="color: #000000;">[] data, Camera camera) {<br></span><span style="color: #008080;"> 52</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 停止照片拍摄</span><br><span style="color: #008080;"> 53</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 54</span> <span style="color: #000000;">                camera.stopPreview();<br></span><span style="color: #008080;"> 55</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 56</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 57</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 调用结束事件</span><br><span style="color: #008080;"> 58</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> listener) {<br></span><span style="color: #008080;"> 59</span> <span style="color: #000000;">                listener.onCameraStopped(data);<br></span><span style="color: #008080;"> 60</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 62</span> <span style="color: #000000;">    };<br></span><span style="color: #008080;"> 63</span><br><span style="color: #008080;"> 64</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> Preview类的构造方法</span><br><span style="color: #008080;"> 65</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> CameraPreview(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;"> 66</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);<br></span><span style="color: #008080;"> 67</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获得SurfaceHolder对象</span><br><span style="color: #008080;"> 68</span>         holder =<span style="color: #000000;"> getHolder();<br></span><span style="color: #008080;"> 69</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 指定用于捕捉拍照事件的SurfaceHolder.Callback对象</span><br><span style="color: #008080;"> 70</span>         holder.addCallback(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 71</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置SurfaceHolder对象的类型</span><br><span style="color: #008080;"> 72</span> <span style="color: #000000;">        holder.setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS);<br></span><span style="color: #008080;"> 73</span> <span style="color: #000000;">        setOnTouchListener(onTouchListener);<br></span><span style="color: #008080;"> 74</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 75</span><br><span style="color: #008080;"> 76</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 在surface创建时激发</span><br><span style="color: #008080;"> 77</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> surfaceCreated(SurfaceHolder holder) {<br></span><span style="color: #008080;"> 78</span>         Log.e(TAG, “==surfaceCreated==”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 79</span>         <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">Utils.checkCameraHardware(getContext())) {<br></span><span style="color: #008080;"> 80</span>             Toast.makeText(getContext(), “摄像头打开失败！”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;"> 81</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 82</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 83</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获得Camera对象</span><br><span style="color: #008080;"> 84</span>         camera =<span style="color: #000000;"> getCameraInstance();<br></span><span style="color: #008080;"> 85</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 86</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 设置用于显示拍照摄像的SurfaceHolder对象</span><br><span style="color: #008080;"> 87</span> <span style="color: #000000;">            camera.setPreviewDisplay(holder);<br></span><span style="color: #008080;"> 88</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;"> 89</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;"> 90</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> 释放手机摄像头</span><br><span style="color: #008080;"> 91</span> <span style="color: #000000;">            camera.release();<br></span><span style="color: #008080;"> 92</span>             camera = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 93</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 94</span> <span style="color: #000000;">        updateCameraParameters();<br></span><span style="color: #008080;"> 95</span>         <span style="color: #0000ff;">if</span> (camera != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 96</span> <span style="color: #000000;">            camera.startPreview();<br></span><span style="color: #008080;"> 97</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 98</span> <span style="color: #000000;">        setFocus();<br></span><span style="color: #008080;"> 99</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">100</span><br><span style="color: #008080;">101</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 在surface销毁时激发</span><br><span style="color: #008080;">102</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> surfaceDestroyed(SurfaceHolder holder) {<br></span><span style="color: #008080;">103</span>         Log.e(TAG, “==surfaceDestroyed==”<span style="color: #000000;">);<br></span><span style="color: #008080;">104</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 释放手机摄像头</span><br><span style="color: #008080;">105</span> <span style="color: #000000;">        camera.release();<br></span><span style="color: #008080;">106</span>         camera = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">107</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">108</span><br><span style="color: #008080;">109</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 在surface的大小发生改变时激发</span><br><span style="color: #008080;">110</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> surfaceChanged(<span style="color: #0000ff;">final</span> SurfaceHolder holder, <span style="color: #0000ff;">int</span> format, <span style="color: #0000ff;">int</span><span style="color: #000000;"> w,<br></span><span style="color: #008080;">111</span>             <span style="color: #0000ff;">int</span><span style="color: #000000;"> h) {<br></span><span style="color: #008080;">112</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> stop preview before making changes</span><br><span style="color: #008080;">113</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">114</span> <span style="color: #000000;">            camera.stopPreview();<br></span><span style="color: #008080;">115</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e){<br></span><span style="color: #008080;">116</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> ignore: tried to stop a non-existent preview</span><br><span style="color: #008080;">117</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">118</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> set preview size and make any resize, rotate or<br></span><span style="color: #008080;">119</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> reformatting changes here</span><br><span style="color: #008080;">120</span> <span style="color: #000000;">        updateCameraParameters();<br></span><span style="color: #008080;">121</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> start preview with new settings</span><br><span style="color: #008080;">122</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">123</span> <span style="color: #000000;">            camera.setPreviewDisplay(holder);<br></span><span style="color: #008080;">124</span> <span style="color: #000000;">            camera.startPreview();<br></span><span style="color: #008080;">125</span><br><span style="color: #008080;">126</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e){<br></span><span style="color: #008080;">127</span>             Log.d(TAG, “Error starting camera preview: “ +<span style="color: #000000;"> e.getMessage());<br></span><span style="color: #008080;">128</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">129</span> <span style="color: #000000;">        setFocus();<br></span><span style="color: #008080;">130</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">131</span><br><span style="color: #008080;">132</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">133</span> <span style="color: #008000;">      点击显示焦点区域<br></span><span style="color: #008080;">134</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">135</span>     OnTouchListener onTouchListener = <span style="color: #0000ff;">new</span><span style="color: #000000;"> OnTouchListener() {<br></span><span style="color: #008080;">136</span>         @SuppressWarnings(“deprecation”<span style="color: #000000;">)<br></span><span style="color: #008080;">137</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">138</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> onTouch(View v, MotionEvent event) {<br></span><span style="color: #008080;">139</span>             <span style="color: #0000ff;">if</span> (event.getAction() ==<span style="color: #000000;"> MotionEvent.ACTION_DOWN) {<br></span><span style="color: #008080;">140</span>                 <span style="color: #0000ff;">int</span> width =<span style="color: #000000;"> mFocusView.getWidth();<br></span><span style="color: #008080;">141</span>                 <span style="color: #0000ff;">int</span> height =<span style="color: #000000;"> mFocusView.getHeight();<br></span><span style="color: #008080;">142</span>                 mFocusView.setX(event.getX() - (width / 2<span style="color: #000000;">));<br></span><span style="color: #008080;">143</span>                 mFocusView.setY(event.getY() - (height / 2<span style="color: #000000;">));<br></span><span style="color: #008080;">144</span> <span style="color: #000000;">                mFocusView.beginFocus();<br></span><span style="color: #008080;">145</span>             } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (event.getAction() ==<span style="color: #000000;"> MotionEvent.ACTION_UP) {<br></span><span style="color: #008080;">146</span> <span style="color: #000000;">                focusOnTouch(event);<br></span><span style="color: #008080;">147</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">148</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">149</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">150</span> <span style="color: #000000;">    };<br></span><span style="color: #008080;">151</span><br><span style="color: #008080;">152</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">153</span> <span style="color: #008000;">      获取摄像头实例<br></span><span style="color: #008080;">154</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">155</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">156</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Camera getCameraInstance() {<br></span><span style="color: #008080;">157</span>         Camera c = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">158</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">159</span>             <span style="color: #0000ff;">int</span> cameraCount = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">160</span>             Camera.CameraInfo cameraInfo = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Camera.CameraInfo();<br></span><span style="color: #008080;">161</span>             cameraCount = Camera.getNumberOfCameras(); <span style="color: #008000;">//</span><span style="color: #008000;"> get cameras number</span><br><span style="color: #008080;">162</span><br><span style="color: #008080;">163</span>             <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> camIdx = 0; camIdx &lt; cameraCount; camIdx++<span style="color: #000000;">) {<br></span><span style="color: #008080;">164</span>                 Camera.getCameraInfo(camIdx, cameraInfo); <span style="color: #008000;">//</span><span style="color: #008000;"> get camerainfo<br></span><span style="color: #008080;">165</span>                 <span style="color: #008000;">//</span><span style="color: #008000;"> 代表摄像头的方位，目前有定义值两个分别为CAMERA_FACING_FRONT前置和CAMERA_FACING_BACK后置</span><br><span style="color: #008080;">166</span>                 <span style="color: #0000ff;">if</span> (cameraInfo.facing ==<span style="color: #000000;"> Camera.CameraInfo.CAMERA_FACING_BACK) {<br></span><span style="color: #008080;">167</span>                     <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">168</span>                         c = Camera.open(camIdx);   <span style="color: #008000;">//</span><span style="color: #008000;">打开后置摄像头</span><br><span style="color: #008080;">169</span>                     } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (RuntimeException e) {<br></span><span style="color: #008080;">170</span>                         Toast.makeText(getContext(), “摄像头打开失败！”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">171</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">172</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">173</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">174</span>             <span style="color: #0000ff;">if</span> (c == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">175</span>                 c = Camera.open(0); <span style="color: #008000;">//</span><span style="color: #008000;"> attempt to get a Camera instance</span><br><span style="color: #008080;">176</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">177</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">178</span>             Toast.makeText(getContext(), “摄像头打开失败！”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">179</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">180</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> c;<br></span><span style="color: #008080;">181</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">182</span><br><span style="color: #008080;">183</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> updateCameraParameters() {<br></span><span style="color: #008080;">184</span>         <span style="color: #0000ff;">if</span> (camera != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">185</span>             Camera.Parameters p =<span style="color: #000000;"> camera.getParameters();<br></span><span style="color: #008080;">186</span><br><span style="color: #008080;">187</span> <span style="color: #000000;">            setParameters(p);<br></span><span style="color: #008080;">188</span><br><span style="color: #008080;">189</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">190</span> <span style="color: #000000;">                camera.setParameters(p);<br></span><span style="color: #008080;">191</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">192</span>                 Camera.Size previewSize =<span style="color: #000000;"> findBestPreviewSize(p);<br></span><span style="color: #008080;">193</span> <span style="color: #000000;">                p.setPreviewSize(previewSize.width, previewSize.height);<br></span><span style="color: #008080;">194</span> <span style="color: #000000;">                p.setPictureSize(previewSize.width, previewSize.height);<br></span><span style="color: #008080;">195</span> <span style="color: #000000;">                camera.setParameters(p);<br></span><span style="color: #008080;">196</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">197</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">198</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">199</span><br><span style="color: #008080;">200</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">201</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> p<br></span><span style="color: #008080;">202</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">203</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setParameters(Camera.Parameters p) {<br></span><span style="color: #008080;">204</span>         List<string> focusModes =<span style="color: #000000;"> p.getSupportedFocusModes();<br></span><span style="color: #008080;">205</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (focusModes<br></span><span style="color: #008080;">206</span> <span style="color: #000000;">                .contains(Camera.Parameters.FOCUS_MODE_CONTINUOUS_PICTURE)) {<br></span><span style="color: #008080;">207</span> <span style="color: #000000;">            p.setFocusMode(Camera.Parameters.FOCUS_MODE_CONTINUOUS_PICTURE);<br></span><span style="color: #008080;">208</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">209</span><br><span style="color: #008080;">210</span>         <span style="color: #0000ff;">long</span> time = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Date().getTime();<br></span><span style="color: #008080;">211</span> <span style="color: #000000;">        p.setGpsTimestamp(time);<br></span><span style="color: #008080;">212</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置照片格式</span><br><span style="color: #008080;">213</span> <span style="color: #000000;">        p.setPictureFormat(PixelFormat.JPEG);<br></span><span style="color: #008080;">214</span>         Camera.Size previewSize =<span style="color: #000000;"> findPreviewSizeByScreen(p);<br></span><span style="color: #008080;">215</span> <span style="color: #000000;">        p.setPreviewSize(previewSize.width, previewSize.height);<br></span><span style="color: #008080;">216</span> <span style="color: #000000;">        p.setPictureSize(previewSize.width, previewSize.height);<br></span><span style="color: #008080;">217</span> <span style="color: #000000;">        p.setFocusMode(Camera.Parameters.FOCUS_MODE_AUTO);<br></span><span style="color: #008080;">218</span>         <span style="color: #0000ff;">if</span> (getContext().getResources().getConfiguration().orientation !=<span style="color: #000000;"> Configuration.ORIENTATION_LANDSCAPE) {<br></span><span style="color: #008080;">219</span>             camera.setDisplayOrientation(90<span style="color: #000000;">);<br></span><span style="color: #008080;">220</span>             p.setRotation(90<span style="color: #000000;">);<br></span><span style="color: #008080;">221</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">222</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">223</span><br><span style="color: #008080;">224</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 进行拍照，并将拍摄的照片传入PictureCallback接口的onPictureTaken方法</span><br><span style="color: #008080;">225</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> takePicture() {<br></span><span style="color: #008080;">226</span>         <span style="color: #0000ff;">if</span> (camera != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">227</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">228</span>                 camera.takePicture(<span style="color: #0000ff;">null</span>, <span style="color: #0000ff;">null</span><span style="color: #000000;">, pictureCallback);<br></span><span style="color: #008080;">229</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">230</span> <span style="color: #000000;">                e.printStackTrace();<br></span><span style="color: #008080;">231</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">232</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">233</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">234</span><br><span style="color: #008080;">235</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 设置监听事件</span><br><span style="color: #008080;">236</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setOnCameraStatusListener(OnCameraStatusListener listener) {<br></span><span style="color: #008080;">237</span>         <span style="color: #0000ff;">this</span>.listener =<span style="color: #000000;"> listener;<br></span><span style="color: #008080;">238</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">239</span><br><span style="color: #008080;">240</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">241</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onAutoFocus(<span style="color: #0000ff;">boolean</span><span style="color: #000000;"> success, Camera camera) {<br></span><span style="color: #008080;">242</span><br><span style="color: #008080;">243</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">244</span><br><span style="color: #008080;">245</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> start() {<br></span><span style="color: #008080;">246</span>         <span style="color: #0000ff;">if</span> (camera != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">247</span> <span style="color: #000000;">            camera.startPreview();<br></span><span style="color: #008080;">248</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">249</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">250</span><br><span style="color: #008080;">251</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> stop() {<br></span><span style="color: #008080;">252</span>         <span style="color: #0000ff;">if</span> (camera != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">253</span> <span style="color: #000000;">            camera.stopPreview();<br></span><span style="color: #008080;">254</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">255</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">256</span><br><span style="color: #008080;">257</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">258</span> <span style="color: #008000;">     <em> 相机拍照监听接口<br></em></span><span style="color: #008080;">259</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">260</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> OnCameraStatusListener {<br></span><span style="color: #008080;">261</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 相机拍照结束事件</span><br><span style="color: #008080;">262</span>         <span style="color: #0000ff;">void</span> onCameraStopped(<span style="color: #0000ff;">byte</span><span style="color: #000000;">[] data);<br></span><span style="color: #008080;">263</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">264</span><br><span style="color: #008080;">265</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">266</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> onMeasure(<span style="color: #0000ff;">int</span> widthSpec, <span style="color: #0000ff;">int</span><span style="color: #000000;"> heightSpec) {<br></span><span style="color: #008080;">267</span>         viewWidth =<span style="color: #000000;"> MeasureSpec.getSize(widthSpec);<br></span><span style="color: #008080;">268</span>         viewHeight =<span style="color: #000000;"> MeasureSpec.getSize(heightSpec);<br></span><span style="color: #008080;">269</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onMeasure(<br></span><span style="color: #008080;">270</span> <span style="color: #000000;">                MeasureSpec.makeMeasureSpec(viewWidth, MeasureSpec.EXACTLY),<br></span><span style="color: #008080;">271</span> <span style="color: #000000;">                MeasureSpec.makeMeasureSpec(viewHeight, MeasureSpec.EXACTLY));<br></span><span style="color: #008080;">272</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">273</span><br><span style="color: #008080;">274</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">275</span> <span style="color: #008000;">     <em> 将预览大小设置为屏幕大小<br></em></span><span style="color: #008080;">276</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> parameters<br></span><span style="color: #008080;">277</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">278</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">279</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Camera.Size findPreviewSizeByScreen(Camera.Parameters parameters) {<br></span><span style="color: #008080;">280</span>         <span style="color: #0000ff;">if</span> (viewWidth != 0 &amp;&amp; viewHeight != 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">281</span>             <span style="color: #0000ff;">return</span> camera.<span style="color: #0000ff;">new</span><span style="color: #000000;"> Size(Math.max(viewWidth, viewHeight),<br></span><span style="color: #008080;">282</span> <span style="color: #000000;">                    Math.min(viewWidth, viewHeight));<br></span><span style="color: #008080;">283</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">284</span>             <span style="color: #0000ff;">return</span> camera.<span style="color: #0000ff;">new</span><span style="color: #000000;"> Size(Utils.getScreenWH(getContext()).heightPixels,<br></span><span style="color: #008080;">285</span> <span style="color: #000000;">                    Utils.getScreenWH(getContext()).widthPixels);<br></span><span style="color: #008080;">286</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">287</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">288</span><br><span style="color: #008080;">289</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">290</span> <span style="color: #008000;">     <em> 找到最合适的显示分辨率 （防止预览图像变形）<br></em></span><span style="color: #008080;">291</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> parameters<br></span><span style="color: #008080;">292</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">293</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">294</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Camera.Size findBestPreviewSize(Camera.Parameters parameters) {<br></span><span style="color: #008080;">295</span><br><span style="color: #008080;">296</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 系统支持的所有预览分辨率</span><br><span style="color: #008080;">297</span>         String previewSizeValueString = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">298</span>         previewSizeValueString = parameters.get(“preview-size-values”<span style="color: #000000;">);<br></span><span style="color: #008080;">299</span><br><span style="color: #008080;">300</span>         <span style="color: #0000ff;">if</span> (previewSizeValueString == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">301</span>             previewSizeValueString = parameters.get(“preview-size-value”<span style="color: #000000;">);<br></span><span style="color: #008080;">302</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">303</span><br><span style="color: #008080;">304</span>         <span style="color: #0000ff;">if</span> (previewSizeValueString == <span style="color: #0000ff;">null</span>) { <span style="color: #008000;">//</span><span style="color: #008000;"> 有些手机例如m9获取不到支持的预览大小 就直接返回屏幕大小</span><br><span style="color: #008080;">305</span>             <span style="color: #0000ff;">return</span> camera.<span style="color: #0000ff;">new</span><span style="color: #000000;"> Size(Utils.getScreenWH(getContext()).widthPixels,<br></span><span style="color: #008080;">306</span> <span style="color: #000000;">                    Utils.getScreenWH(getContext()).heightPixels);<br></span><span style="color: #008080;">307</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">308</span>         <span style="color: #0000ff;">float</span> bestX = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">309</span>         <span style="color: #0000ff;">float</span> bestY = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">310</span><br><span style="color: #008080;">311</span>         <span style="color: #0000ff;">float</span> tmpRadio = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">312</span>         <span style="color: #0000ff;">float</span> viewRadio = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">313</span><br><span style="color: #008080;">314</span>         <span style="color: #0000ff;">if</span> (viewWidth != 0 &amp;&amp; viewHeight != 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">315</span>             viewRadio = Math.min((<span style="color: #0000ff;">float</span>) viewWidth, (<span style="color: #0000ff;">float</span><span style="color: #000000;">) viewHeight)<br></span><span style="color: #008080;">316</span>                     / Math.max((<span style="color: #0000ff;">float</span>) viewWidth, (<span style="color: #0000ff;">float</span><span style="color: #000000;">) viewHeight);<br></span><span style="color: #008080;">317</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">318</span><br><span style="color: #008080;">319</span>         String[] COMMA_PATTERN = previewSizeValueString.split(“,”<span style="color: #000000;">);<br></span><span style="color: #008080;">320</span>         <span style="color: #0000ff;">for</span><span style="color: #000000;"> (String prewsizeString : COMMA_PATTERN) {<br></span><span style="color: #008080;">321</span>             prewsizeString =<span style="color: #000000;"> prewsizeString.trim();<br></span><span style="color: #008080;">322</span><br><span style="color: #008080;">323</span>             <span style="color: #0000ff;">int</span> dimPosition = prewsizeString.indexOf(‘x’<span style="color: #000000;">);<br></span><span style="color: #008080;">324</span>             <span style="color: #0000ff;">if</span> (dimPosition == -1<span style="color: #000000;">) {<br></span><span style="color: #008080;">325</span>                 <span style="color: #0000ff;">continue</span><span style="color: #000000;">;<br></span><span style="color: #008080;">326</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">327</span><br><span style="color: #008080;">328</span>             <span style="color: #0000ff;">float</span> newX = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">329</span>             <span style="color: #0000ff;">float</span> newY = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">330</span><br><span style="color: #008080;">331</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">332</span>                 newX = Float.parseFloat(prewsizeString.substring(0<span style="color: #000000;">, dimPosition));<br></span><span style="color: #008080;">333</span>                 newY = Float.parseFloat(prewsizeString.substring(dimPosition + 1<span style="color: #000000;">));<br></span><span style="color: #008080;">334</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (NumberFormatException e) {<br></span><span style="color: #008080;">335</span>                 <span style="color: #0000ff;">continue</span><span style="color: #000000;">;<br></span><span style="color: #008080;">336</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">337</span><br><span style="color: #008080;">338</span>             <span style="color: #0000ff;">float</span> radio = Math.min(newX, newY) /<span style="color: #000000;"> Math.max(newX, newY);<br></span><span style="color: #008080;">339</span>             <span style="color: #0000ff;">if</span> (tmpRadio == 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">340</span>                 tmpRadio =<span style="color: #000000;"> radio;<br></span><span style="color: #008080;">341</span>                 bestX =<span style="color: #000000;"> newX;<br></span><span style="color: #008080;">342</span>                 bestY =<span style="color: #000000;"> newY;<br></span><span style="color: #008080;">343</span>             } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (tmpRadio != 0 &amp;&amp; (Math.abs(radio - viewRadio)) &lt; (Math.abs(tmpRadio -<span style="color: #000000;"> viewRadio))) {<br></span><span style="color: #008080;">344</span>                 tmpRadio =<span style="color: #000000;"> radio;<br></span><span style="color: #008080;">345</span>                 bestX =<span style="color: #000000;"> newX;<br></span><span style="color: #008080;">346</span>                 bestY =<span style="color: #000000;"> newY;<br></span><span style="color: #008080;">347</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">348</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">349</span><br><span style="color: #008080;">350</span>         <span style="color: #0000ff;">if</span> (bestX &gt; 0 &amp;&amp; bestY &gt; 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">351</span>             <span style="color: #0000ff;">return</span> camera.<span style="color: #0000ff;">new</span> Size((<span style="color: #0000ff;">int</span>) bestX, (<span style="color: #0000ff;">int</span><span style="color: #000000;">) bestY);<br></span><span style="color: #008080;">352</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">353</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">354</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">355</span><br><span style="color: #008080;">356</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">357</span> <span style="color: #008000;">     <em> 设置焦点和测光区域<br></em></span><span style="color: #008080;">358</span> <span style="color: #008000;">     <br></span><span style="color: #008080;">359</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> event<br></span><span style="color: #008080;">360</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">361</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> focusOnTouch(MotionEvent event) {<br></span><span style="color: #008080;">362</span><br><span style="color: #008080;">363</span>         <span style="color: #0000ff;">int</span>[] location = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">int</span>[2<span style="color: #000000;">];<br></span><span style="color: #008080;">364</span>         RelativeLayout relativeLayout =<span style="color: #000000;"> (RelativeLayout)getParent();<br></span><span style="color: #008080;">365</span> <span style="color: #000000;">        relativeLayout.getLocationOnScreen(location);<br></span><span style="color: #008080;">366</span><br><span style="color: #008080;">367</span>         Rect focusRect =<span style="color: #000000;"> Utils.calculateTapArea(mFocusView.getWidth(),<br></span><span style="color: #008080;">368</span> <span style="color: #000000;">                mFocusView.getHeight(), 1f, event.getRawX(), event.getRawY(),<br></span><span style="color: #008080;">369</span>                 location[0], location[0] + relativeLayout.getWidth(), location[1<span style="color: #000000;">],<br></span><span style="color: #008080;">370</span>                 location[1] +<span style="color: #000000;"> relativeLayout.getHeight());<br></span><span style="color: #008080;">371</span>         Rect meteringRect =<span style="color: #000000;"> Utils.calculateTapArea(mFocusView.getWidth(),<br></span><span style="color: #008080;">372</span>                 mFocusView.getHeight(), 1.5f<span style="color: #000000;">, event.getRawX(), event.getRawY(),<br></span><span style="color: #008080;">373</span>                 location[0], location[0] + relativeLayout.getWidth(), location[1<span style="color: #000000;">],<br></span><span style="color: #008080;">374</span>                 location[1] +<span style="color: #000000;"> relativeLayout.getHeight());<br></span><span style="color: #008080;">375</span><br><span style="color: #008080;">376</span>         Camera.Parameters parameters =<span style="color: #000000;"> camera.getParameters();<br></span><span style="color: #008080;">377</span> <span style="color: #000000;">        parameters.setFocusMode(Camera.Parameters.FOCUS_MODE_AUTO);<br></span><span style="color: #008080;">378</span><br><span style="color: #008080;">379</span>         <span style="color: #0000ff;">if</span> (parameters.getMaxNumFocusAreas() &gt; 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">380</span>             List<camera.area> focusAreas = <span style="color: #0000ff;">new</span> ArrayList<camera.area><span style="color: #000000;">();<br></span><span style="color: #008080;">381</span>             focusAreas.add(<span style="color: #0000ff;">new</span> Camera.Area(focusRect, 1000<span style="color: #000000;">));<br></span><span style="color: #008080;">382</span><br><span style="color: #008080;">383</span> <span style="color: #000000;">            parameters.setFocusAreas(focusAreas);<br></span><span style="color: #008080;">384</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">385</span><br><span style="color: #008080;">386</span>         <span style="color: #0000ff;">if</span> (parameters.getMaxNumMeteringAreas() &gt; 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">387</span>             List<camera.area> meteringAreas = <span style="color: #0000ff;">new</span> ArrayList<camera.area><span style="color: #000000;">();<br></span><span style="color: #008080;">388</span>             meteringAreas.add(<span style="color: #0000ff;">new</span> Camera.Area(meteringRect, 1000<span style="color: #000000;">));<br></span><span style="color: #008080;">389</span><br><span style="color: #008080;">390</span> <span style="color: #000000;">            parameters.setMeteringAreas(meteringAreas);<br></span><span style="color: #008080;">391</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">392</span><br><span style="color: #008080;">393</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">394</span> <span style="color: #000000;">            camera.setParameters(parameters);<br></span><span style="color: #008080;">395</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">396</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">397</span>         camera.autoFocus(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">398</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">399</span><br><span style="color: #008080;">400</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">401</span> <span style="color: #008000;">     <em> 设置聚焦的图片<br></em></span><span style="color: #008080;">402</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> focusView<br></span><span style="color: #008080;">403</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">404</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setFocusView(FocusView focusView) {<br></span><span style="color: #008080;">405</span>         <span style="color: #0000ff;">this</span>.mFocusView =<span style="color: #000000;"> focusView;<br></span><span style="color: #008080;">406</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">407</span><br><span style="color: #008080;">408</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">409</span> <span style="color: #008000;">      设置自动聚焦，并且聚焦的圈圈显示在屏幕中间位置<br></span><span style="color: #008080;">410</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">411</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setFocus() {<br></span><span style="color: #008080;">412</span>         <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">mFocusView.isFocusing()) {<br></span><span style="color: #008080;">413</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">414</span>                 camera.autoFocus(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">415</span>                 mFocusView.setX((Utils.getWidthInPx(getContext())-mFocusView.getWidth()) / 2<span style="color: #000000;">);<br></span><span style="color: #008080;">416</span>                 mFocusView.setY((Utils.getHeightInPx(getContext())-mFocusView.getHeight()) / 2<span style="color: #000000;">);<br></span><span style="color: #008080;">417</span> <span style="color: #000000;">                mFocusView.beginFocus();<br></span><span style="color: #008080;">418</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">419</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">420</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">421</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">422</span><br><span style="color: #008080;">423</span> }</camera.area></camera.area></camera.area></camera.area></string></pre><br></div>

<p>　　<span style="font-size: 15px;">3、Activity中使用自定义相机</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> TakePhoteActivity <span style="color: #0000ff;">extends</span> Activity <span style="color: #0000ff;">implements</span><span style="color: #000000;"> CameraPreview.OnCameraStatusListener,<br></span><span style="color: #008080;">  2</span> <span style="color: #000000;">        SensorEventListener {<br></span><span style="color: #008080;">  3</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “TakePhoteActivity”<span style="color: #000000;">;<br></span><span style="color: #008080;">  4</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> Uri IMAGE_URI =<span style="color: #000000;"> MediaStore.Images.Media.EXTERNAL_CONTENT_URI;<br></span><span style="color: #008080;">  5</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String PATH =<span style="color: #000000;"> Environment.getExternalStorageDirectory()<br></span><span style="color: #008080;">  6</span>             .toString() + “/AndroidMedia/“<span style="color: #000000;">;<br></span><span style="color: #008080;">  7</span> <span style="color: #000000;">    CameraPreview mCameraPreview;<br></span><span style="color: #008080;">  8</span> <span style="color: #000000;">    CropImageView mCropImageView;<br></span><span style="color: #008080;">  9</span> <span style="color: #000000;">    RelativeLayout mTakePhotoLayout;<br></span><span style="color: #008080;"> 10</span> <span style="color: #000000;">    LinearLayout mCropperLayout;<br></span><span style="color: #008080;"> 11</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 12</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;"> 13</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;"> 14</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置横屏<br></span><span style="color: #008080;"> 15</span> <span style="color: #008000;">//</span><span style="color: #008000;">        setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE);<br></span><span style="color: #008080;"> 16</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 设置全屏</span><br><span style="color: #008080;"> 17</span> <span style="color: #000000;">        requestWindowFeature(Window.FEATURE_NO_TITLE);<br></span><span style="color: #008080;"> 18</span> <span style="color: #000000;">        getWindow().setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN,<br></span><span style="color: #008080;"> 19</span> <span style="color: #000000;">                WindowManager.LayoutParams.FLAG_FULLSCREEN);<br></span><span style="color: #008080;"> 20</span> <span style="color: #000000;">        setContentView(R.layout.activity_take_phote);<br></span><span style="color: #008080;"> 21</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> Initialize components of the app</span><br><span style="color: #008080;"> 22</span>         mCropImageView =<span style="color: #000000;"> (CropImageView) findViewById(R.id.CropImageView);<br></span><span style="color: #008080;"> 23</span>         mCameraPreview =<span style="color: #000000;"> (CameraPreview) findViewById(R.id.cameraPreview);<br></span><span style="color: #008080;"> 24</span>         FocusView focusView =<span style="color: #000000;"> (FocusView) findViewById(R.id.view_focus);<br></span><span style="color: #008080;"> 25</span>         mTakePhotoLayout =<span style="color: #000000;"> (RelativeLayout) findViewById(R.id.take_photo_layout);<br></span><span style="color: #008080;"> 26</span>         mCropperLayout =<span style="color: #000000;"> (LinearLayout) findViewById(R.id.cropper_layout);<br></span><span style="color: #008080;"> 27</span><br><span style="color: #008080;"> 28</span> <span style="color: #000000;">        mCameraPreview.setFocusView(focusView);<br></span><span style="color: #008080;"> 29</span>         mCameraPreview.setOnCameraStatusListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 30</span>         mCropImageView.setGuidelines(2<span style="color: #000000;">);<br></span><span style="color: #008080;"> 31</span><br><span style="color: #008080;"> 32</span>         mSensorManager =<span style="color: #000000;"> (SensorManager) getSystemService(Context.<br></span><span style="color: #008080;"> 33</span> <span style="color: #000000;">                SENSOR_SERVICE);<br></span><span style="color: #008080;"> 34</span>         mAccel =<span style="color: #000000;"> mSensorManager.getDefaultSensor(Sensor.<br></span><span style="color: #008080;"> 35</span> <span style="color: #000000;">                TYPE_ACCELEROMETER);<br></span><span style="color: #008080;"> 36</span><br><span style="color: #008080;"> 37</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 38</span><br><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">boolean</span> isRotated = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 40</span><br><span style="color: #008080;"> 41</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 42</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onResume() {<br></span><span style="color: #008080;"> 43</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onResume();<br></span><span style="color: #008080;"> 44</span>         <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">isRotated) {<br></span><span style="color: #008080;"> 45</span>             TextView hint_tv =<span style="color: #000000;"> (TextView) findViewById(R.id.hint);<br></span><span style="color: #008080;"> 46</span>             ObjectAnimator animator = ObjectAnimator.ofFloat(hint_tv, “rotation”<span style="color: #000000;">, 0f, 90f);<br></span><span style="color: #008080;"> 47</span>             animator.setStartDelay(800<span style="color: #000000;">);<br></span><span style="color: #008080;"> 48</span>             animator.setDuration(1000<span style="color: #000000;">);<br></span><span style="color: #008080;"> 49</span>             animator.setInterpolator(<span style="color: #0000ff;">new</span><span style="color: #000000;"> LinearInterpolator());<br></span><span style="color: #008080;"> 50</span> <span style="color: #000000;">            animator.start();<br></span><span style="color: #008080;"> 51</span>             View view =<span style="color: #000000;">  findViewById(R.id.crop_hint);<br></span><span style="color: #008080;"> 52</span>             AnimatorSet animSet = <span style="color: #0000ff;">new</span><span style="color: #000000;"> AnimatorSet();<br></span><span style="color: #008080;"> 53</span>             ObjectAnimator animator1 = ObjectAnimator.ofFloat(view, “rotation”<span style="color: #000000;">, 0f, 90f);<br></span><span style="color: #008080;"> 54</span>             ObjectAnimator moveIn = ObjectAnimator.ofFloat(view, “translationX”, 0f, -<span style="color: #000000;">50f);<br></span><span style="color: #008080;"> 55</span> <span style="color: #000000;">            animSet.play(animator1).before(moveIn);<br></span><span style="color: #008080;"> 56</span>             animSet.setDuration(10<span style="color: #000000;">);<br></span><span style="color: #008080;"> 57</span> <span style="color: #000000;">            animSet.start();<br></span><span style="color: #008080;"> 58</span>             isRotated = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 59</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 60</span>         mSensorManager.registerListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">, mAccel, SensorManager.SENSOR_DELAY_UI);<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 62</span><br><span style="color: #008080;"> 63</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 64</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPause() {<br></span><span style="color: #008080;"> 65</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPause();<br></span><span style="color: #008080;"> 66</span>         mSensorManager.unregisterListener(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 68</span><br><span style="color: #008080;"> 69</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 70</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onConfigurationChanged(Configuration newConfig) {<br></span><span style="color: #008080;"> 71</span>         Log.e(TAG, “onConfigurationChanged”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 72</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onConfigurationChanged(newConfig);<br></span><span style="color: #008080;"> 73</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 74</span><br><span style="color: #008080;"> 75</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> takePhoto(View view) {<br></span><span style="color: #008080;"> 76</span>         <span style="color: #0000ff;">if</span>(mCameraPreview != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 77</span> <span style="color: #000000;">            mCameraPreview.takePicture();<br></span><span style="color: #008080;"> 78</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 79</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 80</span><br><span style="color: #008080;"> 81</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> close(View view) {<br></span><span style="color: #008080;"> 82</span> <span style="color: #000000;">        finish();<br></span><span style="color: #008080;"> 83</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 84</span><br><span style="color: #008080;"> 85</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 86</span> <span style="color: #008000;">     <em> 关闭截图界面<br></em></span><span style="color: #008080;"> 87</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> view<br></span><span style="color: #008080;"> 88</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 89</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> closeCropper(View view) {<br></span><span style="color: #008080;"> 90</span> <span style="color: #000000;">        showTakePhotoLayout();<br></span><span style="color: #008080;"> 91</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 92</span><br><span style="color: #008080;"> 93</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 94</span> <span style="color: #008000;">     <em> 开始截图，并保存图片<br></em></span><span style="color: #008080;"> 95</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> view<br></span><span style="color: #008080;"> 96</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 97</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> startCropper(View view) {<br></span><span style="color: #008080;"> 98</span>         <span style="color: #008000;">//</span><span style="color: #008000;">获取截图并旋转90度</span><br><span style="color: #008080;"> 99</span>         CropperImage cropperImage =<span style="color: #000000;"> mCropImageView.getCroppedImage();<br></span><span style="color: #008080;">100</span>         Log.e(TAG, cropperImage.getX() + “,” +<span style="color: #000000;"> cropperImage.getY());<br></span><span style="color: #008080;">101</span>         Log.e(TAG, cropperImage.getWidth() + “,” +<span style="color: #000000;"> cropperImage.getHeight());<br></span><span style="color: #008080;">102</span>         Bitmap bitmap = Utils.rotate(cropperImage.getBitmap(), -90<span style="color: #000000;">);<br></span><span style="color: #008080;">103</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Bitmap bitmap = mCropImageView.getCroppedImage();<br></span><span style="color: #008080;">104</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 系统时间</span><br><span style="color: #008080;">105</span>         <span style="color: #0000ff;">long</span> dateTaken =<span style="color: #000000;"> System.currentTimeMillis();<br></span><span style="color: #008080;">106</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 图像名称</span><br><span style="color: #008080;">107</span>         String filename = DateFormat.format(“yyyy-MM-dd kk.mm.ss”<span style="color: #000000;">, dateTaken)<br></span><span style="color: #008080;">108</span>                 .toString() + “.jpg”<span style="color: #000000;">;<br></span><span style="color: #008080;">109</span>         Uri uri =<span style="color: #000000;"> insertImage(getContentResolver(), filename, dateTaken, PATH,<br></span><span style="color: #008080;">110</span>                 filename, bitmap, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">111</span> <span style="color: #000000;">        cropperImage.getBitmap().recycle();<br></span><span style="color: #008080;">112</span>         cropperImage.setBitmap(<span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">113</span>         Intent intent = <span style="color: #0000ff;">new</span> Intent(<span style="color: #0000ff;">this</span>, ShowCropperedActivity.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;">114</span> <span style="color: #000000;">        intent.setData(uri);<br></span><span style="color: #008080;">115</span>         intent.putExtra(“path”, PATH +<span style="color: #000000;"> filename);<br></span><span style="color: #008080;">116</span>         intent.putExtra(“width”<span style="color: #000000;">, bitmap.getWidth());<br></span><span style="color: #008080;">117</span>         intent.putExtra(“height”<span style="color: #000000;">, bitmap.getHeight());<br></span><span style="color: #008080;">118</span>         intent.putExtra(“cropperImage”<span style="color: #000000;">, cropperImage);<br></span><span style="color: #008080;">119</span> <span style="color: #000000;">        startActivity(intent);<br></span><span style="color: #008080;">120</span> <span style="color: #000000;">        bitmap.recycle();<br></span><span style="color: #008080;">121</span> <span style="color: #000000;">        finish();<br></span><span style="color: #008080;">122</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.overridePendingTransition(R.anim.fade_in,<br></span><span style="color: #008080;">123</span> <span style="color: #000000;">                R.anim.fade_out);<br></span><span style="color: #008080;">124</span> <span style="color: #008000;">//</span><span style="color: #008000;">        doAnimation(cropperImage);</span><br><span style="color: #008080;">125</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">126</span><br><span style="color: #008080;">127</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> doAnimation(CropperImage cropperImage) {<br></span><span style="color: #008080;">128</span>         ImageView imageView = <span style="color: #0000ff;">new</span> ImageView(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">129</span>         View view = LayoutInflater.from(<span style="color: #0000ff;">this</span><span style="color: #000000;">).inflate(<br></span><span style="color: #008080;">130</span>                 R.layout.image_view_layout, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">131</span> <span style="color: #000000;">        ((RelativeLayout) view.findViewById(R.id.root_layout)).addView(imageView);<br></span><span style="color: #008080;">132</span>         RelativeLayout relativeLayout =<span style="color: #000000;"> ((RelativeLayout) findViewById(R.id.root_layout));<br></span><span style="color: #008080;">133</span> <span style="color: #008000;">//</span><span style="color: #008000;">        relativeLayout.addView(imageView);</span><br><span style="color: #008080;">134</span> <span style="color: #000000;">        imageView.setX(cropperImage.getX());<br></span><span style="color: #008080;">135</span> <span style="color: #000000;">        imageView.setY(cropperImage.getY());<br></span><span style="color: #008080;">136</span>         ViewGroup.LayoutParams lp =<span style="color: #000000;"> imageView.getLayoutParams();<br></span><span style="color: #008080;">137</span>         lp.width = (<span style="color: #0000ff;">int</span><span style="color: #000000;">)cropperImage.getWidth();<br></span><span style="color: #008080;">138</span>         lp.height = (<span style="color: #0000ff;">int</span><span style="color: #000000;">) cropperImage.getHeight();<br></span><span style="color: #008080;">139</span> <span style="color: #000000;">        imageView.setLayoutParams(lp);<br></span><span style="color: #008080;">140</span> <span style="color: #000000;">        imageView.setImageBitmap(cropperImage.getBitmap());<br></span><span style="color: #008080;">141</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">142</span> <span style="color: #000000;">            getWindow().addContentView(view, lp);<br></span><span style="color: #008080;">143</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">144</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;">145</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">146</span>         <span style="color: #008000;">/</span><span style="color: #008000;">AnimatorSet animSet = new AnimatorSet();<br></span><span style="color: #008080;">147</span> <span style="color: #008000;">        ObjectAnimator translationX = ObjectAnimator.ofFloat(this, “translationX”, cropperImage.getX(), 0);<br></span><span style="color: #008080;">148</span> <span style="color: #008000;">        ObjectAnimator translationY = ObjectAnimator.ofFloat(this, “translationY”, cropperImage.getY(), 0);</span><span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">149</span><br><span style="color: #008080;">150</span>         TranslateAnimation translateAnimation = <span style="color: #0000ff;">new</span><span style="color: #000000;"> TranslateAnimation(<br></span><span style="color: #008080;">151</span>                 0, -cropperImage.getX(), 0, -(Math.abs(cropperImage.getHeight() - cropperImage.getY())));<span style="color: #008000;">//</span><span style="color: #008000;"> 当前位置移动到指定位置</span><br><span style="color: #008080;">152</span>         RotateAnimation rotateAnimation = <span style="color: #0000ff;">new</span> RotateAnimation(0, -90<span style="color: #000000;">,<br></span><span style="color: #008080;">153</span> <span style="color: #000000;">                Animation.ABSOLUTE, cropperImage.getX() ,Animation.ABSOLUTE, cropperImage.getY());<br></span><span style="color: #008080;">154</span>         AnimationSet animationSet = <span style="color: #0000ff;">new</span> AnimationSet(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">155</span> <span style="color: #000000;">        animationSet.addAnimation(translateAnimation);<br></span><span style="color: #008080;">156</span> <span style="color: #000000;">        animationSet.addAnimation(rotateAnimation);<br></span><span style="color: #008080;">157</span>         animationSet.setFillAfter(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">158</span>         animationSet.setDuration(2000L<span style="color: #000000;">);<br></span><span style="color: #008080;">159</span> <span style="color: #000000;">        imageView.startAnimation(animationSet);<br></span><span style="color: #008080;">160</span> <span style="color: #008000;">//</span><span style="color: #008000;">        finish();</span><br><span style="color: #008080;">161</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">162</span><br><span style="color: #008080;">163</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">164</span> <span style="color: #008000;">      拍照成功后回调<br></span><span style="color: #008080;">165</span> <span style="color: #008000;">     <em> 存储图片并显示截图界面<br></em></span><span style="color: #008080;">166</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> data<br></span><span style="color: #008080;">167</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">168</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">169</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onCameraStopped(<span style="color: #0000ff;">byte</span><span style="color: #000000;">[] data) {<br></span><span style="color: #008080;">170</span>         Log.i(“TAG”, “==onCameraStopped==”<span style="color: #000000;">);<br></span><span style="color: #008080;">171</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 创建图像</span><br><span style="color: #008080;">172</span>         Bitmap bitmap = BitmapFactory.decodeByteArray(data, 0<span style="color: #000000;">, data.length);<br></span><span style="color: #008080;">173</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 系统时间</span><br><span style="color: #008080;">174</span>         <span style="color: #0000ff;">long</span> dateTaken =<span style="color: #000000;"> System.currentTimeMillis();<br></span><span style="color: #008080;">175</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 图像名称</span><br><span style="color: #008080;">176</span>         String filename = DateFormat.format(“yyyy-MM-dd kk.mm.ss”<span style="color: #000000;">, dateTaken)<br></span><span style="color: #008080;">177</span>                 .toString() + “.jpg”<span style="color: #000000;">;<br></span><span style="color: #008080;">178</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 存储图像（PATH目录）</span><br><span style="color: #008080;">179</span>         Uri source =<span style="color: #000000;"> insertImage(getContentResolver(), filename, dateTaken, PATH,<br></span><span style="color: #008080;">180</span> <span style="color: #000000;">                filename, bitmap, data);<br></span><span style="color: #008080;">181</span>         <span style="color: #008000;">//</span><span style="color: #008000;">准备截图</span><br><span style="color: #008080;">182</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">183</span>             mCropImageView.setImageBitmap(MediaStore.Images.Media.getBitmap(<span style="color: #0000ff;">this</span><span style="color: #000000;">.getContentResolver(), source));<br></span><span style="color: #008080;">184</span> <span style="color: #008000;">//</span><span style="color: #008000;">            mCropImageView.rotateImage(90);</span><br><span style="color: #008080;">185</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;">186</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">187</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">188</span> <span style="color: #000000;">        showCropperLayout();<br></span><span style="color: #008080;">189</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">190</span><br><span style="color: #008080;">191</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">192</span> <span style="color: #008000;">      存储图像并将信息添加入媒体数据库<br></span><span style="color: #008080;">193</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">194</span>     <span style="color: #0000ff;">private</span> Uri insertImage(ContentResolver cr, String name, <span style="color: #0000ff;">long</span><span style="color: #000000;"> dateTaken,<br></span><span style="color: #008080;">195</span>                             String directory, String filename, Bitmap source, <span style="color: #0000ff;">byte</span><span style="color: #000000;">[] jpegData) {<br></span><span style="color: #008080;">196</span>         OutputStream outputStream = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">197</span>         String filePath = directory +<span style="color: #000000;"> filename;<br></span><span style="color: #008080;">198</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">199</span>             File dir = <span style="color: #0000ff;">new</span><span style="color: #000000;"> File(directory);<br></span><span style="color: #008080;">200</span>             <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">dir.exists()) {<br></span><span style="color: #008080;">201</span> <span style="color: #000000;">                dir.mkdirs();<br></span><span style="color: #008080;">202</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">203</span>             File file = <span style="color: #0000ff;">new</span><span style="color: #000000;"> File(directory, filename);<br></span><span style="color: #008080;">204</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (file.createNewFile()) {<br></span><span style="color: #008080;">205</span>                 outputStream = <span style="color: #0000ff;">new</span><span style="color: #000000;"> FileOutputStream(file);<br></span><span style="color: #008080;">206</span>                 <span style="color: #0000ff;">if</span> (source != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">207</span>                     source.compress(Bitmap.CompressFormat.JPEG, 100<span style="color: #000000;">, outputStream);<br></span><span style="color: #008080;">208</span>                 } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">209</span> <span style="color: #000000;">                    outputStream.write(jpegData);<br></span><span style="color: #008080;">210</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">211</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">212</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (FileNotFoundException e) {<br></span><span style="color: #008080;">213</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">214</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">215</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;">216</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">217</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">218</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">219</span>             <span style="color: #0000ff;">if</span> (outputStream != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">220</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">221</span> <span style="color: #000000;">                    outputStream.close();<br></span><span style="color: #008080;">222</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Throwable t) {<br></span><span style="color: #008080;">223</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">224</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">225</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">226</span>         ContentValues values = <span style="color: #0000ff;">new</span> ContentValues(7<span style="color: #000000;">);<br></span><span style="color: #008080;">227</span> <span style="color: #000000;">        values.put(MediaStore.Images.Media.TITLE, name);<br></span><span style="color: #008080;">228</span> <span style="color: #000000;">        values.put(MediaStore.Images.Media.DISPLAY_NAME, filename);<br></span><span style="color: #008080;">229</span> <span style="color: #000000;">        values.put(MediaStore.Images.Media.DATE_TAKEN, dateTaken);<br></span><span style="color: #008080;">230</span>         values.put(MediaStore.Images.Media.MIME_TYPE, “image/jpeg”<span style="color: #000000;">);<br></span><span style="color: #008080;">231</span> <span style="color: #000000;">        values.put(MediaStore.Images.Media.DATA, filePath);<br></span><span style="color: #008080;">232</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> cr.insert(IMAGE_URI, values);<br></span><span style="color: #008080;">233</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">234</span><br><span style="color: #008080;">235</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> showTakePhotoLayout() {<br></span><span style="color: #008080;">236</span> <span style="color: #000000;">        mTakePhotoLayout.setVisibility(View.VISIBLE);<br></span><span style="color: #008080;">237</span> <span style="color: #000000;">        mCropperLayout.setVisibility(View.GONE);<br></span><span style="color: #008080;">238</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">239</span><br><span style="color: #008080;">240</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> showCropperLayout() {<br></span><span style="color: #008080;">241</span> <span style="color: #000000;">        mTakePhotoLayout.setVisibility(View.GONE);<br></span><span style="color: #008080;">242</span> <span style="color: #000000;">        mCropperLayout.setVisibility(View.VISIBLE);<br></span><span style="color: #008080;">243</span>         mCameraPreview.start();   <span style="color: #008000;">//</span><span style="color: #008000;">继续启动摄像头</span><br><span style="color: #008080;">244</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">245</span><br><span style="color: #008080;">246</span><br><span style="color: #008080;">247</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">float</span> mLastX = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">248</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">float</span> mLastY = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">249</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">float</span> mLastZ = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">250</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> mInitialized = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">251</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> SensorManager mSensorManager;<br></span><span style="color: #008080;">252</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Sensor mAccel;<br></span><span style="color: #008080;">253</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">254</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onSensorChanged(SensorEvent event) {<br></span><span style="color: #008080;">255</span><br><span style="color: #008080;">256</span>         <span style="color: #0000ff;">float</span> x = event.values[0<span style="color: #000000;">];<br></span><span style="color: #008080;">257</span>         <span style="color: #0000ff;">float</span> y = event.values[1<span style="color: #000000;">];<br></span><span style="color: #008080;">258</span>         <span style="color: #0000ff;">float</span> z = event.values[2<span style="color: #000000;">];<br></span><span style="color: #008080;">259</span>         <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">mInitialized){<br></span><span style="color: #008080;">260</span>             mLastX =<span style="color: #000000;"> x;<br></span><span style="color: #008080;">261</span>             mLastY =<span style="color: #000000;"> y;<br></span><span style="color: #008080;">262</span>             mLastZ =<span style="color: #000000;"> z;<br></span><span style="color: #008080;">263</span>             mInitialized = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">264</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">265</span>         <span style="color: #0000ff;">float</span> deltaX  = Math.abs(mLastX -<span style="color: #000000;"> x);<br></span><span style="color: #008080;">266</span>         <span style="color: #0000ff;">float</span> deltaY = Math.abs(mLastY -<span style="color: #000000;"> y);<br></span><span style="color: #008080;">267</span>         <span style="color: #0000ff;">float</span> deltaZ = Math.abs(mLastZ -<span style="color: #000000;"> z);<br></span><span style="color: #008080;">268</span><br><span style="color: #008080;">269</span>         <span style="color: #0000ff;">if</span>(deltaX &gt; 0.8 || deltaY &gt; 0.8 || deltaZ &gt; 0.8<span style="color: #000000;">){<br></span><span style="color: #008080;">270</span> <span style="color: #000000;">            mCameraPreview.setFocus();<br></span><span style="color: #008080;">271</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">272</span>         mLastX =<span style="color: #000000;"> x;<br></span><span style="color: #008080;">273</span>         mLastY =<span style="color: #000000;"> y;<br></span><span style="color: #008080;">274</span>         mLastZ =<span style="color: #000000;"> z;<br></span><span style="color: #008080;">275</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">276</span><br><span style="color: #008080;">277</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">278</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onAccuracyChanged(Sensor sensor, <span style="color: #0000ff;">int</span><span style="color: #000000;"> accuracy) {<br></span><span style="color: #008080;">279</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">280</span> }</pre><br></div>

<p>　　<span style="font-size: 15px;">actiity中注册了SensorEventListener，也就是使用传感器监听用户手机的移动，如果有一定距离的移动，则自动聚焦，这样体验好一点。</span></p>
<p><span style="font-size: 15px;">　　我对比了一下小猿搜题和学霸君两款app的拍照功能，个人感觉小猿搜题的体验要好一些，因为从主界面进入拍照界面，连个界面没有一个旋转的过渡，而学霸君就有一个过渡，有一丝丝的影响体验。也就是说学霸君的拍照界面是横屏的，在activity的onCreate方法里面调用了</span>setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE)来设置全屏，而切换界面的时候又从竖屏切换为横屏，就会有个过渡的效果，影响了体验。</p>
<p>　　<span style="font-size: 15px;">个人猜测小猿搜题是将拍照界面的activity设置为竖屏，而将摄像头直接旋转90度，这样就强制用户横屏拍摄，当然，拍完之后还要将图片旋转回来。所以我参考小猿搜题来实现的，毕竟体验为王嘛。</span></p>
<p><span style="font-size: 15px;"><img src="http://www.liuling123.com/wp-content/uploads/2015/11/420264-20151028225216372-729805796.png" alt=""></span></p>
<p>&nbsp;</p>
<p>　　<span style="font-size: 15px;">如上图（其实是竖屏），红色圈起来的其实是放到底部，然后将屏幕中间的文字旋转90度（带有动画，起了提示用户横屏拍照的作用），就给人的感觉是横屏的。了。</span></p>
<p><span style="font-size: 15px;">　　还有一点就是小猿搜题拍完照到截图过渡的很自然，感觉很流畅，估计是拍照和截图放在同一个activity中的，如果是两个activty，涉及到界面切换，肯定不会那么自然。所以我也将拍照和截图放在一个界面，拍照完就将自定义相机隐藏，将截图界面显示出来，这样切换就很流畅了。</span></p>
<p><span style="font-size: 15px;">　　项目中截图的功能我是从github上面找的一个开源库cropper：<a href="https://github.com/edmodo/cropper" title="https://github.com/edmodo/cropper" target="_blank" rel="external">https://github.com/edmodo/cropper</a></span></p>
<p>&nbsp;　 &nbsp;<span style="font-size: 15px;">&nbsp;</span><span style="font-size: 15px;">因为ocr图片识别的代码是公司的，所以识别的功能没有添加到demo里面去。</span><span style="font-size: 15px;"><br></span></p>
<p>&nbsp;</p>
<p>　　<span style="color: #ff0000;">Demo<span style="font-size: 15px;">源码下载：<span style="color: #000000;"><a href="https://github.com/liuling07/CustomCameraDemo" title="https://github.com/liuling07/CustomCameraDemo" target="_blank" rel="external">https://github.com/liuling07/CustomCameraDemo</a></span></span></span></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2015/10/custom-camera.html" data-id="ciiy5f4x100crq1d0p47hc6vp" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2015/10/custom-camera.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/camera/">camera</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-listview-partial-refresh" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/listview-partial-refresh.html">ListView实现Item局部刷新</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2015/10/listview-partial-refresh.html">
      <time datetime="2015-10-20T05:44:00.000Z" itemprop="datePublished">2015-10-20</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　&nbsp;<span style="font-size: 15px;">对于ListView数据的刷新大家都知道，改变Adapter的数据源，然后调用Adapter的notifyDateSetChanged()方法即可。</span></p>
<p><span style="font-size: 15px;">　　但是博主在做公司项目的时候，有个下载模块，因为可能同时下载好几个数据，所以用的listview展示所有正在下载的内容。因为下载进度要实时更新，所以要不停的调用notifyDateSetChanged刷新数据。这样会不停的重新绘制整个listview的界面，性能开销非常大。而且如果每个item有图片的话，每个item的图片都需要重新加载，就算图片做了内存缓存，刷新一下图片也会闪一下，不停的刷新就会导致各个item的图片不停的闪，体验一点都不好。</span></p>
<p><span style="font-size: 15px;">　　那么对于上面问题，有没有解决办法呢？当然是有的。我们可以针对某一个item进行局部更新，而不影响其它没有修改的item。那么具体如何实现的呢？我们看下面的代码。</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> updateView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> itemIndex) {<br></span><span style="color: #008080;"> 2</span>         <span style="color: #008000;">//</span><span style="color: #008000;">得到第一个可显示控件的位置，</span><br><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">int</span> visiblePosition =<span style="color: #000000;"> mListView.getFirstVisiblePosition();<br></span><span style="color: #008080;"> 4</span>         <span style="color: #008000;">//</span><span style="color: #008000;">只有当要更新的view在可见的位置时才更新，不可见时，跳过不更新</span><br><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">if</span> (itemIndex - visiblePosition &gt;= 0<span style="color: #000000;">) {<br></span><span style="color: #008080;"> 6</span>             <span style="color: #008000;">//</span><span style="color: #008000;">得到要更新的item的view</span><br><span style="color: #008080;"> 7</span>             View view = mListView.getChildAt(itemIndex -<span style="color: #000000;"> visiblePosition);<br></span><span style="color: #008080;"> 8</span>             <span style="color: #008000;">//</span><span style="color: #008000;">调用adapter更新界面</span><br><span style="color: #008080;"> 9</span> <span style="color: #000000;">            mAdapter.updateView(view, itemIndex);<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">11</span>     }</pre><br></div>

<p>　　<span style="font-size: 15px;">这个函数主要是根据传入的itemIndex来获取第itemIndex的数据所显示的view。itemIndex就是要修改的数据再List集合中的位置，比如我这里下载进度有更新，发了一个广播这里接收到了，需要修改该下载内容的进度条，广播接收器可以这么写：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;"> 2</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onReceive(Context context, Intent intent) {<br></span><span style="color: #008080;"> 3</span>             AppContent appContent = intent.getParcelableExtra(“appContent”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 4</span>             <span style="color: #0000ff;">if</span>(appContent == <span style="color: #0000ff;">null</span>) <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 5</span>             <span style="color: #0000ff;">int</span> itemIndex = 0<span style="color: #000000;">;<br></span><span style="color: #008080;"> 6</span>             <span style="color: #0000ff;">for</span><span style="color: #000000;">(AppContent appContent1 : mList) {<br></span><span style="color: #008080;"> 7</span>                 <span style="color: #0000ff;">if</span><span style="color: #000000;">(appContent.getUrl().equals(appContent1.getUrl())) {<br></span><span style="color: #008080;"> 8</span>                     itemIndex =<span style="color: #000000;"> mList.indexOf(appContent1);<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">                    appContent1.setDownloadPercent(appContent.getDownloadPercent());<br></span><span style="color: #008080;">10</span>                     <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">            updateView(itemIndex);<br></span><span style="color: #008080;">14</span>         }</pre><br></div>

<p>　　<span style="font-size: 15px;">下面看Adapter的具体代码：<br></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> AppContentAdapter <span style="color: #0000ff;">extends</span><span style="color: #000000;"> BaseAdapter{<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span>     <span style="color: #0000ff;">private</span> List<appcontent> mDates = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">  4</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context mContext;<br></span><span style="color: #008080;">  5</span><br><span style="color: #008080;">  6</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> AppContentAdapter(Context context) {<br></span><span style="color: #008080;">  7</span>         <span style="color: #0000ff;">this</span>.mContext =<span style="color: #000000;"> context;<br></span><span style="color: #008080;">  8</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">  9</span><br><span style="color: #008080;"> 10</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 11</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getCount() {<br></span><span style="color: #008080;"> 12</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> mDates.size();<br></span><span style="color: #008080;"> 13</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 14</span><br><span style="color: #008080;"> 15</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 16</span>     <span style="color: #0000ff;">public</span> Object getItem(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position) {<br></span><span style="color: #008080;"> 17</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> mDates.get(position);<br></span><span style="color: #008080;"> 18</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 19</span><br><span style="color: #008080;"> 20</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 21</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">long</span> getItemId(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position) {<br></span><span style="color: #008080;"> 22</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> position;<br></span><span style="color: #008080;"> 23</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 24</span><br><span style="color: #008080;"> 25</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setDates(List<appcontent><span style="color: #000000;"> mDates) {<br></span><span style="color: #008080;"> 26</span>         <span style="color: #0000ff;">this</span>.mDates =<span style="color: #000000;"> mDates;<br></span><span style="color: #008080;"> 27</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 28</span><br><span style="color: #008080;"> 29</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 30</span>     <span style="color: #0000ff;">public</span> View getView(<span style="color: #0000ff;">int</span><span style="color: #000000;"> position, View convertView, ViewGroup parent) {<br></span><span style="color: #008080;"> 31</span>         ViewHolder holder = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 32</span>         <span style="color: #0000ff;">if</span> (convertView == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 33</span>             holder = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ViewHolder();<br></span><span style="color: #008080;"> 34</span>             convertView =<span style="color: #000000;"> LayoutInflater.from(mContext).inflate(<br></span><span style="color: #008080;"> 35</span>                     R.layout.listitem_download, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 36</span>             holder.statusIcon =<span style="color: #000000;"> (DownloadPercentView) convertView.findViewById(R.id.status_icon);<br></span><span style="color: #008080;"> 37</span>             holder.name =<span style="color: #000000;"> (TextView) convertView.findViewById(R.id.name);<br></span><span style="color: #008080;"> 38</span>             holder.downloadPercent =<span style="color: #000000;"> (TextView) convertView.findViewById(R.id.download_percent);<br></span><span style="color: #008080;"> 39</span>             holder.progressBar =<span style="color: #000000;"> (ProgressBar) convertView.findViewById(R.id.progressbar);<br></span><span style="color: #008080;"> 40</span> <span style="color: #000000;">            convertView.setTag(holder);<br></span><span style="color: #008080;"> 41</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 42</span>             holder =<span style="color: #000000;"> (ViewHolder) convertView.getTag();<br></span><span style="color: #008080;"> 43</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 44</span> <span style="color: #000000;">        setData(holder, position);<br></span><span style="color: #008080;"> 45</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> convertView;<br></span><span style="color: #008080;"> 46</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 47</span><br><span style="color: #008080;"> 48</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 49</span> <span style="color: #008000;">     <em> 设置viewHolder的数据<br></em></span><span style="color: #008080;"> 50</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> holder<br></span><span style="color: #008080;"> 51</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> itemIndex<br></span><span style="color: #008080;"> 52</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 53</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span> setData(ViewHolder holder, <span style="color: #0000ff;">int</span><span style="color: #000000;"> itemIndex) {<br></span><span style="color: #008080;"> 54</span>         AppContent appContent =<span style="color: #000000;"> mDates.get(itemIndex);<br></span><span style="color: #008080;"> 55</span> <span style="color: #000000;">        holder.name.setText(appContent.getName());<br></span><span style="color: #008080;"> 56</span> <span style="color: #000000;">        holder.progressBar.setProgress(appContent.getDownloadPercent());<br></span><span style="color: #008080;"> 57</span> <span style="color: #000000;">        setIconByStatus(holder.statusIcon, appContent.getStatus());<br></span><span style="color: #008080;"> 58</span>         <span style="color: #0000ff;">if</span>(appContent.getStatus() ==<span style="color: #000000;"> AppContent.Status.PENDING) {<br></span><span style="color: #008080;"> 59</span> <span style="color: #000000;">            holder.downloadPercent.setVisibility(View.INVISIBLE);<br></span><span style="color: #008080;"> 60</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">            holder.downloadPercent.setVisibility(View.VISIBLE);<br></span><span style="color: #008080;"> 62</span> <span style="color: #000000;">            holder.statusIcon.setProgress(appContent.getDownloadPercent());<br></span><span style="color: #008080;"> 63</span>             holder.downloadPercent.setText(“下载进度：” + appContent.getDownloadPercent() + “%”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 64</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 65</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 66</span><br><span style="color: #008080;"> 67</span><br><span style="color: #008080;"> 68</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 69</span> <span style="color: #008000;">     <em> 局部刷新<br></em></span><span style="color: #008080;"> 70</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> view<br></span><span style="color: #008080;"> 71</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> itemIndex<br></span><span style="color: #008080;"> 72</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 73</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> updateView(View view, <span style="color: #0000ff;">int</span><span style="color: #000000;"> itemIndex) {<br></span><span style="color: #008080;"> 74</span>         <span style="color: #0000ff;">if</span>(view == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 75</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 76</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 77</span>         <span style="color: #008000;">//</span><span style="color: #008000;">从view中取得holder</span><br><span style="color: #008080;"> 78</span>         ViewHolder holder =<span style="color: #000000;"> (ViewHolder) view.getTag();<br></span><span style="color: #008080;"> 79</span>         holder.statusIcon =<span style="color: #000000;"> (DownloadPercentView) view.findViewById(R.id.status_icon);<br></span><span style="color: #008080;"> 80</span>         holder.name =<span style="color: #000000;"> (TextView) view.findViewById(R.id.name);<br></span><span style="color: #008080;"> 81</span>         holder.downloadPercent =<span style="color: #000000;"> (TextView) view.findViewById(R.id.download_percent);<br></span><span style="color: #008080;"> 82</span>         holder.progressBar =<span style="color: #000000;"> (ProgressBar) view.findViewById(R.id.progressbar);<br></span><span style="color: #008080;"> 83</span> <span style="color: #000000;">        setData(holder, itemIndex);<br></span><span style="color: #008080;"> 84</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 85</span><br><span style="color: #008080;"> 86</span>     <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 87</span> <span style="color: #008000;">      根据状态设置图标<br></span><span style="color: #008080;"> 88</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> downloadPercentView<br></span><span style="color: #008080;"> 89</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> status<br></span><span style="color: #008080;"> 90</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 91</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setIconByStatus(DownloadPercentView downloadPercentView, AppContent.Status status) {<br></span><span style="color: #008080;"> 92</span> <span style="color: #000000;">        downloadPercentView.setVisibility(View.VISIBLE);<br></span><span style="color: #008080;"> 93</span>         <span style="color: #0000ff;">if</span>(status ==<span style="color: #000000;"> AppContent.Status.PENDING) {<br></span><span style="color: #008080;"> 94</span> <span style="color: #000000;">            downloadPercentView.setStatus(DownloadPercentView.STATUS_PEDDING);<br></span><span style="color: #008080;"> 95</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 96</span>         <span style="color: #0000ff;">if</span>(status ==<span style="color: #000000;"> AppContent.Status.DOWNLOADING) {<br></span><span style="color: #008080;"> 97</span> <span style="color: #000000;">            downloadPercentView.setStatus(DownloadPercentView.STATUS_DOWNLOADING);<br></span><span style="color: #008080;"> 98</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 99</span>         <span style="color: #0000ff;">if</span>(status ==<span style="color: #000000;"> AppContent.Status.WAITING) {<br></span><span style="color: #008080;">100</span> <span style="color: #000000;">            downloadPercentView.setStatus(DownloadPercentView.STATUS_WAITING);<br></span><span style="color: #008080;">101</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">102</span>         <span style="color: #0000ff;">if</span>(status ==<span style="color: #000000;"> AppContent.Status.PAUSED) {<br></span><span style="color: #008080;">103</span> <span style="color: #000000;">            downloadPercentView.setStatus(DownloadPercentView.STATUS_PAUSED);<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">105</span>         <span style="color: #0000ff;">if</span>(status ==<span style="color: #000000;"> AppContent.Status.FINISHED) {<br></span><span style="color: #008080;">106</span> <span style="color: #000000;">            downloadPercentView.setStatus(DownloadPercentView.STATUS_FINISHED);<br></span><span style="color: #008080;">107</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">108</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">109</span><br><span style="color: #008080;">110</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> ViewHolder {<br></span><span style="color: #008080;">111</span>         <span style="color: #0000ff;">private</span><span style="color: #000000;"> DownloadPercentView statusIcon;<br></span><span style="color: #008080;">112</span>         <span style="color: #0000ff;">private</span><span style="color: #000000;"> TextView name;<br></span><span style="color: #008080;">113</span>         <span style="color: #0000ff;">private</span><span style="color: #000000;"> TextView downloadPercent;<br></span><span style="color: #008080;">114</span>         <span style="color: #0000ff;">private</span><span style="color: #000000;"> ProgressBar progressBar;<br></span><span style="color: #008080;">115</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">116</span> }</appcontent></appcontent></pre><br></div>

<p>　　<span style="font-size: 15px;">其实这些代码就是我上篇博文《<a href="http://www.cnblogs.com/liuling/p/2015-10-16-01.html" title="http://www.cnblogs.com/liuling/p/2015-10-16-01.html" target="_blank" rel="external">AsyncTask实现多任务多线程下载</a>》的例子中的，如果需要可以去下载。</span></p>
<p><span style="font-size: 15px;">&nbsp;</span></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2015/10/listview-partial-refresh.html" data-id="ciiy5f4sj005qq1d04ily87h5" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2015/10/listview-partial-refresh.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/布局/">布局</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-asynctask-multi-task-thread" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/asynctask-multi-task-thread.html">AsyncTask实现多任务多线程断点续传下载</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2015/10/asynctask-multi-task-thread.html">
      <time datetime="2015-10-16T05:29:00.000Z" itemprop="datePublished">2015-10-16</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　<span style="font-size: 15px;">这篇博客是AsyncTask下载系列的最后一篇文章，前面写了关于断点续传的和多线程下载的博客，这篇是在前两篇的基础上面实现的，有兴趣的可以去看下。</span></p>
<p><span style="font-size: 15px;">　　一、<a href="http://www.cnblogs.com/liuling/p/2015-10-10-01.html" title="http://www.cnblogs.com/liuling/p/2015-10-10-01.html" target="_blank" rel="external">AsyncTask实现断点续传</a></span></p>
<p><span style="font-size: 15px;">　　二、<a href="http://www.cnblogs.com/liuling/p/2015-10-13-01.html" title="http://www.cnblogs.com/liuling/p/2015-10-13-01.html" target="_blank" rel="external">AsyncTask实现多线程断点续传</a></span></p>
<p><span style="font-size: 15px;">　　这里模拟应用市场app下载实现了一个Demo，因为只有一个界面，所以没有将下载放到Service中，而是直接在Activity中创建。在正式的项目中，下载都是放到Service中，然后通过BroadCast通知界面更新进度。<span style="line-height: 1.5;"><br></span></span></p>
<p><span style="font-size: 15px;">　　上代码之前，先看下demo的运行效果图吧。</span></p>
<p><img src="http://www.liuling123.com/wp-content/uploads/2015/11/420264-20151016210637601-2103512377.gif" alt=""></p>
<p>&nbsp;</p>
<p>　　<span style="font-size: 15px;">下面我们看代码，这里每一个文件的下载定义一个Downloador来管理下载该文件的所有线程（暂停、下载等）。Downloador创建3个DownloadTask（这里定义每个文件分配3个线程下载）来下载该文件特定的起止位置。这里要通过文件的大小来计算每个线程所下载的起止位置，详细可以参考《<a href="http://www.cnblogs.com/liuling/p/2015-10-13-01.html" title="http://www.cnblogs.com/liuling/p/2015-10-13-01.html" target="_blank" rel="external">AsyncTask实现多线程断点续传</a>》。</span></p>
<p><span style="font-size: 15px;">　　1、Downloador类</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.downloador;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Intent;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.AsyncTask;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Handler;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Message;<br></span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.text.TextUtils;<br></span><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.Log;<br></span><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.Toast;<br></span><span style="color: #008080;"> 12</span><br><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.beans.AppContent;<br></span><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.beans.DownloadInfo;<br></span><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.db.DownloadFileDAO;<br></span><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.db.DownloadInfoDAO;<br></span><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.utils.DownloadUtils;<br></span><span style="color: #008080;"> 18</span><br><span style="color: #008080;"> 19</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.HttpResponse;<br></span><span style="color: #008080;"> 20</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.client.HttpClient;<br></span><span style="color: #008080;"> 21</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.client.methods.HttpGet;<br></span><span style="color: #008080;"> 22</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.impl.client.DefaultHttpClient;<br></span><span style="color: #008080;"> 23</span><br><span style="color: #008080;"> 24</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;"> 25</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;"> 26</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Executor;<br></span><span style="color: #008080;"> 27</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Executors;<br></span><span style="color: #008080;"> 28</span><br><span style="color: #008080;"> 29</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 30</span> <span style="color: #008000;"> <em> @Class: Downloador<br></em></span><span style="color: #008080;"> 31</span> <span style="color: #008000;">  @Description: 任务下载器<br></span><span style="color: #008080;"> 32</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;">: lling(www.cnblogs.com/liuling)<br></span><span style="color: #008080;"> 33</span> <span style="color: #008000;">  @Date: 2015/10/13<br></span><span style="color: #008080;"> 34</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 35</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> Downloador {<br></span><span style="color: #008080;"> 36</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “Downloador”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 37</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> THREAD_POOL_SIZE = 9;  <span style="color: #008000;">//</span><span style="color: #008000;">线程池大小为9</span><br><span style="color: #008080;"> 38</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> THREAD_NUM = 3;  <span style="color: #008000;">//</span><span style="color: #008000;">每个文件3个线程下载</span><br><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> GET_LENGTH_SUCCESS = 1<span style="color: #000000;">;<br></span><span style="color: #008080;"> 40</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> Executor THREAD_POOL_EXECUTOR =<span style="color: #000000;"> Executors.newFixedThreadPool(THREAD_POOL_SIZE);<br></span><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span>     <span style="color: #0000ff;">private</span> List<downloadtask><span style="color: #000000;"> tasks;<br></span><span style="color: #008080;"> 43</span>     <span style="color: #0000ff;">private</span> InnerHandler handler = <span style="color: #0000ff;">new</span><span style="color: #000000;"> InnerHandler();<br></span><span style="color: #008080;"> 44</span><br><span style="color: #008080;"> 45</span>     <span style="color: #0000ff;">private</span> AppContent appContent; <span style="color: #008000;">//</span><span style="color: #008000;">待下载的应用</span><br><span style="color: #008080;"> 46</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span> downloadLength; <span style="color: #008000;">//</span><span style="color: #008000;">下载过程中记录已下载大小</span><br><span style="color: #008080;"> 47</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> fileLength;<br></span><span style="color: #008080;"> 48</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br></span><span style="color: #008080;"> 49</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String downloadPath;<br></span><span style="color: #008080;"> 50</span><br><span style="color: #008080;"> 51</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Downloador(Context context, AppContent appContent) {<br></span><span style="color: #008080;"> 52</span>         <span style="color: #0000ff;">this</span>.context =<span style="color: #000000;"> context;<br></span><span style="color: #008080;"> 53</span>         <span style="color: #0000ff;">this</span>.appContent =<span style="color: #000000;"> appContent;<br></span><span style="color: #008080;"> 54</span>         <span style="color: #0000ff;">this</span>.downloadPath =<span style="color: #000000;"> DownloadUtils.getDownloadPath();<br></span><span style="color: #008080;"> 55</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 56</span><br><span style="color: #008080;"> 57</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 58</span> <span style="color: #008000;">     <em> 开始下载<br></em></span><span style="color: #008080;"> 59</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 60</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> download() {<br></span><span style="color: #008080;"> 61</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(TextUtils.isEmpty(downloadPath)) {<br></span><span style="color: #008080;"> 62</span>             Toast.makeText(context, “未找到SD卡”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;"> 63</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 64</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 65</span>         <span style="color: #0000ff;">if</span>(appContent == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 66</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> IllegalArgumentException(“download content can not be null”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 68</span>         <span style="color: #0000ff;">new</span><span style="color: #000000;"> Thread() {<br></span><span style="color: #008080;"> 69</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 70</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;"> 71</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">获取文件大小</span><br><span style="color: #008080;"> 72</span>                 HttpClient client = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DefaultHttpClient();<br></span><span style="color: #008080;"> 73</span>                 HttpGet request = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HttpGet(appContent.getUrl());<br></span><span style="color: #008080;"> 74</span>                 HttpResponse response = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 75</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 76</span>                     response =<span style="color: #000000;"> client.execute(request);<br></span><span style="color: #008080;"> 77</span>                     fileLength =<span style="color: #000000;"> response.getEntity().getContentLength();<br></span><span style="color: #008080;"> 78</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 79</span> <span style="color: #000000;">                    Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;"> 80</span>                 } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 81</span>                     <span style="color: #0000ff;">if</span> (request != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 82</span> <span style="color: #000000;">                        request.abort();<br></span><span style="color: #008080;"> 83</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;"> 84</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 85</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">计算出该文件已经下载的总长度</span><br><span style="color: #008080;"> 86</span>                 List<downloadinfo> lists =<span style="color: #000000;"> DownloadInfoDAO.getInstance(context.getApplicationContext())<br></span><span style="color: #008080;"> 87</span> <span style="color: #000000;">                        .getDownloadInfosByUrl(appContent.getUrl());<br></span><span style="color: #008080;"> 88</span>                 <span style="color: #0000ff;">for</span><span style="color: #000000;"> (DownloadInfo info : lists) {<br></span><span style="color: #008080;"> 89</span>                     downloadLength +=<span style="color: #000000;"> info.getDownloadLength();<br></span><span style="color: #008080;"> 90</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 91</span><br><span style="color: #008080;"> 92</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">插入文件下载记录到数据库</span><br><span style="color: #008080;"> 93</span> <span style="color: #000000;">                DownloadFileDAO.getInstance(context.getApplicationContext()).insertDownloadFile(appContent);<br></span><span style="color: #008080;"> 94</span> <span style="color: #000000;">                Message.obtain(handler, GET_LENGTH_SUCCESS).sendToTarget();<br></span><span style="color: #008080;"> 95</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 96</span> <span style="color: #000000;">        }.start();<br></span><span style="color: #008080;"> 97</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 98</span><br><span style="color: #008080;"> 99</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">100</span> <span style="color: #008000;">     <em> 开始创建AsyncTask下载<br></em></span><span style="color: #008080;">101</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">102</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> beginDownload() {<br></span><span style="color: #008080;">103</span>         Log.e(TAG, “beginDownload” +<span style="color: #000000;"> appContent.getUrl());<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">        appContent.setStatus(AppContent.Status.WAITING);<br></span><span style="color: #008080;">105</span>         <span style="color: #0000ff;">long</span> blockLength = fileLength /<span style="color: #000000;"> THREAD_NUM;<br></span><span style="color: #008080;">106</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; THREAD_NUM; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;">107</span>             <span style="color: #0000ff;">long</span> beginPosition = i <em> blockLength;<span style="color: #008000;">//</span><span style="color: #008000;">每条线程下载的开始位置</span><br><span style="color: #008080;">108</span>             <span style="color: #0000ff;">long</span> endPosition = (i + 1) </em> blockLength;<span style="color: #008000;">//</span><span style="color: #008000;">每条线程下载的结束位置</span><br><span style="color: #008080;">109</span>             <span style="color: #0000ff;">if</span> (i == (THREAD_NUM - 1<span style="color: #000000;">)) {<br></span><span style="color: #008080;">110</span>                 endPosition = fileLength;<span style="color: #008000;">//</span><span style="color: #008000;">如果整个文件的大小不为线程个数的整数倍，则最后一个线程的结束位置即为文件的总长度</span><br><span style="color: #008080;">111</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">112</span>             DownloadTask task = <span style="color: #0000ff;">new</span> DownloadTask(i, beginPosition, endPosition, <span style="color: #0000ff;">this</span><span style="color: #000000;">, context);<br></span><span style="color: #008080;">113</span> <span style="color: #000000;">            task.executeOnExecutor(THREAD_POOL_EXECUTOR, appContent.getUrl());<br></span><span style="color: #008080;">114</span>             <span style="color: #0000ff;">if</span>(tasks == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">115</span>                 tasks = <span style="color: #0000ff;">new</span> ArrayList<downloadtask><span style="color: #000000;">();<br></span><span style="color: #008080;">116</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">117</span> <span style="color: #000000;">            tasks.add(task);<br></span><span style="color: #008080;">118</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">119</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">120</span><br><span style="color: #008080;">121</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">122</span> <span style="color: #008000;">     <em> 暂停下载<br></em></span><span style="color: #008080;">123</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">124</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> pause() {<br></span><span style="color: #008080;">125</span>         <span style="color: #0000ff;">for</span><span style="color: #000000;"> (DownloadTask task : tasks) {<br></span><span style="color: #008080;">126</span>             <span style="color: #0000ff;">if</span> (task != <span style="color: #0000ff;">null</span> &amp;&amp; (task.getStatus() == AsyncTask.Status.RUNNING || !<span style="color: #000000;">task.isCancelled())) {<br></span><span style="color: #008080;">127</span>                 task.cancel(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">128</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">129</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">130</span> <span style="color: #000000;">        tasks.clear();<br></span><span style="color: #008080;">131</span> <span style="color: #000000;">        appContent.setStatus(AppContent.Status.PAUSED);<br></span><span style="color: #008080;">132</span> <span style="color: #000000;">        DownloadFileDAO.getInstance(context.getApplicationContext()).updateDownloadFile(appContent);<br></span><span style="color: #008080;">133</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">134</span><br><span style="color: #008080;">135</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">136</span> <span style="color: #008000;">     <em> 将已下载大小归零<br></em></span><span style="color: #008080;">137</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">138</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> resetDownloadLength() {<br></span><span style="color: #008080;">139</span>         <span style="color: #0000ff;">this</span>.downloadLength = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">140</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">141</span><br><span style="color: #008080;">142</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">143</span> <span style="color: #008000;">     <em> 添加已下载大小<br></em></span><span style="color: #008080;">144</span> <span style="color: #008000;">      多线程访问需加锁<br></span><span style="color: #008080;">145</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> size<br></span><span style="color: #008080;">146</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">147</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">void</span> updateDownloadLength(<span style="color: #0000ff;">long</span><span style="color: #000000;"> size){<br></span><span style="color: #008080;">148</span>         <span style="color: #0000ff;">this</span>.downloadLength +=<span style="color: #000000;"> size;<br></span><span style="color: #008080;">149</span>         <span style="color: #008000;">//</span><span style="color: #008000;">通知更新界面</span><br><span style="color: #008080;">150</span>         <span style="color: #0000ff;">int</span> percent = (<span style="color: #0000ff;">int</span>)((<span style="color: #0000ff;">float</span>)downloadLength * 100 / (<span style="color: #0000ff;">float</span><span style="color: #000000;">)fileLength);<br></span><span style="color: #008080;">151</span> <span style="color: #000000;">        appContent.setDownloadPercent(percent);<br></span><span style="color: #008080;">152</span>         <span style="color: #0000ff;">if</span>(percent == 100 || downloadLength ==<span style="color: #000000;"> fileLength) {<br></span><span style="color: #008080;">153</span>             appContent.setDownloadPercent(100); <span style="color: #008000;">//</span><span style="color: #008000;">上面计算有时候会有点误差，算到percent=99</span><br><span style="color: #008080;">154</span> <span style="color: #000000;">            appContent.setStatus(AppContent.Status.FINISHED);<br></span><span style="color: #008080;">155</span> <span style="color: #000000;">            DownloadFileDAO.getInstance(context.getApplicationContext()).updateDownloadFile(appContent);<br></span><span style="color: #008080;">156</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">157</span>         Intent intent = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Intent(Constants.DOWNLOAD_MSG);<br></span><span style="color: #008080;">158</span>         <span style="color: #0000ff;">if</span>(appContent.getStatus() ==<span style="color: #000000;"> AppContent.Status.WAITING) {<br></span><span style="color: #008080;">159</span> <span style="color: #000000;">            appContent.setStatus(AppContent.Status.DOWNLOADING);<br></span><span style="color: #008080;">160</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">161</span>         Bundle bundle = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Bundle();<br></span><span style="color: #008080;">162</span>         bundle.putParcelable(“appContent”<span style="color: #000000;">, appContent);<br></span><span style="color: #008080;">163</span> <span style="color: #000000;">        intent.putExtras(bundle);<br></span><span style="color: #008080;">164</span> <span style="color: #000000;">        context.sendBroadcast(intent);<br></span><span style="color: #008080;">165</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">166</span><br><span style="color: #008080;">167</span>     <span style="color: #0000ff;">protected</span><span style="color: #000000;"> String getDownloadPath() {<br></span><span style="color: #008080;">168</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> downloadPath;<br></span><span style="color: #008080;">169</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">170</span><br><span style="color: #008080;">171</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">class</span> InnerHandler <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Handler {<br></span><span style="color: #008080;">172</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">173</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> handleMessage(Message msg) {<br></span><span style="color: #008080;">174</span>             <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (msg.what) {<br></span><span style="color: #008080;">175</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> GET_LENGTH_SUCCESS :<br></span><span style="color: #008080;">176</span> <span style="color: #000000;">                    beginDownload();<br></span><span style="color: #008080;">177</span>                     <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">178</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">179</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">.handleMessage(msg);<br></span><span style="color: #008080;">180</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">181</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">182</span> }</downloadtask></downloadinfo></downloadtask></pre><br></div>

<p><span style="font-size: 15px;">　　2、DownloadTask类</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.downloador;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.AsyncTask;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.Log;<br></span><span style="color: #008080;">  6</span><br><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.beans.DownloadInfo;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.db.DownloadInfoDAO;<br></span><span style="color: #008080;">  9</span><br><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.Header;<br></span><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.HttpResponse;<br></span><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.client.HttpClient;<br></span><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.client.methods.HttpGet;<br></span><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.impl.client.DefaultHttpClient;<br></span><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.message.BasicHeader;<br></span><span style="color: #008080;"> 16</span><br><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.File;<br></span><span style="color: #008080;"> 18</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.IOException;<br></span><span style="color: #008080;"> 19</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.InputStream;<br></span><span style="color: #008080;"> 20</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.OutputStream;<br></span><span style="color: #008080;"> 21</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.RandomAccessFile;<br></span><span style="color: #008080;"> 22</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.MalformedURLException;<br></span><span style="color: #008080;"> 23</span><br><span style="color: #008080;"> 24</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 25</span> <span style="color: #008000;">  @Class: DownloadTask<br></span><span style="color: #008080;"> 26</span> <span style="color: #008000;"> <em> @Description: 文件下载AsyncTask<br></em></span><span style="color: #008080;"> 27</span> <span style="color: #008000;">  </span><span style="color: #808080;">@author</span><span style="color: #008000;">: lling(www.cnblogs.com/liuling)<br></span><span style="color: #008080;"> 28</span> <span style="color: #008000;"> <em> @Date: 2015/10/13<br></em></span><span style="color: #008080;"> 29</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 30</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> DownloadTask <span style="color: #0000ff;">extends</span> AsyncTask<string, integer="" ,="" long=""><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 31</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “DownloadTask”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 32</span><br><span style="color: #008080;"> 33</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> taskId;<br></span><span style="color: #008080;"> 34</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> beginPosition;<br></span><span style="color: #008080;"> 35</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> endPosition;<br></span><span style="color: #008080;"> 36</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span><span style="color: #000000;"> downloadLength;<br></span><span style="color: #008080;"> 37</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String url;<br></span><span style="color: #008080;"> 38</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Downloador downloador;<br></span><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> DownloadInfoDAO downloadInfoDAO;<br></span><span style="color: #008080;"> 40</span><br><span style="color: #008080;"> 41</span><br><span style="color: #008080;"> 42</span>     <span style="color: #0000ff;">public</span> DownloadTask(<span style="color: #0000ff;">int</span> taskId, <span style="color: #0000ff;">long</span> beginPosition, <span style="color: #0000ff;">long</span><span style="color: #000000;"> endPosition, Downloador downloador,<br></span><span style="color: #008080;"> 43</span> <span style="color: #000000;">                        Context context) {<br></span><span style="color: #008080;"> 44</span>         <span style="color: #0000ff;">this</span>.taskId =<span style="color: #000000;"> taskId;<br></span><span style="color: #008080;"> 45</span>         <span style="color: #0000ff;">this</span>.beginPosition =<span style="color: #000000;"> beginPosition;<br></span><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">this</span>.endPosition =<span style="color: #000000;"> endPosition;<br></span><span style="color: #008080;"> 47</span>         <span style="color: #0000ff;">this</span>.downloador =<span style="color: #000000;"> downloador;<br></span><span style="color: #008080;"> 48</span>         downloadInfoDAO =<span style="color: #000000;"> DownloadInfoDAO.getInstance(context.getApplicationContext());<br></span><span style="color: #008080;"> 49</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 50</span><br><span style="color: #008080;"> 51</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 52</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPreExecute() {<br></span><span style="color: #008080;"> 53</span>         Log.e(TAG, “onPreExecute”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 54</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 55</span><br><span style="color: #008080;"> 56</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 57</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPostExecute(Long aLong) {<br></span><span style="color: #008080;"> 58</span>         Log.e(TAG, url + “taskId:” + taskId + “executed”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 59</span> <span style="color: #008000;">//</span><span style="color: #008000;">        downloador.updateDownloadInfo(null);</span><br><span style="color: #008080;"> 60</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 61</span><br><span style="color: #008080;"> 62</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 63</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onProgressUpdate(Integer… values) {<br></span><span style="color: #008080;"> 64</span>         <span style="color: #008000;">//</span><span style="color: #008000;">通知downloador增加已下载大小<br></span><span style="color: #008080;"> 65</span> <span style="color: #008000;">//</span><span style="color: #008000;">        downloador.updateDownloadLength(values[0]);</span><br><span style="color: #008080;"> 66</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 67</span><br><span style="color: #008080;"> 68</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 69</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCancelled() {<br></span><span style="color: #008080;"> 70</span>         Log.e(TAG, “onCancelled”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 71</span> <span style="color: #008000;">//</span><span style="color: #008000;">        downloador.updateDownloadInfo(null);</span><br><span style="color: #008080;"> 72</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 73</span><br><span style="color: #008080;"> 74</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 75</span>     <span style="color: #0000ff;">protected</span><span style="color: #000000;"> Long doInBackground(String… params) {<br></span><span style="color: #008080;"> 76</span>         <span style="color: #008000;">//</span><span style="color: #008000;">这里加判断的作用是：如果还处于等待就暂停了，运行到这里已经cancel了，就直接退出</span><br><span style="color: #008080;"> 77</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(isCancelled()) {<br></span><span style="color: #008080;"> 78</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 79</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 80</span>         url = params[0<span style="color: #000000;">];<br></span><span style="color: #008080;"> 81</span>         <span style="color: #0000ff;">if</span>(url == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 82</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 83</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 84</span>         HttpClient client = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DefaultHttpClient();<br></span><span style="color: #008080;"> 85</span>         HttpGet request = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HttpGet(url);<br></span><span style="color: #008080;"> 86</span> <span style="color: #000000;">        HttpResponse response;<br></span><span style="color: #008080;"> 87</span> <span style="color: #000000;">        InputStream is;<br></span><span style="color: #008080;"> 88</span>         RandomAccessFile fos = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 89</span>         OutputStream output = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 90</span><br><span style="color: #008080;"> 91</span>         DownloadInfo downloadInfo = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 92</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 93</span>             <span style="color: #008000;">//</span><span style="color: #008000;">本地文件</span><br><span style="color: #008080;"> 94</span>             File file = <span style="color: #0000ff;">new</span> File(downloador.getDownloadPath() + File.separator + url.substring(url.lastIndexOf(“/“) + 1<span style="color: #000000;">));<br></span><span style="color: #008080;"> 95</span><br><span style="color: #008080;"> 96</span>             <span style="color: #008000;">//</span><span style="color: #008000;">获取之前下载保存的信息</span><br><span style="color: #008080;"> 97</span>             downloadInfo =<span style="color: #000000;"> downloadInfoDAO.getDownloadInfoByTaskIdAndUrl(taskId, url);<br></span><span style="color: #008080;"> 98</span>             <span style="color: #008000;">//</span><span style="color: #008000;">从之前结束的位置继续下载<br></span><span style="color: #008080;"> 99</span>             <span style="color: #008000;">//</span><span style="color: #008000;">这里加了判断file.exists()，判断是否被用户删除了，如果文件没有下载完，但是已经被用户删除了，则重新下载</span><br><span style="color: #008080;">100</span>             <span style="color: #0000ff;">if</span>(file.exists() &amp;&amp; downloadInfo != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">101</span>                 <span style="color: #0000ff;">if</span>(downloadInfo.isDownloadSuccess() == 1<span style="color: #000000;">) {<br></span><span style="color: #008080;">102</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">下载完成直接结束</span><br><span style="color: #008080;">103</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">105</span>                 beginPosition = beginPosition +<span style="color: #000000;"> downloadInfo.getDownloadLength();<br></span><span style="color: #008080;">106</span>                 downloadLength =<span style="color: #000000;"> downloadInfo.getDownloadLength();<br></span><span style="color: #008080;">107</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">108</span>             <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">file.exists()) {<br></span><span style="color: #008080;">109</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">如果此task已经下载完，但是文件被用户删除，则需要重新设置已下载长度，重新下载</span><br><span style="color: #008080;">110</span> <span style="color: #000000;">                downloador.resetDownloadLength();<br></span><span style="color: #008080;">111</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">112</span><br><span style="color: #008080;">113</span>             <span style="color: #008000;">//</span><span style="color: #008000;">设置下载的数据位置beginPosition字节到endPosition字节</span><br><span style="color: #008080;">114</span>             Header header_size = <span style="color: #0000ff;">new</span> BasicHeader(“Range”, “bytes=” + beginPosition + “-“ +<span style="color: #000000;"> endPosition);<br></span><span style="color: #008080;">115</span> <span style="color: #000000;">            request.addHeader(header_size);<br></span><span style="color: #008080;">116</span>             <span style="color: #008000;">//</span><span style="color: #008000;">执行请求获取下载输入流</span><br><span style="color: #008080;">117</span>             response =<span style="color: #000000;"> client.execute(request);<br></span><span style="color: #008080;">118</span>             is =<span style="color: #000000;"> response.getEntity().getContent();<br></span><span style="color: #008080;">119</span><br><span style="color: #008080;">120</span>             <span style="color: #008000;">//</span><span style="color: #008000;">创建文件输出流</span><br><span style="color: #008080;">121</span>             fos = <span style="color: #0000ff;">new</span> RandomAccessFile(file, “rw”<span style="color: #000000;">);<br></span><span style="color: #008080;">122</span>             <span style="color: #008000;">//</span><span style="color: #008000;">从文件的size以后的位置开始写入</span><br><span style="color: #008080;">123</span> <span style="color: #000000;">            fos.seek(beginPosition);<br></span><span style="color: #008080;">124</span><br><span style="color: #008080;">125</span>             <span style="color: #0000ff;">byte</span> buffer [] = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">byte</span>[1024<span style="color: #000000;">];<br></span><span style="color: #008080;">126</span>             <span style="color: #0000ff;">int</span> inputSize = -1<span style="color: #000000;">;<br></span><span style="color: #008080;">127</span>             <span style="color: #0000ff;">while</span>((inputSize = is.read(buffer)) != -1<span style="color: #000000;">) {<br></span><span style="color: #008080;">128</span>                 fos.write(buffer, 0<span style="color: #000000;">, inputSize);<br></span><span style="color: #008080;">129</span>                 downloadLength +=<span style="color: #000000;"> inputSize;<br></span><span style="color: #008080;">130</span> <span style="color: #000000;">                downloador.updateDownloadLength(inputSize);<br></span><span style="color: #008080;">131</span><br><span style="color: #008080;">132</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">如果暂停了，需要将下载信息存入数据库</span><br><span style="color: #008080;">133</span>                 <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isCancelled()) {<br></span><span style="color: #008080;">134</span>                     <span style="color: #0000ff;">if</span>(downloadInfo == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">135</span>                         downloadInfo = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadInfo();<br></span><span style="color: #008080;">136</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">137</span> <span style="color: #000000;">                    downloadInfo.setUrl(url);<br></span><span style="color: #008080;">138</span> <span style="color: #000000;">                    downloadInfo.setDownloadLength(downloadLength);<br></span><span style="color: #008080;">139</span> <span style="color: #000000;">                    downloadInfo.setTaskId(taskId);<br></span><span style="color: #008080;">140</span>                     downloadInfo.setDownloadSuccess(0<span style="color: #000000;">);<br></span><span style="color: #008080;">141</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">保存下载信息到数据库</span><br><span style="color: #008080;">142</span> <span style="color: #000000;">                    downloadInfoDAO.insertDownloadInfo(downloadInfo);<br></span><span style="color: #008080;">143</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">144</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">145</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">146</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (MalformedURLException e) {<br></span><span style="color: #008080;">147</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">148</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;">149</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">150</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;">{<br></span><span style="color: #008080;">151</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;">{<br></span><span style="color: #008080;">152</span>                 <span style="color: #0000ff;">if</span> (request != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">153</span> <span style="color: #000000;">                    request.abort();<br></span><span style="color: #008080;">154</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">155</span>                 <span style="color: #0000ff;">if</span>(output != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">156</span> <span style="color: #000000;">                    output.close();<br></span><span style="color: #008080;">157</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">158</span>                 <span style="color: #0000ff;">if</span>(fos != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">159</span> <span style="color: #000000;">                    fos.close();<br></span><span style="color: #008080;">160</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">161</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;">(Exception e) {<br></span><span style="color: #008080;">162</span> <span style="color: #000000;">                e.printStackTrace();<br></span><span style="color: #008080;">163</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">164</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">165</span>         <span style="color: #008000;">//</span><span style="color: #008000;">执行到这里，说明该task已经下载完了</span><br><span style="color: #008080;">166</span>         <span style="color: #0000ff;">if</span>(downloadInfo == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">167</span>             downloadInfo = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadInfo();<br></span><span style="color: #008080;">168</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">169</span> <span style="color: #000000;">        downloadInfo.setUrl(url);<br></span><span style="color: #008080;">170</span> <span style="color: #000000;">        downloadInfo.setDownloadLength(downloadLength);<br></span><span style="color: #008080;">171</span> <span style="color: #000000;">        downloadInfo.setTaskId(taskId);<br></span><span style="color: #008080;">172</span>         downloadInfo.setDownloadSuccess(1<span style="color: #000000;">);<br></span><span style="color: #008080;">173</span>         <span style="color: #008000;">//</span><span style="color: #008000;">保存下载信息到数据库</span><br><span style="color: #008080;">174</span> <span style="color: #000000;">        downloadInfoDAO.insertDownloadInfo(downloadInfo);<br></span><span style="color: #008080;">175</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">176</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">177</span> }</string,></pre><br></div>

<p>　　<span style="font-size: 15px;">Downloador和DownloadTask只这个例子的核心代码，下面是关于数据库的，因为要实现断点续传必须要在暂停的时候将每个线程下载的位置记录下来，方便下次继续下载时读取。这里有两个表，一个是存放每个文件的下载状态的，一个是存放每个文件对应的每个线程的下载状态的。</span></p>
<p><span style="font-size: 15px;">　　3、DBHelper</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.db;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.database.sqlite.SQLiteDatabase;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.database.sqlite.SQLiteOpenHelper;<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 8</span> <span style="color: #008000;">  @Class: DBHelper<br></span><span style="color: #008080;"> 9</span> <span style="color: #008000;"> <em> @Description: 数据库帮助类<br></em></span><span style="color: #008080;">10</span> <span style="color: #008000;">  </span><span style="color: #808080;">@author</span><span style="color: #008000;">: lling(www.cnblogs.com/liuling)<br></span><span style="color: #008080;">11</span> <span style="color: #008000;"> <em> @Date: 2015/10/14<br></em></span><span style="color: #008080;">12</span>  <span style="color: #008000;">/</span><br><span style="color: #008080;">13</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> DBHelper <span style="color: #0000ff;">extends</span><span style="color: #000000;"> SQLiteOpenHelper {<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> DBHelper(Context context) {<br></span><span style="color: #008080;">16</span>         <span style="color: #0000ff;">super</span>(context, “download.db”, <span style="color: #0000ff;">null</span>, 1<span style="color: #000000;">);<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(SQLiteDatabase db) {<br></span><span style="color: #008080;">21</span>         db.execSQL(“create table download_info(_id INTEGER PRIMARY KEY AUTOINCREMENT, task_id INTEGER, “<br><span style="color: #008080;">22</span>                 + “download_length INTEGER, url VARCHAR(255), is_success INTEGER)”<span style="color: #000000;">);<br></span><span style="color: #008080;">23</span>         db.execSQL(“create table download_file(_id INTEGER PRIMARY KEY AUTOINCREMENT, app_name VARCHAR(255), “<br><span style="color: #008080;">24</span>                 + “url VARCHAR(255), download_percent INTEGER, status INTEGER)”<span style="color: #000000;">);<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">26</span><br><span style="color: #008080;">27</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">28</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> onUpgrade(SQLiteDatabase db, <span style="color: #0000ff;">int</span> oldVersion, <span style="color: #0000ff;">int</span><span style="color: #000000;"> newVersion) {<br></span><span style="color: #008080;">29</span><br><span style="color: #008080;">30</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">31</span> }</pre><br></div>

<p>　<span style="font-size: 15px;">　4、DownloadFileDAO，文件下载状态的数据库操作类</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.db;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.database.Cursor;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.database.sqlite.SQLiteDatabase;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.text.TextUtils;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.Log;<br></span><span style="color: #008080;">  8</span><br><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.beans.AppContent;<br></span><span style="color: #008080;"> 10</span><br><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;"> 13</span><br><span style="color: #008080;"> 14</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 15</span> <span style="color: #008000;"> <em> @Class: DownloadFileDAO<br></em></span><span style="color: #008080;"> 16</span> <span style="color: #008000;">  @Description: 每个文件下载状态记录的数据库操作类<br></span><span style="color: #008080;"> 17</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;">: lling(www.cnblogs.com/liuling)<br></span><span style="color: #008080;"> 18</span> <span style="color: #008000;">  @Date: 2015/10/13<br></span><span style="color: #008080;"> 19</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 20</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> DownloadFileDAO {<br></span><span style="color: #008080;"> 21</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “DownloadFileDAO”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> DownloadFileDAO dao=<span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 23</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br></span><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> DownloadFileDAO(Context context) {<br></span><span style="color: #008080;"> 25</span>         <span style="color: #0000ff;">this</span>.context=<span style="color: #000000;">context;<br></span><span style="color: #008080;"> 26</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 27</span><br><span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> DownloadFileDAO getInstance(Context context){<br></span><span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">if</span>(dao==<span style="color: #0000ff;">null</span><span style="color: #000000;">){<br></span><span style="color: #008080;"> 30</span>             dao=<span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadFileDAO(context);<br></span><span style="color: #008080;"> 31</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 32</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> dao;<br></span><span style="color: #008080;"> 33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 34</span><br><span style="color: #008080;"> 35</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 36</span> <span style="color: #008000;">     <em> 获取数据库连接<br></em></span><span style="color: #008080;"> 37</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 38</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> SQLiteDatabase getConnection() {<br></span><span style="color: #008080;"> 40</span>         SQLiteDatabase sqliteDatabase = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 41</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 42</span>             sqliteDatabase= <span style="color: #0000ff;">new</span><span style="color: #000000;"> DBHelper(context).getReadableDatabase();<br></span><span style="color: #008080;"> 43</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 44</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;"> 45</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> sqliteDatabase;<br></span><span style="color: #008080;"> 47</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 50</span> <span style="color: #008000;">      插入数据<br></span><span style="color: #008080;"> 51</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> appContent<br></span><span style="color: #008080;"> 52</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 53</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> insertDownloadFile(AppContent appContent) {<br></span><span style="color: #008080;"> 54</span>         <span style="color: #0000ff;">if</span>(appContent == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 55</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 56</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 57</span>         <span style="color: #008000;">//</span><span style="color: #008000;">如果本地已经存在，直接修改</span><br><span style="color: #008080;"> 58</span>         <span style="color: #0000ff;">if</span>(getAppContentByUrl(appContent.getUrl()) != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 59</span> <span style="color: #000000;">            updateDownloadFile(appContent);<br></span><span style="color: #008080;"> 60</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 62</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;"> 63</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 64</span>             String sql = “insert into download_file(app_name, url, download_percent, status) values (?,?,?,?)”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 65</span>             Object[] bindArgs =<span style="color: #000000;"> { appContent.getName(), appContent.getUrl(), appContent.getDownloadPercent()<br></span><span style="color: #008080;"> 66</span> <span style="color: #000000;">                    , appContent.getStatus().getValue()};<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">            database.execSQL(sql, bindArgs);<br></span><span style="color: #008080;"> 68</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 69</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;"> 70</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 71</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;"> 72</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;"> 73</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 74</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 75</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 76</span><br><span style="color: #008080;"> 77</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 78</span> <span style="color: #008000;">     <em> 根据url获取下载文件信息<br></em></span><span style="color: #008080;"> 79</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> url<br></span><span style="color: #008080;"> 80</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 81</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 82</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> AppContent getAppContentByUrl(String url) {<br></span><span style="color: #008080;"> 83</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(TextUtils.isEmpty(url)) {<br></span><span style="color: #008080;"> 84</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 85</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 86</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;"> 87</span>         AppContent appContent = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 88</span>         Cursor cursor = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 89</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 90</span>             String sql = “select * from download_file where url=?”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 91</span>             cursor = database.rawQuery(sql, <span style="color: #0000ff;">new</span><span style="color: #000000;"> String[] { url });<br></span><span style="color: #008080;"> 92</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (cursor.moveToNext()) {<br></span><span style="color: #008080;"> 93</span>                 appContent = <span style="color: #0000ff;">new</span> AppContent(cursor.getString(1), cursor.getString(2<span style="color: #000000;">));<br></span><span style="color: #008080;"> 94</span>                 appContent.setDownloadPercent(cursor.getInt(3<span style="color: #000000;">));<br></span><span style="color: #008080;"> 95</span>                 appContent.setStatus(AppContent.Status.getByValue(cursor.getInt(4<span style="color: #000000;">)));<br></span><span style="color: #008080;"> 96</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 97</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 98</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;"> 99</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">100</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;">101</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;">102</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">103</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> cursor) {<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">                cursor.close();<br></span><span style="color: #008080;">105</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">106</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">107</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> appContent;<br></span><span style="color: #008080;">108</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">109</span><br><span style="color: #008080;">110</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">111</span> <span style="color: #008000;">     <em> 更新下载信息<br></em></span><span style="color: #008080;">112</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> appContent<br></span><span style="color: #008080;">113</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">114</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> updateDownloadFile(AppContent appContent) {<br></span><span style="color: #008080;">115</span>         <span style="color: #0000ff;">if</span>(appContent == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">116</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">117</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">118</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;">119</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">120</span>             Log.e(TAG, “update download_file,app name:” + appContent.getName() + “,url:” +<span style="color: #000000;"> appContent.getUrl()<br></span><span style="color: #008080;">121</span>                     + “,percent” + appContent.getDownloadPercent() + “,status:” +<span style="color: #000000;"> appContent.getStatus().getValue());<br></span><span style="color: #008080;">122</span>             String sql = “update download_file set app_name=?, url=?, download_percent=?, status=? where url=?”<span style="color: #000000;">;<br></span><span style="color: #008080;">123</span>             Object[] bindArgs =<span style="color: #000000;"> {appContent.getName(), appContent.getUrl(), appContent.getDownloadPercent()<br></span><span style="color: #008080;">124</span> <span style="color: #000000;">                    , appContent.getStatus().getValue(), appContent.getUrl()};<br></span><span style="color: #008080;">125</span> <span style="color: #000000;">            database.execSQL(sql, bindArgs);<br></span><span style="color: #008080;">126</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">127</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">128</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">129</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;">130</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;">131</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">132</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">133</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">134</span><br><span style="color: #008080;">135</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">136</span> <span style="color: #008000;">      获取所有下载文件记录<br></span><span style="color: #008080;">137</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">138</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">139</span>     <span style="color: #0000ff;">public</span> List<appcontent><span style="color: #000000;"> getAll() {<br></span><span style="color: #008080;">140</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;">141</span>         List<appcontent> list = <span style="color: #0000ff;">new</span> ArrayList<appcontent><span style="color: #000000;">();<br></span><span style="color: #008080;">142</span>         Cursor cursor = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">143</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">144</span>             String sql = “select <em> from download_file”<span style="color: #000000;">;<br></span><span style="color: #008080;">145</span>             cursor = database.rawQuery(sql, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">146</span>             <span style="color: #0000ff;">while</span><span style="color: #000000;"> (cursor.moveToNext()) {<br></span><span style="color: #008080;">147</span>                 AppContent appContent = <span style="color: #0000ff;">new</span> AppContent(cursor.getString(1), cursor.getString(2<span style="color: #000000;">));<br></span><span style="color: #008080;">148</span>                 appContent.setDownloadPercent(cursor.getInt(3<span style="color: #000000;">));<br></span><span style="color: #008080;">149</span>                 appContent.setStatus(AppContent.Status.getByValue(cursor.getInt(4<span style="color: #000000;">)));<br></span><span style="color: #008080;">150</span> <span style="color: #000000;">                list.add(appContent);<br></span><span style="color: #008080;">151</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">152</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">153</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">154</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">155</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;">156</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;">157</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">158</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> cursor) {<br></span><span style="color: #008080;">159</span> <span style="color: #000000;">                cursor.close();<br></span><span style="color: #008080;">160</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">161</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">162</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> list;<br></span><span style="color: #008080;">163</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">164</span><br><span style="color: #008080;">165</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">166</span> <span style="color: #008000;">     </span></em> 根据url删除记录<br><span style="color: #008080;">167</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> url<br></span><span style="color: #008080;">168</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">169</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> delByUrl(String url) {<br></span><span style="color: #008080;">170</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(TextUtils.isEmpty(url)) {<br></span><span style="color: #008080;">171</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">172</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">173</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;">174</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">175</span>             String sql = “delete from download_file where url=?”<span style="color: #000000;">;<br></span><span style="color: #008080;">176</span>             Object[] bindArgs =<span style="color: #000000;"> { url };<br></span><span style="color: #008080;">177</span> <span style="color: #000000;">            database.execSQL(sql, bindArgs);<br></span><span style="color: #008080;">178</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">179</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">180</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">181</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;">182</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;">183</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">184</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">185</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">186</span><br><span style="color: #008080;">187</span> }</appcontent></appcontent></appcontent></pre><br></div>

<p>　　<span style="font-size: 15px;">5、DownloadInfoDAO，每个线程对应下载状态的数据库操作类</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.db;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.database.Cursor;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.database.sqlite.SQLiteDatabase;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.text.TextUtils;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.Log;<br></span><span style="color: #008080;">  8</span><br><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> com.bbk.lling.multitaskdownload.beans.DownloadInfo;<br></span><span style="color: #008080;"> 10</span><br><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;"> 13</span><br><span style="color: #008080;"> 14</span> <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 15</span> <span style="color: #008000;"> <em> @Class: DownloadInfoDAO<br></em></span><span style="color: #008080;"> 16</span> <span style="color: #008000;">  @Description: 每个单独线程下载信息记录的数据库操作类<br></span><span style="color: #008080;"> 17</span> <span style="color: #008000;"> <em> </em></span><span style="color: #808080;">@author</span><span style="color: #008000;">: lling(www.cnblogs.com/liuling)<br></span><span style="color: #008080;"> 18</span> <span style="color: #008000;">  @Date: 2015/10/13<br></span><span style="color: #008080;"> 19</span>  <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 20</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span><span style="color: #000000;"> DownloadInfoDAO {<br></span><span style="color: #008080;"> 21</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “DownloadInfoDAO”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> DownloadInfoDAO dao=<span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 23</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Context context;<br></span><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;">  DownloadInfoDAO(Context context) {<br></span><span style="color: #008080;"> 25</span>         <span style="color: #0000ff;">this</span>.context=<span style="color: #000000;">context;<br></span><span style="color: #008080;"> 26</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 27</span><br><span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span><span style="color: #000000;"> DownloadInfoDAO getInstance(Context context){<br></span><span style="color: #008080;"> 29</span>         <span style="color: #0000ff;">if</span>(dao==<span style="color: #0000ff;">null</span><span style="color: #000000;">){<br></span><span style="color: #008080;"> 30</span>             dao=<span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadInfoDAO(context);<br></span><span style="color: #008080;"> 31</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 32</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> dao;<br></span><span style="color: #008080;"> 33</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 34</span><br><span style="color: #008080;"> 35</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 36</span> <span style="color: #008000;">     <em> 获取数据库连接<br></em></span><span style="color: #008080;"> 37</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;"> 38</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> SQLiteDatabase getConnection() {<br></span><span style="color: #008080;"> 40</span>         SQLiteDatabase sqliteDatabase = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 41</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 42</span>             sqliteDatabase= <span style="color: #0000ff;">new</span><span style="color: #000000;"> DBHelper(context).getReadableDatabase();<br></span><span style="color: #008080;"> 43</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 44</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;"> 45</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> sqliteDatabase;<br></span><span style="color: #008080;"> 47</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 48</span><br><span style="color: #008080;"> 49</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;"> 50</span> <span style="color: #008000;">      插入数据<br></span><span style="color: #008080;"> 51</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> downloadInfo<br></span><span style="color: #008080;"> 52</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 53</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> insertDownloadInfo(DownloadInfo downloadInfo) {<br></span><span style="color: #008080;"> 54</span>         <span style="color: #0000ff;">if</span>(downloadInfo == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 55</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 56</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 57</span>         <span style="color: #008000;">//</span><span style="color: #008000;">如果本地已经存在，直接修改</span><br><span style="color: #008080;"> 58</span>         <span style="color: #0000ff;">if</span>(getDownloadInfoByTaskIdAndUrl(downloadInfo.getTaskId(), downloadInfo.getUrl()) != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 59</span> <span style="color: #000000;">            updateDownloadInfo(downloadInfo);<br></span><span style="color: #008080;"> 60</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 62</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;"> 63</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 64</span>             String sql = “insert into download_info(task_id, download_length, url, is_success) values (?,?,?,?)”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 65</span>             Object[] bindArgs =<span style="color: #000000;"> { downloadInfo.getTaskId(), downloadInfo.getDownloadLength(),<br></span><span style="color: #008080;"> 66</span> <span style="color: #000000;">                    downloadInfo.getUrl(), downloadInfo.isDownloadSuccess()};<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">            database.execSQL(sql, bindArgs);<br></span><span style="color: #008080;"> 68</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 69</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;"> 70</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 71</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;"> 72</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;"> 73</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 74</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 75</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 76</span><br><span style="color: #008080;"> 77</span>     <span style="color: #0000ff;">public</span> List<downloadinfo><span style="color: #000000;"> getDownloadInfosByUrl(String url) {<br></span><span style="color: #008080;"> 78</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(TextUtils.isEmpty(url)) {<br></span><span style="color: #008080;"> 79</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 80</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 81</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;"> 82</span>         List<downloadinfo> list = <span style="color: #0000ff;">new</span> ArrayList<downloadinfo><span style="color: #000000;">();<br></span><span style="color: #008080;"> 83</span>         Cursor cursor = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 84</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 85</span>             String sql = “select <em> from download_info where url=?”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 86</span>             cursor = database.rawQuery(sql, <span style="color: #0000ff;">new</span><span style="color: #000000;"> String[] { url });<br></span><span style="color: #008080;"> 87</span>             <span style="color: #0000ff;">while</span><span style="color: #000000;"> (cursor.moveToNext()) {<br></span><span style="color: #008080;"> 88</span>                 DownloadInfo info = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadInfo();<br></span><span style="color: #008080;"> 89</span>                 info.setTaskId(cursor.getInt(1<span style="color: #000000;">));<br></span><span style="color: #008080;"> 90</span>                 info.setDownloadLength(cursor.getLong(2<span style="color: #000000;">));<br></span><span style="color: #008080;"> 91</span>                 info.setDownloadSuccess(cursor.getInt(4<span style="color: #000000;">));<br></span><span style="color: #008080;"> 92</span>                 info.setUrl(cursor.getString(3<span style="color: #000000;">));<br></span><span style="color: #008080;"> 93</span> <span style="color: #000000;">                list.add(info);<br></span><span style="color: #008080;"> 94</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 95</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 96</span> <span style="color: #000000;">            e.printStackTrace();<br></span><span style="color: #008080;"> 97</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 98</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;"> 99</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;">100</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">101</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> cursor) {<br></span><span style="color: #008080;">102</span> <span style="color: #000000;">                cursor.close();<br></span><span style="color: #008080;">103</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">104</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">105</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> list;<br></span><span style="color: #008080;">106</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">107</span><br><span style="color: #008080;">108</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">109</span> <span style="color: #008000;">     </span></em> 根据taskid和url获取下载信息<br><span style="color: #008080;">110</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> taskId<br></span><span style="color: #008080;">111</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> url<br></span><span style="color: #008080;">112</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@return</span><br><span style="color: #008080;">113</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">114</span>     <span style="color: #0000ff;">public</span> DownloadInfo getDownloadInfoByTaskIdAndUrl(<span style="color: #0000ff;">int</span><span style="color: #000000;"> taskId, String url) {<br></span><span style="color: #008080;">115</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;">(TextUtils.isEmpty(url)) {<br></span><span style="color: #008080;">116</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">117</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">118</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;">119</span>         DownloadInfo info = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">120</span>         Cursor cursor = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">121</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">122</span>             String sql = “select <em> from download_info where url=? and task_id=?”<span style="color: #000000;">;<br></span><span style="color: #008080;">123</span>             cursor = database.rawQuery(sql, <span style="color: #0000ff;">new</span><span style="color: #000000;"> String[] { url, String.valueOf(taskId) });<br></span><span style="color: #008080;">124</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (cursor.moveToNext()) {<br></span><span style="color: #008080;">125</span>                 info = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadInfo();<br></span><span style="color: #008080;">126</span>                 info.setTaskId(cursor.getInt(1<span style="color: #000000;">));<br></span><span style="color: #008080;">127</span>                 info.setDownloadLength(cursor.getLong(2<span style="color: #000000;">));<br></span><span style="color: #008080;">128</span>                 info.setDownloadSuccess(cursor.getInt(4<span style="color: #000000;">));<br></span><span style="color: #008080;">129</span>                 info.setUrl(cursor.getString(3<span style="color: #000000;">));<br></span><span style="color: #008080;">130</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">131</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">132</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">133</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">134</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;">135</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;">136</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">137</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> cursor) {<br></span><span style="color: #008080;">138</span> <span style="color: #000000;">                cursor.close();<br></span><span style="color: #008080;">139</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">140</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">141</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> info;<br></span><span style="color: #008080;">142</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">143</span><br><span style="color: #008080;">144</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">145</span> <span style="color: #008000;">     </span></em> 更新下载信息<br><span style="color: #008080;">146</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> downloadInfo<br></span><span style="color: #008080;">147</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">148</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> updateDownloadInfo(DownloadInfo downloadInfo) {<br></span><span style="color: #008080;">149</span>         <span style="color: #0000ff;">if</span>(downloadInfo == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">150</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">151</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">152</span>         SQLiteDatabase database =<span style="color: #000000;"> getConnection();<br></span><span style="color: #008080;">153</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">154</span>             String sql = “update download_info set download_length=?, is_success=? where task_id=? and url=?”<span style="color: #000000;">;<br></span><span style="color: #008080;">155</span>             Object[] bindArgs =<span style="color: #000000;"> { downloadInfo.getDownloadLength(), downloadInfo.isDownloadSuccess(),<br></span><span style="color: #008080;">156</span> <span style="color: #000000;">                    downloadInfo.getTaskId(), downloadInfo.getUrl() };<br></span><span style="color: #008080;">157</span> <span style="color: #000000;">            database.execSQL(sql, bindArgs);<br></span><span style="color: #008080;">158</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">159</span> <span style="color: #000000;">            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">160</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">161</span>             <span style="color: #0000ff;">if</span> (<span style="color: #0000ff;">null</span> !=<span style="color: #000000;"> database) {<br></span><span style="color: #008080;">162</span> <span style="color: #000000;">                database.close();<br></span><span style="color: #008080;">163</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">164</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">165</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">166</span><br><span style="color: #008080;">167</span> }</downloadinfo></downloadinfo></downloadinfo></pre><br></div>

<p>　　<span style="font-size: 15px;">具体的界面和使用代码我就不贴代码了，代码有点多。需要的可以下载Demo的源码看看。</span></p>
<p><span style="font-size: 15px;">　　因为还没有花太多时间去测，里面难免会有些bug，如果大家发现什么问题，欢迎留言探讨，谢谢！</span></p>
<p><span style="color: #ff0000;"><strong>源码下载：</strong><a href="https://github.com/liuling07/MultiTaskAndThreadDownload" title="https://github.com/liuling07/MultiTaskAndThreadDownload" target="_blank" rel="external"><span style="color: #000000;">https://github.com/liuling07/MultiTaskAndThreadDownload</span></a></span></p>
<p>&nbsp;</p>
<p>原创内容，转载请注明出处：<a href="http://www.cnblogs.com/liuling/p/2015-10-16-01.html" title="http://www.cnblogs.com/liuling/p/2015-10-16-01.html" target="_blank" rel="external">http://www.cnblogs.com/liuling/p/2015-10-16-01.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2015/10/asynctask-multi-task-thread.html" data-id="ciiy5f4xy00eaq1d0vcggywdr" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2015/10/asynctask-multi-task-thread.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AsyncTask/">AsyncTask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多线程/">多线程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/断点续传/">断点续传</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-customview-download-percent" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/customview-download-percent.html">Android中使用自定义View实现下载进度的显示</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2015/10/customview-download-percent.html">
      <time datetime="2015-10-15T02:09:00.000Z" itemprop="datePublished">2015-10-15</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p><span style="font-size: 15px;">　　一般有下载功能的应用都会有这样一个场景，需要一个图标来标识不同的状态。之前在公司的项目中写过一个，今天抽空来整理一下。</span></p>
<p><span style="font-size: 15px;">　　一般下载都会有这么几种状态：未开始、等待、正在下载、下载结束，当然有时候会有下载出错的状态。等待状态是指用户点击开始下载，但是线程池中没有空闲的线程来处理该次下载，所以状态为等待。</span></p>
<p><strong><span style="font-size: 15px;">效果图：</span></strong></p>
<p><span style="font-size: 15px;"><img src="http://www.liuling123.com/wp-content/uploads/2015/11/420264-20151015180126929-146101307.gif" alt=""></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>　　<span style="font-size: 15px;">这里我只是演示了一下下载和暂停的状态，其他状态没有演示，在代码中设置就可以了。</span></p>
<p><span style="font-size: 15px;"><strong>实现代码：</strong></span></p>
<p><span style="font-size: 15px;">1、自定义View</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> DownloadPercentView <span style="color: #0000ff;">extends</span><span style="color: #000000;"> View {<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> STATUS_PEDDING = 1<span style="color: #000000;">;<br></span><span style="color: #008080;">  4</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> STATUS_WAITING = 2<span style="color: #000000;">;<br></span><span style="color: #008080;">  5</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> STATUS_DOWNLOADING = 3<span style="color: #000000;">;<br></span><span style="color: #008080;">  6</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> STATUS_PAUSED = 4<span style="color: #000000;">;<br></span><span style="color: #008080;">  7</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> STATUS_FINISHED = 5<span style="color: #000000;">;<br></span><span style="color: #008080;">  8</span><br><span style="color: #008080;">  9</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 画实心圆的画笔</span><br><span style="color: #008080;"> 10</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Paint mCirclePaint;<br></span><span style="color: #008080;"> 11</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 画圆环的画笔</span><br><span style="color: #008080;"> 12</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Paint mRingPaint;<br></span><span style="color: #008080;"> 13</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 绘制进度文字的画笔</span><br><span style="color: #008080;"> 14</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Paint mTxtPaint;<br></span><span style="color: #008080;"> 15</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 圆形颜色</span><br><span style="color: #008080;"> 16</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> mCircleColor;<br></span><span style="color: #008080;"> 17</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 圆环颜色</span><br><span style="color: #008080;"> 18</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> mRingColor;<br></span><span style="color: #008080;"> 19</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 半径</span><br><span style="color: #008080;"> 20</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> mRadius;<br></span><span style="color: #008080;"> 21</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 圆环宽度</span><br><span style="color: #008080;"> 22</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> mStrokeWidth = 2<span style="color: #000000;">;<br></span><span style="color: #008080;"> 23</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 圆心x坐标</span><br><span style="color: #008080;"> 24</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> mXCenter;<br></span><span style="color: #008080;"> 25</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 圆心y坐标</span><br><span style="color: #008080;"> 26</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> mYCenter;<br></span><span style="color: #008080;"> 27</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 总进度</span><br><span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> mTotalProgress = 100<span style="color: #000000;">;<br></span><span style="color: #008080;"> 29</span>     <span style="color: #008000;">//</span><span style="color: #008000;"> 当前进度</span><br><span style="color: #008080;"> 30</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> mProgress;<br></span><span style="color: #008080;"> 31</span>     <span style="color: #008000;">//</span><span style="color: #008000;">下载状态</span><br><span style="color: #008080;"> 32</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> mStatus = 1<span style="color: #000000;">;<br></span><span style="color: #008080;"> 33</span><br><span style="color: #008080;"> 34</span>     <span style="color: #008000;">//</span><span style="color: #008000;">默认显示的图片</span><br><span style="color: #008080;"> 35</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Bitmap mNotBeginImg;<br></span><span style="color: #008080;"> 36</span>     <span style="color: #008000;">//</span><span style="color: #008000;">暂停时中间显示的图片</span><br><span style="color: #008080;"> 37</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Bitmap mPausedImg;<br></span><span style="color: #008080;"> 38</span>     <span style="color: #008000;">//</span><span style="color: #008000;">等待时显示的图片</span><br><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Bitmap mWatiImg;<br></span><span style="color: #008080;"> 40</span>     <span style="color: #008000;">//</span><span style="color: #008000;">下载完成时显示的图片</span><br><span style="color: #008080;"> 41</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Bitmap finishedImg;<br></span><span style="color: #008080;"> 42</span><br><span style="color: #008080;"> 43</span><br><span style="color: #008080;"> 44</span><br><span style="color: #008080;"> 45</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> DownloadPercentView(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;"> 46</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">(context, attrs);<br></span><span style="color: #008080;"> 47</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> 获取自定义的属性</span><br><span style="color: #008080;"> 48</span> <span style="color: #000000;">        initAttrs(context, attrs);<br></span><span style="color: #008080;"> 49</span> <span style="color: #000000;">        initVariable();<br></span><span style="color: #008080;"> 50</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 51</span><br><span style="color: #008080;"> 52</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> initAttrs(Context context, AttributeSet attrs) {<br></span><span style="color: #008080;"> 53</span>         TypedArray typeArray =<span style="color: #000000;"> context.getTheme().obtainStyledAttributes(attrs,<br></span><span style="color: #008080;"> 54</span>                 R.styleable.DownloadPercentView, 0, 0<span style="color: #000000;">);<br></span><span style="color: #008080;"> 55</span>         mRadius = (<span style="color: #0000ff;">int</span>)typeArray.getDimension(R.styleable.DownloadPercentView_radius, 100<span style="color: #000000;">);<br></span><span style="color: #008080;"> 56</span>         mNotBeginImg =<span style="color: #000000;"> ((BitmapDrawable)typeArray.getDrawable(R.styleable.DownloadPercentView_notBeginImg)).getBitmap();<br></span><span style="color: #008080;"> 57</span>         mPausedImg =<span style="color: #000000;"> ((BitmapDrawable)typeArray.getDrawable(R.styleable.DownloadPercentView_pausedImg)).getBitmap();<br></span><span style="color: #008080;"> 58</span>         mWatiImg =<span style="color: #000000;"> ((BitmapDrawable)typeArray.getDrawable(R.styleable.DownloadPercentView_waitImg)).getBitmap();<br></span><span style="color: #008080;"> 59</span>         finishedImg =<span style="color: #000000;"> ((BitmapDrawable)typeArray.getDrawable(R.styleable.DownloadPercentView_finishedImg)).getBitmap();<br></span><span style="color: #008080;"> 60</span><br><span style="color: #008080;"> 61</span>         mNotBeginImg = big(mNotBeginImg, mRadius <em> 2, mRadius </em> 2<span style="color: #000000;">);<br></span><span style="color: #008080;"> 62</span>         mPausedImg = big(mPausedImg, mRadius <em> 2, mRadius </em> 2<span style="color: #000000;">);<br></span><span style="color: #008080;"> 63</span>         mWatiImg = big(mWatiImg, mRadius <em> 2, mRadius </em> 2<span style="color: #000000;">);<br></span><span style="color: #008080;"> 64</span>         finishedImg = big(finishedImg, mRadius <em> 2, mRadius </em> 2<span style="color: #000000;">);<br></span><span style="color: #008080;"> 65</span><br><span style="color: #008080;"> 66</span>         mStrokeWidth = (<span style="color: #0000ff;">int</span>)typeArray.getDimension(R.styleable.DownloadPercentView_strokeWidth, 2<span style="color: #000000;">);<br></span><span style="color: #008080;"> 67</span><br><span style="color: #008080;"> 68</span> <span style="color: #008000;">//</span><span style="color: #008000;">        mRadius = Math.max(mNotBeginImg.getWidth()/2, mNotBeginImg.getHeight()/2) + mStrokeWidth;</span><br><span style="color: #008080;"> 69</span>         mCircleColor = typeArray.getColor(R.styleable.DownloadPercentView_circleColor, 0xFFFFFFFF<span style="color: #000000;">);<br></span><span style="color: #008080;"> 70</span>         mRingColor = typeArray.getColor(R.styleable.DownloadPercentView_ringColor, 0xFFFFFFFF<span style="color: #000000;">);<br></span><span style="color: #008080;"> 71</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 72</span><br><span style="color: #008080;"> 73</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> initVariable() {<br></span><span style="color: #008080;"> 74</span>         <span style="color: #008000;">//</span><span style="color: #008000;">初始化绘制灰色圆的画笔</span><br><span style="color: #008080;"> 75</span>         mCirclePaint = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Paint();<br></span><span style="color: #008080;"> 76</span>         mCirclePaint.setAntiAlias(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 77</span> <span style="color: #000000;">        mCirclePaint.setColor(mCircleColor);<br></span><span style="color: #008080;"> 78</span> <span style="color: #000000;">        mCirclePaint.setStyle(Paint.Style.STROKE);<br></span><span style="color: #008080;"> 79</span> <span style="color: #000000;">        mCirclePaint.setStrokeWidth(mStrokeWidth);<br></span><span style="color: #008080;"> 80</span><br><span style="color: #008080;"> 81</span>         <span style="color: #008000;">//</span><span style="color: #008000;">初始化绘制圆弧的画笔</span><br><span style="color: #008080;"> 82</span>         mRingPaint = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Paint();<br></span><span style="color: #008080;"> 83</span>         mRingPaint.setAntiAlias(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 84</span> <span style="color: #000000;">        mRingPaint.setColor(mRingColor);<br></span><span style="color: #008080;"> 85</span> <span style="color: #000000;">        mRingPaint.setStyle(Paint.Style.STROKE);<br></span><span style="color: #008080;"> 86</span> <span style="color: #000000;">        mRingPaint.setStrokeWidth(mStrokeWidth);<br></span><span style="color: #008080;"> 87</span><br><span style="color: #008080;"> 88</span>         <span style="color: #008000;">//</span><span style="color: #008000;">初始化绘制文字的画笔</span><br><span style="color: #008080;"> 89</span>         mTxtPaint = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Paint();<br></span><span style="color: #008080;"> 90</span>         mTxtPaint.setAntiAlias(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 91</span>         mTxtPaint.setColor(Color.parseColor(“#52ce90”<span style="color: #000000;">));<br></span><span style="color: #008080;"> 92</span> <span style="color: #000000;">        mTxtPaint.setTextAlign(Paint.Align.CENTER);<br></span><span style="color: #008080;"> 93</span>         mTxtPaint.setTextSize(24<span style="color: #000000;">);<br></span><span style="color: #008080;"> 94</span><br><span style="color: #008080;"> 95</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 96</span><br><span style="color: #008080;"> 97</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 98</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span> onMeasure(<span style="color: #0000ff;">int</span> widthMeasureSpec, <span style="color: #0000ff;">int</span><span style="color: #000000;"> heightMeasureSpec) {<br></span><span style="color: #008080;"> 99</span>         <span style="color: #0000ff;">int</span> width = (<span style="color: #0000ff;">int</span>)Math.ceil(mRadius) <em> 2<span style="color: #000000;">;<br></span><span style="color: #008080;">100</span> <span style="color: #000000;">        setMeasuredDimension(width, width);<br></span><span style="color: #008080;">101</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">102</span><br><span style="color: #008080;">103</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">104</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDraw(Canvas canvas) {<br></span><span style="color: #008080;">105</span>         mXCenter = getWidth() / 2<span style="color: #000000;">;<br></span><span style="color: #008080;">106</span>         mYCenter = getHeight() / 2<span style="color: #000000;">;<br></span><span style="color: #008080;">107</span>         <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (mStatus) {<br></span><span style="color: #008080;">108</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> STATUS_PEDDING:<br></span><span style="color: #008080;">109</span>                 canvas.drawBitmap(mNotBeginImg, 0, 0, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">110</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">111</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> STATUS_WAITING:<br></span><span style="color: #008080;">112</span>                 canvas.drawBitmap(mWatiImg, 0, 0, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">113</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">114</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> STATUS_DOWNLOADING:<br></span><span style="color: #008080;">115</span> <span style="color: #000000;">                drawDownloadingView(canvas);<br></span><span style="color: #008080;">116</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">117</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> STATUS_PAUSED:<br></span><span style="color: #008080;">118</span> <span style="color: #000000;">                drawPausedView(canvas);<br></span><span style="color: #008080;">119</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">120</span>             <span style="color: #0000ff;">case</span><span style="color: #000000;"> STATUS_FINISHED:<br></span><span style="color: #008080;">121</span>                 canvas.drawBitmap(finishedImg, 0, 0, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">122</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">123</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">124</span><br><span style="color: #008080;">125</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">126</span><br><span style="color: #008080;">127</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">128</span> <span style="color: #008000;">     </span></em> 绘制下载中的view<br><span style="color: #008080;">129</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> canvas<br></span><span style="color: #008080;">130</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">131</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> drawDownloadingView(Canvas canvas) {<br></span><span style="color: #008080;">132</span>         <span style="color: #008000;">//</span><span style="color: #008000;">绘制灰色圆环</span><br><span style="color: #008080;">133</span>         canvas.drawCircle(mXCenter, mYCenter, mRadius - mStrokeWidth/2<span style="color: #000000;">, mCirclePaint);<br></span><span style="color: #008080;">134</span><br><span style="color: #008080;">135</span>         <span style="color: #008000;">//</span><span style="color: #008000;">绘制进度扇形圆环</span><br><span style="color: #008080;">136</span>         RectF oval = <span style="color: #0000ff;">new</span><span style="color: #000000;"> RectF();<br></span><span style="color: #008080;">137</span>         <span style="color: #008000;">//</span><span style="color: #008000;">设置椭圆上下左右的坐标</span><br><span style="color: #008080;">138</span>         oval.left = mXCenter - mRadius + mStrokeWidth/2<span style="color: #000000;">;<br></span><span style="color: #008080;">139</span>         oval.top = mYCenter - mRadius + mStrokeWidth/2<span style="color: #000000;">;<br></span><span style="color: #008080;">140</span>         oval.right = mXCenter + mRadius - mStrokeWidth/2<span style="color: #000000;">;<br></span><span style="color: #008080;">141</span>         oval.bottom = mYCenter + mRadius - mStrokeWidth/2<span style="color: #000000;">;<br></span><span style="color: #008080;">142</span>         canvas.drawArc(oval, -90, ((<span style="color: #0000ff;">float</span>)mProgress / mTotalProgress) <em> 360, <span style="color: #0000ff;">false</span><span style="color: #000000;">, mRingPaint);<br></span><span style="color: #008080;">143</span><br><span style="color: #008080;">144</span>         <span style="color: #008000;">//</span><span style="color: #008000;">绘制中间百分比文字</span><br><span style="color: #008080;">145</span>         String percentTxt =<span style="color: #000000;"> String.valueOf(mProgress);<br></span><span style="color: #008080;">146</span>         <span style="color: #008000;">//</span><span style="color: #008000;">计算文字垂直居中的baseline</span><br><span style="color: #008080;">147</span>         Paint.FontMetricsInt fontMetrics =<span style="color: #000000;"> mTxtPaint.getFontMetricsInt();<br></span><span style="color: #008080;">148</span>         <span style="color: #0000ff;">float</span> baseline = oval.top + (oval.bottom - oval.top - fontMetrics.bottom + fontMetrics.top) / 2 -<span style="color: #000000;"> fontMetrics.top;<br></span><span style="color: #008080;">149</span> <span style="color: #000000;">        canvas.drawText(percentTxt, mXCenter, baseline, mTxtPaint);<br></span><span style="color: #008080;">150</span><br><span style="color: #008080;">151</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">152</span><br><span style="color: #008080;">153</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">154</span> <span style="color: #008000;">     </span></em> 绘制暂停时的view<br><span style="color: #008080;">155</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> canvas<br></span><span style="color: #008080;">156</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">157</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> drawPausedView(Canvas canvas) {<br></span><span style="color: #008080;">158</span>         <span style="color: #008000;">//</span><span style="color: #008000;">绘制灰色圆环</span><br><span style="color: #008080;">159</span>         canvas.drawCircle(mXCenter, mYCenter, mRadius - mStrokeWidth/2<span style="color: #000000;">, mCirclePaint);<br></span><span style="color: #008080;">160</span><br><span style="color: #008080;">161</span>         <span style="color: #008000;">//</span><span style="color: #008000;">绘制进度扇形圆环</span><br><span style="color: #008080;">162</span>         RectF oval = <span style="color: #0000ff;">new</span><span style="color: #000000;"> RectF();<br></span><span style="color: #008080;">163</span>         <span style="color: #008000;">//</span><span style="color: #008000;">设置椭圆上下左右的坐标</span><br><span style="color: #008080;">164</span>         oval.left = mXCenter - mRadius + mStrokeWidth/2<span style="color: #000000;">;<br></span><span style="color: #008080;">165</span>         oval.top = mYCenter - mRadius + mStrokeWidth/2<span style="color: #000000;">;<br></span><span style="color: #008080;">166</span>         oval.right = mXCenter + mRadius - mStrokeWidth/2<span style="color: #000000;">;<br></span><span style="color: #008080;">167</span>         oval.bottom = mYCenter + mRadius - mStrokeWidth/2<span style="color: #000000;">;<br></span><span style="color: #008080;">168</span>         canvas.drawArc(oval, -90, ((<span style="color: #0000ff;">float</span>) mProgress / mTotalProgress) <em> 360, <span style="color: #0000ff;">false</span><span style="color: #000000;">, mRingPaint);<br></span><span style="color: #008080;">169</span><br><span style="color: #008080;">170</span>         <span style="color: #008000;">//</span><span style="color: #008000;">绘制中间暂停图标</span><br><span style="color: #008080;">171</span>         canvas.drawBitmap(mPausedImg, 0, 0, <span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">172</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">173</span><br><span style="color: #008080;">174</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">175</span> <span style="color: #008000;">     </span></em> 更新进度<br><span style="color: #008080;">176</span> <span style="color: #008000;">     <em> </em></span><span style="color: #808080;">@param</span><span style="color: #008000;"> progress<br></span><span style="color: #008080;">177</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">178</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setProgress(<span style="color: #0000ff;">int</span><span style="color: #000000;"> progress) {<br></span><span style="color: #008080;">179</span>         mProgress =<span style="color: #000000;"> progress;<br></span><span style="color: #008080;">180</span> <span style="color: #000000;">        postInvalidate();<br></span><span style="color: #008080;">181</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">182</span><br><span style="color: #008080;">183</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">184</span> <span style="color: #008000;">     <em> 设置下载状态<br></em></span><span style="color: #008080;">185</span> <span style="color: #008000;">      </span><span style="color: #808080;">@param</span><span style="color: #008000;"> status<br></span><span style="color: #008080;">186</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">187</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setStatus(<span style="color: #0000ff;">int</span><span style="color: #000000;"> status) {<br></span><span style="color: #008080;">188</span>         <span style="color: #0000ff;">this</span>.mStatus =<span style="color: #000000;"> status;<br></span><span style="color: #008080;">189</span> <span style="color: #000000;">        postInvalidate();<br></span><span style="color: #008080;">190</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">191</span><br><span style="color: #008080;">192</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">193</span> <span style="color: #008000;">     <em> 获取下载状态<br></em></span><span style="color: #008080;">194</span> <span style="color: #008000;">      </span><span style="color: #808080;">@return</span><br><span style="color: #008080;">195</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;">196</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getStatus() {<br></span><span style="color: #008080;">197</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> mStatus;<br></span><span style="color: #008080;">198</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">199</span><br><span style="color: #008080;">200</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> Bitmap big(Bitmap b,<span style="color: #0000ff;">float</span> x,<span style="color: #0000ff;">float</span><span style="color: #000000;"> y)<br></span><span style="color: #008080;">201</span> <span style="color: #000000;">    {<br></span><span style="color: #008080;">202</span>         <span style="color: #0000ff;">int</span> w=<span style="color: #000000;">b.getWidth();<br></span><span style="color: #008080;">203</span>         <span style="color: #0000ff;">int</span> h=<span style="color: #000000;">b.getHeight();<br></span><span style="color: #008080;">204</span>         <span style="color: #0000ff;">float</span> sx=(<span style="color: #0000ff;">float</span>)x/<span style="color: #000000;">w;<br></span><span style="color: #008080;">205</span>         <span style="color: #0000ff;">float</span> sy=(<span style="color: #0000ff;">float</span>)y/<span style="color: #000000;">h;<br></span><span style="color: #008080;">206</span>         Matrix matrix = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Matrix();<br></span><span style="color: #008080;">207</span>         matrix.postScale(sx, sy); <span style="color: #008000;">//</span><span style="color: #008000;"> 长和宽放大缩小的比例</span><br><span style="color: #008080;">208</span>         Bitmap resizeBmp = Bitmap.createBitmap(b, 0, 0<span style="color: #000000;">, w,<br></span><span style="color: #008080;">209</span>                 h, matrix, <span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">210</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> resizeBmp;<br></span><span style="color: #008080;">211</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">212</span><br><span style="color: #008080;">213</span> }</pre><br></div>

<p><span style="font-size: 15px;">2、自定义属性</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;?</span><span style="color: #ff00ff;">xml version=”1.0” encoding=”utf-8”</span><span style="color: #0000ff;">?&gt;</span><br><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">resources</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">declare-styleable </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”DownloadPercentView”</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">attr </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”radius”</span><span style="color: #ff0000;"> format</span><span style="color: #0000ff;">=”dimension”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">attr </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”notBeginImg”</span><span style="color: #ff0000;"> format</span><span style="color: #0000ff;">=”string”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">attr </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”waitImg”</span><span style="color: #ff0000;"> format</span><span style="color: #0000ff;">=”string”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">attr </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”pausedImg”</span><span style="color: #ff0000;"> format</span><span style="color: #0000ff;">=”string”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">attr </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”finishedImg”</span><span style="color: #ff0000;"> format</span><span style="color: #0000ff;">=”string”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">10</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">attr </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”strokeWidth”</span><span style="color: #ff0000;"> format</span><span style="color: #0000ff;">=”dimension”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">11</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">attr </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”circleColor”</span><span style="color: #ff0000;"> format</span><span style="color: #0000ff;">=”color”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">12</span>         <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">attr </span><span style="color: #ff0000;">name</span><span style="color: #0000ff;">=”ringColor”</span><span style="color: #ff0000;"> format</span><span style="color: #0000ff;">=”color”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">13</span>     <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">declare-styleable</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">resources</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p><span style="font-size: 15px;">3、使用自定义布局</span></p>
<p><span style="font-size: 15px;">　　首先在布局文件中引用：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">RelativeLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="external">http://schemas.android.com/apk/res/android</a>“</span><br><span style="color: #008080;"> 2</span> <span style="color: #ff0000;">    xmlns:custom</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res-auto" target="_blank" rel="external">http://schemas.android.com/apk/res-auto</a>“</span><br><span style="color: #008080;"> 3</span> <span style="color: #ff0000;">    xmlns:tools</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/tools" target="_blank" rel="external">http://schemas.android.com/tools</a>“</span><br><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">    android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">    android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"> android:paddingLeft</span><span style="color: #0000ff;">=”@dimen/activity_horizontal_margin”</span><br><span style="color: #008080;"> 6</span> <span style="color: #ff0000;">    android:paddingRight</span><span style="color: #0000ff;">=”@dimen/activity_horizontal_margin”</span><br><span style="color: #008080;"> 7</span> <span style="color: #ff0000;">    android:paddingTop</span><span style="color: #0000ff;">=”@dimen/activity_vertical_margin”</span><br><span style="color: #008080;"> 8</span> <span style="color: #ff0000;">    android:paddingBottom</span><span style="color: #0000ff;">=”@dimen/activity_vertical_margin”</span><span style="color: #ff0000;"> tools:context</span><span style="color: #0000ff;">=”.MainActivity”</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">com.bbk.lling.downloadpercentdemo.DownloadPercentView<br></span><span style="color: #008080;">11</span>         <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/downloadView”</span><br><span style="color: #008080;">12</span> <span style="color: #ff0000;">        android:layout_width</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">13</span> <span style="color: #ff0000;">        android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">14</span> <span style="color: #ff0000;">        android:layout_centerInParent</span><span style="color: #0000ff;">=”true”</span><br><span style="color: #008080;">15</span> <span style="color: #ff0000;">        custom:notBeginImg</span><span style="color: #0000ff;">=”@drawable/ic_no_download”</span><br><span style="color: #008080;">16</span> <span style="color: #ff0000;">        custom:waitImg</span><span style="color: #0000ff;">=”@drawable/ic_wait”</span><br><span style="color: #008080;">17</span> <span style="color: #ff0000;">        custom:pausedImg</span><span style="color: #0000ff;">=”@drawable/ic_pause”</span><br><span style="color: #008080;">18</span> <span style="color: #ff0000;">        custom:finishedImg</span><span style="color: #0000ff;">=”@drawable/ic_finished”</span><br><span style="color: #008080;">19</span> <span style="color: #ff0000;">        custom:strokeWidth</span><span style="color: #0000ff;">=”2dp”</span><br><span style="color: #008080;">20</span> <span style="color: #ff0000;">        custom:circleColor</span><span style="color: #0000ff;">=”#bdbdbd”</span><br><span style="color: #008080;">21</span> <span style="color: #ff0000;">        custom:radius</span><span style="color: #0000ff;">=”18dp”</span><br><span style="color: #008080;">22</span> <span style="color: #ff0000;">        custom:ringColor</span><span style="color: #0000ff;">=”#52ce90”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">RelativeLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>&nbsp;</p>
<p>　　<span style="font-size: 15px;">然后我这里在Activity使用一个线程来模拟下载过程来演示：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.downloadpercentdemo;<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.app.Activity;<br></span><span style="color: #008080;"> 4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Handler;<br></span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Message;<br></span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Activity {<br></span><span style="color: #008080;">11</span><br><span style="color: #008080;">12</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> MSG_UPDATE = 1<span style="color: #000000;">;<br></span><span style="color: #008080;">13</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> MSG_FINISHED = 2<span style="color: #000000;">;<br></span><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> DownloadPercentView mDownloadPercentView;<br></span><span style="color: #008080;">16</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> mDownloadProgress = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">17</span>     <span style="color: #0000ff;">private</span> Handler mHandler = <span style="color: #0000ff;">new</span><span style="color: #000000;"> InnerHandler();<br></span><span style="color: #008080;">18</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">boolean</span> downloading = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">21</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;">22</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">        setContentView(R.layout.activity_main);<br></span><span style="color: #008080;">24</span>         mDownloadPercentView =<span style="color: #000000;"> (DownloadPercentView) findViewById(R.id.downloadView);<br></span><span style="color: #008080;">25</span>         mDownloadPercentView.setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener() {<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">27</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v) {<br></span><span style="color: #008080;">28</span>                 <span style="color: #0000ff;">if</span>(mDownloadPercentView.getStatus() ==<span style="color: #000000;"> DownloadPercentView.STATUS_PEDDING<br></span><span style="color: #008080;">29</span>                         || mDownloadPercentView.getStatus() ==<span style="color: #000000;"> DownloadPercentView.STATUS_PAUSED) {<br></span><span style="color: #008080;">30</span>                     downloading = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">31</span> <span style="color: #000000;">                    mDownloadPercentView.setStatus(DownloadPercentView.STATUS_DOWNLOADING);<br></span><span style="color: #008080;">32</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">模拟下载</span><br><span style="color: #008080;">33</span>                     <span style="color: #0000ff;">new</span> Thread(<span style="color: #0000ff;">new</span><span style="color: #000000;"> Runnable() {<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">                        @Override<br></span><span style="color: #008080;">35</span>                         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;">36</span>                             <span style="color: #0000ff;">while</span><span style="color: #000000;"> (downloading) {<br></span><span style="color: #008080;">37</span>                                 <span style="color: #0000ff;">if</span>(mDownloadProgress == 100<span style="color: #000000;">) {<br></span><span style="color: #008080;">38</span> <span style="color: #000000;">                                    mHandler.sendEmptyMessage(MSG_FINISHED);<br></span><span style="color: #008080;">39</span>                                     <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">                                }<br></span><span style="color: #008080;">41</span>                                 mDownloadProgress += 1<span style="color: #000000;">;<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">                                mHandler.sendEmptyMessage(MSG_UPDATE);<br></span><span style="color: #008080;">43</span>                                 <span style="color: #0000ff;">try</span><span style="color: #000000;">{<br></span><span style="color: #008080;">44</span>                                     Thread.sleep(100<span style="color: #000000;">);<br></span><span style="color: #008080;">45</span>                                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">46</span> <span style="color: #000000;">                                }<br></span><span style="color: #008080;">47</span><br><span style="color: #008080;">48</span> <span style="color: #000000;">                            }<br></span><span style="color: #008080;">49</span> <span style="color: #000000;">                        }<br></span><span style="color: #008080;">50</span> <span style="color: #000000;">                    }).start();<br></span><span style="color: #008080;">51</span>                 } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span>(mDownloadPercentView.getStatus() ==<span style="color: #000000;"> DownloadPercentView.STATUS_DOWNLOADING){<br></span><span style="color: #008080;">52</span>                     downloading = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">53</span> <span style="color: #000000;">                    mDownloadPercentView.setStatus(DownloadPercentView.STATUS_PAUSED);<br></span><span style="color: #008080;">54</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">55</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">56</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">57</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">58</span><br><span style="color: #008080;">59</span>     <span style="color: #0000ff;">class</span> InnerHandler <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Handler {<br></span><span style="color: #008080;">60</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">61</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> handleMessage(Message msg) {<br></span><span style="color: #008080;">62</span>             <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (msg.what) {<br></span><span style="color: #008080;">63</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> MSG_FINISHED:<br></span><span style="color: #008080;">64</span> <span style="color: #000000;">                    mDownloadPercentView.setStatus(DownloadPercentView.STATUS_FINISHED);<br></span><span style="color: #008080;">65</span>                     <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">66</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> MSG_UPDATE:<br></span><span style="color: #008080;">67</span> <span style="color: #000000;">                    mDownloadPercentView.setProgress(mDownloadProgress);<br></span><span style="color: #008080;">68</span>                     <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">69</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">70</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">.handleMessage(msg);<br></span><span style="color: #008080;">71</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">72</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">73</span><br><span style="color: #008080;">74</span><br><span style="color: #008080;">75</span> }</pre><br></div>

<p>&nbsp;</p>
<p><span style="font-size: 15px;"><span style="color: #ff0000;"><strong>源码下载：</strong></span><a href="https://github.com/liuling07/DownloadPercentDemo" title="https://github.com/liuling07/DownloadPercentDemo" target="_blank" rel="external">https://github.com/liuling07/DownloadPercentDemo</a></span></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2015/10/customview-download-percent.html" data-id="ciiy5f4wy00cmq1d02pqbuhy4" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2015/10/customview-download-percent.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/自定义控件/">自定义控件</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-parcelable-example" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/parcelable-example.html">Android中Parcelable接口的使用</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2015/10/parcelable-example.html">
      <time datetime="2015-10-13T22:46:00.000Z" itemprop="datePublished">2015-10-14</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p><span style="font-size: 15px;">　　在做开发的过程中，序列化是非常常见的。比如要将对象保存本地磁盘或者在网络上传输等。实现序列化有两种方式，一种是实现Serializable接口，第二种是实现Parcelable。</span></p>
<p><span style="font-size: 15px;"><strong>Serializable与Parcelable的区别</strong></span></p>
<p><span style="font-size: 15px;">　　1、Serializable是JDK提供的接口，而Parcelable是Android SDK提供的。</span></p>
<p><span style="font-size: 15px;">　　2、Serializable序列化是基于磁盘的，而Parcelable是基于内存的。在内存中读写肯定效率要高于磁盘，所以Android中跨进程传递对象都是使用Parcelable。</span></p>
<p><strong>Parcelable接口定义</strong></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span><span style="color: #000000;"> Parcelable {<br></span><span style="color: #008080;"> 2</span>     <span style="color: #008000;">//</span><span style="color: #008000;">内容描述接口，基本不用管</span><br><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> describeContents();<br></span><span style="color: #008080;"> 4</span>     <span style="color: #008000;">//</span><span style="color: #008000;">写入接口函数，打包</span><br><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> writeToParcel(Parcel dest, <span style="color: #0000ff;">int</span><span style="color: #000000;"> flags);<br></span><span style="color: #008080;"> 6</span>      <span style="color: #008000;">//</span><span style="color: #008000;">读取接口，目的是要从Parcel中构造一个实现了Parcelable的类的实例处理。因为实现类在这里还是不可知的，所以需要用到模板的方式，继承类名通过模板参数传入。<br></span><span style="color: #008080;"> 7</span>     <span style="color: #008000;">//</span><span style="color: #008000;">为了能够实现模板参数的传入，这里定义Creator嵌入接口,内含两个接口函数分别返回单个和多个继承类实例。</span><br><span style="color: #008080;"> 8</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">interface</span> Creator<t><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 9</span>            <span style="color: #0000ff;">public</span><span style="color: #000000;"> T createFromParcel(Parcel source);<br></span><span style="color: #008080;">10</span>            <span style="color: #0000ff;">public</span> T[] newArray(<span style="color: #0000ff;">int</span><span style="color: #000000;"> size);<br></span><span style="color: #008080;">11</span>        }</t></pre><br></div>

<p><span style="font-size: 15px;">　　从parcelable接口定义中，我们可以看到，实现parcelable接口，需要我们实现下面几个方法：</span></p>
<p><span style="font-size: 15px;">&nbsp;&nbsp; 　　1.describeContents方法。内容接口描述，默认返回0就可以;</span></p>
<p><span style="font-size: 15px;">&nbsp;&nbsp;　　 2.writeToParcel 方法。该方法将类的数据写入外部提供的Parcel中.即打包需要传递的数据到Parcel容器保存，以便从parcel容器获取数据，该方法声明如下：</span></p>
<p><span style="font-size: 15px;">&nbsp;&nbsp;&nbsp;&nbsp;　　　　writeToParcel (Parcel dest, int flags) 具体参数含义见javadoc</span></p>
<p><span style="font-size: 15px;">&nbsp;&nbsp; 　　3.静态的Parcelable.Creator接口，本接口有两个方法：</span></p>
<p><span style="font-size: 15px;">&nbsp;&nbsp;&nbsp;&nbsp;　　　　createFromParcel(Parcel in)&nbsp; 从Parcel容器中读取传递数据值，封装成Parcelable对象返回逻辑层。</span></p>
<p><span style="font-size: 15px;">&nbsp;&nbsp;&nbsp;&nbsp;　　　　newArray(int size) 创建一个类型为T，长度为size的数组，仅一句话（return new T[size])即可。方法是供外部类反序列化本类数组使用。</span></p>
<p>&nbsp;</p>
<p><strong>Parcelable的使用</strong></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> AppContent <span style="color: #0000ff;">implements</span><span style="color: #000000;"> Serializable, Parcelable {<br></span><span style="color: #008080;"> 2</span>     <span style="color: #008000;">//</span><span style="color: #008000;">应用名字</span><br><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String name;<br></span><span style="color: #008080;"> 4</span>     <span style="color: #008000;">//</span><span style="color: #008000;">应用下载链接</span><br><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> String url;<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">int</span> downloadPercent = 0<span style="color: #000000;">;<br></span><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">private</span> Status status =<span style="color: #000000;"> Status.PENDING;<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> AppContent(String name, String url) {<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">this</span>.name =<span style="color: #000000;"> name;<br></span><span style="color: #008080;">13</span>         <span style="color: #0000ff;">this</span>.url =<span style="color: #000000;"> url;<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String getName() {<br></span><span style="color: #008080;">17</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> name;<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setName(String name) {<br></span><span style="color: #008080;">21</span>         <span style="color: #0000ff;">this</span>.name =<span style="color: #000000;"> name;<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String getUrl() {<br></span><span style="color: #008080;">25</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> url;<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">27</span><br><span style="color: #008080;">28</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setUrl(String url) {<br></span><span style="color: #008080;">29</span>         <span style="color: #0000ff;">this</span>.url =<span style="color: #000000;"> url;<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">31</span><br><span style="color: #008080;">32</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> getDownloadPercent() {<br></span><span style="color: #008080;">33</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> downloadPercent;<br></span><span style="color: #008080;">34</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">35</span><br><span style="color: #008080;">36</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> setDownloadPercent(<span style="color: #0000ff;">int</span><span style="color: #000000;"> downloadPercent) {<br></span><span style="color: #008080;">37</span>         <span style="color: #0000ff;">this</span>.downloadPercent =<span style="color: #000000;"> downloadPercent;<br></span><span style="color: #008080;">38</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">39</span><br><span style="color: #008080;">40</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> Status getStatus() {<br></span><span style="color: #008080;">41</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> status;<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">43</span><br><span style="color: #008080;">44</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setStatus(Status status) {<br></span><span style="color: #008080;">45</span>         <span style="color: #0000ff;">this</span>.status =<span style="color: #000000;"> status;<br></span><span style="color: #008080;">46</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">47</span><br><span style="color: #008080;">48</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">49</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String toString() {<br></span><span style="color: #008080;">50</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> name;<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">52</span><br><span style="color: #008080;">53</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">54</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">int</span><span style="color: #000000;"> describeContents() {<br></span><span style="color: #008080;">55</span>         <span style="color: #0000ff;">return</span> 0<span style="color: #000000;">;<br></span><span style="color: #008080;">56</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">57</span><br><span style="color: #008080;">58</span>     <span style="color: #008000;">//</span><span style="color: #008000;">实现Parcel接口必须覆盖实现的方法</span><br><span style="color: #008080;">59</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">60</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> writeToParcel(Parcel dest, <span style="color: #0000ff;">int</span><span style="color: #000000;"> flags) {<br></span><span style="color: #008080;">61</span>         <span style="color: #008000;">/<em></em></span><span style="color: #008000;">将AppContent的成员写入Parcel，<br></span><span style="color: #008080;">62</span> <span style="color: #008000;">          注：Parcel中的数据是按顺序写入和读取的，即先被写入的就会先被读取出来<br></span><span style="color: #008080;">63</span>          <span style="color: #008000;">*/</span><br><span style="color: #008080;">64</span> <span style="color: #000000;">        dest.writeString(name);<br></span><span style="color: #008080;">65</span> <span style="color: #000000;">        dest.writeString(url);<br></span><span style="color: #008080;">66</span> <span style="color: #000000;">        dest.writeInt(downloadPercent);<br></span><span style="color: #008080;">67</span> <span style="color: #000000;">        dest.writeValue(status);<br></span><span style="color: #008080;">68</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">69</span><br><span style="color: #008080;">70</span>     <span style="color: #008000;">//</span><span style="color: #008000;">该静态域是必须要有的，而且名字必须是CREATOR，否则会出错</span><br><span style="color: #008080;">71</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> Parcelable.Creator<appcontent> CREATOR =<br><span style="color: #008080;">72</span>             <span style="color: #0000ff;">new</span> Parcelable.Creator<appcontent><span style="color: #000000;">() {<br></span><span style="color: #008080;">73</span><br><span style="color: #008080;">74</span> <span style="color: #000000;">                @Override<br></span><span style="color: #008080;">75</span>                 <span style="color: #0000ff;">public</span><span style="color: #000000;"> AppContent createFromParcel(Parcel source) {<br></span><span style="color: #008080;">76</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">从Parcel读取通过writeToParcel方法写入的AppContent的相关成员信息</span><br><span style="color: #008080;">77</span>                     String name =<span style="color: #000000;"> source.readString();<br></span><span style="color: #008080;">78</span>                     String url =<span style="color: #000000;"> source.readString();<br></span><span style="color: #008080;">79</span>                     <span style="color: #0000ff;">int</span> downloadPercent =<span style="color: #000000;"> source.readInt();<br></span><span style="color: #008080;">80</span>                     Status status = (Status)source.readValue(<span style="color: #0000ff;">new</span><span style="color: #000000;"> ClassLoader(){});<br></span><span style="color: #008080;">81</span>                     AppContent appContent = <span style="color: #0000ff;">new</span><span style="color: #000000;"> AppContent(name, url);<br></span><span style="color: #008080;">82</span> <span style="color: #000000;">                    appContent.setDownloadPercent(downloadPercent);<br></span><span style="color: #008080;">83</span> <span style="color: #000000;">                    appContent.setStatus(status);<br></span><span style="color: #008080;">84</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">更加读取到的信息，创建返回Person对象</span><br><span style="color: #008080;">85</span>                     <span style="color: #0000ff;">return</span><span style="color: #000000;"> appContent;<br></span><span style="color: #008080;">86</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">87</span><br><span style="color: #008080;">88</span> <span style="color: #000000;">                @Override<br></span><span style="color: #008080;">89</span>                 <span style="color: #0000ff;">public</span> AppContent[] newArray(<span style="color: #0000ff;">int</span><span style="color: #000000;"> size)<br></span><span style="color: #008080;">90</span> <span style="color: #000000;">                {<br></span><span style="color: #008080;">91</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> TODO Auto-generated method stub<br></span><span style="color: #008080;">92</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">返回AppContent对象数组</span><br><span style="color: #008080;">93</span>                     <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> AppContent[size];<br></span><span style="color: #008080;">94</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">95</span> <span style="color: #000000;">            };<br></span><span style="color: #008080;">96</span><br><span style="color: #008080;">97</span> }</appcontent></appcontent></pre><br></div>

<p>　　通过Intent进行传递：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span>    Intent intent = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Intent(Constants.DOWNLOAD_MSG);<br></span><span style="color: #008080;">2</span>    Bundle bundle = <span style="color: #0000ff;">new</span><span style="color: #000000;"> Bundle();<br></span><span style="color: #008080;">3</span>    bundle.putParcelable(“appContent”<span style="color: #000000;">, appContent);<br></span><span style="color: #008080;">4</span>    intent.putExtras(bundle);</pre><br></div>

<p>&nbsp;</p>
<p>　　参考：<a href="http://www.tuicool.com/articles/MJzAZn" title="http://www.tuicool.com/articles/MJzAZn" target="_blank" rel="external">http://www.tuicool.com/articles/MJzAZn</a>，感谢作者。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2015/10/parcelable-example.html" data-id="ciiy5f4r7003qq1d0j067707u" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2015/10/parcelable-example.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-asynctask-multithread-download" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/asynctask-multithread-download.html">AsyncTask实现多线程断点续传</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2015/10/asynctask-multithread-download.html">
      <time datetime="2015-10-13T04:11:00.000Z" itemprop="datePublished">2015-10-13</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　<span style="font-size: 15px;">前面一篇博客<a href="http://www.cnblogs.com/liuling/p/2015-10-10-01.html" title="AsyncTask实现断点续传" target="_blank" rel="external">《AsyncTask实现断点续传》</a>讲解了如何实现单线程下的断点续传，也就是一个文件只有一个线程进行下载。</span></p>
<p><span style="font-size: 15px;">　 &nbsp; 对于大文件而言，使用多线程下载就会比单线程下载要快一些。多线程下载相比单线程下载要稍微复杂一点，本博文将详细讲解如何使用AsyncTask来实现多线程的断点续传下载。</span></p>
<p><span style="font-size: 15px;"><strong>一、实现原理</strong></span></p>
<p><span style="font-size: 15px;">　　多线程下载首先要通过每个文件总的下载线程数（我这里设定5个）来确定每个线程所负责下载的起止位置。</span></p>
<div class="cnblogs_code"><br><pre>        <span style="color: #0000ff;">long</span> blockLength = mFileLength /<span style="color: #000000;"> DEFAULT_POOL_SIZE;<br>        </span><span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; DEFAULT_POOL_SIZE; i++<span style="color: #000000;">) {<br>            </span><span style="color: #0000ff;">long</span> beginPosition = i <em> blockLength;<span style="color: #008000;">//</span><span style="color: #008000;">每条线程下载的开始位置</span><br>            <span style="color: #0000ff;">long</span> endPosition = (i + 1) </em> blockLength;<span style="color: #008000;">//</span><span style="color: #008000;">每条线程下载的结束位置</span><br>            <span style="color: #0000ff;">if</span> (i == (DEFAULT_POOL_SIZE - 1<span style="color: #000000;">)) {<br>                endPosition </span>= mFileLength;<span style="color: #008000;">//</span><span style="color: #008000;">如果整个文件的大小不为线程个数的整数倍，则最后一个线程的结束位置即为文件的总长度</span><br><span style="color: #000000;">            }<br>           ……<br>        }</span></pre><br></div>

<p>　　<span style="font-size: 15px;">这里需要注意的是，文件大小往往不是线程个数的整数倍，所以最后一个线程的结束位置需要设置为文件长度。</span></p>
<p><span style="font-size: 15px;">　　确定好每个线程的下载起止位置之后，需要设置http请求头来下载文件的指定位置：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span>       <span style="color: #008000;">//</span><span style="color: #008000;">设置下载的数据位置beginPosition字节到endPosition字节</span><br><span style="color: #008080;">2</span>       Header header_size = <span style="color: #0000ff;">new</span> BasicHeader(“Range”, “bytes=” + beginPosition + “-“ +<span style="color: #000000;"> endPosition);<br></span><span style="color: #008080;">3</span>       request.addHeader(header_size);</pre><br></div>

<p>　　以上是多线程下载的原理，但是还要实现断点续传需要在每次暂停之后记录每个线程已下载的大小，下次继续下载时从上次下载后的位置开始下载。一般项目中都会存数据库中，我这里为了简单起见直接存在了SharedPreferences中，已下载url和线程编号作为key值。</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #000000;">       @Override<br></span><span style="color: #008080;"> 2</span>         <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPostExecute(Long aLong) {<br></span><span style="color: #008080;"> 3</span>             Log.i(TAG, “download success “<span style="color: #000000;">);<br></span><span style="color: #008080;"> 4</span>             <span style="color: #008000;">//</span><span style="color: #008000;">下载完成移除记录</span><br><span style="color: #008080;"> 5</span> <span style="color: #000000;">            mSharedPreferences.edit().remove(currentThreadIndex).commit();<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 7</span><br><span style="color: #008080;"> 8</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCancelled() {<br></span><span style="color: #008080;">10</span>             Log.i(TAG, “download cancelled “<span style="color: #000000;">);<br></span><span style="color: #008080;">11</span>             <span style="color: #008000;">//</span><span style="color: #008000;">记录已下载大小current</span><br><span style="color: #008080;">12</span> <span style="color: #000000;">            mSharedPreferences.edit().putLong(currentThreadIndex, current).commit();<br></span><span style="color: #008080;">13</span>         }</pre><br></div>

<p>　　下载的时候，首先获取已下载位置，如果已经下载过，就从上次下载后的位置开始下载：</p>
<div class="cnblogs_code"><br><pre>      <span style="color: #008000;">//</span><span style="color: #008000;">获取之前下载保存的信息，从之前结束的位置继续下载<br>      </span><span style="color: #008000;">//</span><span style="color: #008000;">这里加了判断file.exists()，判断是否被用户删除了，如果文件没有下载完，但是已经被用户删除了，则重新下载</span><br>      <span style="color: #0000ff;">long</span> downedPosition = mSharedPreferences.getLong(currentThreadIndex, 0<span style="color: #000000;">);<br>      </span><span style="color: #0000ff;">if</span>(file.exists() &amp;&amp; downedPosition != 0<span style="color: #000000;">) {<br>          beginPosition </span>= beginPosition +<span style="color: #000000;"> downedPosition;<br>          current </span>=<span style="color: #000000;"> downedPosition;<br>          </span><span style="color: #0000ff;">synchronized</span><span style="color: #000000;"> (mCurrentLength) {<br>               mCurrentLength </span>+=<span style="color: #000000;"> downedPosition;<br>          }<br>      }</span></pre><br></div>

<p>&nbsp;</p>
<p><strong>二、完整代码</strong></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.multithreaddownload;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.app.Activity;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.Context;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.content.SharedPreferences;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.AsyncTask;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Environment;<br></span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Handler;<br></span><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Message;<br></span><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.Log;<br></span><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.ProgressBar;<br></span><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.TextView;<br></span><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.Toast;<br></span><span style="color: #008080;"> 16</span><br><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.Header;<br></span><span style="color: #008080;"> 18</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.HttpResponse;<br></span><span style="color: #008080;"> 19</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.client.HttpClient;<br></span><span style="color: #008080;"> 20</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.client.methods.HttpGet;<br></span><span style="color: #008080;"> 21</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.impl.client.DefaultHttpClient;<br></span><span style="color: #008080;"> 22</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.message.BasicHeader;<br></span><span style="color: #008080;"> 23</span><br><span style="color: #008080;"> 24</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.File;<br></span><span style="color: #008080;"> 25</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.IOException;<br></span><span style="color: #008080;"> 26</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.InputStream;<br></span><span style="color: #008080;"> 27</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.OutputStream;<br></span><span style="color: #008080;"> 28</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.RandomAccessFile;<br></span><span style="color: #008080;"> 29</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.MalformedURLException;<br></span><span style="color: #008080;"> 30</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.ArrayList;<br></span><span style="color: #008080;"> 31</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.List;<br></span><span style="color: #008080;"> 32</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Executor;<br></span><span style="color: #008080;"> 33</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.util.concurrent.Executors;<br></span><span style="color: #008080;"> 34</span><br><span style="color: #008080;"> 35</span><br><span style="color: #008080;"> 36</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> MainActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Activity {<br></span><span style="color: #008080;"> 37</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “MainActivity”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 38</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> DEFAULT_POOL_SIZE = 5<span style="color: #000000;">;<br></span><span style="color: #008080;"> 39</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">int</span> GET_LENGTH_SUCCESS = 1<span style="color: #000000;">;<br></span><span style="color: #008080;"> 40</span>     <span style="color: #008000;">//</span><span style="color: #008000;">下载路径</span><br><span style="color: #008080;"> 41</span>     <span style="color: #0000ff;">private</span> String downloadPath = Environment.getExternalStorageDirectory() +<br><span style="color: #008080;"> 42</span>             File.separator + “download”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 43</span><br><span style="color: #008080;"> 44</span> <span style="color: #008000;">//</span><span style="color: #008000;">    private String mUrl = “</span><span style="color: #008000; text-decoration: underline;"><a href="http://ftp.neu.edu.cn/mirrors/eclipse/technology/epp/downloads/release/juno/SR2/eclipse-java-juno-SR2-linux-gtk-x86_64.tar.gz" target="_blank" rel="external">http://ftp.neu.edu.cn/mirrors/eclipse/technology/epp/downloads/release/juno/SR2/eclipse-java-juno-SR2-linux-gtk-x86_64.tar.gz</a></span><span style="color: #008000;">“;</span><br><span style="color: #008080;"> 45</span>     <span style="color: #0000ff;">private</span> String mUrl = “<a href="http://p.gdown.baidu.com/c4cb746699b92c9b6565cc65aa2e086552651f73c5d0e634a51f028e32af6abf3d68079eeb75401c76c9bb301e5fb71c144a704cb1a2f527a2e8ca3d6fe561dc5eaf6538e5b3ab0699308d13fe0b711a817c88b0f85a01a248df82824ace3cd7f2832c7c19173236" target="_blank" rel="external">http://p.gdown.baidu.com/c4cb746699b92c9b6565cc65aa2e086552651f73c5d0e634a51f028e32af6abf3d68079eeb75401c76c9bb301e5fb71c144a704cb1a2f527a2e8ca3d6fe561dc5eaf6538e5b3ab0699308d13fe0b711a817c88b0f85a01a248df82824ace3cd7f2832c7c19173236</a>“<span style="color: #000000;">;<br></span><span style="color: #008080;"> 46</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> ProgressBar mProgressBar;<br></span><span style="color: #008080;"> 47</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> TextView mPercentTV;<br></span><span style="color: #008080;"> 48</span>     SharedPreferences mSharedPreferences = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 49</span>     <span style="color: #0000ff;">long</span> mFileLength = 0<span style="color: #000000;">;<br></span><span style="color: #008080;"> 50</span>     Long mCurrentLength = 0L<span style="color: #000000;">;<br></span><span style="color: #008080;"> 51</span><br><span style="color: #008080;"> 52</span>     <span style="color: #0000ff;">private</span> InnerHandler mHandler = <span style="color: #0000ff;">new</span><span style="color: #000000;"> InnerHandler();<br></span><span style="color: #008080;"> 53</span><br><span style="color: #008080;"> 54</span>     <span style="color: #008000;">//</span><span style="color: #008000;">创建线程池</span><br><span style="color: #008080;"> 55</span>     <span style="color: #0000ff;">private</span> Executor mExecutor =<span style="color: #000000;"> Executors.newCachedThreadPool();<br></span><span style="color: #008080;"> 56</span><br><span style="color: #008080;"> 57</span>     <span style="color: #0000ff;">private</span> List<downloadasynctask> mTaskList = <span style="color: #0000ff;">new</span> ArrayList<downloadasynctask><span style="color: #000000;">();<br></span><span style="color: #008080;"> 58</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 59</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;"> 60</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;"> 61</span> <span style="color: #000000;">        setContentView(R.layout.activity_main);<br></span><span style="color: #008080;"> 62</span>         mProgressBar =<span style="color: #000000;"> (ProgressBar) findViewById(R.id.progressbar);<br></span><span style="color: #008080;"> 63</span>         mPercentTV =<span style="color: #000000;"> (TextView) findViewById(R.id.percent_tv);<br></span><span style="color: #008080;"> 64</span>         mSharedPreferences = getSharedPreferences(“download”<span style="color: #000000;">, Context.MODE_PRIVATE);<br></span><span style="color: #008080;"> 65</span>         <span style="color: #008000;">//</span><span style="color: #008000;">开始下载</span><br><span style="color: #008080;"> 66</span>         findViewById(R.id.begin).setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener() {<br></span><span style="color: #008080;"> 67</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 68</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v) {<br></span><span style="color: #008080;"> 69</span>                 <span style="color: #0000ff;">new</span><span style="color: #000000;"> Thread() {<br></span><span style="color: #008080;"> 70</span> <span style="color: #000000;">                    @Override<br></span><span style="color: #008080;"> 71</span>                     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;"> 72</span>                         <span style="color: #008000;">//</span><span style="color: #008000;">创建存储文件夹</span><br><span style="color: #008080;"> 73</span>                         File dir = <span style="color: #0000ff;">new</span><span style="color: #000000;"> File(downloadPath);<br></span><span style="color: #008080;"> 74</span>                         <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">dir.exists()) {<br></span><span style="color: #008080;"> 75</span> <span style="color: #000000;">                            dir.mkdir();<br></span><span style="color: #008080;"> 76</span> <span style="color: #000000;">                        }<br></span><span style="color: #008080;"> 77</span>                         <span style="color: #008000;">//</span><span style="color: #008000;">获取文件大小</span><br><span style="color: #008080;"> 78</span>                         HttpClient client = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DefaultHttpClient();<br></span><span style="color: #008080;"> 79</span>                         HttpGet request = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HttpGet(mUrl);<br></span><span style="color: #008080;"> 80</span>                         HttpResponse response = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 81</span><br><span style="color: #008080;"> 82</span>                         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 83</span>                             response =<span style="color: #000000;"> client.execute(request);<br></span><span style="color: #008080;"> 84</span>                             mFileLength =<span style="color: #000000;"> response.getEntity().getContentLength();<br></span><span style="color: #008080;"> 85</span>                         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;"> 86</span> <span style="color: #000000;">                            Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;"> 87</span>                         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 88</span>                             <span style="color: #0000ff;">if</span> (request != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 89</span> <span style="color: #000000;">                                request.abort();<br></span><span style="color: #008080;"> 90</span> <span style="color: #000000;">                            }<br></span><span style="color: #008080;"> 91</span> <span style="color: #000000;">                        }<br></span><span style="color: #008080;"> 92</span> <span style="color: #000000;">                        Message.obtain(mHandler, GET_LENGTH_SUCCESS).sendToTarget();<br></span><span style="color: #008080;"> 93</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;"> 94</span> <span style="color: #000000;">                }.start();<br></span><span style="color: #008080;"> 95</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 96</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;"> 97</span><br><span style="color: #008080;"> 98</span>         <span style="color: #008000;">//</span><span style="color: #008000;">暂停下载</span><br><span style="color: #008080;"> 99</span>         findViewById(R.id.end).setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener() {<br></span><span style="color: #008080;">100</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">101</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v) {<br></span><span style="color: #008080;">102</span>                 <span style="color: #0000ff;">for</span><span style="color: #000000;"> (DownloadAsyncTask task : mTaskList) {<br></span><span style="color: #008080;">103</span>                     <span style="color: #0000ff;">if</span> (task != <span style="color: #0000ff;">null</span> &amp;&amp; (task.getStatus() == AsyncTask.Status.RUNNING || !<span style="color: #000000;">task.isCancelled())) {<br></span><span style="color: #008080;">104</span>                         task.cancel(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">105</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">106</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">107</span> <span style="color: #000000;">                mTaskList.clear();<br></span><span style="color: #008080;">108</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">109</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;">110</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">111</span><br><span style="color: #008080;">112</span>     <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;">113</span> <span style="color: #008000;">     <em> 开始下载<br></em></span><span style="color: #008080;">114</span> <span style="color: #008000;">      根据待下载文件大小计算每个线程下载位置，并创建AsyncTask<br></span><span style="color: #008080;">115</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">116</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> beginDownload() {<br></span><span style="color: #008080;">117</span>         mCurrentLength = 0L<span style="color: #000000;">;<br></span><span style="color: #008080;">118</span> <span style="color: #000000;">        mPercentTV.setVisibility(View.VISIBLE);<br></span><span style="color: #008080;">119</span>         mProgressBar.setProgress(0<span style="color: #000000;">);<br></span><span style="color: #008080;">120</span>         <span style="color: #0000ff;">long</span> blockLength = mFileLength /<span style="color: #000000;"> DEFAULT_POOL_SIZE;<br></span><span style="color: #008080;">121</span>         <span style="color: #0000ff;">for</span> (<span style="color: #0000ff;">int</span> i = 0; i &lt; DEFAULT_POOL_SIZE; i++<span style="color: #000000;">) {<br></span><span style="color: #008080;">122</span>             <span style="color: #0000ff;">long</span> beginPosition = i  blockLength;<span style="color: #008000;">//</span><span style="color: #008000;">每条线程下载的开始位置</span><br><span style="color: #008080;">123</span>             <span style="color: #0000ff;">long</span> endPosition = (i + 1) * blockLength;<span style="color: #008000;">//</span><span style="color: #008000;">每条线程下载的结束位置</span><br><span style="color: #008080;">124</span>             <span style="color: #0000ff;">if</span> (i == (DEFAULT_POOL_SIZE - 1<span style="color: #000000;">)) {<br></span><span style="color: #008080;">125</span>                 endPosition = mFileLength;<span style="color: #008000;">//</span><span style="color: #008000;">如果整个文件的大小不为线程个数的整数倍，则最后一个线程的结束位置即为文件的总长度</span><br><span style="color: #008080;">126</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">127</span>             DownloadAsyncTask task = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DownloadAsyncTask(beginPosition, endPosition);<br></span><span style="color: #008080;">128</span> <span style="color: #000000;">            mTaskList.add(task);<br></span><span style="color: #008080;">129</span> <span style="color: #000000;">            task.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, mUrl, String.valueOf(i));<br></span><span style="color: #008080;">130</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">131</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">132</span><br><span style="color: #008080;">133</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;">134</span> <span style="color: #008000;">     <em> 更新进度条<br></em></span><span style="color: #008080;">135</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;">136</span>     <span style="color: #0000ff;">synchronized</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> updateProgress() {<br></span><span style="color: #008080;">137</span>         <span style="color: #0000ff;">int</span> percent = (<span style="color: #0000ff;">int</span>) Math.ceil((<span style="color: #0000ff;">float</span>)mCurrentLength / (<span style="color: #0000ff;">float</span>)mFileLength <em> 100<span style="color: #000000;">);<br></span><span style="color: #008080;">138</span> <span style="color: #008000;">//</span><span style="color: #008000;">        Log.i(TAG, “downloading  “ + mCurrentLength + “,” + mFileLength + “,” + percent);</span><br><span style="color: #008080;">139</span>         <span style="color: #0000ff;">if</span>(percent &gt;<span style="color: #000000;"> mProgressBar.getProgress()) {<br></span><span style="color: #008080;">140</span> <span style="color: #000000;">            mProgressBar.setProgress(percent);<br></span><span style="color: #008080;">141</span>             mPercentTV.setText(“下载进度：” + percent + “%”<span style="color: #000000;">);<br></span><span style="color: #008080;">142</span>             <span style="color: #0000ff;">if</span> (mProgressBar.getProgress() ==<span style="color: #000000;"> mProgressBar.getMax()) {<br></span><span style="color: #008080;">143</span>                 Toast.makeText(MainActivity.<span style="color: #0000ff;">this</span>, “下载结束”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">144</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">145</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">146</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">147</span><br><span style="color: #008080;">148</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;">149</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onDestroy() {<br></span><span style="color: #008080;">150</span>         <span style="color: #0000ff;">for</span><span style="color: #000000;">(DownloadAsyncTask task: mTaskList) {<br></span><span style="color: #008080;">151</span>             <span style="color: #0000ff;">if</span>(task != <span style="color: #0000ff;">null</span> &amp;&amp; task.getStatus() ==<span style="color: #000000;"> AsyncTask.Status.RUNNING) {<br></span><span style="color: #008080;">152</span>                 task.cancel(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">153</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">154</span> <span style="color: #000000;">            mTaskList.clear();<br></span><span style="color: #008080;">155</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">156</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onDestroy();<br></span><span style="color: #008080;">157</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">158</span><br><span style="color: #008080;">159</span>     <span style="color: #008000;">/**</span><br><span style="color: #008080;">160</span> <span style="color: #008000;">     </span></em> 下载的AsyncTask<br><span style="color: #008080;">161</span>      <span style="color: #008000;"><em>/</em></span><br><span style="color: #008080;">162</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">class</span> DownloadAsyncTask <span style="color: #0000ff;">extends</span> AsyncTask<string, integer="" ,="" long=""><span style="color: #000000;"> {<br></span><span style="color: #008080;">163</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “DownloadAsyncTask”<span style="color: #000000;">;<br></span><span style="color: #008080;">164</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span> beginPosition = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">165</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span> endPosition = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">166</span><br><span style="color: #008080;">167</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">long</span> current = 0<span style="color: #000000;">;<br></span><span style="color: #008080;">168</span><br><span style="color: #008080;">169</span>         <span style="color: #0000ff;">private</span><span style="color: #000000;"> String currentThreadIndex;<br></span><span style="color: #008080;">170</span><br><span style="color: #008080;">171</span><br><span style="color: #008080;">172</span>         <span style="color: #0000ff;">public</span> DownloadAsyncTask(<span style="color: #0000ff;">long</span> beginPosition, <span style="color: #0000ff;">long</span><span style="color: #000000;"> endPosition) {<br></span><span style="color: #008080;">173</span>             <span style="color: #0000ff;">this</span>.beginPosition =<span style="color: #000000;"> beginPosition;<br></span><span style="color: #008080;">174</span>             <span style="color: #0000ff;">this</span>.endPosition =<span style="color: #000000;"> endPosition;<br></span><span style="color: #008080;">175</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">176</span><br><span style="color: #008080;">177</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">178</span>         <span style="color: #0000ff;">protected</span><span style="color: #000000;"> Long doInBackground(String… params) {<br></span><span style="color: #008080;">179</span>             Log.i(TAG, “downloading”<span style="color: #000000;">);<br></span><span style="color: #008080;">180</span>             String url = params[0<span style="color: #000000;">];<br></span><span style="color: #008080;">181</span>             currentThreadIndex = url + params[1<span style="color: #000000;">];<br></span><span style="color: #008080;">182</span>             <span style="color: #0000ff;">if</span>(url == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">183</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">184</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">185</span>             HttpClient client = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DefaultHttpClient();<br></span><span style="color: #008080;">186</span>             HttpGet request = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HttpGet(url);<br></span><span style="color: #008080;">187</span>             HttpResponse response = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">188</span>             InputStream is = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">189</span>             RandomAccessFile fos = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">190</span>             OutputStream output = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">191</span><br><span style="color: #008080;">192</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">193</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">本地文件</span><br><span style="color: #008080;">194</span>                 File file = <span style="color: #0000ff;">new</span> File(downloadPath + File.separator + url.substring(url.lastIndexOf(“/“) + 1<span style="color: #000000;">));<br></span><span style="color: #008080;">195</span><br><span style="color: #008080;">196</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">获取之前下载保存的信息，从之前结束的位置继续下载<br></span><span style="color: #008080;">197</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">这里加了判断file.exists()，判断是否被用户删除了，如果文件没有下载完，但是已经被用户删除了，则重新下载</span><br><span style="color: #008080;">198</span>                 <span style="color: #0000ff;">long</span> downedPosition = mSharedPreferences.getLong(currentThreadIndex, 0<span style="color: #000000;">);<br></span><span style="color: #008080;">199</span>                 <span style="color: #0000ff;">if</span>(file.exists() &amp;&amp; downedPosition != 0<span style="color: #000000;">) {<br></span><span style="color: #008080;">200</span>                     beginPosition = beginPosition +<span style="color: #000000;"> downedPosition;<br></span><span style="color: #008080;">201</span>                     current =<span style="color: #000000;"> downedPosition;<br></span><span style="color: #008080;">202</span>                     <span style="color: #0000ff;">synchronized</span><span style="color: #000000;"> (mCurrentLength) {<br></span><span style="color: #008080;">203</span>                         mCurrentLength +=<span style="color: #000000;"> downedPosition;<br></span><span style="color: #008080;">204</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">205</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">206</span><br><span style="color: #008080;">207</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">设置下载的数据位置beginPosition字节到endPosition字节</span><br><span style="color: #008080;">208</span>                 Header header_size = <span style="color: #0000ff;">new</span> BasicHeader(“Range”, “bytes=” + beginPosition + “-“ +<span style="color: #000000;"> endPosition);<br></span><span style="color: #008080;">209</span> <span style="color: #000000;">                request.addHeader(header_size);<br></span><span style="color: #008080;">210</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">执行请求获取下载输入流</span><br><span style="color: #008080;">211</span>                 response =<span style="color: #000000;"> client.execute(request);<br></span><span style="color: #008080;">212</span>                 is =<span style="color: #000000;"> response.getEntity().getContent();<br></span><span style="color: #008080;">213</span><br><span style="color: #008080;">214</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">创建文件输出流</span><br><span style="color: #008080;">215</span>                 fos = <span style="color: #0000ff;">new</span> RandomAccessFile(file, “rw”<span style="color: #000000;">);<br></span><span style="color: #008080;">216</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">从文件的size以后的位置开始写入，其实也不用，直接往后写就可以。有时候多线程下载需要用</span><br><span style="color: #008080;">217</span> <span style="color: #000000;">                fos.seek(beginPosition);<br></span><span style="color: #008080;">218</span><br><span style="color: #008080;">219</span>                 <span style="color: #0000ff;">byte</span> buffer [] = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">byte</span>[1024<span style="color: #000000;">];<br></span><span style="color: #008080;">220</span>                 <span style="color: #0000ff;">int</span> inputSize = -1<span style="color: #000000;">;<br></span><span style="color: #008080;">221</span>                 <span style="color: #0000ff;">while</span>((inputSize = is.read(buffer)) != -1<span style="color: #000000;">) {<br></span><span style="color: #008080;">222</span>                     fos.write(buffer, 0<span style="color: #000000;">, inputSize);<br></span><span style="color: #008080;">223</span>                     current +=<span style="color: #000000;"> inputSize;<br></span><span style="color: #008080;">224</span>                     <span style="color: #0000ff;">synchronized</span><span style="color: #000000;"> (mCurrentLength) {<br></span><span style="color: #008080;">225</span>                         mCurrentLength +=<span style="color: #000000;"> inputSize;<br></span><span style="color: #008080;">226</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">227</span>                     <span style="color: #0000ff;">this</span><span style="color: #000000;">.publishProgress();<br></span><span style="color: #008080;">228</span>                     <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isCancelled()) {<br></span><span style="color: #008080;">229</span>                         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">230</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">231</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">232</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (MalformedURLException e) {<br></span><span style="color: #008080;">233</span> <span style="color: #000000;">                Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">234</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;">235</span> <span style="color: #000000;">                Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">236</span>             } <span style="color: #0000ff;">finally</span><span style="color: #000000;">{<br></span><span style="color: #008080;">237</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;">{<br></span><span style="color: #008080;">238</span>                     <span style="color: #008000;">/</span><span style="color: #008000;">if(is != null) {<br></span><span style="color: #008080;">239</span> <span style="color: #008000;">                        is.close();<br></span><span style="color: #008080;">240</span> <span style="color: #008000;">                    }</span><span style="color: #008000;">*/</span><br><span style="color: #008080;">241</span>                     <span style="color: #0000ff;">if</span> (request != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">242</span> <span style="color: #000000;">                        request.abort();<br></span><span style="color: #008080;">243</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">244</span>                     <span style="color: #0000ff;">if</span>(output != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">245</span> <span style="color: #000000;">                        output.close();<br></span><span style="color: #008080;">246</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">247</span>                     <span style="color: #0000ff;">if</span>(fos != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">248</span> <span style="color: #000000;">                        fos.close();<br></span><span style="color: #008080;">249</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">250</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;">(Exception e) {<br></span><span style="color: #008080;">251</span> <span style="color: #000000;">                    e.printStackTrace();<br></span><span style="color: #008080;">252</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">253</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">254</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">255</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">256</span><br><span style="color: #008080;">257</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">258</span>         <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPreExecute() {<br></span><span style="color: #008080;">259</span>             Log.i(TAG, “download begin “<span style="color: #000000;">);<br></span><span style="color: #008080;">260</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPreExecute();<br></span><span style="color: #008080;">261</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">262</span><br><span style="color: #008080;">263</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">264</span>         <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onProgressUpdate(Integer… values) {<br></span><span style="color: #008080;">265</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">.onProgressUpdate(values);<br></span><span style="color: #008080;">266</span>             <span style="color: #008000;">//</span><span style="color: #008000;">更新界面进度条</span><br><span style="color: #008080;">267</span> <span style="color: #000000;">            updateProgress();<br></span><span style="color: #008080;">268</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">269</span><br><span style="color: #008080;">270</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">271</span>         <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPostExecute(Long aLong) {<br></span><span style="color: #008080;">272</span>             Log.i(TAG, “download success “<span style="color: #000000;">);<br></span><span style="color: #008080;">273</span>             <span style="color: #008000;">//</span><span style="color: #008000;">下载完成移除记录</span><br><span style="color: #008080;">274</span> <span style="color: #000000;">            mSharedPreferences.edit().remove(currentThreadIndex).commit();<br></span><span style="color: #008080;">275</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">276</span><br><span style="color: #008080;">277</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">278</span>         <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCancelled() {<br></span><span style="color: #008080;">279</span>             Log.i(TAG, “download cancelled “<span style="color: #000000;">);<br></span><span style="color: #008080;">280</span>             <span style="color: #008000;">//</span><span style="color: #008000;">记录已下载大小current</span><br><span style="color: #008080;">281</span> <span style="color: #000000;">            mSharedPreferences.edit().putLong(currentThreadIndex, current).commit();<br></span><span style="color: #008080;">282</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">283</span><br><span style="color: #008080;">284</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">285</span>         <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCancelled(Long aLong) {<br></span><span style="color: #008080;">286</span>             Log.i(TAG, “download cancelled(Long aLong)”<span style="color: #000000;">);<br></span><span style="color: #008080;">287</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCancelled(aLong);<br></span><span style="color: #008080;">288</span> <span style="color: #000000;">            mSharedPreferences.edit().putLong(currentThreadIndex, current).commit();<br></span><span style="color: #008080;">289</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">290</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">291</span><br><span style="color: #008080;">292</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">class</span> InnerHandler <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Handler {<br></span><span style="color: #008080;">293</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">294</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> handleMessage(Message msg) {<br></span><span style="color: #008080;">295</span>             <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (msg.what) {<br></span><span style="color: #008080;">296</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> GET_LENGTH_SUCCESS :<br></span><span style="color: #008080;">297</span> <span style="color: #000000;">                    beginDownload();<br></span><span style="color: #008080;">298</span>                     <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">299</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">300</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">.handleMessage(msg);<br></span><span style="color: #008080;">301</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">302</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">303</span><br><span style="color: #008080;">304</span> }</string,></downloadasynctask></downloadasynctask></pre><br></div>

<p>　　<span style="font-size: 15px;">布局文件和前面一篇博客<a href="http://www.cnblogs.com/liuling/p/2015-10-10-01.html" title="AsyncTask实现断点续传" target="_blank" rel="external">《AsyncTask实现断点续传》</a>布局文件是一样的，这里就不贴代码了。</span></p>
<p><span style="font-size: 15px;">　　以上代码亲测可用，几百M大文件也没问题。</span></p>
<p><strong><span style="font-size: 15px;">三、遇到的坑</span></strong></p>
<p><span style="font-size: 15px;">　　问题描述：在使用上面代码下载</span><span style="font-family: 'Courier New'; font-size: 12px; line-height: 1.5;"><a href="http://ftp.neu.edu.cn/mirrors/eclipse/technology/epp/downloads/release/juno/SR2/eclipse-java-juno-SR2-linux-gtk-x86_64.tar.gz" target="_blank" rel="external">http://ftp.neu.edu.cn/mirrors/eclipse/technology/epp/downloads/release/juno/SR2/eclipse-java-juno-SR2-linux-gtk-x86_64.tar.gz</a><span style="font-size: 15px;">文件的时候，不知道为什么暂停时候执行AsyncTask.cancel(true)来取消下载任务，不执行onCancel()函数，也就没有记录该线程下载的位置。并且再次点击下载的时候，5个Task都只执行了onPreEexcute()方法，压根就不执行doInBackground()方法。而下载其他文件没有这个问题。</span></span></p>
<p><span style="font-family: 'Courier New'; font-size: 12px; line-height: 1.5;"><span style="font-size: 15px;">　　这个问题折腾了我好久，它又没有报任何异常，调试又调试不出来。看AsyncTask的源码、上stackoverflow也没有找到原因。看到这个网站（<a href="https://groups.google.com/forum/#!topic/android-developers/B-oBiS7npfQ）时，我还真以为是AsyncTask的一个bug。" target="_blank" rel="external">https://groups.google.com/forum/#!topic/android-developers/B-oBiS7npfQ）时，我还真以为是AsyncTask的一个bug。</a></span></span></p>
<p><span style="font-size: 15px;">　　百番周折，问题居然出现在上面代码239行（这里已注释）。不知道为什么，执行这一句的时候，线程就阻塞在那里了，所以doInBackground()方法一直没有结束，onCancel()方法当然也不会执行了。同时，因为使用的是线程池Executor，线程数为5个，点击取消之后5个线程都阻塞了，所以再次点击下载的时候只执行了onPreEexcute()方法，没有空闲的线程去执行doInBackground()方法。真是巨坑无比有木有。。。</span></p>
<p><span style="font-size: 15px;">　　虽然问题解决了，但是为什么有的文件下载执行到</span>is.close()的时候线程会阻塞而有的不会？这还是个谜。如果哪位大神知道是什么原因，还望指点指点！</p>
<p>&nbsp;</p>
<p><span style="font-size: 15px;"><span style="color: #ff0000;"><strong>源码下载：</strong></span><a href="https://github.com/liuling07/MultiTaskAndThreadDownload" title="https://github.com/liuling07/MultiTaskAndThreadDownload" target="_blank" rel="external">https://github.com/liuling07/MultiTaskAndThreadDownload</a></span></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2015/10/asynctask-multithread-download.html" data-id="ciiy5f4xu00e4q1d0d40lq9ye" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2015/10/asynctask-multithread-download.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/多线程/">多线程</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/断点续传/">断点续传</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-asynctask-source" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/asynctask-source.html">AsyncTask源码分析</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2015/10/asynctask-source.html">
      <time datetime="2015-10-10T08:19:00.000Z" itemprop="datePublished">2015-10-10</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <div>关于AsyncTask的用法可以参看前面一篇博客<a href="http://www.cnblogs.com/liuling/p/2015-10-10-01.html" title="AsyncTask实现断点续传" target="_blank" rel="external">《AsyncTask实现断点续传》</a>，本文只解析AsyncTask的源代码。</div><br><div>&nbsp;</div><br><div>AsyncTask.execute方法：</div><br><div><br><div><br><div class="linenums"><br><div class="L0"><br><div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> AsyncTask<params, progress,="" result=""><span style="color: #000000;"> execute(Params… params) {<br></span><span style="color: #008080;">2</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> executeOnExecutor(sDefaultExecutor, params);<br></span><span style="color: #008080;">3</span>     }</params,></pre><br></div><br></div><br></div><br></div><br><div>execute方法里面直接调用了executeOnexecute方法。</div><br></div><br><div>&nbsp;</div><br><div>AsyncTask.executeOnexecute方法：</div><br><div><br><div class="linenums"><br><div class="L0"><br><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">final</span> AsyncTask<params, progress,="" result=""><span style="color: #000000;"> executeOnExecutor(Executor exec,<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">            Params… params) {<br></span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">if</span> (mStatus !=<span style="color: #000000;"> Status.PENDING) {<br></span><span style="color: #008080;"> 4</span>             <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (mStatus) {<br></span><span style="color: #008080;"> 5</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> RUNNING:<br></span><span style="color: #008080;"> 6</span>                     <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> IllegalStateException(“Cannot execute task:”<br><span style="color: #008080;"> 7</span>                             + “ the task is already running.”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 8</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> FINISHED:<br></span><span style="color: #008080;"> 9</span>                     <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> IllegalStateException(“Cannot execute task:”<br><span style="color: #008080;">10</span>                             + “ the task has already been executed “<br><span style="color: #008080;">11</span>                             + “(a task can be executed only once)”<span style="color: #000000;">);<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">14</span>         mStatus =<span style="color: #000000;"> Status.RUNNING;<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        onPreExecute();<br></span><span style="color: #008080;">16</span>         mWorker.mParams =<span style="color: #000000;"> params;<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">        exec.execute(mFuture);<br></span><span style="color: #008080;">18</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">this</span><span style="color: #000000;">;<br></span><span style="color: #008080;">19</span>     }</params,></pre><br></div><br></div><br></div><br></div><br><div>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;3-13行是检测AsyncTask的状态，如果状态不为PENDING，则会抛异常，这也是为什么一个AsyncTask只能被执行一次的原因。14行将状态改为RUNNING，表示该任务正在运行。然后调用AsyncTask的onPreExecute()方法。</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;由下面代码可以看出，AsyncTask有三种状态：PENDING（未运行）、RUNNING（正在运行）、FINISHED（已运行完毕）。</div><br><div><br><div class="linenums"><br><div class="L0"><br><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">enum</span><span style="color: #000000;"> Status {<br></span><span style="color: #008080;"> 2</span>         <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 3</span> <span style="color: #008000;">         <em> Indicates that the task has not been executed yet.<br></em></span><span style="color: #008080;"> 4</span>          <span style="color: #008000;">/</span><br><span style="color: #008080;"> 5</span> <span style="color: #000000;">        PENDING,<br></span><span style="color: #008080;"> 6</span>         <span style="color: #008000;">/</span><br><span style="color: #008080;"> 7</span> <span style="color: #008000;">         <em> Indicates that the task is running.<br></em></span><span style="color: #008080;"> 8</span>          <span style="color: #008000;">/</span><br><span style="color: #008080;"> 9</span> <span style="color: #000000;">        RUNNING,<br></span><span style="color: #008080;">10</span>         <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;">11</span> <span style="color: #008000;">          Indicates that {</span><span style="color: #808080;">@link</span><span style="color: #008000;"> AsyncTask#onPostExecute} has finished.<br></span><span style="color: #008080;">12</span>          <span style="color: #008000;">*/</span><br><span style="color: #008080;">13</span> <span style="color: #000000;">        FINISHED,<br></span><span style="color: #008080;">14</span>     }</pre><br></div><br></div><br></div><br></div><br><div>&nbsp;</div><br><div>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;FutureTask代码：</div><br><div><br><div><br><div class="linenums"><br><div class="L0"><br><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> FutureTask<v> <span style="color: #0000ff;">implements</span> RunnableFuture<v><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">    ……<br></span><span style="color: #008080;"> 3</span>     <span style="color: #008000;">//</span><span style="color: #008000;">构造方法传入一个Callable对象</span><br><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">public</span> FutureTask(Callable<v><span style="color: #000000;"> callable) {<br></span><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">if</span> (callable == <span style="color: #0000ff;">null</span><span style="color: #000000;">)<br></span><span style="color: #008080;"> 6</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> NullPointerException();<br></span><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">this</span>.callable =<span style="color: #000000;"> callable;<br></span><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">this</span>.state = NEW;       <span style="color: #008000;">//</span><span style="color: #008000;"> ensure visibility of callable</span><br><span style="color: #008080;"> 9</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">10</span>     <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> run() {<br></span><span style="color: #008080;">11</span>         <span style="color: #0000ff;">if</span> (state != NEW ||<br><span style="color: #008080;">12</span>             !UNSAFE.compareAndSwapObject(<span style="color: #0000ff;">this</span><span style="color: #000000;">, runnerOffset,<br></span><span style="color: #008080;">13</span>                                          <span style="color: #0000ff;">null</span><span style="color: #000000;">, Thread.currentThread()))<br></span><span style="color: #008080;">14</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;">15</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">16</span>             Callable<v> c =<span style="color: #000000;"> callable;<br></span><span style="color: #008080;">17</span>             <span style="color: #0000ff;">if</span> (c != <span style="color: #0000ff;">null</span> &amp;&amp; state ==<span style="color: #000000;"> NEW) {<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">                V result;<br></span><span style="color: #008080;">19</span>                 <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> ran;<br></span><span style="color: #008080;">20</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">21</span>                     result = c.call();<span style="color: #008000;">//</span><span style="color: #008000;">这里调用了callable.call()方法</span><br><span style="color: #008080;">22</span>                     ran = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">23</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Throwable ex) {<br></span><span style="color: #008080;">24</span>                     result = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">25</span>                     ran = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">                    setException(ex);<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">28</span>                 <span style="color: #0000ff;">if</span><span style="color: #000000;"> (ran)<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">                    set(result);<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">31</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">32</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> runner must be non-null until state is settled to<br></span><span style="color: #008080;">33</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> prevent concurrent calls to run()</span><br><span style="color: #008080;">34</span>             runner = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">35</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> state must be re-read after nulling runner to prevent<br></span><span style="color: #008080;">36</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> leaked interrupts</span><br><span style="color: #008080;">37</span>             <span style="color: #0000ff;">int</span> s =<span style="color: #000000;"> state;<br></span><span style="color: #008080;">38</span>             <span style="color: #0000ff;">if</span> (s &gt;=<span style="color: #000000;"> INTERRUPTING)<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">                handlePossibleCancellationInterrupt(s);<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">41</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">42</span> <span style="color: #000000;">    ……<br></span><span style="color: #008080;">43</span> }</v></v></v></v></pre><br></div>

<p>&nbsp;</p>
<p></p></div><br></div><br></div><br></div><p></p>
<div>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;AsyncTask构造方法：</div><br><div><br><div><br><div class="linenums"><br><div class="L0"><br><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">class</span> AsyncTask<params, progress,="" result=""><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">    ……<br></span><span style="color: #008080;"> 3</span>     <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 4</span> <span style="color: #008000;">      Creates a new asynchronous task. This constructor must be invoked on the UI thread.<br></span><span style="color: #008080;"> 5</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 6</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> AsyncTask() {<br></span><span style="color: #008080;"> 7</span>         mWorker = <span style="color: #0000ff;">new</span> WorkerRunnable<params, result=""><span style="color: #000000;">() {<br></span><span style="color: #008080;"> 8</span>             <span style="color: #0000ff;">public</span> Result call() <span style="color: #0000ff;">throws</span><span style="color: #000000;"> Exception {<br></span><span style="color: #008080;"> 9</span>                 mTaskInvoked.set(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">                Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);<br></span><span style="color: #008080;">11</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">noinspection unchecked</span><br><span style="color: #008080;">12</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> postResult(doInBackground(mParams));<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">        };<br></span><span style="color: #008080;">15</span>         <span style="color: #008000;">//</span><span style="color: #008000;">创建FutureTask对象的时候传入了mWorker作为Callable</span><br><span style="color: #008080;">16</span>         mFuture = <span style="color: #0000ff;">new</span> FutureTask<result><span style="color: #000000;">(mWorker) {<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;">18</span>             <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> done() {<br></span><span style="color: #008080;">19</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">                    postResultIfNotInvoked(get());<br></span><span style="color: #008080;">21</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">                    android.util.Log.w(LOG_TAG, e);<br></span><span style="color: #008080;">23</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (ExecutionException e) {<br></span><span style="color: #008080;">24</span>                     <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> RuntimeException(“An error occured while executing doInBackground()”<span style="color: #000000;">,<br></span><span style="color: #008080;">25</span> <span style="color: #000000;">                            e.getCause());<br></span><span style="color: #008080;">26</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (CancellationException e) {<br></span><span style="color: #008080;">27</span>                     postResultIfNotInvoked(<span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">        };<br></span><span style="color: #008080;">31</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">    ……<br></span><span style="color: #008080;">33</span> }</result></params,></params,></pre><br></div>

<p>&nbsp;</p>
<p></p></div><br></div><br></div><p></p>
<div>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;由FutureTask源码我们可以看出，run()方法里面调用了c.call()，而AsyncTask 中创建FutureTask的时候传入了mWorker，所以FutureTask.run()方法里面c.call()调用的是mWorker对象的call()方法，而AsyncTask里mWorker重写了call方法，即上面8-14行，所以c.call()会执行到mWorker.call()方法来。call方法里面11行将线程的优先级设置为后台线程，这样当多个线程并发后很多无关紧要的线程分配的CPU时间将会减少，有利于主线程的处理。</div><br></div><br><div><span style="font-family: 微软雅黑;">&nbsp; &nbsp; &nbsp; &nbsp; 接下来11行执行了doInBackground(mParams)方法，通常我们会重写该方法来实现业务逻辑操作。然后执行postResult方法，并且将结果返回给</span>FutureTask（因为是FutureTask.run方法调用的此call方法，所以需要返回结果到FutureTask.run方法）。这里我们先看看postResult：</div><br><div><br><div><br><div class="linenums"><br><div class="L0"><br><div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> Result postResult(Result result) {<br></span><span style="color: #008080;">2</span>         @SuppressWarnings(“unchecked”<span style="color: #000000;">)<br></span><span style="color: #008080;">3</span>         Message message =<span style="color: #000000;"> sHandler.obtainMessage(MESSAGE_POST_RESULT,<br></span><span style="color: #008080;">4</span>                 <span style="color: #0000ff;">new</span> AsyncTaskResult<result>(<span style="color: #0000ff;">this</span><span style="color: #000000;">, result));<br></span><span style="color: #008080;">5</span> <span style="color: #000000;">        message.sendToTarget();<br></span><span style="color: #008080;">6</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> result;<br></span><span style="color: #008080;">7</span>     }</result></pre><br></div><br><code>&lt;span class=&quot;pln&quot;&gt;&lt;span class=&quot;kwd&quot;&gt;
&lt;/span&gt;&lt;/span&gt;</code></div>

<p></p></div><p></p>
<p></p></div><p></p>
<div><span style="font-family: 微软雅黑;">&nbsp; &nbsp; &nbsp; &nbsp; 这里的sHandler是InternalHandler对象。</span></div>

<p></p></div><p></p>
<div><br><div><br><div class="linenums"><br><div class="L0"><br><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">class</span> InternalHandler <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Handler {<br></span><span style="color: #008080;"> 2</span>         @SuppressWarnings({“unchecked”, “RawUseOfParameterizedType”<span style="color: #000000;">})<br></span><span style="color: #008080;"> 3</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> handleMessage(Message msg) {<br></span><span style="color: #008080;"> 5</span>             AsyncTaskResult result =<span style="color: #000000;"> (AsyncTaskResult) msg.obj;<br></span><span style="color: #008080;"> 6</span>             <span style="color: #0000ff;">switch</span><span style="color: #000000;"> (msg.what) {<br></span><span style="color: #008080;"> 7</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> MESSAGE_POST_RESULT:<br></span><span style="color: #008080;"> 8</span>                     <span style="color: #008000;">//</span><span style="color: #008000;"> There is only one result</span><br><span style="color: #008080;"> 9</span>                     result.mTask.finish(result.mData[0<span style="color: #000000;">]);<br></span><span style="color: #008080;">10</span>                     <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">11</span>                 <span style="color: #0000ff;">case</span><span style="color: #000000;"> MESSAGE_POST_PROGRESS:<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">                    result.mTask.onProgressUpdate(result.mData);<br></span><span style="color: #008080;">13</span>                     <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">16</span>     }</pre><br></div><br><code>&lt;span class=&quot;pln&quot;&gt;&lt;span class=&quot;kwd&quot;&gt;
&lt;/span&gt;&lt;/span&gt;</code></div>

<p></p></div><p></p>
<p></p></div><p></p>
<div><span style="font-family: 微软雅黑;">&nbsp; &nbsp; &nbsp; &nbsp; 由第9行代码可知最终会执行AsyncTask的finish方法，代码如下：</span></div>

<p></p></div><p></p>
<div><br><div><br><div class="linenums"><br><div class="L0"><br><div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> finish(Result result) {<br></span><span style="color: #008080;">2</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (isCancelled()) {<br></span><span style="color: #008080;">3</span> <span style="color: #000000;">            onCancelled(result);<br></span><span style="color: #008080;">4</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">5</span> <span style="color: #000000;">            onPostExecute(result);<br></span><span style="color: #008080;">6</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">7</span>         mStatus =<span style="color: #000000;"> Status.FINISHED;<br></span><span style="color: #008080;">8</span>     }</pre><br></div><br><code>&lt;span class=&quot;pln&quot;&gt;&lt;span class=&quot;kwd&quot;&gt;
&lt;/span&gt;&lt;/span&gt;</code></div>

<p></p></div><p></p>
<p></p></div><p></p>
<div><span style="font-family: 微软雅黑;">&nbsp; &nbsp; &nbsp; &nbsp; finish的作用是如果task被取消了就执行onCancelled方法，如果没有被取消而是正常执行完毕，则执行onPostExecute方法（这也是为什么task被调用了cancel方法，不会执行</span>onPostExecute的原因）。最后将task的状态标记为FINISHED。</div>

<p></p></div><p></p>
<div><span style="font-family: 微软雅黑;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></div><br><div><span style="font-family: 微软雅黑;">&nbsp; &nbsp; &nbsp; &nbsp; 上面说到mWorker.call会将执行结果返回给</span>FutureTask.run()方法并且继续往下执行，我们再次看看FutureTask.run方法（20-30行）：</div><br><div><br><div><br><div class="linenums"><br><div class="L0"><br><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> ran;<br></span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 3</span>      result =<span style="color: #000000;"> c.call();<br></span><span style="color: #008080;"> 4</span>      ran = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 5</span> } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Throwable ex) {<br></span><span style="color: #008080;"> 6</span>      result = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 7</span>      ran = <span style="color: #0000ff;">false</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">     setException(ex);<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">}<br></span><span style="color: #008080;">10</span> <span style="color: #0000ff;">if</span><span style="color: #000000;"> (ran)<br></span><span style="color: #008080;">11</span>      set(result);</pre><br></div><br><code>&lt;span class=&quot;kwd&quot;&gt;
&lt;/span&gt;</code></div>

<p></p></div><p></p>
<p></p></div><p></p>
<div><span style="font-family: 微软雅黑;">&nbsp; &nbsp; &nbsp; &nbsp; 由上面代码可以看到，执行完c.call后，会执行set(result)方法。</span></div>

<p></p></div><p></p>
<div><br><div><br><div class="linenums"><br><div class="L0"><br><div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> set(V v) {<br></span><span style="color: #008080;">2</span>         <span style="color: #0000ff;">if</span> (UNSAFE.compareAndSwapInt(<span style="color: #0000ff;">this</span><span style="color: #000000;">, stateOffset, NEW, COMPLETING)) {<br></span><span style="color: #008080;">3</span>             outcome =<span style="color: #000000;"> v;<br></span><span style="color: #008080;">4</span>             UNSAFE.putOrderedInt(<span style="color: #0000ff;">this</span>, stateOffset, NORMAL); <span style="color: #008000;">//</span><span style="color: #008000;"> final state</span><br><span style="color: #008080;">5</span> <span style="color: #000000;">            finishCompletion();<br></span><span style="color: #008080;">6</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">7</span>     }</pre><br></div><br><code>&lt;span class=&quot;pln&quot;&gt;&lt;span class=&quot;kwd&quot;&gt;
&lt;/span&gt;&lt;/span&gt;</code></div>

<p></p></div><p></p>
<p></p></div><p></p>
<div><span style="font-family: 微软雅黑;">&nbsp; &nbsp; &nbsp; &nbsp; 最终会执行finishCompletion()方法。</span></div>

<p></p></div><p></p>
<div><br><div><br><div class="linenums"><br><div class="L0"><br><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> finishCompletion() {<br></span><span style="color: #008080;"> 2</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> assert state &gt; COMPLETING;</span><br><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">for</span> (WaitNode q; (q = waiters) != <span style="color: #0000ff;">null</span><span style="color: #000000;">;) {<br></span><span style="color: #008080;"> 4</span>             <span style="color: #0000ff;">if</span> (UNSAFE.compareAndSwapObject(<span style="color: #0000ff;">this</span>, waitersOffset, q, <span style="color: #0000ff;">null</span><span style="color: #000000;">)) {<br></span><span style="color: #008080;"> 5</span>                 <span style="color: #0000ff;">for</span><span style="color: #000000;"> (;;) {<br></span><span style="color: #008080;"> 6</span>                     Thread t =<span style="color: #000000;"> q.thread;<br></span><span style="color: #008080;"> 7</span>                     <span style="color: #0000ff;">if</span> (t != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 8</span>                         q.thread = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">                        LockSupport.unpark(t);<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">11</span>                     WaitNode next =<span style="color: #000000;"> q.next;<br></span><span style="color: #008080;">12</span>                     <span style="color: #0000ff;">if</span> (next == <span style="color: #0000ff;">null</span><span style="color: #000000;">)<br></span><span style="color: #008080;">13</span>                         <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">14</span>                     q.next = <span style="color: #0000ff;">null</span>; <span style="color: #008000;">//</span><span style="color: #008000;"> unlink to help gc</span><br><span style="color: #008080;">15</span>                     q =<span style="color: #000000;"> next;<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">17</span>                 <span style="color: #0000ff;">break</span><span style="color: #000000;">;<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">        done();<br></span><span style="color: #008080;">21</span>         callable = <span style="color: #0000ff;">null</span>;        <span style="color: #008000;">//</span><span style="color: #008000;"> to reduce footprint</span><br><span style="color: #008080;">22</span>     }</pre><br></div><br><code>&lt;span class=&quot;pln&quot;&gt;&lt;span class=&quot;kwd&quot;&gt;
&lt;/span&gt;&lt;/span&gt;</code></div>

<p></p></div><p></p>
<p></p></div><p></p>
<div><span style="font-family: 微软雅黑;">&nbsp; &nbsp; &nbsp; &nbsp; 看到21行代码，会执行</span>FutureTask的done()方法，而这个方法在AsyncTask构造函数中初始化FutureTask对象的时候被重写了。</div>

<p></p></div><p></p>
<div><br><div><br><div class="linenums"><br><div class="L0"><br><div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span>     mFuture = <span style="color: #0000ff;">new</span> FutureTask<result><span style="color: #000000;">(mWorker) {<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 3</span>             <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> done() {<br></span><span style="color: #008080;"> 4</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">                    postResultIfNotInvoked(get());<br></span><span style="color: #008080;"> 6</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (InterruptedException e) {<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">                    android.util.Log.w(LOG_TAG, e);<br></span><span style="color: #008080;"> 8</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (ExecutionException e) {<br></span><span style="color: #008080;"> 9</span>                     <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> RuntimeException(“An error occured while executing doInBackground()”<span style="color: #000000;">,<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">                            e.getCause());<br></span><span style="color: #008080;">11</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (CancellationException e) {<br></span><span style="color: #008080;">12</span>                     postResultIfNotInvoked(<span style="color: #0000ff;">null</span><span style="color: #000000;">);<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">15</span>         };</result></pre><br></div><br></div><br></div><br></div><br><div><span style="font-family: 微软雅黑;">&nbsp; &nbsp; &nbsp; &nbsp; 这里主要是验证postResult是否被调用了，如果没有被调用着调用</span>postResult函数，因为前面mWorker.call方法里面调用过了，所以这里不错操作。</div><br></div><br><div>&nbsp;</div><br><div><span style="font-family: 微软雅黑;">&nbsp; &nbsp; &nbsp; &nbsp; 顺便提一下，在AsyncTask的doInBackground方法中如果需要更新UI的话，则调用</span>AsyncTask的publishProgress方法即可：</div><br><div><br><div><br><div class="linenums"><br><div class="L0"><br><div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">final</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> publishProgress(Progress… values) {<br></span><span style="color: #008080;">2</span>         <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">isCancelled()) {<br></span><span style="color: #008080;">3</span> <span style="color: #000000;">            sHandler.obtainMessage(MESSAGE_POST_PROGRESS,<br></span><span style="color: #008080;">4</span>                     <span style="color: #0000ff;">new</span> AsyncTaskResult<progress>(<span style="color: #0000ff;">this</span><span style="color: #000000;">, values)).sendToTarget();<br></span><span style="color: #008080;">5</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">6</span>     }</progress></pre><br></div><br><code>&lt;span class=&quot;pln&quot;&gt;&lt;span class=&quot;kwd&quot;&gt;
&lt;/span&gt;&lt;/span&gt;</code></div>

<p></p></div><p></p>
<p></p></div><p></p>
<div><span style="font-family: 微软雅黑;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span>publishProgress方法最终也会通过sHandler来调用AsyncTask的onProgressUpdate方法，一般我们如果需要获取进度的话都需要重写AsyncTask的onProgressUpdate。</div>

<p></p></div><p></p>
<div>&nbsp;</div><br><div><span style="font-family: 微软雅黑;">&nbsp; &nbsp; &nbsp; &nbsp; 好了，</span>AsyncTask的源码也分析完了。再次总结一下Asynctask使用的注意事项：</div><br><div><br><br>　　&nbsp;1.异步任务的实例必须在UI线程中创建。<br><br>　　2.execute(Params… params)方法必须在UI线程中调用。<br><br>　　3.不要手动调用onPreExecute()，doInBackground(Params… params)，onProgressUpdate(Progress… values)，onPostExecute(Result result)这几个方法。<br><br>　　4.不能在doInBackground(Params… params)中更改UI组件的信息。<br><br>　　5.一个任务实例只能执行一次，如果执行第二次将会抛出异常。<br><br><small><small>&nbsp;</small></small></div>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2015/10/asynctask-source.html" data-id="ciiy5f4xs00dzq1d0p88o9vl0" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2015/10/asynctask-source.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AsyncTask/">AsyncTask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-asynctask-download" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/asynctask-download.html">AsyncTask实现断点续传</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2015/10/asynctask-download.html">
      <time datetime="2015-10-09T19:34:00.000Z" itemprop="datePublished">2015-10-10</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　之前公司里面项目的下载模块都是使用xUtils提供的，最近看了下xUtils的源码，它里面也是使用AsyncTask来执行异步任务的，它的下载也包含了断点续传的功能。这里我自己也使用AsyncTask也实现了简单的断点续传的功能。</p>
<p>　　首先说一说AsyncTask吧，先来看看AsyncTask的定义：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">abstract</span> <span style="color: #0000ff;">class</span> AsyncTask<params, progress,="" result=""> </params,></pre><br></div>

<p>　　三种泛型类型分别代表&ldquo;启动任务执行的输入参数&rdquo;、&ldquo;后台任务执行的进度&rdquo;、&ldquo;后台计算结果的类型&rdquo;。在特定场合下，并不是所有类型都被使用，如果没有被使用，可以用java.lang.Void类型代替。</p>
<p>　　一个异步任务的执行一般包括以下几个步骤：</p>
<p>　　1.<strong>execute(Params… params)</strong>，执行一个异步任务，需要我们在代码中调用此方法，触发异步任务的执行。</p>
<p>　　2.<strong>onPreExecute()</strong>，在execute(Params… params)被调用后立即执行，一般用来在执行后台任务前对UI做一些标记。</p>
<p>　　3.<strong>doInBackground(Params… params)</strong>，在onPreExecute()完成后立即执行，用于执行较为费时的操作，此方法将接收输入参数和返回计算结果。在执行过程中可以调用publishProgress(Progress… values)来更新进度信息。</p>
<p>　　4.<strong>onProgressUpdate(Progress… values)</strong>，在调用publishProgress(Progress… values)时，此方法被执行，直接将进度信息更新到UI组件上。</p>
<p>　　5.<strong>onPostExecute(Result result)</strong>，当后台操作结束时，此方法将会被调用，计算结果将做为参数传递到此方法中，直接将结果显示到UI组件上。</p>
<p>　　在使用的时候，有几点需要格外注意：</p>
<p>　　1.异步任务的实例必须在UI线程中创建。</p>
<p>　　2.execute(Params… params)方法必须在UI线程中调用。</p>
<p>　　3.不要手动调用onPreExecute()，doInBackground(Params… params)，onProgressUpdate(Progress… values)，onPostExecute(Result result)这几个方法。</p>
<p>　　4.不能在doInBackground(Params… params)中更改UI组件的信息。</p>
<p>　　5.一个任务实例只能执行一次，如果执行第二次将会抛出异常。</p>
<p>　　下面是使用AsyncTask实现断点续传的代码：</p>
<p>　　断点续传的思路其实也挺简单，首先判断待下载的文件在本地是否存在，如果存在，则表示该文件已经下载过一部分了，只需要获取文件当前大小即已下载大小，设置给http的header就行了：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> Header header_size = <span style="color: #0000ff;">new</span> BasicHeader(“Range”, “bytes=” + readedSize + “-“<span style="color: #000000;">);<br></span><span style="color: #008080;">2</span> request.addHeader(header_size);</pre><br></div>

<p>&nbsp;</p>
<p>　　1、布局文件代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">LinearLayout </span><span style="color: #ff0000;">xmlns:android</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/apk/res/android" target="_blank" rel="external">http://schemas.android.com/apk/res/android</a>“</span><br><span style="color: #008080;"> 2</span> <span style="color: #ff0000;">    xmlns:tools</span><span style="color: #0000ff;">=”<a href="http://schemas.android.com/tools" target="_blank" rel="external">http://schemas.android.com/tools</a>“</span><span style="color: #ff0000;"> android:layout_width</span><span style="color: #0000ff;">=”match_parent”</span><br><span style="color: #008080;"> 3</span> <span style="color: #ff0000;">    android:layout_height</span><span style="color: #0000ff;">=”match_parent”</span><span style="color: #ff0000;"> android:paddingLeft</span><span style="color: #0000ff;">=”@dimen/activity_horizontal_margin”</span><br><span style="color: #008080;"> 4</span> <span style="color: #ff0000;">    android:paddingRight</span><span style="color: #0000ff;">=”@dimen/activity_horizontal_margin”</span><br><span style="color: #008080;"> 5</span> <span style="color: #ff0000;">    android:paddingTop</span><span style="color: #0000ff;">=”@dimen/activity_vertical_margin”</span><br><span style="color: #008080;"> 6</span> <span style="color: #ff0000;">    android:paddingBottom</span><span style="color: #0000ff;">=”@dimen/activity_vertical_margin”</span><span style="color: #ff0000;"> tools:context</span><span style="color: #0000ff;">=”.AsyncTaskDemoActivity”</span><br><span style="color: #008080;"> 7</span> <span style="color: #ff0000;">    android:orientation</span><span style="color: #0000ff;">=”vertical”</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;"> 8</span><br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Button<br></span><span style="color: #008080;">10</span>         <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/begin”</span><br><span style="color: #008080;">11</span> <span style="color: #ff0000;">        android:layout_width</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">12</span> <span style="color: #ff0000;">        android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">13</span> <span style="color: #ff0000;">        android:text</span><span style="color: #0000ff;">=”开始下载”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">14</span><br><span style="color: #008080;">15</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">Button<br></span><span style="color: #008080;">16</span>         <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/end”</span><br><span style="color: #008080;">17</span> <span style="color: #ff0000;">        android:layout_width</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">18</span> <span style="color: #ff0000;">        android:layout_height</span><span style="color: #0000ff;">=”wrap_content”</span><br><span style="color: #008080;">19</span> <span style="color: #ff0000;">        android:text</span><span style="color: #0000ff;">=”暂停下载”</span><span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">20</span><br><span style="color: #008080;">21</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">ProgressBar<br></span><span style="color: #008080;">22</span>         <span style="color: #ff0000;">android:id</span><span style="color: #0000ff;">=”@+id/progressbar”</span><br><span style="color: #008080;">23</span> <span style="color: #ff0000;">        style</span><span style="color: #0000ff;">=”?android:attr/progressBarStyleHorizontal”</span><br><span style="color: #008080;">24</span> <span style="color: #ff0000;">        android:layout_width</span><span style="color: #0000ff;">=”fill_parent”</span><br><span style="color: #008080;">25</span> <span style="color: #ff0000;">        android:layout_height</span><span style="color: #0000ff;">=”3dp”</span><br><span style="color: #008080;">26</span> <span style="color: #ff0000;">        android:layout_marginTop</span><span style="color: #0000ff;">=”10dp”</span><br><span style="color: #008080;">27</span> <span style="color: #ff0000;">        android:max</span><span style="color: #0000ff;">=”100”</span> <span style="color: #0000ff;">/&gt;</span><br><span style="color: #008080;">28</span><br><span style="color: #008080;">29</span> <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">LinearLayout</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p>　　布局比较简单，就两个按钮和一个进度条控件，按钮控制下载与暂停。</p>
<p>&nbsp;</p>
<p>　　2、断点续传核心代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">package</span><span style="color: #000000;"> com.bbk.lling.myapplication;<br></span><span style="color: #008080;">  2</span><br><span style="color: #008080;">  3</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.app.Activity;<br></span><span style="color: #008080;">  4</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.AsyncTask;<br></span><span style="color: #008080;">  5</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Bundle;<br></span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.os.Environment;<br></span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.util.Log;<br></span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.view.View;<br></span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.ProgressBar;<br></span><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> android.widget.Toast;<br></span><span style="color: #008080;"> 11</span><br><span style="color: #008080;"> 12</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.Header;<br></span><span style="color: #008080;"> 13</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.HttpResponse;<br></span><span style="color: #008080;"> 14</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.client.HttpClient;<br></span><span style="color: #008080;"> 15</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.client.methods.HttpGet;<br></span><span style="color: #008080;"> 16</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.impl.client.DefaultHttpClient;<br></span><span style="color: #008080;"> 17</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> org.apache.http.message.BasicHeader;<br></span><span style="color: #008080;"> 18</span><br><span style="color: #008080;"> 19</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.File;<br></span><span style="color: #008080;"> 20</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.FileOutputStream;<br></span><span style="color: #008080;"> 21</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.IOException;<br></span><span style="color: #008080;"> 22</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.InputStream;<br></span><span style="color: #008080;"> 23</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.OutputStream;<br></span><span style="color: #008080;"> 24</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.io.RandomAccessFile;<br></span><span style="color: #008080;"> 25</span> <span style="color: #0000ff;">import</span><span style="color: #000000;"> java.net.MalformedURLException;<br></span><span style="color: #008080;"> 26</span><br><span style="color: #008080;"> 27</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> AsyncTaskDemoActivity <span style="color: #0000ff;">extends</span><span style="color: #000000;"> Activity {<br></span><span style="color: #008080;"> 28</span><br><span style="color: #008080;"> 29</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> ProgressBar progressBar;<br></span><span style="color: #008080;"> 30</span>     <span style="color: #008000;">//</span><span style="color: #008000;">下载路径</span><br><span style="color: #008080;"> 31</span>     <span style="color: #0000ff;">private</span> String downloadPath = Environment.getExternalStorageDirectory() +<br><span style="color: #008080;"> 32</span>             File.separator + “download”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 33</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> DownloadAsyncTask downloadTask;<br></span><span style="color: #008080;"> 34</span><br><span style="color: #008080;"> 35</span> <span style="color: #000000;">    @Override<br></span><span style="color: #008080;"> 36</span>     <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onCreate(Bundle savedInstanceState) {<br></span><span style="color: #008080;"> 37</span>         <span style="color: #0000ff;">super</span><span style="color: #000000;">.onCreate(savedInstanceState);<br></span><span style="color: #008080;"> 38</span> <span style="color: #000000;">        setContentView(R.layout.activity_async_task_demo);<br></span><span style="color: #008080;"> 39</span>         progressBar =<span style="color: #000000;"> (ProgressBar) findViewById(R.id.progressbar);<br></span><span style="color: #008080;"> 40</span>         <span style="color: #008000;">//</span><span style="color: #008000;">开始下载</span><br><span style="color: #008080;"> 41</span>         findViewById(R.id.begin).setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener() {<br></span><span style="color: #008080;"> 42</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 43</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v) {<br></span><span style="color: #008080;"> 44</span>                 <span style="color: #008000;">/<strong></strong></span><br><span style="color: #008080;"> 45</span> <span style="color: #008000;">                 <em> 一个AsyncTask只能被执行一次，否则会抛异常<br></em></span><span style="color: #008080;"> 46</span> <span style="color: #008000;">                  java.lang.IllegalStateException: Cannot execute task: the task is already running.<br></span><span style="color: #008080;"> 47</span> <span style="color: #008000;">                 <em> 如果要重新开始任务的话要重新创建AsyncTask对象<br></em></span><span style="color: #008080;"> 48</span>                  <span style="color: #008000;">/</span><br><span style="color: #008080;"> 49</span>                 <span style="color: #0000ff;">if</span>(downloadTask != <span style="color: #0000ff;">null</span> &amp;&amp; !<span style="color: #000000;">downloadTask.isCancelled()) {<br></span><span style="color: #008080;"> 50</span>                     <span style="color: #0000ff;">return</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 51</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 52</span>                 downloadTask = <span style="color: #0000ff;">new</span> DownloadAsyncTask(“<a href="http://bbk-lewen.u.qiniudn.com/3d5b1a2c-4986-4e4a-a626-b504a36e600a.flv" target="_blank" rel="external">http://bbk-lewen.u.qiniudn.com/3d5b1a2c-4986-4e4a-a626-b504a36e600a.flv</a>“<span style="color: #000000;">);<br></span><span style="color: #008080;"> 53</span> <span style="color: #000000;">                downloadTask.execute();<br></span><span style="color: #008080;"> 54</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 55</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;"> 56</span><br><span style="color: #008080;"> 57</span>         <span style="color: #008000;">//</span><span style="color: #008000;">暂停下载</span><br><span style="color: #008080;"> 58</span>         findViewById(R.id.end).setOnClickListener(<span style="color: #0000ff;">new</span><span style="color: #000000;"> View.OnClickListener() {<br></span><span style="color: #008080;"> 59</span> <span style="color: #000000;">            @Override<br></span><span style="color: #008080;"> 60</span>             <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onClick(View v) {<br></span><span style="color: #008080;"> 61</span>                 <span style="color: #0000ff;">if</span>(downloadTask != <span style="color: #0000ff;">null</span> &amp;&amp; downloadTask.getStatus() ==<span style="color: #000000;"> AsyncTask.Status.RUNNING) {<br></span><span style="color: #008080;"> 62</span>                     downloadTask.cancel(<span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;"> 63</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 64</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 65</span> <span style="color: #000000;">        });<br></span><span style="color: #008080;"> 66</span><br><span style="color: #008080;"> 67</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 68</span><br><span style="color: #008080;"> 69</span>     <span style="color: #008000;">/</span><br><span style="color: #008080;"> 70</span> <span style="color: #008000;">     <em> 下载的AsyncTask<br></em></span><span style="color: #008080;"> 71</span>      <span style="color: #008000;">/</span><br><span style="color: #008080;"> 72</span>     <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">class</span> DownloadAsyncTask <span style="color: #0000ff;">extends</span> AsyncTask<string, integer,="" long=""><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 73</span>         <span style="color: #0000ff;">private</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">final</span> String TAG = “DownloadAsyncTask”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 74</span>         <span style="color: #0000ff;">private</span><span style="color: #000000;"> String mUrl;<br></span><span style="color: #008080;"> 75</span><br><span style="color: #008080;"> 76</span>         <span style="color: #0000ff;">public</span><span style="color: #000000;"> DownloadAsyncTask(String url) {<br></span><span style="color: #008080;"> 77</span>             <span style="color: #0000ff;">this</span>.mUrl =<span style="color: #000000;"> url;<br></span><span style="color: #008080;"> 78</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 79</span><br><span style="color: #008080;"> 80</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;"> 81</span>         <span style="color: #0000ff;">protected</span><span style="color: #000000;"> Long doInBackground(String… params) {<br></span><span style="color: #008080;"> 82</span>             Log.i(TAG, “downloading”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 83</span>             <span style="color: #0000ff;">if</span>(mUrl == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 84</span>                 <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 85</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;"> 86</span>             HttpClient client = <span style="color: #0000ff;">new</span><span style="color: #000000;"> DefaultHttpClient();<br></span><span style="color: #008080;"> 87</span>             HttpGet request = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HttpGet(mUrl);<br></span><span style="color: #008080;"> 88</span>             HttpResponse response = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 89</span>             InputStream is = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 90</span>             RandomAccessFile fos = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 91</span>             OutputStream output = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 92</span><br><span style="color: #008080;"> 93</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 94</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">创建存储文件夹</span><br><span style="color: #008080;"> 95</span>                 File dir = <span style="color: #0000ff;">new</span><span style="color: #000000;"> File(downloadPath);<br></span><span style="color: #008080;"> 96</span>                 <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">dir.exists()) {<br></span><span style="color: #008080;"> 97</span> <span style="color: #000000;">                    dir.mkdir();<br></span><span style="color: #008080;"> 98</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;"> 99</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">本地文件</span><br><span style="color: #008080;">100</span>                 File file = <span style="color: #0000ff;">new</span> File(downloadPath + File.separator + mUrl.substring(mUrl.lastIndexOf(“/“) + 1<span style="color: #000000;">));<br></span><span style="color: #008080;">101</span>                 <span style="color: #0000ff;">if</span>(!<span style="color: #000000;">file.exists()){<br></span><span style="color: #008080;">102</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">创建文件输出流</span><br><span style="color: #008080;">103</span>                     output = <span style="color: #0000ff;">new</span><span style="color: #000000;"> FileOutputStream(file);<br></span><span style="color: #008080;">104</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">获取下载输入流</span><br><span style="color: #008080;">105</span>                     response =<span style="color: #000000;"> client.execute(request);<br></span><span style="color: #008080;">106</span>                     is =<span style="color: #000000;"> response.getEntity().getContent();<br></span><span style="color: #008080;">107</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">写入本地</span><br><span style="color: #008080;">108</span> <span style="color: #000000;">                    file.createNewFile();<br></span><span style="color: #008080;">109</span>                     <span style="color: #0000ff;">byte</span> buffer [] = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">byte</span>[1024<span style="color: #000000;">];<br></span><span style="color: #008080;">110</span>                     <span style="color: #0000ff;">int</span> inputSize = -1<span style="color: #000000;">;<br></span><span style="color: #008080;">111</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">获取文件总大小，用于计算进度</span><br><span style="color: #008080;">112</span>                     <span style="color: #0000ff;">long</span> total =<span style="color: #000000;"> response.getEntity().getContentLength();<br></span><span style="color: #008080;">113</span>                     <span style="color: #0000ff;">int</span> count = 0; <span style="color: #008000;">//</span><span style="color: #008000;">已下载大小</span><br><span style="color: #008080;">114</span>                     <span style="color: #0000ff;">while</span>((inputSize = is.read(buffer)) != -1<span style="color: #000000;">) {<br></span><span style="color: #008080;">115</span>                         output.write(buffer, 0<span style="color: #000000;">, inputSize);<br></span><span style="color: #008080;">116</span>                         count +=<span style="color: #000000;"> inputSize;<br></span><span style="color: #008080;">117</span>                         <span style="color: #008000;">//</span><span style="color: #008000;">更新进度</span><br><span style="color: #008080;">118</span>                         <span style="color: #0000ff;">this</span>.publishProgress((<span style="color: #0000ff;">int</span>) ((count / (<span style="color: #0000ff;">float</span>) total) <em> 100<span style="color: #000000;">));<br></span><span style="color: #008080;">119</span>                         <span style="color: #008000;">//</span><span style="color: #008000;">一旦任务被取消则退出循环，否则一直执行，直到结束</span><br><span style="color: #008080;">120</span>                         <span style="color: #0000ff;">if</span><span style="color: #000000;">(isCancelled()) {<br></span><span style="color: #008080;">121</span> <span style="color: #000000;">                            output.flush();<br></span><span style="color: #008080;">122</span>                             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">123</span> <span style="color: #000000;">                        }<br></span><span style="color: #008080;">124</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">125</span> <span style="color: #000000;">                    output.flush();<br></span><span style="color: #008080;">126</span>                 } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">127</span>                     <span style="color: #0000ff;">long</span> readedSize = file.length(); <span style="color: #008000;">//</span><span style="color: #008000;">文件大小，即已下载大小<br></span><span style="color: #008080;">128</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">设置下载的数据位置XX字节到XX字节</span><br><span style="color: #008080;">129</span>                     Header header_size = <span style="color: #0000ff;">new</span> BasicHeader(“Range”, “bytes=” + readedSize + “-“<span style="color: #000000;">);<br></span><span style="color: #008080;">130</span> <span style="color: #000000;">                    request.addHeader(header_size);<br></span><span style="color: #008080;">131</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">执行请求获取下载输入流</span><br><span style="color: #008080;">132</span>                     response =<span style="color: #000000;"> client.execute(request);<br></span><span style="color: #008080;">133</span>                     is =<span style="color: #000000;"> response.getEntity().getContent();<br></span><span style="color: #008080;">134</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">文件总大小=已下载大小+未下载大小</span><br><span style="color: #008080;">135</span>                     <span style="color: #0000ff;">long</span> total = readedSize +<span style="color: #000000;"> response.getEntity().getContentLength();<br></span><span style="color: #008080;">136</span><br><span style="color: #008080;">137</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">创建文件输出流</span><br><span style="color: #008080;">138</span>                     fos = <span style="color: #0000ff;">new</span> RandomAccessFile(file, “rw”<span style="color: #000000;">);<br></span><span style="color: #008080;">139</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">从文件的size以后的位置开始写入，其实也不用，直接往后写就可以。有时候多线程下载需要用</span><br><span style="color: #008080;">140</span> <span style="color: #000000;">                    fos.seek(readedSize);<br></span><span style="color: #008080;">141</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">这里用RandomAccessFile和FileOutputStream都可以，只是使用FileOutputStream的时候要传入第二哥参数true,表示从后面填充<br></span><span style="color: #008080;">142</span> <span style="color: #008000;">//</span><span style="color: #008000;">                    output = new FileOutputStream(file, true);</span><br><span style="color: #008080;">143</span><br><span style="color: #008080;">144</span>                     <span style="color: #0000ff;">byte</span> buffer [] = <span style="color: #0000ff;">new</span> <span style="color: #0000ff;">byte</span>[1024<span style="color: #000000;">];<br></span><span style="color: #008080;">145</span>                     <span style="color: #0000ff;">int</span> inputSize = -1<span style="color: #000000;">;<br></span><span style="color: #008080;">146</span>                     <span style="color: #0000ff;">int</span> count = (<span style="color: #0000ff;">int</span><span style="color: #000000;">)readedSize;<br></span><span style="color: #008080;">147</span>                     <span style="color: #0000ff;">while</span>((inputSize = is.read(buffer)) != -1<span style="color: #000000;">) {<br></span><span style="color: #008080;">148</span>                         fos.write(buffer, 0<span style="color: #000000;">, inputSize);<br></span><span style="color: #008080;">149</span> <span style="color: #008000;">//</span><span style="color: #008000;">                        output.write(buffer, 0, inputSize);</span><br><span style="color: #008080;">150</span>                         count +=<span style="color: #000000;"> inputSize;<br></span><span style="color: #008080;">151</span>                         <span style="color: #0000ff;">this</span>.publishProgress((<span style="color: #0000ff;">int</span>) ((count / (<span style="color: #0000ff;">float</span>) total) </em> 100<span style="color: #000000;">));<br></span><span style="color: #008080;">152</span>                         <span style="color: #0000ff;">if</span><span style="color: #000000;">(isCancelled()) {<br></span><span style="color: #008080;">153</span> <span style="color: #008000;">//</span><span style="color: #008000;">                            output.flush();</span><br><span style="color: #008080;">154</span>                             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">155</span> <span style="color: #000000;">                        }<br></span><span style="color: #008080;">156</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">157</span> <span style="color: #008000;">//</span><span style="color: #008000;">                    output.flush();</span><br><span style="color: #008080;">158</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">159</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (MalformedURLException e) {<br></span><span style="color: #008080;">160</span> <span style="color: #000000;">                Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">161</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;">162</span> <span style="color: #000000;">                Log.e(TAG, e.getMessage());<br></span><span style="color: #008080;">163</span>             } <span style="color: #0000ff;">finally</span><span style="color: #000000;">{<br></span><span style="color: #008080;">164</span>                 <span style="color: #0000ff;">try</span><span style="color: #000000;">{<br></span><span style="color: #008080;">165</span>                     <span style="color: #0000ff;">if</span>(is != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">166</span> <span style="color: #000000;">                        is.close();<br></span><span style="color: #008080;">167</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">168</span>                     <span style="color: #0000ff;">if</span>(output != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">169</span> <span style="color: #000000;">                        output.close();<br></span><span style="color: #008080;">170</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">171</span>                     <span style="color: #0000ff;">if</span>(fos != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">172</span> <span style="color: #000000;">                        fos.close();<br></span><span style="color: #008080;">173</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">174</span>                 } <span style="color: #0000ff;">catch</span><span style="color: #000000;">(Exception e) {<br></span><span style="color: #008080;">175</span> <span style="color: #000000;">                    e.printStackTrace();<br></span><span style="color: #008080;">176</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">177</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">178</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">179</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">180</span><br><span style="color: #008080;">181</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">182</span>         <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPreExecute() {<br></span><span style="color: #008080;">183</span>             Log.i(TAG, “download begin “<span style="color: #000000;">);<br></span><span style="color: #008080;">184</span>             Toast.makeText(AsyncTaskDemoActivity.<span style="color: #0000ff;">this</span>, “开始下载”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">185</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPreExecute();<br></span><span style="color: #008080;">186</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">187</span><br><span style="color: #008080;">188</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">189</span>         <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onProgressUpdate(Integer… values) {<br></span><span style="color: #008080;">190</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">.onProgressUpdate(values);<br></span><span style="color: #008080;">191</span>             Log.i(TAG, “downloading  “ + values[0<span style="color: #000000;">]);<br></span><span style="color: #008080;">192</span>             <span style="color: #008000;">//</span><span style="color: #008000;">更新界面进度条</span><br><span style="color: #008080;">193</span>             progressBar.setProgress(values[0<span style="color: #000000;">]);<br></span><span style="color: #008080;">194</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">195</span><br><span style="color: #008080;">196</span> <span style="color: #000000;">        @Override<br></span><span style="color: #008080;">197</span>         <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> onPostExecute(Long aLong) {<br></span><span style="color: #008080;">198</span>             Log.i(TAG, “download success “ +<span style="color: #000000;"> aLong);<br></span><span style="color: #008080;">199</span>             Toast.makeText(AsyncTaskDemoActivity.<span style="color: #0000ff;">this</span>, “下载结束”<span style="color: #000000;">, Toast.LENGTH_SHORT).show();<br></span><span style="color: #008080;">200</span>             <span style="color: #0000ff;">super</span><span style="color: #000000;">.onPostExecute(aLong);<br></span><span style="color: #008080;">201</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">202</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">203</span><br><span style="color: #008080;">204</span> }</string,></pre><br></div>

<p>　　这样简单的断点续传功能就实现了，这里只是单个线程的，如果涉及多个线程同时下载，那复杂很多，后面再琢磨琢磨。</p>
<p>&nbsp;</p>
<p><span style="font-size: 15px;"><span style="color: #ff0000;"><strong>源码下载：</strong></span><a href="https://github.com/liuling07/MultiTaskAndThreadDownload" title="https://github.com/liuling07/MultiTaskAndThreadDownload" target="_blank" rel="external">https://github.com/liuling07/MultiTaskAndThreadDownload</a></span></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2015/10/asynctask-download.html" data-id="ciiy5f4y200egq1d0731c4l08" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2015/10/asynctask-download.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AsyncTask/">AsyncTask</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/断点续传/">断点续传</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-overdraw" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/overdraw.html">Android布局优化之过度绘制</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2015/10/overdraw.html">
      <time datetime="2015-10-07T22:38:00.000Z" itemprop="datePublished">2015-10-08</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>如果一个布局十分复杂，那么就需要来排查是否出现了过度绘制，如果出现了，那么很可能会造成刷新率下降，造成卡顿的现象。那么什么是过度绘制呢？过度绘制就是在同一个区域中叠加了多个控件。这就像小时候我们画画，白纸就是没有绘制的画板，如果我们画了一个房子，涂上了红色，又在上面画了窗户，图上了棕色，窗户上又画了蓝色的玻璃，这重重复的叠加就是过度绘制，在白纸上的结果是，过度绘制的区域纸会被水笔浸的比较湿，在手机上就会出现显示较慢。如果说这是感性的认识，那么我就引用下面一段话来理性的解释一下：</p>
<blockquote>
<p>1. 布局文件是一个xml文件，inflate布局文件其实就是解析xml，根据标签信息创建相应的布局对象并做关联。xml中的标签和属性设置越多，节点树的深度越深，在解析时要执行的判断逻辑、函数的嵌套和递归就越多，所以时间消耗越多；</p>
<p>2. inflate操作只是布局影响的第一个环节，一个界面要显示出来，在requestLayout后还要执行一系列的measure、layout、draw的操作，每一步的执行时间都会受到布局本身的影响。而界面的最终显示是所有这些操作完成后才实现的，所以如果布局质量差，会增加每一步操作的时间成本，最终显示时间就会比较长。</p>
</blockquote>
<p>现在，我们就来说说如何查看是否有过度绘制，和如何避免它吧。</p>
<p>&nbsp;</p>
<p><strong>一、查看是否存在过度绘制</strong></p>
<p>1. GPU过渡绘制:对于过度绘制的测试主要通过人工进行测试，也是发现应用过渡绘制的首选途径 .通过打开开发者选项中的 显示GPU过度绘制(魅族手机:设置&mdash;辅助功能&ndash;开发人员工具&ndash;硬件加速渲染&mdash;调试GPU过渡绘制&mdash; 显示过渡绘制区域.）来进行测试（PS：只有android4.2及以上的版本才具备此功能)</p>
<p>1. 颜色标识: 从好到差:蓝-绿-淡红-红</p>
<p>1. 蓝色1x过度绘制<br>2. 绿色2x过度绘制<br>3. 淡红色3x过度绘制<br>4. 红色超过4x过度绘制</p>
<p>2. 验收标准:</p>
<p>1. 控制过度绘制为2x<br>2. 不允许存在4x过度绘制<br>3. 不允许存在面积超过屏幕1/4区域的3x过度绘制（淡红色区域）</p>
<p><img src="http://www.liuling123.com/wp-content/uploads/2015/11/061747014999623.png" alt=""></p>
<p>从图中我们就可以看到，文字部分出现了绿色（因为和底部的蓝色叠加了，所以变成了黄绿色），在顶部开关部分出现了红色，也就是四层的过度绘制，这是需要避免的。但由于在屏幕上占的位置很小，所以可以酌情考虑。</p>
<p>&nbsp;</p>
<p><img src="http://www.liuling123.com/wp-content/uploads/2015/11/061751006098571.png" alt=""></p>
<p>上面面是小米商店的截屏，可以看见其中有大量的过度绘制区域，总结下来过度绘制较常见于文字区域。</p>
<p>&nbsp;</p>
<p><strong>二、避免过度绘制的方法</strong></p>
<p>下面这段文字来自他人博客：</p>
<blockquote>
<p>作者：<a href="http://weibo.com/1315612820/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo" title="个人微博" target="_blank" rel="external">Gracker</a><br>出处：<a href="http://www.androidperformance.com/" title="网站主页" target="_blank" rel="external">androidperformance.com</a><br>本文版权归作者所有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利。<br>打赏一下：&nbsp;<a href="http://weibo.com/p/1001603801588257955883?from=page_100505_profile&amp;wvr=6&amp;mod=wenzhangmod" target="_blank" rel="external">微博打赏</a></p>
</blockquote>
<p>1. 尽量多使用RelativeLayout和LinearLayout, 不要使用绝对布局AbsoluteLayout，</p>
<p>1. 在布局<strong>层次一样的情况下</strong>， 建议使用LinearLayout代替RelativeLayout, 因为LinearLayout性能要稍高一点.<br>2. 在完成<strong>相对较复杂的布局时</strong>,建议使用<strong>RelativeLayout</strong>,RelativeLayout可以简单实现LinearLayout嵌套才能实现的布局.</p>
<p>2. 将可复用的组件抽取出来并通过include标签使用；<br>3. 使用<strong>ViewStub</strong>标签来加载一些不常用的布局；<br>4. 动态地inflation view性能要比SetVisiblity性能要好.当然用<strong>VIewStub</strong>是最好的选择.<br>5. 使用<strong>merge</strong>标签减少布局的嵌套层次<br>6. 去掉多余的背景颜色</p>
<p>7. 对于有多层背景颜色的Layout来说,留最上面一层的颜色即可,其他底层的颜色都可以去掉<br>8. 对于使用Selector当背景的Layout(比如ListView的Item,会使用Selector来标记点击,选择等不同的状态),可以将normal状态的color设置为&rdquo;@android:color/transparent&rdquo;,来解决对应的问题</p>
<p>9. 内嵌使用包含layout_weight属性的LinearLayout会在绘制时<strong>花费昂贵的系统资源</strong>，因为每一个子组件都需要被测量两次。在使用ListView与GridView的时候，这个问题显的尤其重要，因为子组件会重复被创建.所以要尽量避免使用Layout_weight<br>10. 使得Layout宽而浅，而不是窄而深（在<strong>Hierarchy Viewer</strong>的Tree视图里面体现）</p>
<p>&nbsp;</p>
<p>上面提到的多个工具和技巧我都在之前的文章有所讲解了，在实际开发过程中需要多多思考，根据情况来使用不同的技巧。</p>
<p>&nbsp;</p>
<p>参考自：</p>
<p><a href="http://www.androidperformance.com/android-performance-optimization-overdraw-1.html" target="_blank" rel="external">http://www.androidperformance.com/android-performance-optimization-overdraw-1.html</a></p>
<p><a href="http://www.open-open.com/lib/view/open1421656495031.html" target="_blank" rel="external">http://www.open-open.com/lib/view/open1421656495031.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2015/10/overdraw.html" data-id="ciiy5f4rd003wq1d0bwcl4r8u" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2015/10/overdraw.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/布局/">布局</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/布局优化/">布局优化</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <article id="post-optimize-viewstub" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/optimize-viewstub.html">【转】Android布局优化之ViewStub</a>
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2015/10/optimize-viewstub.html">
      <time datetime="2015-10-07T20:26:00.000Z" itemprop="datePublished">2015-10-08</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>ViewStub是Android布局优化中一个很不错的标签/控件，直接继承自View。虽然Android开发人员基本上都听说过，但是真正用的可能不多。</p>
<p>ViewStub可以理解成一个非常轻量级的View，与其他的控件一样，有着自己的属性及特定的方法。当ViewStub使用在布局文件中时，当程序inflate布局文件时，ViewStub本身也会被解析，且占据内存控件，但是与其他控件相比，主要区别体现在以下几点：</p>
<p>1.当布局文件inflate时，ViewStub控件虽然也占据内存，但是相相比于其他控件，ViewStub所占内存很小；</p>
<p>2.布局文件inflate时，ViewStub主要是作为一个&ldquo;占位符&rdquo;的性质，放置于view tree中，且ViewStub本身是不可见的。ViewStub中有一个layout属性，指向ViewStub本身可能被替换掉的布局文件，在一定时机时，通过viewStub.inflate()完成此过程；</p>
<p>3.ViewStub本身是不可见的，对ViewStub&nbsp;setVisibility(..)与其他控件不一样，ViewStub的setVisibility 成View.VISIBLE或INVISIBLE如果是首次使用，都会自动inflate其指向的布局文件，并替换ViewStub本身，再次使用则是相当于对其指向的布局文件设置可见性。</p>
<p>这里需要注意的是：</p>
<p>1.ViewStub之所以常称之为&ldquo;延迟化加载&rdquo;，是因为在教多数情况下，程序无需显示ViewStub所指向的布局文件，只有在特定的某些较少条件下，此时ViewStub所指向的布局文件才需要被inflate，且此布局文件直接将当前ViewStub替换掉，具体是通过viewStub.infalte()或viewStub.setVisibility(View.VISIBLE)来完成；</p>
<p>2.正确把握住ViewStub的应用场景非常重要，正如如1中所描述需求场景下，使用ViewStub可以优化布局；</p>
<p>3.对ViewStub的inflate操作只能进行一次，因为inflate的时候是将其指向的布局文件解析inflate并替换掉当前ViewStub本身（由此体现出了ViewStub&ldquo;占位符&rdquo;性质），一旦替换后，此时原来的布局文件中就没有ViewStub控件了，因此，如果多次对ViewStub进行infalte，会出现错误信息：ViewStub must have a non-null ViewGroup viewParent。</p>
<p>4.3中所讲到的ViewStub指向的布局文件解析inflate并替换掉当前ViewStub本身，并不是完全意义上的替换（与include标签还不太一样），替换时，布局文件的layout params是以ViewStub为准，其他布局属性是以布局文件自身为准。</p>
<p>下面看一下简单的需求场景：在listview显示列表数据时，可能会出现服务端一条数据都没有的情况，此时显示一个EmptyView，提示用户暂无数据。此时考虑到实际应用中EmptyView显示出来的机会相当小，因此，可以在布局文件中使用ViewStub站位，然后确实没有数据时才viewStub.infalte()。</p>
<p>相关部分代码如下：</p>
<div class="cnblogs_code"><br><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a title="复制代码"><img src="http://www.liuling123.com/wp-content/uploads/2015/11/copycode.gif" alt="复制代码"></a></span></div><br><pre> 1 public void showEmptyView() {<br> 2     listview.setVisibility(View.GONE);<br> 3     if (noDataView == null) {<br> 4         ViewStub noDataViewStub = (ViewStub) view.findViewById(R.id.no_data_viewstub);<br> 5         noDataView = noDataViewStub.inflate();<br> 6     } else {<br> 7         noDataView.setVisibility(View.VISIBLE);<br> 8     }<br> 9 }<br>10<br>11 public void showListView(){<br>12     listview.setVisibility(View.VISIBLE);<br>13     if(noDataView != null){<br>14         noDataView.setVisibility(View.GONE);<br>15     }<br>16 }</pre><br><div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a title="复制代码"><img src="http://www.liuling123.com/wp-content/uploads/2015/11/copycode.gif" alt="复制代码"></a></span></div><br></div>

<p>特别需要注意的是对ViewStub是否已经inflate的判断。</p>
<p>在Listview Item中，有时候可能遇到如下场景：在不同的列表页item的布局一部分不同，但相对于整个item布局来说又不是很多，此时最常见的有如下两种处理：</p>
<p>1.对不同的部分都写出来，放到一个item文件中，然后逻辑分别处理不同部分的显示与否（View.VISIBLE和View.GONE）；</p>
<p>2.对这两种不同的item整个部分都分别区分开，完全写成两个item文件，然后结合listView显示不同布局分别做逻辑处理（通过getItemType()等方式）。</p>
<p>以上两种处理方式其实都可以，第一种方式逻辑清晰，非常灵活，只是在一定程度上增加了内存和资源消耗。第二种方式是的布局文件有重复（虽然相同部分可以通过include，但是逻辑上还是有重复的），包括逻辑上处理的代码实质上的重复。一般对于有较大不同的item布局推荐采用此种方式。</p>
<p>有时候结合需求，可以在第一种方式的基础上，结合ViewStub&ldquo;占位符&rdquo;可以比较好的完成此类需求。也相当于是两种方式的一种折中形式，但同时兼顾了内存和资源消耗以及不同的布局逻辑控件。</p>
<p>&nbsp;</p>
<p>原文：<a href="http://www.cnblogs.com/lwbqqyumidi/p/4047108.html" title="http://www.cnblogs.com/lwbqqyumidi/p/4047108.html" target="_blank" rel="external">http://www.cnblogs.com/lwbqqyumidi/p/4047108.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://liuling07.github.io/2015/10/optimize-viewstub.html" data-id="ciiy5f4rl004aq1d0stspwlho" class="article-share-link">Share</a>
      
        <a href="http://liuling07.github.io/2015/10/optimize-viewstub.html#ds-thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/">android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/布局/">布局</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/布局优化/">布局优化</a></li></ul>

    </footer>
  </div>
  
</article>



    
      <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
      </nav>
    </section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新博文</h3>
    <div class="widget">
      <ul id="recent-post" class="no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/人生感悟/">人生感悟</a></p>
              <p class="item-title"><a href="/2015/12/say-bye-to-my-2015.html" class="title">Say bye to my 2015</a></p>
              <p class="item-date"><time datetime="2015-12-25T09:25:10.000Z" itemprop="datePublished">2015-12-25</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/12/mvp-pattern-android.html" class="title">MVP模式在Android项目中的使用</a></p>
              <p class="item-date"><time datetime="2015-12-23T14:16:04.000Z" itemprop="datePublished">2015-12-23</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/12/intent-resolving-in-android-m.html" class="title">【译文】Android M中Intent的解析</a></p>
              <p class="item-date"><time datetime="2015-12-04T06:52:06.000Z" itemprop="datePublished">2015-12-04</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/12/performance-listviews.html" class="title">【译文】高性能ListViews</a></p>
              <p class="item-date"><time datetime="2015-12-02T10:22:14.000Z" itemprop="datePublished">2015-12-02</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/11/android-multi-photo-picker.html" class="title">Android带多选功能的PhotoPicker</a></p>
              <p class="item-date"><time datetime="2015-11-21T07:46:03.000Z" itemprop="datePublished">2015-11-21</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">博文分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Framework/">Framework</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hadoop/">Hadoop</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JNI-amp-NDK/">JNI&amp;NDK</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a><span class="category-list-count">35</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NoSQL/">NoSQL</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/人生感悟/">人生感悟</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他技术/">其他技术</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后端/">后端</a><span class="category-list-count">29</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构和算法/">数据结构和算法</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">7</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/AsyncTask/" style="font-size: 11.54px;">AsyncTask</a> <a href="/tags/LruCache/" style="font-size: 10px;">LruCache</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/NoSQL/" style="font-size: 13.08px;">NoSQL</a> <a href="/tags/android/" style="font-size: 18.46px;">android</a> <a href="/tags/android-studio/" style="font-size: 10px;">android studio</a> <a href="/tags/c/" style="font-size: 10px;">c++</a> <a href="/tags/camera/" style="font-size: 10px;">camera</a> <a href="/tags/framework/" style="font-size: 10.77px;">framework</a> <a href="/tags/hadoop/" style="font-size: 14.62px;">hadoop</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/jni/" style="font-size: 13.08px;">jni</a> <a href="/tags/linux/" style="font-size: 16.15px;">linux</a> <a href="/tags/mysql/" style="font-size: 11.54px;">mysql</a> <a href="/tags/redis/" style="font-size: 13.08px;">redis</a> <a href="/tags/spring/" style="font-size: 10.77px;">spring</a> <a href="/tags/sqlite/" style="font-size: 10px;">sqlite</a> <a href="/tags/web后端/" style="font-size: 19.23px;">web后端</a> <a href="/tags/内存缓存/" style="font-size: 10px;">内存缓存</a> <a href="/tags/前端/" style="font-size: 13.85px;">前端</a> <a href="/tags/反射/" style="font-size: 10px;">反射</a> <a href="/tags/图片选择/" style="font-size: 10.77px;">图片选择</a> <a href="/tags/多线程/" style="font-size: 17.69px;">多线程</a> <a href="/tags/布局/" style="font-size: 12.31px;">布局</a> <a href="/tags/布局优化/" style="font-size: 10.77px;">布局优化</a> <a href="/tags/开源/" style="font-size: 10.77px;">开源</a> <a href="/tags/断点续传/" style="font-size: 11.54px;">断点续传</a> <a href="/tags/科学上网/" style="font-size: 10px;">科学上网</a> <a href="/tags/自定义控件/" style="font-size: 10px;">自定义控件</a> <a href="/tags/解决方案/" style="font-size: 16.92px;">解决方案</a> <a href="/tags/设计模式/" style="font-size: 15.38px;">设计模式</a> <a href="/tags/译文/" style="font-size: 10.77px;">译文</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">博文归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">November 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">May 2013</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">March 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">February 2013</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">January 2013</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">December 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">November 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">August 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">July 2012</a><span class="archive-list-count">8</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap widget-list">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a target="_blank" href="http://blog.daimajia.com">代码家</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.trinea.cn">Trinea</a>
          </li>
        
          <li>
            <a target="_blank" href="https://www.aswifter.com">APP开发者</a>
          </li>
        
          <li>
            <a target="_blank" href="http://blog.seoui.com">笑松小站</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.apkfuns.com">舞影凌风</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.ttfde.org">TTF的家园</a>
          </li>
        
          <li>
            <a target="_blank" href="http://rocko.xyz">Rocko&#39;s blog</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.93sec.cc">教程资源网</a>
          </li>
        
      </ul>
    </div>
  </div>


  
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2000 - 2016 Lauren<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    

<script type="text/javascript">
  var duoshuoQuery = {short_name:"liuling07"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>





 <script src="//ajax.lug.ustc.edu.cn/ajax/libs/jquery/2.1.3/jquery.min.js"></script>




  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>