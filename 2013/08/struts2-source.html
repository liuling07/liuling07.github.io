<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>struts2请求过程源码分析 | 残剑博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Struts2是Struts社区和WebWork社区的共同成果，我们甚至可以说，Struts2是WebWork的升级版，他采用的正是WebWork的核心，所以，Struts2并不是一个不成熟的产品，相反，构建在WebWork基础之上的Struts2是一个运行稳定、性能优异、设计成熟的WEB框架。
　　我这里的struts2源码是从官网下载的一个最新的struts-2.3.15.1-src.zip，">
<meta property="og:type" content="article">
<meta property="og:title" content="struts2请求过程源码分析">
<meta property="og:url" content="http://www.liuling123.com/2013/08/struts2-source.html">
<meta property="og:site_name" content="残剑博客">
<meta property="og:description" content="Struts2是Struts社区和WebWork社区的共同成果，我们甚至可以说，Struts2是WebWork的升级版，他采用的正是WebWork的核心，所以，Struts2并不是一个不成熟的产品，相反，构建在WebWork基础之上的Struts2是一个运行稳定、性能优异、设计成熟的WEB框架。
　　我这里的struts2源码是从官网下载的一个最新的struts-2.3.15.1-src.zip，">
<meta property="og:image" content="http://www.liuling123.com/wp-content/uploads/2015/11/09202011-2fea5e8ff5b04a50b1ea62caee458465.jpg">
<meta property="og:image" content="http://www.liuling123.com/wp-content/uploads/2015/11/09202934-b79818718d674f9c86a3d687a14a0779.jpg">
<meta property="og:updated_time" content="2016-01-03T07:41:23.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="struts2请求过程源码分析">
<meta name="twitter:description" content="Struts2是Struts社区和WebWork社区的共同成果，我们甚至可以说，Struts2是WebWork的升级版，他采用的正是WebWork的核心，所以，Struts2并不是一个不成熟的产品，相反，构建在WebWork基础之上的Struts2是一个运行稳定、性能优异、设计成熟的WEB框架。
　　我这里的struts2源码是从官网下载的一个最新的struts-2.3.15.1-src.zip，">
  
  
    <link rel="icon" href="favicon.png">
  
  
 <link href='//fonts.lug.ustc.edu.cn/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
 <link href="//fonts.lug.ustc.edu.cn/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">


  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css" type="text/css">
  

  

  
</head>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo"><i class="logo" style="background-image: url(/css/images/logo.png)"></i><span class="site-title">残剑博客</span></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/.">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      
        <nav id="sub-nav">
          <div class="profile" id="profile-nav">
            <a id="profile-anchor" href="javascript:;"><img class="avatar" src="/css/images/protrait.jpg"><i class="fa fa-caret-down"></i></a>
          </div>
        </nav>
      
      <div id="search-form-wrap">
        
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="http://www.liuling123.com"></form>
        
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
        
          <td><a class="main-nav-link" href="/.">Home</a></td>
        
          <td><a class="main-nav-link" href="/archives">Archives</a></td>
        
          <td><a class="main-nav-link" href="/categories">Categories</a></td>
        
          <td><a class="main-nav-link" href="/tags">Tags</a></td>
        
          <td><a class="main-nav-link" href="/about">About</a></td>
        
        <td>
          
            <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="搜索"><input type="hidden" name="sitesearch" value="http://www.liuling123.com"></form>
          
        </td>
      </tr>
    </table>
  </div>
</header>

    <div class="outer">
      
        <aside id="profile">
  <div class="inner profile-inner">
    <div class="base-info profile-block">
      <img id="avatar" src="/css/images/protrait.jpg">
      <h2 id="name">Lauren</h2>
      <h3 id="title">Android Developer</h3>
      <span id="location"><i class="fa fa-map-marker"></i>Shenzhen, China</span>
      <a id="follow" href="https://github.com/liuling07">关注我</a>
    </div>
    <div class="article-info profile-block">
      <div class="article-info-block">
        135
        <span>文章</span>
      </div>
      <div class="article-info-block">
        32
        <span>标签</span>
      </div>
    </div>
    
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
          
          <td><a href="https://github.com/liuling07" target="_blank" title="github"><i class="fa fa-github"></i></a></td>
          
          <td><a href="http://weibo.com/LaurenLiuling/" target="_blank" title="weibo"><i class="fa fa-weibo"></i></a></td>
          
          <td><a href="https://plus.google.com/u/0/107098505138563589748/" target="_blank" title="google-plus"><i class="fa fa-google-plus"></i></a></td>
          
          <td><a href="http://stackoverflow.com/users/5629327/lauren-liuling" target="_blank" title="stack-overflow"><i class="fa fa-stack-overflow"></i></a></td>
          
          <td><a href="https://twitter.com/lauren_liuLing/" target="_blank" title="twitter"><i class="fa fa-twitter"></i></a></td>
          
          <td><a href="https://www.facebook.com/lauren.liuling/" target="_blank" title="facebook"><i class="fa fa-facebook"></i></a></td>
          
          <td><a href="/atom.xml" target="_blank" title="rss"><i class="fa fa-rss"></i></a></td>
          
        </tr>
      </table>
    </div>
    
    
  </div>
</aside>

      
      <section id="main"><article id="post-struts2-source" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      struts2请求过程源码分析
    </h1>
  

        <div class="article-meta">
          
  <div class="article-date">
    <i class="fa fa-calendar"></i>
    <a href="/2013/08/struts2-source.html">
      <time datetime="2013-08-09T19:15:00.000Z" itemprop="datePublished">2013-08-10</time>
    </a>
  </div>


          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/categories/后端/">后端</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
                
        <p>　　Struts2是Struts社区和WebWork社区的共同成果，我们甚至可以说，Struts2是WebWork的升级版，他采用的正是WebWork的核心，所以，Struts2并不是一个不成熟的产品，相反，构建在WebWork基础之上的Struts2是一个运行稳定、性能优异、设计成熟的WEB框架。</p>
<p>　　我这里的struts2源码是从官网下载的一个最新的struts-2.3.15.1-src.zip，将其解压即可。里面的目录页文件非常的多，我们只需要定位到struts-2.3.15.1\src\core\src\main\java\org\apache\struts2查看源文件。目录结构如下图<img src="http://www.liuling123.com/wp-content/uploads/2015/11/09202011-2fea5e8ff5b04a50b1ea62caee458465.jpg" alt=""></p>
<p>　　Struts2框架的正常运行，除了占核心地位的xwork的支持以外，Struts2本身也提供了许多类，这些类被分门别类组织到不同的包中。从源代码中发现，基本上每一个Struts2类都访问了WebWork提供的功能，从而也可以看出Struts2与WebWork千丝万缕的联系。但无论如何，Struts2的核心功能比如将请求委托给哪个Action处理都是由xwork完成的，Struts2只是在WebWork的基础上做了适当的简化、加强和封装，并少量保留Struts1.x中的习惯。</p>
<a id="more"></a>
<p><span style="color: #000000; font-size: 14px;">以下是包说明：</span></p>
<table style="font: 12px/18px tahoma, arial, sans-serif; margin: 0px; padding: 0px; border: 1px solid #c0c0c0; color: #444444; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; border-collapse: collapse; border-spacing: 0px; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" border="0" align="left"><br><tbody style="margin: 0px; padding: 0px;"><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2. components</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><br><br><span style="font-size: 14px;">该包封装视图组件，Struts2在视图组件上有了很大加强，不仅增加了组件的属性个数，更新增了几个非常有用的组件，如updownselect、doubleselect、datetimepicker、token、tree等。</span><br><br><span style="font-size: 14px;">&nbsp;另外，Struts2可视化视图组件开始支持主题(theme)，缺省情况下，使用自带的缺省主题，如果要自定义页面效果，需要将组件的theme属性设置为simple。</span><br><br></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2. config</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">该包定义与配置相关的接口和类。实际上，工程中的xml和properties文件的读取和解析都是由WebWork完成的，Struts只做了少量的工作。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2.dispatcher</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">Struts2的核心包，最重要的类都放在该包中。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2.impl</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">该包只定义了3个类，他们是StrutsActionProxy、StrutsActionProxyFactory、StrutsObjectFactory，这三个类都是对xwork的扩展。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2.interceptor</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">定义内置的截拦器。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2.servlet</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">用HttpServletRequest相关方法<span style="margin: 0px; padding: 0px;">实现</span>principalproxy接口。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2.util</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">实用包。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">org.apache.struts2.views</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="margin: 0px; padding: 0px; font-size: 14px;">提供freemarker、jsp、velocity等不同类型的页面呈现。</span></td><br></tr><br></tbody><br></table>

<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="color: #000000; font-size: 14px;">&nbsp;根目录下的5个文件说明：</span></p>
<table style="font: 12px/18px tahoma, arial, sans-serif; margin: 0px; padding: 0px; border: 1px solid #c0c0c0; color: #444444; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; white-space: normal; border-collapse: collapse; border-spacing: 0px; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;" border="0" align="left"><br><tbody style="margin: 0px; padding: 0px;"><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">StrutsStatics</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">Struts常数。常数可以用来获取或设置对象从行动中或其他集合。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">RequestUtils</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">请求处理程序类。此类只有一个方法getServletPath，作用检索当前请求的servlet路径</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">ServletActionContext</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">网站的特定的上下文信息</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">StrutsConstants</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">该类提供了框架配置键的中心位置用于存储和检索配置设置。</span></td><br></tr><br><tr style="margin: 0px; padding: 0px;"><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">StrutsException</span></td><br><td style="margin: 0px; padding: 3px; border: 1px solid #c0c0c0; border-collapse: collapse; word-break: normal !important;"><span style="font-size: 14px;">通用运行时异常类</span></td><br></tr><br></tbody><br></table>

<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">&nbsp; &nbsp;</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p><span style="font-size: 14px;">&nbsp;</span></p>
<p>&nbsp;</p>
<p><span style="color: #000000;"><span style="font-size: 14px;">s</span><span style="font-size: 14px;">truts2 架构图如下图所示：</span></span></p>
<p><span style="font-size: 14px;"><img src="http://www.liuling123.com/wp-content/uploads/2015/11/09202934-b79818718d674f9c86a3d687a14a0779.jpg" alt=""></span></p>
<p><span style="color: #000000; font-size: 14px;">依照上图，我们可以看出一个请求在struts的处理大概有如下步骤：</span></p>
<p>　　1、客户端初始化一个指向Servlet容器（例如Tomcat）的请求；</p>
<p>　　2、这个请求经过一系列的过滤器（Filter）（这些过滤器中有一个叫做ActionContextCleanUp的可选过滤器，这个过滤器对于Struts2和其他框架的集成很有帮助，例如：SiteMesh Plugin）；</p>
<p>　　3、接着<span style="color: #000000;">StrutsPrepareAndExecuteFilter</span>被调用，<span style="color: #000000;">StrutsPrepareAndExecuteFilter</span>询问ActionMapper来决定这个请求是否需要调用某个Action；</p>
<p>　　4、如果ActionMapper决定需要调用某个Action，FilterDispatcher把请求的处理交给ActionProxy；</p>
<p>　　5、ActionProxy通过Configuration Manager询问框架的配置文件，找到需要调用的Action类；</p>
<p>　　6、ActionProxy创建一个ActionInvocation的实例。</p>
<p>　　7、ActionInvocation实例使用命名模式来调用，在调用Action的过程前后，涉及到相关拦截器（Intercepter）的调用。</p>
<p>　　8、一旦Action执行完毕，ActionInvocation负责根据struts.xml中的配置找到对应的返回结果。返回结果通常是（但不总是，也可能是另外的一个Action链）一个需要被表示的JSP或者FreeMarker的模版。在表示的过程中可以使用Struts2 框架中继承的标签。在这个过程中需要涉及到ActionMapper。</p>
<p>&nbsp;</p>
<p>strut2源码分析：</p>
<p>　　首先我们使用struts2框架都会在web.xml中注册和映射struts2，配置内容如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">filter</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">2</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">filter-name</span><span style="color: #0000ff;">&gt;</span>struts2<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">filter-name</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">3</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">filter-class</span><span style="color: #0000ff;">&gt;</span>org.apache.struts2.dispatcher.ng.filter.StrutsPrepareAndExecuteFilter<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">filter-class</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">4</span>   <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">filter</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">5</span>   <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">filter-mapping</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">6</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">filter-name</span><span style="color: #0000ff;">&gt;</span>struts2<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">filter-name</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">7</span>     <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">url-pattern</span><span style="color: #0000ff;">&gt;</span>/*<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">url-pattern</span><span style="color: #0000ff;">&gt;</span><br><span style="color: #008080;">8</span>   <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">filter-mapping</span><span style="color: #0000ff;">&gt;</span></pre><br></div>

<p><span style="color: #ff0000;">注：在早期的struts2中，都是使用FilterDispathcer，从Struts 2.1.3开始，它已不推荐使用。如果你使用的Struts的版本 &gt;= 2.1.3，推荐升级到新的Filter，StrutsPrepareAndExecuteFilter。在此研究的是StrutsPrepareAndExecuteFilter。</span></p>
<p><span style="color: #ff0000;">　　<span style="color: #000000;">StrutsPrepareAndExecuteFilter中的方法：</span></span></p>
<table border="1"><br><tbody><br><tr><br><td><span style="color: #000000; font-size: 14px;">void init(FilterConfig filterConfig)</span></td><br><td><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;继承自Filter，过滤器的初始化</span></td><br></tr><br><tr><br><td><span style="color: #000000; font-size: 14px;">doFilter(ServletRequest req, ServletResponse res, FilterChain chain)</span></td><br><td><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;<span style="text-align: left; text-transform: none; line-height: 26px; text-indent: 0px; letter-spacing: normal; font-family: Arial; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">继承自Filter，执行过滤器</span></span></td><br></tr><br><tr><br><td><span style="color: #000000; font-size: 14px;">void destroy()</span></td><br><td><span style="color: #000000; font-size: 14px;">继承自Filter，用于资源释放</span></td><br></tr><br><tr><br><td><span style="color: #000000; font-size: 14px;">void postInit(Dispatcher dispatcher, FilterConfig filterConfig)</span></td><br><td><span style="color: #000000; font-size: 14px;"><span style="text-align: left; text-transform: none; line-height: 26px; text-indent: 0px; letter-spacing: normal; font-family: Arial; font-style: normal; font-variant: normal; font-weight: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp;Callback for post initialization（一个空的方法，用于方法回调初始化）</span></span></td><br></tr><br></tbody><br></table>

<p>&nbsp;web容器一启动，就会初始化核心过滤器<span style="color: #000000;">StrutsPrepareAndExecuteFilter</span>，并执行初始化方法，初始化方法如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> init(FilterConfig filterConfig) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> ServletException {<br></span><span style="color: #008080;"> 2</span>         InitOperations init = <span style="color: #0000ff;">new</span><span style="color: #000000;"> InitOperations();<br></span><span style="color: #008080;"> 3</span>         Dispatcher dispatcher = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 5</span>             <span style="color: #008000;">//</span><span style="color: #008000;">封装filterConfig，其中有个主要方法getInitParameterNames将参数名字以String格式存储在List中</span><br><span style="color: #008080;"> 6</span>             FilterHostConfig config = <span style="color: #0000ff;">new</span><span style="color: #000000;"> FilterHostConfig(filterConfig);<br></span><span style="color: #008080;"> 7</span>             <span style="color: #008000;">//</span><span style="color: #008000;">初始化struts内部日志</span><br><span style="color: #008080;"> 8</span> <span style="color: #000000;">            init.initLogging(config);<br></span><span style="color: #008080;"> 9</span>             <span style="color: #008000;">//</span><span style="color: #008000;">创建dispatcher ，并初始化</span><br><span style="color: #008080;">10</span>             dispatcher =<span style="color: #000000;"> init.initDispatcher(config);<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">            init.initStaticContentLoader(config, dispatcher);<br></span><span style="color: #008080;">12</span>             <span style="color: #008000;">//</span><span style="color: #008000;">初始化类属性：prepare 、execute</span><br><span style="color: #008080;">13</span>             prepare = <span style="color: #0000ff;">new</span><span style="color: #000000;"> PrepareOperations(filterConfig.getServletContext(), dispatcher);<br></span><span style="color: #008080;">14</span>             execute = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ExecuteOperations(filterConfig.getServletContext(), dispatcher);<br></span><span style="color: #008080;">15</span>             <span style="color: #0000ff;">this</span>.excludedPatterns =<span style="color: #000000;"> init.buildExcludedPatternsList(dispatcher);<br></span><span style="color: #008080;">16</span>             <span style="color: #008000;">//</span><span style="color: #008000;">回调空的postInit方法</span><br><span style="color: #008080;">17</span> <span style="color: #000000;">            postInit(dispatcher, filterConfig);<br></span><span style="color: #008080;">18</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">19</span>             <span style="color: #0000ff;">if</span> (dispatcher != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">                dispatcher.cleanUpAfterInit();<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">            init.cleanup();<br></span><span style="color: #008080;">23</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">24</span>     }</pre><br></div>

<p><span style="font: 14px/26px Arial; text-align: left; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;"><span class="Apple-converted-space">&nbsp;关于封装filterConfig，</span>首先看下FilterHostConfig ，源码如下：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">class</span> FilterHostConfig <span style="color: #0000ff;">implements</span><span style="color: #000000;"> HostConfig {<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span>     <span style="color: #0000ff;">private</span><span style="color: #000000;"> FilterConfig config;<br></span><span style="color: #008080;"> 4</span>     <span style="color: #008000;">//</span><span style="color: #008000;">构造方法</span><br><span style="color: #008080;"> 5</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> FilterHostConfig(FilterConfig config) {<br></span><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">this</span>.config =<span style="color: #000000;"> config;<br></span><span style="color: #008080;"> 7</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;"> 8</span>     <span style="color: #008000;">//</span><span style="color: #008000;">根据init-param配置的param-name获取param-value的值  </span><br><span style="color: #008080;"> 9</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> String getInitParameter(String key) {<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> config.getInitParameter(key);<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">12</span>     <span style="color: #008000;">//</span><span style="color: #008000;">返回初始化参数名的迭代器 </span><br><span style="color: #008080;">13</span>     <span style="color: #0000ff;">public</span> Iterator<string><span style="color: #000000;"> getInitParameterNames() {<br></span><span style="color: #008080;">14</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> MakeIterator.convert(config.getInitParameterNames());<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">16</span>     <span style="color: #008000;">//</span><span style="color: #008000;">返回Servlet上下文</span><br><span style="color: #008080;">17</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ServletContext getServletContext() {<br></span><span style="color: #008080;">18</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> config.getServletContext();<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">    }<br></span><span style="color: #008080;">20</span> }</string></pre><br></div>

<p><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　只有短短的几行代码，getInitParameterNames是这个类的核心，将Filter初始化参数名称有枚举类型转为Iterator。此类的主要作为是对filterConfig 封装。</span></p>
<p><span style="font-size: 14px;">　　接下来，看下<span style="color: #000000;">StrutsPrepareAndExecuteFilter</span>中init方法中dispatcher = init.initDispatcher(config);这是初始化dispatcher的，是通过init对象的initDispatcher方法来初始化的，init是InitOperations类的对象，我们看看InitOperations中initDispatcher方法：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span>  <span style="color: #0000ff;">public</span><span style="color: #000000;"> Dispatcher initDispatcher( HostConfig filterConfig ) {<br></span><span style="color: #008080;">2</span>         Dispatcher dispatcher =<span style="color: #000000;"> createDispatcher(filterConfig);<br></span><span style="color: #008080;">3</span> <span style="color: #000000;">        dispatcher.init();<br></span><span style="color: #008080;">4</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> dispatcher;<br></span><span style="color: #008080;">5</span>     }</pre><br></div>

<p><span style="color: #000000; font-size: 14px;"><span style="font: 14px/26px Arial; text-align: left; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　创建Dispatcher，会读取 filterConfig 中的配置信息，将配置信息解析出来，封装成为一个Map，然后根绝servlet上下文和参数Map构造Dispatcher ：</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">private</span><span style="color: #000000;"> Dispatcher createDispatcher( HostConfig filterConfig ) {<br></span><span style="color: #008080;"> 2</span>         <span style="color: #008000;">//</span><span style="color: #008000;">存放参数的Map</span><br><span style="color: #008080;"> 3</span>         Map<string, string=""> params = <span style="color: #0000ff;">new</span> HashMap<string, string=""><span style="color: #000000;">();<br></span><span style="color: #008080;"> 4</span>         <span style="color: #008000;">//</span><span style="color: #008000;">将参数存放到Map</span><br><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">for</span> ( Iterator e =<span style="color: #000000;"> filterConfig.getInitParameterNames(); e.hasNext(); ) {<br></span><span style="color: #008080;"> 6</span>             String name =<span style="color: #000000;"> (String) e.next();<br></span><span style="color: #008080;"> 7</span>             String value =<span style="color: #000000;"> filterConfig.getInitParameter(name);<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">            params.put(name, value);<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">10</span>         <span style="color: #008000;">//</span><span style="color: #008000;">根据servlet上下文和参数Map构造Dispatcher </span><br><span style="color: #008080;">11</span>         <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> Dispatcher(filterConfig.getServletContext(), params);<br></span><span style="color: #008080;">12</span>     }</string,></string,></pre><br></div>

<p>　　这样dispatcher对象创建完成，接着就是dispatcher对象的初始化，打开Dispatcher类，看到它的init方法如下：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> init() {<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">if</span> (configurationManager == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 4</span>             configurationManager =<span style="color: #000000;"> createConfigurationManager(BeanSelectionProvider.DEFAULT_BEAN_NAME);<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 8</span> <span style="color: #000000;">            init_FileManager();<br></span><span style="color: #008080;"> 9</span>             <span style="color: #008000;">//</span><span style="color: #008000;">加载org/apache/struts2/default.properties</span><br><span style="color: #008080;">10</span>             init_DefaultProperties(); <span style="color: #008000;">//</span><span style="color: #008000;"> [1]<br></span><span style="color: #008080;">11</span>             <span style="color: #008000;">//</span><span style="color: #008000;">加载struts-default.xml,struts-plugin.xml,struts.xml</span><br><span style="color: #008080;">12</span>             init_TraditionalXmlConfigurations(); <span style="color: #008000;">//</span><span style="color: #008000;"> [2]</span><br><span style="color: #008080;">13</span>             init_LegacyStrutsProperties(); <span style="color: #008000;">//</span><span style="color: #008000;"> [3]<br></span><span style="color: #008080;">14</span>             <span style="color: #008000;">//</span><span style="color: #008000;">用户自己实现的ConfigurationProviders类 </span><br><span style="color: #008080;">15</span>             init_CustomConfigurationProviders(); <span style="color: #008000;">//</span><span style="color: #008000;"> [5]<br></span><span style="color: #008080;">16</span>             <span style="color: #008000;">//</span><span style="color: #008000;">Filter的初始化参数 </span><br><span style="color: #008080;">17</span>             init_FilterInitParameters() ; <span style="color: #008000;">//</span><span style="color: #008000;"> [6]</span><br><span style="color: #008080;">18</span>             init_AliasStandardObjects() ; <span style="color: #008000;">//</span><span style="color: #008000;"> [7]</span><br><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>             Container container =<span style="color: #000000;"> init_PreloadConfiguration();<br></span><span style="color: #008080;">21</span>             container.inject(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">            init_CheckWebLogicWorkaround(container);<br></span><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span>             <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">dispatcherListeners.isEmpty()) {<br></span><span style="color: #008080;">25</span>                 <span style="color: #0000ff;">for</span><span style="color: #000000;"> (DispatcherListener l : dispatcherListeners) {<br></span><span style="color: #008080;">26</span>                     l.dispatcherInitialized(<span style="color: #0000ff;">this</span><span style="color: #000000;">);<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">28</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">29</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception ex) {<br></span><span style="color: #008080;">30</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (LOG.isErrorEnabled())<br></span><span style="color: #008080;">31</span>                 LOG.error(“Dispatcher initialization failed”<span style="color: #000000;">, ex);<br></span><span style="color: #008080;">32</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> StrutsException(ex);<br></span><span style="color: #008080;">33</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">34</span>     }</pre><br></div>

<p>　　这里主要是加载一些配置文件的，<span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">将按照顺序逐一加载：default.properties，struts-default.xml,struts-plugin.xml,struts.xml，&hellip;&hellip;关于文件是如何加载的，大家可以自己取看源文件，主要是由xwork核心类加载的，代码在xwork-core\src\main\java\com\opensymphony\xwork2\config\providers包里面。</span></p>
<p><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　现在，我们回到StrutsPrepareAndExecuteFilter类中，刚才我们分析了StrutsPrepareAndExecuteFilter类的init方法，该方法在web容器一启动就会调用的，当用户访问某个action的时候，首先调用核心过滤器StrutsPrepareAndExecuteFilter的doFilter方法，该方法内容如下：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> doFilter(ServletRequest req, ServletResponse res, FilterChain chain) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException, ServletException {<br></span><span style="color: #008080;"> 2</span><br><span style="color: #008080;"> 3</span>         HttpServletRequest request =<span style="color: #000000;"> (HttpServletRequest) req;<br></span><span style="color: #008080;"> 4</span>         HttpServletResponse response =<span style="color: #000000;"> (HttpServletResponse) res;<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 7</span>             <span style="color: #008000;">//</span><span style="color: #008000;">设置编码和国际化</span><br><span style="color: #008080;"> 8</span> <span style="color: #000000;">            prepare.setEncodingAndLocale(request, response);<br></span><span style="color: #008080;"> 9</span>             <span style="color: #008000;">//</span><span style="color: #008000;">创建action上下文</span><br><span style="color: #008080;">10</span> <span style="color: #000000;">            prepare.createActionContext(request, response);<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">            prepare.assignDispatcherToThread();<br></span><span style="color: #008080;">12</span>             <span style="color: #0000ff;">if</span> (excludedPatterns != <span style="color: #0000ff;">null</span> &amp;&amp;<span style="color: #000000;"> prepare.isUrlExcluded(request, excludedPatterns)) {<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">                chain.doFilter(request, response);<br></span><span style="color: #008080;">14</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">15</span>                 request =<span style="color: #000000;"> prepare.wrapRequest(request);<br></span><span style="color: #008080;">16</span>                 ActionMapping mapping = prepare.findActionMapping(request, response, <span style="color: #0000ff;">true</span><span style="color: #000000;">);<br></span><span style="color: #008080;">17</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">如果mapping为空，则认为不是调用action,会调用下一个过滤器链，直到获取到mapping才调用action</span><br><span style="color: #008080;">18</span>                 <span style="color: #0000ff;">if</span> (mapping == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">19</span>                     <span style="color: #0000ff;">boolean</span> handled =<span style="color: #000000;"> execute.executeStaticResourceRequest(request, response);<br></span><span style="color: #008080;">20</span>                     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">handled) {<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">                        chain.doFilter(request, response);<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">23</span>                 } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">24</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">执行action</span><br><span style="color: #008080;">25</span> <span style="color: #000000;">                    execute.executeAction(request, response, mapping);<br></span><span style="color: #008080;">26</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">27</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">28</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">29</span> <span style="color: #000000;">            prepare.cleanupRequest(request);<br></span><span style="color: #008080;">30</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">31</span>     }</pre><br></div>

<p>　　下面对doFilter方法中的重点部分一一讲解：</p>
<p>(1)prepare.setEncodingAndLocale(request, response);</p>
<p>　　第8行是调用prepare对象的setEncodingAndLocale方法，prepare是PrepareOperations类的对象，PrepareOperations类是用来做请求准备工作的。我们看下PrepareOperations类中的setEncodingAndLocale方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> setEncodingAndLocale(HttpServletRequest request, HttpServletResponse response) {<br></span><span style="color: #008080;">2</span> <span style="color: #000000;">        dispatcher.prepare(request, response);<br></span><span style="color: #008080;">3</span>     }</pre><br></div>

<p>　　在这方法里面我们可以看到它只是调用了dispatcher的prepare方法而已，下面我们看看dispatcher的prepare方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> prepare(HttpServletRequest request, HttpServletResponse response) {<br></span><span style="color: #008080;"> 2</span>         String encoding = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">if</span> (defaultEncoding != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 4</span>             encoding =<span style="color: #000000;"> defaultEncoding;<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 6</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> check for Ajax request to use UTF-8 encoding strictly </span><span style="color: #008000; text-decoration: underline;"><a href="http://www.w3.org/TR/XMLHttpRequest/" target="_blank" rel="external">http://www.w3.org/TR/XMLHttpRequest/</a></span><span style="color: #008000;">#the-send-method</span><br><span style="color: #008080;"> 7</span>         <span style="color: #0000ff;">if</span> (“XMLHttpRequest”.equals(request.getHeader(“X-Requested-With”<span style="color: #000000;">))) {<br></span><span style="color: #008080;"> 8</span>             encoding = “UTF-8”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">10</span><br><span style="color: #008080;">11</span>         Locale locale = <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">12</span>         <span style="color: #0000ff;">if</span> (defaultLocale != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">13</span>             locale =<span style="color: #000000;"> LocalizedTextUtil.localeFromString(defaultLocale, request.getLocale());<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">15</span><br><span style="color: #008080;">16</span>         <span style="color: #0000ff;">if</span> (encoding != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">            applyEncoding(request, encoding);<br></span><span style="color: #008080;">18</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">19</span><br><span style="color: #008080;">20</span>         <span style="color: #0000ff;">if</span> (locale != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">            response.setLocale(locale);<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">23</span><br><span style="color: #008080;">24</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (paramsWorkaroundEnabled) {<br></span><span style="color: #008080;">25</span>             request.getParameter(“foo”); <span style="color: #008000;">//</span><span style="color: #008000;"> simply read any parameter (existing or not) to “prime” the request</span><br><span style="color: #008080;">26</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">27</span>     }</pre><br></div>

<p>　　我们可以看到该方法只是简单的设置了<span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">encoding 和locale ，做的只是一些辅助的工作。</span></p>
<p><span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">(2)prepare.createActionContext(request, response)</span></p>
<p><span style="color: #000000; font-size: 14px;"><span style="font: 14px/26px Arial; text-align: left; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">　　我们回到StrutsPrepareAndExecuteFilter的doFilter方法，看到第10行代码：prepare.createActionContext(request, response);这是action上下文的创建，<span style="font: 14px/26px Arial; text-align: left; color: #000000; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">ActionContext是一个容器，这个容易主要存储request、session、application、parameters等相关信 息.ActionContext是一个线程的本地变量，这意味着不同的action之间不会共享ActionContext，所以也不用考虑线程安全问 题。其实质是一个Map，key是标示request、session、&hellip;&hellip;的字符串，值是其对应的对象，我们可以看到com.opensymphony.xwork2.ActionContext类中时如下定义的：</span></span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">static</span> ThreadLocal<actioncontext> actionContext = <span style="color: #0000ff;">new</span> ThreadLocal<actioncontext>();</actioncontext></actioncontext></pre><br></div>

<p><span style="color: #000000; font-size: 14px;"><span style="font: 14px/26px Arial; text-align: left; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">我们看下PrepareOperations类的createActionContext方法：</span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">/<em>*</em></span><br><span style="color: #008080;"> 2</span> <span style="color: #008000;">      Creates the action context and initializes the thread local<br></span><span style="color: #008080;"> 3</span>      <span style="color: #008000;">*/</span><br><span style="color: #008080;"> 4</span>     <span style="color: #0000ff;">public</span><span style="color: #000000;"> ActionContext createActionContext(HttpServletRequest request, HttpServletResponse response) {<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">        ActionContext ctx;<br></span><span style="color: #008080;"> 6</span>         Integer counter = 1<span style="color: #000000;">;<br></span><span style="color: #008080;"> 7</span>         Integer oldCounter =<span style="color: #000000;"> (Integer) request.getAttribute(CLEANUP_RECURSION_COUNTER);<br></span><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">if</span> (oldCounter != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 9</span>             counter = oldCounter + 1<span style="color: #000000;">;<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">11</span>         <span style="color: #008000;">//</span><span style="color: #008000;">此处是从ThreadLocal中获取此ActionContext变量</span><br><span style="color: #008080;">12</span>         ActionContext oldContext =<span style="color: #000000;"> ActionContext.getContext();<br></span><span style="color: #008080;">13</span>         <span style="color: #0000ff;">if</span> (oldContext != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">14</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> detected existing context, so we are probably in a forward</span><br><span style="color: #008080;">15</span>             ctx = <span style="color: #0000ff;">new</span> ActionContext(<span style="color: #0000ff;">new</span> HashMap<string, object=""><span style="color: #000000;">(oldContext.getContextMap()));<br></span><span style="color: #008080;">16</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">17</span>             ValueStack stack = dispatcher.getContainer().getInstance(ValueStackFactory.<span style="color: #0000ff;">class</span><span style="color: #000000;">).createValueStack();<br></span><span style="color: #008080;">18</span>             stack.getContext().putAll(dispatcher.createContextMap(request, response, <span style="color: #0000ff;">null</span><span style="color: #000000;">, servletContext));<br></span><span style="color: #008080;">19</span>             <span style="color: #008000;">//</span><span style="color: #008000;">stack.getContext()返回的是一个Map<string，object>，根据此Map构造一个ActionContext</string，object></span><br><span style="color: #008080;">20</span>             ctx = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ActionContext(stack.getContext());<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">22</span> <span style="color: #000000;">        request.setAttribute(CLEANUP_RECURSION_COUNTER, counter);<br></span><span style="color: #008080;">23</span>         <span style="color: #008000;">//</span><span style="color: #008000;">将ActionContext存到ThreadLocal </span><br><span style="color: #008080;">24</span> <span style="color: #000000;">        ActionContext.setContext(ctx);<br></span><span style="color: #008080;">25</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> ctx;<br></span><span style="color: #008080;">26</span>     }</string,></pre><br></div>

<p><span style="font: 14px/26px Arial; text-align: left; color: #333333; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; orphans: 2; widows: 2; font-size-adjust: none; font-stretch: normal; background-color: #ffffff; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px;">&nbsp; 　　上面第18行代码中dispatcher.createContextMap，如何封装相关参数：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> Map<string,object><span style="color: #000000;"> createContextMap(HttpServletRequest request, HttpServletResponse response,<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">            ActionMapping mapping, ServletContext context) {<br></span><span style="color: #008080;"> 3</span><br><span style="color: #008080;"> 4</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> request map wrapping the http request objects</span><br><span style="color: #008080;"> 5</span>         Map requestMap = <span style="color: #0000ff;">new</span><span style="color: #000000;"> RequestMap(request);<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> parameters map wrapping the http parameters.  ActionMapping parameters are now handled and applied separately</span><br><span style="color: #008080;"> 8</span>         Map params = <span style="color: #0000ff;">new</span><span style="color: #000000;"> HashMap(request.getParameterMap());<br></span><span style="color: #008080;"> 9</span><br><span style="color: #008080;">10</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> session map wrapping the http session</span><br><span style="color: #008080;">11</span>         Map session = <span style="color: #0000ff;">new</span><span style="color: #000000;"> SessionMap(request);<br></span><span style="color: #008080;">12</span><br><span style="color: #008080;">13</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> application map wrapping the ServletContext</span><br><span style="color: #008080;">14</span>         Map application = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ApplicationMap(context);<br></span><span style="color: #008080;">15</span>         <span style="color: #008000;">//</span><span style="color: #008000;">requestMap、params、session等Map封装成为一个上下文Map </span><br><span style="color: #008080;">16</span>         Map<string,object> extraContext =<span style="color: #000000;"> createContextMap(requestMap, params, session, application, request, response, context);<br></span><span style="color: #008080;">17</span><br><span style="color: #008080;">18</span>         <span style="color: #0000ff;">if</span> (mapping != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">19</span> <span style="color: #000000;">            extraContext.put(ServletActionContext.ACTION_MAPPING, mapping);<br></span><span style="color: #008080;">20</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">21</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> extraContext;<br></span><span style="color: #008080;">22</span>     }</string,object></string,object></pre><br></div>

<p>(3)request = prepare.wrapRequest(request)</p>
<p>　　我们再次回到StrutsPrepareAndExecuteFilter的doFilter方法中，看到第15行：request = prepare.wrapRequest(request);这一句是对request进行包装的，我们看下prepare的wrapRequest方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> HttpServletRequest wrapRequest(HttpServletRequest oldRequest) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> ServletException {<br></span><span style="color: #008080;"> 2</span>         HttpServletRequest request =<span style="color: #000000;"> oldRequest;<br></span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 4</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> Wrap request first, just in case it is multipart/form-data<br></span><span style="color: #008080;"> 5</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> parameters might not be accessible through before encoding (ww-1278)</span><br><span style="color: #008080;"> 6</span>             request =<span style="color: #000000;"> dispatcher.wrapRequest(request, servletContext);<br></span><span style="color: #008080;"> 7</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (IOException e) {<br></span><span style="color: #008080;"> 8</span>             <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> ServletException(“Could not wrap servlet request with MultipartRequestWrapper!”<span style="color: #000000;">, e);<br></span><span style="color: #008080;"> 9</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> request;<br></span><span style="color: #008080;">11</span>     }</pre><br></div>

<p>　　由第6行我们可以看到它里面调用的是dispatcher的wrapRequest方法，并且将servletContext对象也传进去了，我们看下dispatcher的wrapRequest：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> HttpServletRequest wrapRequest(HttpServletRequest request, ServletContext servletContext) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> IOException {<br></span><span style="color: #008080;"> 2</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> don’t wrap more than once</span><br><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">if</span> (request <span style="color: #0000ff;">instanceof</span><span style="color: #000000;"> StrutsRequestWrapper) {<br></span><span style="color: #008080;"> 4</span>             <span style="color: #0000ff;">return</span><span style="color: #000000;"> request;<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 6</span><br><span style="color: #008080;"> 7</span>         String content_type =<span style="color: #000000;"> request.getContentType();<br></span><span style="color: #008080;"> 8</span>         <span style="color: #008000;">//</span><span style="color: #008000;">如果content_type是multipart/form-data类型，则将request包装成MultiPartRequestWrapper对象，否则包装成StrutsRequestWrapper对象</span><br><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">if</span> (content_type != <span style="color: #0000ff;">null</span> &amp;&amp; content_type.contains(“multipart/form-data”<span style="color: #000000;">)) {<br></span><span style="color: #008080;">10</span>             MultiPartRequest mpr =<span style="color: #000000;"> getMultiPartRequest();<br></span><span style="color: #008080;">11</span>             LocaleProvider provider = getContainer().getInstance(LocaleProvider.<span style="color: #0000ff;">class</span><span style="color: #000000;">);<br></span><span style="color: #008080;">12</span>             request = <span style="color: #0000ff;">new</span><span style="color: #000000;"> MultiPartRequestWrapper(mpr, request, getSaveDir(servletContext), provider);<br></span><span style="color: #008080;">13</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">14</span>             request = <span style="color: #0000ff;">new</span><span style="color: #000000;"> StrutsRequestWrapper(request, disableRequestAttributeValueStackLookup);<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> request;<br></span><span style="color: #008080;">18</span>     }</pre><br></div>

<p>　　此次包装根据请求内容的类型不同，返回不同的对象，如果为multipart/form-data类型，则返回MultiPartRequestWrapper类型的对象，该对象服务于文件上传，否则返回StrutsRequestWrapper类型的对象，MultiPartRequestWrapper是StrutsRequestWrapper的子类，而这两个类都是HttpServletRequest接口的实现。</p>
<p>(4)ActionMapping mapping = prepare.findActionMapping(request, response, true)</p>
<p>　　包装request后，通过ActionMapper的getMapping()方法得到请求的Action，Action的配置信息存储在ActionMapping对象中，如StrutsPrepareAndExecuteFilter的doFilter方法中第16行：ActionMapping mapping = prepare.findActionMapping(request, response, true);我们找到prepare对象的findActionMapping方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> ActionMapping findActionMapping(HttpServletRequest request, HttpServletResponse response, <span style="color: #0000ff;">boolean</span><span style="color: #000000;"> forceLookup) {<br></span><span style="color: #008080;"> 2</span>         <span style="color: #008000;">//</span><span style="color: #008000;">首先从request对象中取mapping对象，看是否存在</span><br><span style="color: #008080;"> 3</span>         ActionMapping mapping =<span style="color: #000000;"> (ActionMapping) request.getAttribute(STRUTS_ACTION_MAPPING_KEY);<br></span><span style="color: #008080;"> 4</span>         <span style="color: #008000;">//</span><span style="color: #008000;">不存在就创建一个</span><br><span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">if</span> (mapping == <span style="color: #0000ff;">null</span> ||<span style="color: #000000;"> forceLookup) {<br></span><span style="color: #008080;"> 6</span>             <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 7</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">首先创建ActionMapper对象，通过ActionMapper对象创建mapping对象</span><br><span style="color: #008080;"> 8</span>                 mapping = dispatcher.getContainer().getInstance(ActionMapper.<span style="color: #0000ff;">class</span><span style="color: #000000;">).getMapping(request, dispatcher.getConfigurationManager());<br></span><span style="color: #008080;"> 9</span>                 <span style="color: #0000ff;">if</span> (mapping != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">10</span> <span style="color: #000000;">                    request.setAttribute(STRUTS_ACTION_MAPPING_KEY, mapping);<br></span><span style="color: #008080;">11</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">12</span>             } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception ex) {<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">                dispatcher.sendError(request, response, servletContext, HttpServletResponse.SC_INTERNAL_SERVER_ERROR, ex);<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">15</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">16</span><br><span style="color: #008080;">17</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> mapping;<br></span><span style="color: #008080;">18</span>     }</pre><br></div>

<p>　　下面是ActionMapper接口的实现类DefaultActionMapper的getMapping()方法的源代码：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span><span style="color: #000000;"> ActionMapping getMapping(HttpServletRequest request, ConfigurationManager configManager) {<br></span><span style="color: #008080;"> 2</span>         ActionMapping mapping = <span style="color: #0000ff;">new</span><span style="color: #000000;"> ActionMapping();<br></span><span style="color: #008080;"> 3</span>         <span style="color: #008000;">//</span><span style="color: #008000;">获得请求的uri，即请求路径URL中工程名以后的部分，如/userAction.action</span><br><span style="color: #008080;"> 4</span>         String uri =<span style="color: #000000;"> getUri(request);<br></span><span style="color: #008080;"> 5</span>         <span style="color: #008000;">//</span><span style="color: #008000;">修正url的带;jsessionid 时找不到的bug</span><br><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">int</span> indexOfSemicolon = uri.indexOf(“;”<span style="color: #000000;">);<br></span><span style="color: #008080;"> 7</span>         uri = (indexOfSemicolon &gt; -1) ? uri.substring(0<span style="color: #000000;">, indexOfSemicolon) : uri;<br></span><span style="color: #008080;"> 8</span>         <span style="color: #008000;">//</span><span style="color: #008000;">删除扩展名，如.action或者.do</span><br><span style="color: #008080;"> 9</span>         uri =<span style="color: #000000;"> dropExtension(uri, mapping);<br></span><span style="color: #008080;">10</span>         <span style="color: #0000ff;">if</span> (uri == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">11</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;">12</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">13</span>         <span style="color: #008000;">//</span><span style="color: #008000;">从uri中分离得到请求的action名、命名空间。</span><br><span style="color: #008080;">14</span> <span style="color: #000000;">        parseNameAndNamespace(uri, mapping, configManager);<br></span><span style="color: #008080;">15</span>         <span style="color: #008000;">//</span><span style="color: #008000;">处理特殊的请求参数</span><br><span style="color: #008080;">16</span> <span style="color: #000000;">        handleSpecialParameters(request, mapping);<br></span><span style="color: #008080;">17</span>         <span style="color: #008000;">//</span><span style="color: #008000;">如果允许动态方法调用，即形如/userAction!getAll.action的请求，分离action名和方法名</span><br><span style="color: #008080;">18</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> parseActionName(mapping);<br></span><span style="color: #008080;">19</span>     }</pre><br></div>

<p>　　下面对getMapping方法中的重要部分一一讲解：</p>
<p>　　①：parseNameAndNamespace(uri, mapping, configManager)</p>
<p>　　我们主要看下第14行的parseNameAndNamespace(uri, mapping, configManager);这个方法的主要作用是分离出action名和命名空间：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">protected</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> parseNameAndNamespace(String uri, ActionMapping mapping, ConfigurationManager configManager) {<br></span><span style="color: #008080;"> 2</span> <span style="color: #000000;">        String namespace, name;<br></span><span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">int</span> lastSlash = uri.lastIndexOf(“/“); <span style="color: #008000;">//</span><span style="color: #008000;">最后的斜杆的位置</span><br><span style="color: #008080;"> 4</span>         <span style="color: #0000ff;">if</span> (lastSlash == -1<span style="color: #000000;">) {<br></span><span style="color: #008080;"> 5</span>             namespace = “”<span style="color: #000000;">;<br></span><span style="color: #008080;"> 6</span>             name =<span style="color: #000000;"> uri;<br></span><span style="color: #008080;"> 7</span>         } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (lastSlash == 0<span style="color: #000000;">) {<br></span><span style="color: #008080;"> 8</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> ww-1046, assume it is the root namespace, it will fallback to<br></span><span style="color: #008080;"> 9</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> default<br></span><span style="color: #008080;">10</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> namespace anyway if not found in root namespace.</span><br><span style="color: #008080;">11</span>             namespace = “/“<span style="color: #000000;">;<br></span><span style="color: #008080;">12</span>             name = uri.substring(lastSlash + 1<span style="color: #000000;">);<br></span><span style="color: #008080;">13</span>         <span style="color: #008000;">//</span><span style="color: #008000;">允许采用完整的命名空间,即设置命名空间是否必须进行精确匹配</span><br><span style="color: #008080;">14</span>         } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span><span style="color: #000000;"> (alwaysSelectFullNamespace) {<br></span><span style="color: #008080;">15</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> Simply select the namespace as everything before the last slash</span><br><span style="color: #008080;">16</span>             namespace = uri.substring(0<span style="color: #000000;">, lastSlash);<br></span><span style="color: #008080;">17</span>             name = uri.substring(lastSlash + 1<span style="color: #000000;">);<br></span><span style="color: #008080;">18</span>         } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">19</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> Try to find the namespace in those defined, defaulting to “”</span><br><span style="color: #008080;">20</span>             Configuration config =<span style="color: #000000;"> configManager.getConfiguration();<br></span><span style="color: #008080;">21</span>             String prefix = uri.substring(0, lastSlash); <span style="color: #008000;">//</span><span style="color: #008000;">临时的命名空间，将会用来进行匹配</span><br><span style="color: #008080;">22</span>             namespace = “”;<span style="color: #008000;">//</span><span style="color: #008000;">将命名空间暂时设为””</span><br><span style="color: #008080;">23</span>             <span style="color: #0000ff;">boolean</span> rootAvailable = <span style="color: #0000ff;">false</span>;<span style="color: #008000;">//</span><span style="color: #008000;">rootAvailable作用是判断配置文件中是否配置了命名空间”/“<br></span><span style="color: #008080;">24</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> Find the longest matching namespace, defaulting to the default</span><br><span style="color: #008080;">25</span>             <span style="color: #0000ff;">for</span> (Object cfg : config.getPackageConfigs().values()) { <span style="color: #008000;">//</span><span style="color: #008000;">循环遍历配置文件中的package标签</span><br><span style="color: #008080;">26</span>                 String ns = ((PackageConfig) cfg).getNamespace();    <span style="color: #008000;">//</span><span style="color: #008000;">获取每个package标签的namespace属性<br></span><span style="color: #008080;">27</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">进行匹配</span><br><span style="color: #008080;">28</span>                 <span style="color: #0000ff;">if</span> (ns != <span style="color: #0000ff;">null</span> &amp;&amp; prefix.startsWith(ns) &amp;&amp; (prefix.length() == ns.length() || prefix.charAt(ns.length()) == ‘/‘<span style="color: #000000;">)) {<br></span><span style="color: #008080;">29</span>                     <span style="color: #0000ff;">if</span> (ns.length() &gt;<span style="color: #000000;"> namespace.length()) {<br></span><span style="color: #008080;">30</span>                         namespace =<span style="color: #000000;"> ns;<br></span><span style="color: #008080;">31</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">32</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">33</span>                 <span style="color: #0000ff;">if</span> (“/“<span style="color: #000000;">.equals(ns)) {<br></span><span style="color: #008080;">34</span>                     rootAvailable = <span style="color: #0000ff;">true</span><span style="color: #000000;">;<br></span><span style="color: #008080;">35</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">36</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">37</span><br><span style="color: #008080;">38</span>             name = uri.substring(namespace.length() + 1<span style="color: #000000;">);<br></span><span style="color: #008080;">39</span><br><span style="color: #008080;">40</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> Still none found, use root namespace if found</span><br><span style="color: #008080;">41</span>             <span style="color: #0000ff;">if</span> (rootAvailable &amp;&amp; “”<span style="color: #000000;">.equals(namespace)) {<br></span><span style="color: #008080;">42</span>                 namespace = “/“<span style="color: #000000;">;<br></span><span style="color: #008080;">43</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">45</span><br><span style="color: #008080;">46</span>         <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">allowSlashesInActionNames) {<br></span><span style="color: #008080;">47</span>             <span style="color: #0000ff;">int</span> pos = name.lastIndexOf(‘/‘<span style="color: #000000;">);<br></span><span style="color: #008080;">48</span>             <span style="color: #0000ff;">if</span> (pos &gt; -1 &amp;&amp; pos &lt; name.length() - 1<span style="color: #000000;">) {<br></span><span style="color: #008080;">49</span>                 name = name.substring(pos + 1<span style="color: #000000;">);<br></span><span style="color: #008080;">50</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">51</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">52</span>         <span style="color: #008000;">//</span><span style="color: #008000;">将分离后的acion名和命名空间保存到mapping对象</span><br><span style="color: #008080;">53</span> <span style="color: #000000;">        mapping.setNamespace(namespace);<br></span><span style="color: #008080;">54</span> <span style="color: #000000;">        mapping.setName(cleanupActionName(name));<br></span><span style="color: #008080;">55</span>     }</pre><br></div>

<p>　　看到上面代码的第14行，<span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">参数alwaysSelectFullNamespace我们可以通过名字就能大概猜出来”允许采用完整的命名空间”，即设置命名空间是否必须进行精确匹配，true必须，false可以模糊匹配，默认是false。进行精确匹配时要求请求url中的命名空间必须与配置文件中配置的某个命名空间必须相同，如果没有找到相同的则匹配失败。这个参数可通过struts2的”struts.mapper.alwaysSelectFullNamespace”常量配置，如：<constant name="struts.mapper.alwaysSelectFullNamespace" value="true">。当</constant></span></span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">alwaysSelectFullNamespace为true时，将uri以lastSlash为分割，左边的为namespace，右边的为name。如：</span><span style="line-height: 1.5; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;"><a href="http://localhost:8080/myproject/" target="_blank" rel="external">http://localhost:8080/myproject/</a></span></span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">home/<span style="color: #000000;">actionName</span>!method.action,此时uri为</span><span style="line-height: 1.5; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">/</span></span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">home/<span style="color: #000000;">actionName</span>!method.action(不过前面把后缀名去掉了，变成<span style="line-height: 1.5; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">/</span></span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">home/<span style="color: #000000;">actionName</span>!method</span>)，</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">lastSlash的,当前值是5，这样namespace为”/home”, name为<span style="color: #000000;">actionName</span>!method。</span></p>
<p><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">　　我们再看到上面代码第18行到第44行：</span>当上面的所有条件都不满足时，其中包括<span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">alwaysSelectFullNamespace 为false(命名空间进行模糊匹配)，将由此部分处理，进行模糊匹配。第1句，通过</span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">configManager.getConfiguration()从配置管理器中获得配置对象Configuration，Configuration中存放着struts2的所有配置，形式是将xml文档的相应元素封装为java bean，如<package< span=""></package<></span><span style="line-height: 1.5; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">&gt;</span></span><span style="line-height: 1.5; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">元素被封装到</span></span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">PackageConfig类中，这个一会儿会用到。第2句按lastSlash将uri截取出prefix，这是一个临时的命名空间，之后将会拿prefix进行模糊匹配。第3句namespace = “”，将命名空间暂时设为””。第4句创建并设置rootAvailable，</span></span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">rootAvailable作用是判断配置文件中是否配置了命名空间”/“，true为配置了，false未配置，下面for语句将会遍历我们配置的所有包(&lt;</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">package</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">&gt;</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">)，同时设置</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">rootAvailable。第5句for，通过</span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">config.getPackageConfigs()获得所有已经配置的包，然后遍历。String ns = ((PackageConfig) cfg).getNamespace()获得当前包的命名空间ns，之后的if句是进行模糊匹配的核心，我摘出来单独说，如下：</span></span></span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">if</span> (ns != <span style="color: #0000ff;">null</span> &amp;&amp; prefix.startsWith(ns) &amp;&amp; (prefix.length() == ns.length() || prefix.charAt(ns.length()) == ‘/‘<span style="color: #000000;">)) {<br></span><span style="color: #008080;">2</span>                     <span style="color: #0000ff;">if</span> (ns.length() &gt;<span style="color: #000000;"> namespace.length()) {<br></span><span style="color: #008080;">3</span>                         namespace =<span style="color: #000000;"> ns;<br></span><span style="color: #008080;">4</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;">5</span>                 }</pre><br></div>

<p><span style="line-height: 24px; font-size: 14px;">　　ns != null &amp;&amp; prefix.startsWith(ns)这部分判断当ns不等于空并且ns是</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">prefix的前缀。</span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">prefix.length() == ns.length()当二者长度相等时，结合前面部分就是ns是</span></span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">prefix的前缀并且二者长度相等，最终结论就是ns和</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">prefix相等。如果前面的条件不成立，则说明prefix的长度大于ns。</span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">prefix.charAt(ns.length()) == ‘/‘)意思是prefix中与ns不相等的字符中的第一个字符必须是”/“，也就是说，在命名空间采用斜杠分级的形式中，ns必须是prefix的某一子集，如：/common/home 是用户配置的命名空间，则在http的请求url中，/common/home/index1、</span></span><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">/common/home/index2</span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">、</span><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">/common/home/index/aaa 都是正确的，都可以成功的匹配到</span><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">/common/home，而/common/homeaa、/common/homea/aaa都是错误的。接着</span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">if (ns.length() &gt; namespace.length()) 句，目的是找出字符长度最长的。因为命名空间采用的是分级的，则长度越长所表示的越精确，如/common/home/index比/common/home精确。之后将namespace = ns。</span></span></p>
<p><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">　　我们接着往下看</span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">if (“/“.equals(ns)) 当我们配置了”/“这个命名空间时，将rootAvailable = true。</span></span><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">name = uri.substring(namespace.length() + 1)句不涉及到命名空间就不说了。</span><span style="font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">if (rootAvailable &amp;&amp; “”.equals(namespace))如果通过上面的for循环没有找到匹配的命名空间即namespace的值仍然是当初设置的””，但却配置了”/“时，将命名空间设为”/“。</span></span></p>
<p><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">　　我们再看到第46到51行那个if语句：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">allowSlashesInActionNames) {<br></span><span style="color: #008080;">2</span>      <span style="color: #0000ff;">int</span> pos = name.lastIndexOf(‘/‘<span style="color: #000000;">);<br></span><span style="color: #008080;">3</span>      <span style="color: #0000ff;">if</span> (pos &gt; -1 &amp;&amp; pos &lt; name.length() - 1<span style="color: #000000;">) {<br></span><span style="color: #008080;">4</span>           name = name.substring(pos + 1<span style="color: #000000;">);<br></span><span style="color: #008080;">5</span> <span style="color: #000000;">     }<br></span><span style="color: #008080;">6</span> }</pre><br></div>

<p><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">　　allowSlashesInActionNames代表是否允许”/“出现在Action的名称中，默认为false，如果不允许”/“出现在Action名中，并且这时的Action名中有”/“，则取”/“后面的部分。</span></p>
<p><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">下面是命名空间匹配规则的总结：</span></p>
<p><span style="color: #ff0000; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">(1). 如果请求url中没有命名空间时，将采用”/“作为命名空间。</span></span></p>
<p><span style="color: #ff0000; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">(2). 当我们将常量 struts.mapper.alwaysSelectFullNamespace设为true时，那么请求url的命名空间必须和配置文件配置的完全相同才能匹配。</span></span></p>
<p><span style="color: #ff0000; line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">当将常量 struts.mapper.alwaysSelectFullNamespace设为false时，那么请求url的命名空间和配置文件配置的可按模糊匹配。规则：</span></p>
<p><span style="color: #ff0000; line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">　　a.如果配置文件中配置了/common 而url中的命名空间/common、/common/home、/common/home/index等等都是可匹配的，即子命名空间可匹配父命名空间。</span></p>
<p><span style="color: #ff0000;"><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">　　b.如果对于某个url请求中的命名空间同时匹配了俩个或俩个以上的配置文件中配置的命名空间，则选字符最长的，如：</span><span style="line-height: 1.5; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">当前请求的命名空间为/common/home/index/aaaa,&nbsp; 而我们在配置时同时配置&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 了/common/home、/common/home/index&nbsp; 则将会匹配命名空间最长的，即</span></span><span style="line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;">/common/home/index。</span></span></p>
<p><span style="color: #ff0000; font-family: 'arial, 宋体, sans-serif';"><span style="line-height: 24px; font-size: 14px;">(3).最后，如果请求的命名空间在配置中没有匹配到时，将采用””作为命名空间。如果没有设置为””的命名空间将抛出404错误。</span></span></p>
<p>　　②：parseActionName(mapping)</p>
<p><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">　　好了，到这里parseNameAndNamespace方法已经分析完了，我们再次回到getMapping方法中去，看到16行：handleSpecialParameters(request, mapping);好像是处理特殊参数的函数吧，里面有点看不懂，暂时就不管，以后有时间再研究。我们看到18行：return parseActionName(mapping);主要是用来处理形如/userAction!getAll.action的请求，分离action名和方法名：</span></p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">protected</span><span style="color: #000000;"> ActionMapping parseActionName(ActionMapping mapping) {<br></span><span style="color: #008080;"> 2</span>         <span style="color: #0000ff;">if</span> (mapping.getName() == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 3</span>             <span style="color: #0000ff;">return</span> <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 4</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;"> 5</span>         <span style="color: #008000;">//</span><span style="color: #008000;">如果允许动态方法调用</span><br><span style="color: #008080;"> 6</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (allowDynamicMethodCalls) {<br></span><span style="color: #008080;"> 7</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> handle “name!method” convention.</span><br><span style="color: #008080;"> 8</span>             String name =<span style="color: #000000;"> mapping.getName();<br></span><span style="color: #008080;"> 9</span>             <span style="color: #0000ff;">int</span> exclamation = name.lastIndexOf(“!”<span style="color: #000000;">);<br></span><span style="color: #008080;">10</span>             <span style="color: #008000;">//</span><span style="color: #008000;">如果包含”!”就进行分离</span><br><span style="color: #008080;">11</span>             <span style="color: #0000ff;">if</span> (exclamation != -1<span style="color: #000000;">) {<br></span><span style="color: #008080;">12</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">分离出action名</span><br><span style="color: #008080;">13</span>                 mapping.setName(name.substring(0<span style="color: #000000;">, exclamation));<br></span><span style="color: #008080;">14</span>                 <span style="color: #008000;">//</span><span style="color: #008000;">分离出方法名</span><br><span style="color: #008080;">15</span>                 mapping.setMethod(name.substring(exclamation + 1<span style="color: #000000;">));<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">18</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> mapping;<br></span><span style="color: #008080;">19</span>     }</pre><br></div>

<p><span style="line-height: 24px; font-family: 'arial, 宋体, sans-serif'; font-size: 14px;">　　到此为止getMapping方法已经分析结束了！</span></p>
<p>(5)execute.executeAction(request, response, mapping)</p>
<p>　　上面我们分析完了mapping的获取，继续看doFilter方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #008000;">//</span><span style="color: #008000;">如果mapping为空，则认为不是调用action,会调用下一个过滤器链，直到获取到mapping才调用action</span><br><span style="color: #008080;"> 2</span>                 <span style="color: #0000ff;">if</span> (mapping == <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;"> 3</span>                     <span style="color: #0000ff;">boolean</span> handled =<span style="color: #000000;"> execute.executeStaticResourceRequest(request, response);<br></span><span style="color: #008080;"> 4</span>                     <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">handled) {<br></span><span style="color: #008080;"> 5</span> <span style="color: #000000;">                        chain.doFilter(request, response);<br></span><span style="color: #008080;"> 6</span> <span style="color: #000000;">                    }<br></span><span style="color: #008080;"> 7</span>                 } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;"> 8</span>                     <span style="color: #008000;">//</span><span style="color: #008000;">执行action</span><br><span style="color: #008080;"> 9</span> <span style="color: #000000;">                    execute.executeAction(request, response, mapping);<br></span><span style="color: #008080;">10</span>                 }</pre><br></div>

<p>　　如果mapping对象不为空，则会执行action，我们看到上面代码第9行：execute是ExecuteOperations类的对象，ExecuteOperations类在包org.apache.struts2.dispatcher.ng下面，我们找到它里面的executeAction方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;">1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span> executeAction(HttpServletRequest request, HttpServletResponse response, ActionMapping mapping) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> ServletException {<br></span><span style="color: #008080;">2</span> <span style="color: #000000;">        dispatcher.serviceAction(request, response, servletContext, mapping);<br></span><span style="color: #008080;">3</span>     }</pre><br></div>

<p>我们可以看到它里面只是简单的调用了dispatcher的serviceAction方法：我们找到dispatcher的serviceAction方法：</p>
<div class="cnblogs_code"><br><pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">public</span> <span style="color: #0000ff;">void</span><span style="color: #000000;"> serviceAction(HttpServletRequest request, HttpServletResponse response, ServletContext context,<br></span><span style="color: #008080;"> 2</span>                               ActionMapping mapping) <span style="color: #0000ff;">throws</span><span style="color: #000000;"> ServletException {<br></span><span style="color: #008080;"> 3</span>         <span style="color: #008000;">//</span><span style="color: #008000;">封转上下文环境，主要将requestMap、params、session等Map封装成为一个上下文Map</span><br><span style="color: #008080;"> 4</span>         Map<string, object=""> extraContext =<span style="color: #000000;"> createContextMap(request, response, mapping, context);<br></span><span style="color: #008080;"> 5</span><br><span style="color: #008080;"> 6</span>         <span style="color: #008000;">//</span><span style="color: #008000;"> If there was a previous value stack, then create a new copy and pass it in to be used by the new Action</span><br><span style="color: #008080;"> 7</span>         ValueStack stack =<span style="color: #000000;"> (ValueStack) request.getAttribute(ServletActionContext.STRUTS_VALUESTACK_KEY);<br></span><span style="color: #008080;"> 8</span>         <span style="color: #0000ff;">boolean</span> nullStack = stack == <span style="color: #0000ff;">null</span><span style="color: #000000;">;<br></span><span style="color: #008080;"> 9</span>         <span style="color: #0000ff;">if</span><span style="color: #000000;"> (nullStack) {<br></span><span style="color: #008080;">10</span>             ActionContext ctx =<span style="color: #000000;"> ActionContext.getContext();<br></span><span style="color: #008080;">11</span>             <span style="color: #0000ff;">if</span> (ctx != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">12</span>                 stack =<span style="color: #000000;"> ctx.getValueStack();<br></span><span style="color: #008080;">13</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">14</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">15</span>         <span style="color: #0000ff;">if</span> (stack != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">16</span> <span style="color: #000000;">            extraContext.put(ActionContext.VALUE_STACK, valueStackFactory.createValueStack(stack));<br></span><span style="color: #008080;">17</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">18</span><br><span style="color: #008080;">19</span>         String timerKey = “Handling request from Dispatcher”<span style="color: #000000;">;<br></span><span style="color: #008080;">20</span>         <span style="color: #0000ff;">try</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">21</span> <span style="color: #000000;">            UtilTimerStack.push(timerKey);<br></span><span style="color: #008080;">22</span>             String namespace = mapping.getNamespace();<span style="color: #008000;">//</span><span style="color: #008000;">从mapping对象获取命名空间</span><br><span style="color: #008080;">23</span>             String name = mapping.getName();          <span style="color: #008000;">//</span><span style="color: #008000;">获取请求的action名</span><br><span style="color: #008080;">24</span>             String method = mapping.getMethod();      <span style="color: #008000;">//</span><span style="color: #008000;">获取请求方法<br></span><span style="color: #008080;">25</span>             <span style="color: #008000;">//</span><span style="color: #008000;">得到配置对象</span><br><span style="color: #008080;">26</span>             Configuration config =<span style="color: #000000;"> configurationManager.getConfiguration();<br></span><span style="color: #008080;">27</span>             <span style="color: #008000;">//</span><span style="color: #008000;">根据执行上下文参数，命名空间，名称等创建用户自定义Action的代理对象  </span><br><span style="color: #008080;">28</span>             ActionProxy proxy = config.getContainer().getInstance(ActionProxyFactory.<span style="color: #0000ff;">class</span><span style="color: #000000;">).createActionProxy(<br></span><span style="color: #008080;">29</span>                     namespace, name, method, extraContext, <span style="color: #0000ff;">true</span>, <span style="color: #0000ff;">false</span><span style="color: #000000;">);<br></span><span style="color: #008080;">30</span><br><span style="color: #008080;">31</span> <span style="color: #000000;">            request.setAttribute(ServletActionContext.STRUTS_VALUESTACK_KEY, proxy.getInvocation().getStack());<br></span><span style="color: #008080;">32</span><br><span style="color: #008080;">33</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> if the ActionMapping says to go straight to a result, do it!<br></span><span style="color: #008080;">34</span>             <span style="color: #008000;">//</span><span style="color: #008000;">如果配置文件中执行的这个action配置了result，就直接转到result</span><br><span style="color: #008080;">35</span>             <span style="color: #0000ff;">if</span> (mapping.getResult() != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">36</span>                 Result result =<span style="color: #000000;"> mapping.getResult();<br></span><span style="color: #008080;">37</span> <span style="color: #000000;">                result.execute(proxy.getInvocation());<br></span><span style="color: #008080;">38</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">39</span> <span style="color: #000000;">                proxy.execute();<br></span><span style="color: #008080;">40</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">41</span><br><span style="color: #008080;">42</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> If there was a previous value stack then set it back onto the request</span><br><span style="color: #008080;">43</span>             <span style="color: #0000ff;">if</span> (!<span style="color: #000000;">nullStack) {<br></span><span style="color: #008080;">44</span> <span style="color: #000000;">                request.setAttribute(ServletActionContext.STRUTS_VALUESTACK_KEY, stack);<br></span><span style="color: #008080;">45</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">46</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (ConfigurationException e) {<br></span><span style="color: #008080;">47</span>             <span style="color: #008000;">//</span><span style="color: #008000;"> WW-2874 Only log error if in devMode</span><br><span style="color: #008080;">48</span>             <span style="color: #0000ff;">if</span><span style="color: #000000;"> (devMode) {<br></span><span style="color: #008080;">49</span>                 String reqStr =<span style="color: #000000;"> request.getRequestURI();<br></span><span style="color: #008080;">50</span>                 <span style="color: #0000ff;">if</span> (request.getQueryString() != <span style="color: #0000ff;">null</span><span style="color: #000000;">) {<br></span><span style="color: #008080;">51</span>                     reqStr = reqStr + “?” +<span style="color: #000000;"> request.getQueryString();<br></span><span style="color: #008080;">52</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">53</span>                 LOG.error(“Could not find action or result\n” +<span style="color: #000000;"> reqStr, e);<br></span><span style="color: #008080;">54</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">55</span>                 <span style="color: #0000ff;">if</span><span style="color: #000000;"> (LOG.isWarnEnabled()) {<br></span><span style="color: #008080;">56</span>                     LOG.warn(“Could not find action or result”<span style="color: #000000;">, e);<br></span><span style="color: #008080;">57</span> <span style="color: #000000;">                }<br></span><span style="color: #008080;">58</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">59</span> <span style="color: #000000;">            sendError(request, response, context, HttpServletResponse.SC_NOT_FOUND, e);<br></span><span style="color: #008080;">60</span>         } <span style="color: #0000ff;">catch</span><span style="color: #000000;"> (Exception e) {<br></span><span style="color: #008080;">61</span>             <span style="color: #0000ff;">if</span> (handleException ||<span style="color: #000000;"> devMode) {<br></span><span style="color: #008080;">62</span> <span style="color: #000000;">                sendError(request, response, context, HttpServletResponse.SC_INTERNAL_SERVER_ERROR, e);<br></span><span style="color: #008080;">63</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">64</span>                 <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span><span style="color: #000000;"> ServletException(e);<br></span><span style="color: #008080;">65</span> <span style="color: #000000;">            }<br></span><span style="color: #008080;">66</span>         } <span style="color: #0000ff;">finally</span><span style="color: #000000;"> {<br></span><span style="color: #008080;">67</span> <span style="color: #000000;">            UtilTimerStack.pop(timerKey);<br></span><span style="color: #008080;">68</span> <span style="color: #000000;">        }<br></span><span style="color: #008080;">69</span>     }</string,></pre><br></div>

<p>　　最后通过Result完成页面跳转！</p>
<p>&nbsp;</p>
<p>总结：以前总是只会用struts2框架，对里面的原理没有一个很清晰的认识，这两天花时间把struts2框架的源码分析了一下，对它的工作原理有个更深的认识。既然是开源框架，有时间久得去研究研究它的源码，不然开源就失去了意义了，不要只停留在会用的层面上！</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.liuling123.com/2013/08/struts2-source.html" data-id="ciiylp3h5000m4vd06vkaydwo" class="article-share-link">分享到</a>
      
        <a href="http://www.liuling123.com/2013/08/struts2-source.html#ds-thread" class="article-comment-link">评论</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web后端/">web后端</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2013/08/string-summarize.html" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          对字符串操作的各种笔试题
        
      </div>
    </a>
  
  
    <a href="/2013/08/shell.html" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">shell语法使用</div>
    </a>
  
</nav>


  
</article>


  <section id="comments">
    <!-- 多说评论框 start -->
  <div class="ds-thread" data-thread-key="post-struts2-source" data-title="struts2请求过程源码分析" data-url="http://www.liuling123.com/2013/08/struts2-source.html"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"liuling123"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共JS代码 end -->
  </section>

</section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新博文</h3>
    <div class="widget">
      <ul id="recent-post" class="no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/人生感悟/">人生感悟</a></p>
              <p class="item-title"><a href="/2015/12/Say-bye-to-my-2015.html" class="title">Say bye to my 2015</a></p>
              <p class="item-date"><time datetime="2015-12-25T09:25:10.000Z" itemprop="datePublished">2015-12-25</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/12/mvp-pattern-android.html" class="title">MVP模式在Android项目中的使用</a></p>
              <p class="item-date"><time datetime="2015-12-23T14:16:04.000Z" itemprop="datePublished">2015-12-23</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/12/intent-resolving-in-android-m.html" class="title">【译文】Android M中Intent的解析</a></p>
              <p class="item-date"><time datetime="2015-12-04T06:52:06.000Z" itemprop="datePublished">2015-12-04</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/12/performance-listviews.html" class="title">【译文】高性能ListViews</a></p>
              <p class="item-date"><time datetime="2015-12-02T10:22:14.000Z" itemprop="datePublished">2015-12-02</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/categories/Android/">Android</a></p>
              <p class="item-title"><a href="/2015/11/android-multi-photo-picker.html" class="title">Android带多选功能的PhotoPicker</a></p>
              <p class="item-date"><time datetime="2015-11-21T07:46:03.000Z" itemprop="datePublished">2015-11-21</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">博文分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Framework/">Framework</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hadoop/">Hadoop</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JNI-amp-NDK/">JNI&amp;NDK</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a><span class="category-list-count">35</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NoSQL/">NoSQL</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/人生感悟/">人生感悟</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他技术/">其他技术</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/后端/">后端</a><span class="category-list-count">29</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据结构和算法/">数据结构和算法</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">7</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/AsyncTask/" style="font-size: 11.54px;">AsyncTask</a> <a href="/tags/LruCache/" style="font-size: 10px;">LruCache</a> <a href="/tags/MVP/" style="font-size: 10px;">MVP</a> <a href="/tags/NoSQL/" style="font-size: 13.08px;">NoSQL</a> <a href="/tags/android/" style="font-size: 18.46px;">android</a> <a href="/tags/android-studio/" style="font-size: 10px;">android studio</a> <a href="/tags/c/" style="font-size: 10px;">c++</a> <a href="/tags/camera/" style="font-size: 10px;">camera</a> <a href="/tags/framework/" style="font-size: 10.77px;">framework</a> <a href="/tags/hadoop/" style="font-size: 14.62px;">hadoop</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/jni/" style="font-size: 13.08px;">jni</a> <a href="/tags/linux/" style="font-size: 16.15px;">linux</a> <a href="/tags/mysql/" style="font-size: 11.54px;">mysql</a> <a href="/tags/redis/" style="font-size: 13.08px;">redis</a> <a href="/tags/spring/" style="font-size: 10.77px;">spring</a> <a href="/tags/sqlite/" style="font-size: 10px;">sqlite</a> <a href="/tags/web后端/" style="font-size: 19.23px;">web后端</a> <a href="/tags/内存缓存/" style="font-size: 10px;">内存缓存</a> <a href="/tags/前端/" style="font-size: 13.85px;">前端</a> <a href="/tags/反射/" style="font-size: 10px;">反射</a> <a href="/tags/图片选择/" style="font-size: 10.77px;">图片选择</a> <a href="/tags/多线程/" style="font-size: 17.69px;">多线程</a> <a href="/tags/布局/" style="font-size: 12.31px;">布局</a> <a href="/tags/布局优化/" style="font-size: 10.77px;">布局优化</a> <a href="/tags/开源/" style="font-size: 10.77px;">开源</a> <a href="/tags/断点续传/" style="font-size: 11.54px;">断点续传</a> <a href="/tags/科学上网/" style="font-size: 10px;">科学上网</a> <a href="/tags/自定义控件/" style="font-size: 10px;">自定义控件</a> <a href="/tags/解决方案/" style="font-size: 16.92px;">解决方案</a> <a href="/tags/设计模式/" style="font-size: 15.38px;">设计模式</a> <a href="/tags/译文/" style="font-size: 10.77px;">译文</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">博文归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">八月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">四月 2014</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">三月 2014</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">十二月 2013</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">十一月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">八月 2013</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">七月 2013</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">六月 2013</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">五月 2013</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">四月 2013</a><span class="archive-list-count">19</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/03/">三月 2013</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/02/">二月 2013</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/01/">一月 2013</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/12/">十二月 2012</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/11/">十一月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/08/">八月 2012</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2012/07/">七月 2012</a><span class="archive-list-count">8</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap widget-list">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a target="_blank" href="http://blog.daimajia.com">代码家</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.trinea.cn">Trinea</a>
          </li>
        
          <li>
            <a target="_blank" href="https://www.aswifter.com">APP开发者</a>
          </li>
        
          <li>
            <a target="_blank" href="http://blog.seoui.com">笑松小站</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.apkfuns.com">舞影凌风</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.ttfde.org">TTF的家园</a>
          </li>
        
          <li>
            <a target="_blank" href="http://rocko.xyz">Rocko&#39;s blog</a>
          </li>
        
          <li>
            <a target="_blank" href="http://www.93sec.cc">教程资源网</a>
          </li>
        
      </ul>
    </div>
  </div>


  
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 - 2016 Lauren<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>
</footer>
    

<script type="text/javascript">
  var duoshuoQuery = {short_name:"liuling123"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>





 <script src="//ajax.lug.ustc.edu.cn/ajax/libs/jquery/2.1.3/jquery.min.js"></script>




  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>